/* (c) Mathigon */
var App=function(t){"use strict";
function e(t,e,s,i){var n,o=arguments.length,r=o<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,s):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,s,i);else for(var h=t.length-1;h>=0;h--)(n=t[h])&&(r=(o<3?n(r):o>3?n(e,s,r):n(e,s))||r);return o>3&&r&&Object.defineProperty(e,s,r),r}function s(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{a(i.next(t))}catch(t){o(t)}}function h(t){try{a(i.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,h)}a((i=i.apply(t,e||[])).next())}))}function i(t,...e){return e.includes(t)}function n(t,e){for(const s of Object.keys(e))Object.prototype.hasOwnProperty.call(t,s)||(t[s]=e[s]);return t}const o=(t,e)=>t.concat(e);function r(t,e,s=o){for(const i of Object.keys(e))i in t&&Array.isArray(t[i])&&Array.isArray(e[i])?t[i]=s(t[i],e[i]):i in t&&t[i]instanceof Object&&e[i]instanceof Object?r(t[i],e[i]):t[i]=e[i]}function h(t,e=0){return e?+setTimeout(t,e):(t(),0)}function a(t){return new Promise((e=>setTimeout(e,t)))}function l(){let t=()=>{},e=()=>{};const s=new Promise(((s,i)=>{t=s,e=i}));return s.catch((t=>t)),{promise:s,resolve:t,reject:e}}function c(t){const e=new Map;return function(...s){const i=s.join("--");return e.has(i)||e.set(i,t(...s)),e.get(i)}}function d(t,e=0,s=!1){let i=!1,n=!1;return(...o)=>{i?n=!0:(s?n=!0:t(...o),i=!0,setTimeout((()=>{n&&t(...o),i=n=!1}),e))}}function p(t,e={}){if(!t)return e;try{return JSON.parse(t)||e}catch(t){return e}}function u(t,e){return new Array(e).fill(t)}function f(t,e,s){const i=[];for(let n=0;n<e;++n)i.push(u(t,s));return i}function g(t,e){const s=[];for(let i=0;i<e;++i)s.push(t(i));return s}function m(t,e,s=1){const i=[];if(void 0===e&&t>=0)for(let e=0;e<t;e+=s)i.push(e);else if(void 0===e)for(let e=0;e>t;e-=s)i.push(e);else if(t<=e)for(let n=t;n<=e;n+=s)i.push(n);else for(let n=t;n>=e;n-=s)i.push(n);return i}function v(t,e=0){return t[t.length-1-e]}function $(t){return t.reduce(((t,e)=>t+e),0)}function w(t,e,s=!1){return t.slice(0).sort(((t,i)=>{const n=e(t),o=e(i);return n<o?s?1:-1:n>o?s?-1:1:0}))}function x(t){let e=0;return()=>t[e++%t.length]}function y(t){return t.filter(((e,s)=>t.indexOf(e)===s))}function b(t){return t.reduce(((t,e)=>t.concat(Array.isArray(e)?b(e):e)),[])}function M(t,e){const s=[];for(let i=0;i<t.length;i+=e)s.push(t.slice(i,i+e));return s}function k(...t){return t.reduce(((t,e)=>t.concat(e)),[])}function A(t,e=/\s+/){return t?t.trim().split(e):[]}function C(t){return t.toLowerCase().replace(/^-/,"").replace(/-(.)/g,((t,e)=>e.toUpperCase()))}function P(t,e,s=!1){const i=f(0,t.length+1,e.length+1);for(let e=0;e<=t.length;e++)i[e][0]=e;for(let t=0;t<=e.length;t++)i[0][t]=t;for(let s=1;s<=t.length;s++)for(let n=1;n<=e.length;n++)i[s][n]=Math.min(i[s-1][n-1]+(t.charAt(s-1)===e.charAt(n-1)?0:1),i[s-1][n]+1,i[s][n-1]+1);return s?Math.min(...i[t.length]):i[t.length][e.length]}class T{constructor(){this.events=new Map}on(t,e){for(const s of A(t))this.events.has(s)||this.events.set(s,[]),this.events.get(s).push(e)}one(t,e){const s=i=>{this.off(t,s),e(i)};this.on(t,s)}off(t,e){for(const s of A(t))this.events.has(s)&&this.events.set(s,this.events.get(s).filter((t=>t!==e)))}trigger(t,e){for(const s of A(t))if(this.events.has(s))for(const t of this.events.get(s))t(e)}}const S=/^#?([a-f\d])([a-f\d])([a-f\d])$/i,L=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i,_=/rgba?\(([0-9,]+), ?([0-9,]+), ?([0-9,]+)(, ?([0-9,]+))?\)/,z=["#22ab24","#009ea6","#0f82f2","#6d3bbf","#cd0e66","#eb4726","#fd8c00"];function E(t,e){if(e<=0)return O.from(t[0]);if(e>=1)return O.from(v(t));const s=Math.floor(e*(t.length-1)),i=e*(t.length-1)-s;return O.mix(t[s+1],t[s],i)}function I(t,e,s){return s<0&&(s+=1),s>1&&(s-=1),s<1/6?t+6*(e-t)*s:s<.5?e:s<2/3?t+(e-t)*(2/3-s)*6:t}class O{constructor(t,e,s,i=1){this.r=t,this.g=e,this.b=s,this.a=i}get hex(){return"#"+[this.r,this.g,this.b].map((t=>{return 1===(e=Math.round(t).toString(16)).length?"0"+e:e;var e})).join("")}get rgb(){return"rgba("+[this.r,this.g,this.b].map((t=>Math.round(t))).join(",")+","+this.a+")"}get hsl(){const t=this.r/255,e=this.g/255,s=this.b/255,i=Math.max(t,e,s),n=Math.min(t,e,s),o=(n+i)/2,r=i-n;if(i===n)return[0,0,Math.round(100*o)];let h=t===i?(e-s)/r:e===i?2+(s-t)/r:4+(t-e)/r;h=Math.min(60*h,360),h<0&&(h+=360);const a=o<=.5?r/(i+n):r/(2-i-n);return[Math.round(h),Math.round(100*a),Math.round(100*o)]}get chroma(){return Math.max(this.r,this.g,this.b)-Math.min(this.r,this.g,this.b)}toString(){return this.rgb}copy(){return new O(this.r,this.g,this.b,this.a)}static from(t){return"string"!=typeof t?t:t.startsWith("#")?O.fromHex(t):O.fromRgb(t)}static fromRgb(t){const e=t.match(_);if(!e)return new O(0,0,0);const s=e[4]?+e[5]||0:1;return new O(+e[1],+e[2],+e[3],s)}static fromHex(t){t=t.replace(S,(function(t,e,s,i){return e+e+s+s+i+i}));const e=L.exec(t);return e?new O(parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)):new O(0,0,0)}static fromHsl(t,e,s){if(t/=360,s/=100,0===(e/=100)){const t=Math.round(255*s);return new O(t,t,t)}const i=s<.5?s*(1+e):s+e-s*e,n=2*s-i,o=I(n,i,t+1/3),r=I(n,i,t),h=I(n,i,t-1/3);return new O(Math.round(255*o),Math.round(255*r),Math.round(255*h))}static rainbow(t){return g((e=>E(z,e/(t-1))),t)}static gradient(t,e){return g((s=>E(t,s/(e-1))),e)}static shades(t,e,s=.5){const i=O.mix("#fff",t,s),n=O.mix("#000",t,s);return O.gradient([i,t,n],e)}static mix(t,e,s=.5){return t=O.from(t),e=O.from(e),new O(s*t.r+(1-s)*e.r,s*t.g+(1-s)*e.g,s*t.b+(1-s)*e.b,s*t.a+(1-s)*e.a)}static mixMany(t,e){e||(e=t.map((()=>1)));const s=$(e),i=t.map((t=>t.hsl)),n=i.map((t=>t[0])),o=n.map((t=>t<180?t+360:t)),r=e.map(((e,s)=>e*Math.sqrt(t[s].chroma))),h=$(r),a=$(n.map(((t,e)=>t*r[e])))/h,l=$(o.map(((t,e)=>t*r[e])))/h,c=$(n.map(((t,e)=>Math.abs(t-a)*r[e])))<=$(o.map(((t,e)=>Math.abs(t-l)*r[e])))?a:l%360,d=$(i.map(((t,s)=>e[s]*t[1])))/s,p=$(i.map(((t,s)=>e[s]*t[2])))/s;return O.fromHsl(c,d,p)}}function q(t,e,s=1e-6){return!isNaN(t)&&!isNaN(e)&&Math.abs(t-e)<s}function V(t,e,s,i=1e-6){return e>s&&([e,s]=[s,e]),t>e+i&&t<s-i}const B=/(\d+)(\d{3})/,R=["","k","m","b","t","q"];function D(t,e=0,s=!0){const i=function(t,e=6){if(!e)return""+t;const s=(""+Math.abs(Math.floor(t))).length,i=t<0?1:0;if(s<=e-i)return""+X(t,e-s-i-1);const n=Math.floor(Math.log10(Math.abs(t))/3);return X(t/Math.pow(10,3*n),e-(s%3||3)-i-1)+R[n]}(t,e).replace("-","–");return s?function(t){let[e,s]=t.split(".");for(;B.test(e);)e=e.replace(B,"$1,$2");return e+(s?"."+s:"")}(i):i}const j=/^-?0,[0-9]+$/,N=/^-?([0-9]+(,[0-9]{3})*)?\.?[0-9]*$/,H=/^-?[0-9]+(\.[0-9]{3})*,?[0-9]*$/;function Z(t){return!(t=t.replace(/^–/,"-").trim())||t.match(/[^0-9.,-]/)?NaN:j.test(t)?parseFloat(t.replace(/,/,".")):N.test(t)?parseFloat(t.replace(/,/g,"")):H.test(t)?parseFloat(t.replace(/\./g,"").replace(/,/,".")):NaN}const F=["","one","two","three","four","five","six","seven","eight","nine","ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen","seventeen","eighteen","nineteen"],U=["","","twenty","thirty","forty","fifty","sixty","seventy","eighty","ninety"],W=[""," thousand"," million"," billion"," trillion"," quadrillion"," quintillion"," sextillion"];function K(t){const[e,s,i]=t.split(""),n="0"===e?"":" "+F[+e]+" hundred";return s+i==="00"?n:+s<2?n+" "+F[+(s+i)]:"0"===i?n+" "+U[+s]:n+" "+U[+s]+"-"+F[+i]}function G(t){if(0===t)return"zero";const e=Math.round(Math.abs(t)).toString(),s=Math.ceil(e.length/3),i=e.padStart(3*s,"0");let n="";for(let t=0;t<s;t+=1){const e=i.substr(3*t,3);"000"!==e&&(n+=K(e)+W[s-1-t])}return n.trim()}function X(t,e=0){const s=Math.pow(10,e);return Math.round(t*s)/s}function Y(t,e=1){return Math.round(t/e)*e}function Q(t,e=-1/0,s=1/0){return Math.min(s,Math.max(e,t))}function J(t,e,s=.5){return t+(e-t)*s}function tt(t){return t*t}function et(t,e){return(t%e+e)%e}function st(t,e=0){const s=it(t.slice(0));return e?s.filter((t=>t.length===e)):s}function it(t){if(1===t.length)return[[],t];const e=t.pop(),s=it(t),i=[];for(const t of s)i.push(t,[...t,e]);return i}const nt=(t,e)=>{const s=t<0?"–":"";return 1===Math.abs(t)&&e?s+e:s+Math.abs(t)+(e||"")};class ot{constructor(t=0,e=0){this.re=t,this.im=e}get modulus(){return Math.sqrt(this.re*this.re+this.im*this.im)}get argument(){return Math.atan2(this.im,this.re)}get conjugate(){return new ot(this.re,-this.im)}root(t,e=0){const s=Math.pow(this.modulus,1/t),i=(this.argument+2*e*Math.PI)/t;return new ot(s*Math.cos(i),s*Math.sin(i))}toString(t=2){const e=X(this.re,t),s=X(this.im,t);return 0===s?nt(e):0===e?nt(s,"i"):[nt(e),s<0?"–":"+",nt(Math.abs(s),"i")].join(" ")}add(t){return ot.sum(this,t)}subtract(t){return ot.difference(this,t)}multiply(t){return ot.product(this,t)}divide(t){return ot.quotient(this,t)}static sum(t,e){return"number"==typeof t&&(t=new ot(t,0)),"number"==typeof e&&(e=new ot(e,0)),new ot(t.re+e.re,t.im+e.im)}static difference(t,e){return"number"==typeof t&&(t=new ot(t,0)),"number"==typeof e&&(e=new ot(e,0)),new ot(t.re-e.re,t.im-e.im)}static product(t,e){"number"==typeof t&&(t=new ot(t,0)),"number"==typeof e&&(e=new ot(e,0));const s=t.re*e.re-t.im*e.im,i=t.im*e.re+t.re*e.im;return new ot(s,i)}static quotient(t,e){if("number"==typeof t&&(t=new ot(t,0)),"number"==typeof e&&(e=new ot(e,0)),Math.abs(e.re)<Number.EPSILON||Math.abs(e.im)<Number.EPSILON)return new ot(1/0,1/0);const s=e.re*e.re+e.im*e.im,i=(t.re*e.re+t.im*e.im)/s,n=(t.im*e.re-t.re*e.im)/s;return new ot(i,n)}static exp(t){"number"==typeof t&&(t=new ot(t,0));const e=Math.exp(t.re);return new ot(e*Math.cos(t.im),e*Math.sin(t.im))}}function rt(t){if(t%1!=0||t<2)return!1;if(t%2==0)return 2===t;if(t%3==0)return 3===t;const e=Math.sqrt(t);for(let s=5;s<=e;s+=6){if(t%s==0)return!1;if(t%(s+2)==0)return!1}return!0}function ht(t){if(1===t)return[];if(rt(t))return[t];const e=Math.sqrt(t);for(let s=2;s<=e;++s)if(t%s==0)return ht(s).concat(ht(t/s));return[]}function at(t=2){const e=function(t,e,s){return f(t,e,s)}(0,t,t);for(let s=0;s<t;++s)e[s][s]=1;return e}function lt(...t){const[e,...s]=t,i=s.length>1?lt(...s):s[0];if(e[0].length!==i.length)throw new Error("Matrix sizes don’t match.");const n=[];for(let t=0;t<e.length;++t){const s=[];for(let n=0;n<i[0].length;++n){let o=0;for(let s=0;s<i.length;++s)o+=e[t][s]*i[s][n];s.push(o)}n.push(s)}return n}function ct(t){const e=Math.random()*$(t);let s=0;return t.findIndex((t=>(s+=t)>=e))}const dt=new Map;function pt(t=.5){return Math.random()<t?1:0}const ut=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,1.5056327351493116e-7];function ft(t){if(t<.5)return Math.PI/(Math.sin(Math.PI*t)*ft(1-t));t-=1;let e=ut[0];for(let s=1;s<9;s++)e+=ut[s]/(t+s);const s=t+7+.5;return Math.sqrt(2*Math.PI)*Math.pow(s,t+.5)*Math.exp(-s)*e}function gt(t,e,s,i=1){let n=0;for(let o=e;o<s;o+=i)n+=t(o)*i||0;return n}var mt=Object.freeze({__proto__:null,shuffle:function(t){for(let e=(t=t.slice(0)).length-1;e>0;--e){const s=Math.floor(Math.random()*(e+1));[t[e],t[s]]=[t[s],t[e]]}return t},integer:function(t,e){const s=void 0===e?t:e-t+1;return(void 0===e?0:t)+Math.floor(s*Math.random())},weighted:ct,find:function(t){return t[Math.floor(t.length*Math.random())]},smart:function(t,e){e||(e=function(t=10){return Math.random().toString(36).substr(2,t)}()),dt.has(e)||dt.set(e,u(1,t));const s=dt.get(e),i=ct(s.map((t=>t*t)));return s[i]-=1,s[i]<=0&&dt.set(e,s.map((t=>t+1))),i},bernoulli:pt,binomial:function(t=1,e=.5){let s=0;for(let i=0;i<t;++i)s+=pt(e);return s},poisson:function(t=1){if(t<=0)return 0;const e=Math.exp(-t);let s=1,i=0;for(;s>e;++i)s*=Math.random();return i-1},uniform:function(t=0,e=1){return t+(e-t)*Math.random()},normal:function(t=0,e=1){const s=Math.random(),i=Math.random();return Math.sqrt(-2*Math.log(s))*Math.cos(2*Math.PI*i)*Math.sqrt(e)+t},exponential:function(t=1){return t<=0?0:-Math.log(Math.random())/t},geometric:function(t=.5){if(!(t<=0||t>1))return Math.floor(Math.log(Math.random())/Math.log(1-t))},cauchy:function(){let t,e,s;do{e=2*Math.random()-1,s=2*Math.random()-1,t=e*e+s*s}while(t>=1);return e/s},normalPDF:function(t,e=1,s=0){return Math.exp(-((t-e)**2)/(2*s))/Math.sqrt(2*Math.PI*s)},integrate:gt,chiCDF:function(t,e){return 1-gt((t=>Math.pow(t,(e-2)/2)*Math.exp(-t/2)),0,t)/Math.pow(2,e/2)/ft(e/2)}});function vt(t,e){let s=1,i=t[0];for(let n=1;n<t.length;++n)s*=e,i+=s*t[n];return i}function $t(t,e=2){const s=t.map((t=>m(e+1).map((e=>Math.pow(t[0],e))))),i=function(t){const e=[];for(let s=0;s<t[0].length;++s){const i=[];for(let e=0;e<t.length;++e)i.push(t[e][s]);e.push(i)}return e}(s),n=t.map((t=>[t[1]])),o=lt(i,s);return lt(function(t){const e=t.length;if(e!==t[0].length)throw new Error("Not a square matrix.");const s=at(e),i=function(t,e,s){const i=[];for(let n=0;n<e;++n){const e=[];for(let i=0;i<s;++i)e.push(t(n,i));i.push(e)}return i}(((e,s)=>t[e][s]),e,e);for(let t=0;t<e;++t){let n=i[t][t];if(!n){for(let n=t+1;n<e;++n)if(0!==i[n][t]){for(let o=0;o<e;++o)[i[n][o],i[t][o]]=[i[t][o],i[n][o]],[s[n][o],s[t][o]]=[s[t][o],s[n][o]];break}if(n=i[t][t],!n)throw new Error("Matrix not invertible.")}for(let o=0;o<e;++o)i[t][o]=i[t][o]/n,s[t][o]=s[t][o]/n;for(let n=0;n<e;++n){if(n===t)continue;const o=i[n][t];for(let r=0;r<e;++r)i[n][r]-=o*i[t][r],s[n][r]-=o*s[t][r]}}return s}(o),i,n).map((t=>t[0]))}function wt(t,e){const s=t.reduce(((t,e)=>t+e[1]),0)/t.length,i=t.reduce(((t,e)=>t+(e[1]-s)**2),0);return 1-t.reduce(((t,s)=>t+(s[1]-e(s[0]))**2),0)/i}var xt=Object.freeze({__proto__:null,linear:function(t,e=!1){let s=0,i=0,n=0,o=0;const r=t.length;for(let e=0;e<r;e++)s+=t[e][0],i+=t[e][1],n+=t[e][0]*t[e][0],o+=t[e][0]*t[e][1];if(e){return[0,o/n]}const h=(r*o-s*i)/(r*n-s*s);return[i/r-h*s/r,h]},exponential:function(t){const e=[0,0,0,0,0,0];for(const s of t)e[0]+=s[0],e[1]+=s[1],e[2]+=s[0]*s[0]*s[1],e[3]+=s[1]*Math.log(s[1]),e[4]+=s[0]*s[1]*Math.log(s[1]),e[5]+=s[0]*s[1];const s=e[1]*e[2]-e[5]*e[5];return[Math.exp((e[2]*e[3]-e[5]*e[4])/s),(e[1]*e[4]-e[5]*e[3])/s]},logarithmic:function(t){const e=[0,0,0,0],s=t.length;for(const s of t)e[0]+=Math.log(s[0]),e[1]+=s[1]*Math.log(s[0]),e[2]+=s[1],e[3]+=Math.pow(Math.log(s[0]),2);const i=(s*e[1]-e[2]*e[0])/(s*e[3]-e[0]*e[0]);return[(e[2]-i*e[0])/s,i]},power:function(t){const e=[0,0,0,0],s=t.length;for(const s of t)e[0]+=Math.log(s[0]),e[1]+=Math.log(s[1])*Math.log(s[0]),e[2]+=Math.log(s[1]),e[3]+=Math.pow(Math.log(s[0]),2);const i=(s*e[1]-e[2]*e[0])/(s*e[3]-e[0]*e[0]);return[Math.exp((e[2]-i*e[0])/s),i]},polynomial:$t,coefficient:wt,bestPolynomial:function(t,e=.85,s=8){if(!(t.length<=1))for(let i=1;i<s;++i){const s=$t(t,i),n=t=>vt(s,t);if(wt(t,n)>=e)return{order:i,coefficients:s,fn:n}}}});const yt=2*Math.PI;function bt(t,e){return et(Math.atan2(t.y-(e?e.y:0),t.x-(e?e.x:0)),yt)}class Mt{constructor(t=0,e=0){this.x=t,this.y=e,this.type="point"}get unitVector(){return q(this.length,0)?new Mt(1,0):this.scale(1/this.length)}get length(){return Math.sqrt(this.x**2+this.y**2)}get inverse(){return new Mt(-this.x,-this.y)}get flip(){return new Mt(this.y,this.x)}get perpendicular(){return new Mt(-this.y,this.x)}get array(){return[this.x,this.y]}distanceFromLine(t){return Mt.distance(this,t.project(this))}clamp(t,e=0){const s=Q(this.x,t.xMin+e,t.xMax-e),i=Q(this.y,t.yMin+e,t.yMax-e);return new Mt(s,i)}changeCoordinates(t,e){const s=e.xMin+(this.x-t.xMin)/t.dx*e.dx,i=e.yMin+(this.y-t.yMin)/t.dy*e.dy;return new Mt(s,i)}add(t){return Mt.sum(this,t)}subtract(t){return Mt.difference(this,t)}round(t=1){return new Mt(Y(this.x,t),Y(this.y,t))}floor(){return new Mt(Math.floor(this.x),Math.floor(this.y))}mod(t,e=t){return new Mt(this.x%t,this.y%e)}angle(t=kt){return bt(this,t)}snap(t,e=5){return q(this.x,t.x,e)?new Mt(t.x,this.y):q(this.y,t.y,e)?new Mt(this.x,t.y):this}static average(...t){const e=$(t.map((t=>t.x)))/t.length,s=$(t.map((t=>t.y)))/t.length;return new Mt(e,s)}static dot(t,e){return t.x*e.x+t.y*e.y}static sum(t,e){return new Mt(t.x+e.x,t.y+e.y)}static difference(t,e){return new Mt(t.x-e.x,t.y-e.y)}static distance(t,e){return Math.sqrt(tt(t.x-e.x)+tt(t.y-e.y))}static manhattan(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}static interpolate(t,e,s=.5){return new Mt(J(t.x,e.x,s),J(t.y,e.y,s))}static interpolateList(t,e=.5){const s=t.length-1,i=Math.floor(Q(e,0,1)*s);return Mt.interpolate(t[i],t[i+1],s*e-i)}static fromPolar(t,e=1){return new Mt(e*Math.cos(t),e*Math.sin(t))}static random(t){const e=mt.uniform(t.xMin,t.xMax),s=mt.uniform(t.yMin,t.yMax);return new Mt(e,s)}transform(t){const e=t[0][0]*this.x+t[0][1]*this.y+t[0][2],s=t[1][0]*this.x+t[1][1]*this.y+t[1][2];return new Mt(e,s)}rotate(t,e=kt){if(q(t,0))return this;const s=this.x-e.x,i=this.y-e.y,n=Math.cos(t),o=Math.sin(t),r=s*n-i*o+e.x,h=s*o+i*n+e.y;return new Mt(r,h)}reflect(t){const e=t.p2.x-t.p1.x,s=t.p2.y-t.p1.y,i=this.x-t.p1.x,n=(e*(this.y-t.p1.y)-s*i)/(e*e+s*s),o=this.x+2*n*s,r=this.y-2*n*e;return new Mt(o,r)}scale(t,e=t){return new Mt(this.x*t,this.y*e)}shift(t,e=t){return new Mt(this.x+t,this.y+e)}translate(t){return this.shift(t.x,t.y)}equals(t,e){return q(this.x,t.x,e)&&q(this.y,t.y,e)}}const kt=new Mt(0,0);class At{constructor(t,e,s){this.c=t,this.start=e,this.angle=s,this.type="arc"}get radius(){return Mt.distance(this.c,this.start)}get end(){return this.start.rotate(this.angle,this.c)}get startAngle(){return bt(this.start,this.c)}contract(t){return new this.constructor(this.c,this.at(t/2),this.angle*(1-t))}get minor(){return this.angle<=Math.PI?this:new this.constructor(this.c,this.end,yt-this.angle)}get major(){return this.angle>=Math.PI?this:new this.constructor(this.c,this.end,yt-this.angle)}get center(){return this.at(.5)}project(t){const e=this.startAngle,s=e+this.angle;let i=bt(t,this.c);return s>yt&&i<s-yt&&(i+=yt),i=Q(i,e,s),this.c.shift(this.radius,0).rotate(i,this.c)}at(t){return this.start.rotate(this.angle*t,this.c)}contains(t){return t.equals(this.project(t))}transform(t){return new this.constructor(this.c.transform(t),this.start.transform(t),this.angle)}rotate(t,e=kt){return q(t,0)?this:new this.constructor(this.c.rotate(t,e),this.start.rotate(t,e),this.angle)}reflect(t){return new this.constructor(this.c.reflect(t),this.start.reflect(t),this.angle)}scale(t,e=t){return new this.constructor(this.c.scale(t,e),this.start.scale(t,e),this.angle)}shift(t,e=t){return new this.constructor(this.c.shift(t,e),this.start.shift(t,e),this.angle)}translate(t){return this.shift(t.x,t.y)}equals(){return!1}}class Ct extends At{constructor(){super(...arguments),this.type="sector"}}class Pt{constructor(t,e){this.p1=t,this.p2=e,this.type="line"}make(t,e){return new Pt(t,e)}get length(){return Mt.distance(this.p1,this.p2)}get lengthSquared(){return(this.p1.x-this.p2.x)**2+(this.p1.y-this.p2.y)**2}get midpoint(){return Mt.average(this.p1,this.p2)}get slope(){return(this.p2.y-this.p1.y)/(this.p2.x-this.p1.x)}get intercept(){return this.p1.y+this.slope*this.p1.x}get angle(){return bt(this.p2,this.p1)}get unitVector(){return this.p2.subtract(this.p1).unitVector}get perpendicularVector(){return new Mt(this.p2.y-this.p1.y,this.p1.x-this.p2.x).unitVector}parallel(t){const e=Mt.sum(t,Mt.difference(this.p2,this.p1));return new Pt(t,e)}perpendicular(t){return new Pt(t,Mt.sum(t,this.perpendicularVector))}get perpendicularBisector(){return this.perpendicular(this.midpoint)}distanceSquared(t){const e=this.project(t);return(t.x-e.x)**2+(t.y-e.y)**2}offset(t){const e=Mt.difference(this.p2,this.p1),s=Mt.difference(t,this.p1);return Mt.dot(e,s)/this.lengthSquared}project(t){return this.at(this.offset(t))}side(t,e){const s=Mt.difference(this.p2,this.p1),i=Mt.difference(t,this.p1),n=i.x*s.y-i.y*s.x;return q(n,0,e)?0:Math.sign(n)}contains(t,e){return 0===this.side(t,e)}at(t){return Mt.interpolate(this.p1,this.p2,t)}transform(t){return new this.constructor(this.p1.transform(t),this.p2.transform(t))}rotate(t,e=kt){return q(t,0)?this:new this.constructor(this.p1.rotate(t,e),this.p2.rotate(t,e))}reflect(t){return new this.constructor(this.p1.reflect(t),this.p2.reflect(t))}scale(t,e=t){return this.make(this.p1.scale(t,e),this.p2.scale(t,e))}shift(t,e=t){return this.make(this.p1.shift(t,e),this.p2.shift(t,e))}translate(t){return this.shift(t.x,t.y)}equals(t,e){return this.contains(t.p1,e)&&this.contains(t.p2,e)}}class Tt extends Pt{constructor(){super(...arguments),this.type="ray"}make(t,e){return new Tt(t,e)}equals(t,e){return"ray"===t.type&&(this.p1.equals(t.p1,e)&&this.contains(t.p2,e))}}class St extends Pt{constructor(){super(...arguments),this.type="segment"}contains(t,e){return!!Pt.prototype.contains.call(this,t,e)&&(!(!this.p1.equals(t,e)&&!this.p2.equals(t,e))||(q(this.p1.x,this.p2.x,e)?V(t.y,this.p1.y,this.p2.y):V(t.x,this.p1.x,this.p2.x)))}make(t,e){return new St(t,e)}project(t){const e=Mt.difference(this.p2,this.p1),s=Mt.difference(t,this.p1),i=Q(Mt.dot(e,s)/this.lengthSquared,0,1);return Mt.sum(this.p1,e.scale(i))}contract(t){return new St(this.at(t),this.at(1-t))}equals(t,e,s=!1){return"segment"===t.type&&(this.p1.equals(t.p1,e)&&this.p2.equals(t.p2,e)||!s&&this.p1.equals(t.p2,e)&&this.p2.equals(t.p1,e))}}class Lt{constructor(t,e,s){this.a=t,this.b=e,this.c=s,this.type="angle"}static fromDegrees(t){return Lt.fromRadians(t*(Math.PI/180))}static fromRadians(t){const e=new Mt(1,0),s=e.rotate(t);return new Lt(e,kt,s)}get rad(){const t=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x);let e=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x)-t;return e<0&&(e+=yt),e}get deg(){return 180*this.rad/Math.PI}get isRight(){return q(this.rad,Math.PI/2,Math.PI/360)}get bisector(){if(this.b.equals(this.a))return;if(this.b.equals(this.c))return;const t=Math.atan2(this.a.y-this.b.y,this.a.x-this.b.x),e=Math.atan2(this.c.y-this.b.y,this.c.x-this.b.x);let s=(t+e)/2;t>e&&(s+=Math.PI);const i=Math.cos(s)+this.b.x,n=Math.sin(s)+this.b.y;return new Pt(this.b,new Mt(i,n))}get sup(){return this.rad<Math.PI?this:new Lt(this.c,this.b,this.a)}get arc(){return new At(this.b,this.a,this.rad)}project(){return this.c}at(){return this.c}contains(){return!1}transform(t){return new Lt(this.a.transform(t),this.b.transform(t),this.c.transform(t))}rotate(t,e){return q(t,0)?this:new Lt(this.a.rotate(t,e),this.b.rotate(t,e),this.c.rotate(t,e))}reflect(t){return new Lt(this.a.reflect(t),this.b.reflect(t),this.c.reflect(t))}scale(t,e=t){return new Lt(this.a.scale(t,e),this.b.scale(t,e),this.c.scale(t,e))}shift(t,e=t){return new Lt(this.a.shift(t,e),this.b.shift(t,e),this.c.shift(t,e))}translate(t){return new Lt(this.a.translate(t),this.b.translate(t),this.c.translate(t))}equals(t){return!1}}class _t{constructor(t=kt,e=1){this.c=t,this.r=e,this.type="circle"}get circumference(){return yt*this.r}get area(){return Math.PI*this.r**2}get arc(){const t=this.c.shift(this.r,0);return new At(this.c,t,yt)}tangentAt(t){const e=this.at(t),s=this.c.rotate(Math.PI/2,e);return new Pt(e,s)}collision(t){const e=this.c.x<t.p.x?t.p.x:this.c.x>t.p.x+t.w?t.p.x+t.w:this.c.x,s=this.c.y<t.p.y?t.p.y:this.c.y>t.p.y+t.h?t.p.y+t.h:this.c.y;return Mt.distance(this.c,new Mt(e,s))<=this.r}project(t){const e=t.subtract(this.c).unitVector.scale(this.r);return Mt.sum(this.c,e)}at(t){const e=yt*t;return this.c.shift(this.r*Math.cos(e),this.r*Math.sin(e))}contains(t){return Mt.distance(t,this.c)<=this.r}transform(t){const e=Math.abs(t[0][0])+Math.abs(t[1][1]);return new _t(this.c.transform(t),this.r*e/2)}rotate(t,e=kt){return q(t,0)?this:new _t(this.c.rotate(t,e),this.r)}reflect(t){return new _t(this.c.reflect(t),this.r)}scale(t,e=t){return new _t(this.c.scale(t,e),this.r*(t+e)/2)}shift(t,e=t){return new _t(this.c.shift(t,e),this.r)}translate(t){return this.shift(t.x,t.y)}equals(t,e){return q(this.r,t.r,e)&&this.c.equals(t.c,e)}}function zt(t){return["polygon","polyline","rectangle","triangle"].includes(t.type)}function Et(t){return["polygon","triangle"].includes(t.type)}function It(t){return"polyline"===t.type}function Ot(t){return"rectangle"===t.type}function qt(t){return["line","ray","segment"].includes(t.type)}function Vt(t){return"line"===t.type}function Bt(t){return"segment"===t.type}function Rt(t){return"circle"===t.type}function Dt(t){return"arc"===t.type}function jt(t){return"sector"===t.type}function Nt(t){return"angle"===t.type}function Ht(t){return"point"===t.type}function Zt(t,e){const s=t.p2.x-t.p1.x,i=t.p2.y-t.p1.y,n=tt(s)+tt(i),o=e.c.x,r=e.c.y,h=(t.p1.x-o)*(t.p2.y-r)-(t.p2.x-o)*(t.p1.y-r),a=tt(e.r)*n-tt(h);if(a<0)return[];const l=h*i/n,c=-h*s/n;if(q(a,0))return[e.c.shift(l,c)];const d=s*(i<0?-1:1)*Math.sqrt(a)/n,p=Math.abs(i)*Math.sqrt(a)/n;return[e.c.shift(l+d,c+p),e.c.shift(l-d,c-p)]}function Ft(t,e){let s=[];qt(t)&&qt(e)?s=function(t,e){const s=t.p1.x-t.p2.x,i=t.p1.y-t.p2.y,n=e.p1.x-e.p2.x,o=e.p1.y-e.p2.y,r=s*o-i*n;if(q(r,0))return[];const h=t.p1.x*t.p2.y-t.p1.y*t.p2.x,a=e.p1.x*e.p2.y-e.p1.y*e.p2.x;return[new Mt((h*n-s*a)/r,(h*o-i*a)/r)]}(t,e):qt(t)&&Rt(e)?s=Zt(t,e):Rt(t)&&qt(e)?s=Zt(e,t):Rt(t)&&Rt(e)&&(s=function(t,e){const s=Mt.distance(t.c,e.c);if(s>t.r+e.r)return[];if(s<Math.abs(t.r-e.r))return[];if(q(s,0)&&q(t.r,e.r))return[];if(q(s,t.r+e.r))return[new Pt(t.c,e.c).midpoint];const i=(tt(t.r)-tt(e.r)+tt(s))/(2*s),n=Math.sqrt(tt(t.r)-tt(i)),o=(e.c.x-t.c.x)*i/s+(e.c.y-t.c.y)*n/s+t.c.x,r=(e.c.y-t.c.y)*i/s-(e.c.x-t.c.x)*n/s+t.c.y,h=(e.c.x-t.c.x)*i/s-(e.c.y-t.c.y)*n/s+t.c.x,a=(e.c.y-t.c.y)*i/s+(e.c.x-t.c.x)*n/s+t.c.y;return[new Mt(o,r),new Mt(h,a)]}(t,e));for(const i of[t,e])"segment"===i.type&&(s=s.filter((t=>{return s=t,q((e=i).p1.x,e.p2.x)?V(s.y,e.p1.y,e.p2.y):V(s.x,e.p1.x,e.p2.x);var e,s}))),"ray"===i.type&&(s=s.filter((t=>{return s=t,q((e=i).p1.x,e.p2.x)?(s.y-e.p1.y)/(e.p2.y-e.p1.y)>0:(s.x-e.p1.x)/(e.p2.x-e.p1.x)>0;var e,s})));return s}function Ut(...t){if(t.length<2)return[];if(t.length>2)return b(st(t,2).map((t=>Ut(...t))));let[e,s]=t;if(zt(s)&&([e,s]=[s,e]),zt(e)){const t=qt(s)?e.points.filter((t=>s.contains(t))):[];for(const i of e.edges)t.push(...Ut(i,s));return t}return Ft(e,s)}class Wt{constructor(...t){this.type="polygon",this.points=t}get circumference(){if(this.points.length<=1)return 0;let t=Mt.distance(this.points[0],v(this.points));for(let e=1;e<this.points.length;++e)t+=Mt.distance(this.points[e-1],this.points[e]);return t}get signedArea(){const t=this.points,e=t.length;let s=t[e-1].x*t[0].y-t[0].x*t[e-1].y;for(let i=1;i<e;++i)s+=t[i-1].x*t[i].y-t[i].x*t[i-1].y;return s/2}get area(){return Math.abs(this.signedArea)}get centroid(){const t=this.points,e=t.length;let s=0;for(let i=0;i<e;++i)s+=t[i].x;let i=0;for(let s=0;s<e;++s)i+=t[s].y;return new Mt(s/e,i/e)}get edges(){const t=this.points,e=t.length,s=[];for(let i=0;i<e;++i)s.push(new St(t[i],t[(i+1)%e]));return s}get radius(){const t=this.centroid,e=this.points.map((e=>Mt.distance(e,t)));return Math.max(...e)}get oriented(){if(this.signedArea>=0)return this;const t=[...this.points].reverse();return new this.constructor(...t)}cut(t){let e=[];const s=[];for(const i of this.edges){const n=t.side(i.p1),o=t.side(i.p2);if(n&&o&&n!==o){const n=Ut(i,t)[0];e.push(new St(i.p1,n));const r=new St(n,i.p2);r.flag=o,e.push(r),s.push(r)}else 0===n&&o&&(s.push(i),i.flag=o),e.push(i)}if(s.length<2)return[this];s.sort(((e,s)=>t.offset(e.p1)-t.offset(s.p1)));const i=(t,s)=>{const i=e.length,n=[];s<t&&(s+=i);for(let o=t;o<=s;o++)n.push(e[o%i]);return n},n=t=>{const i=e.length,n=e[t].flag;let o=t;for(;;)if(o=(o+1)%i,e[o].flag===n&&(e[o].flag=void 0,s.splice(s.indexOf(e[o]),1)),o===t||e[o].flag)return o},o=[];let r=0;for(;s.length>=2;){let t=s[0],h=s[1],a=e.indexOf(t),l=e.indexOf(h),c=!1;if(n(a)===l?c=!0:([t,h]=[h,t],[a,l]=[l,a],n(a)===l&&(c=!0)),c?(r--,o.push(i(a,l)),e=i(l,a),t.flag=h.flag=void 0,s.splice(0,2),s.length<2&&o.push(e)):(r++,s.reverse()),r>1)break}return o.map((t=>new Wt(...t.map((t=>t.p1)))))}static collision(t,e){if(t.points.some((t=>e.contains(t))))return!0;if(e.points.some((e=>t.contains(e))))return!0;for(const s of t.edges)for(const t of e.edges)if(Ut(s,t)[0])return!0;return!1}static regular(t,e=1){const s=yt/t,i=Math.PI/2-s/2,n=g((t=>Mt.fromPolar(i+s*t,e)),t);return new Wt(...n)}static interpolate(t,e,s=.5){const i=t.points.map(((t,i)=>Mt.interpolate(t,e.points[i],s)));return new Wt(...i)}contains(t){let e=!1;for(const s of this.edges){if(s.p1.equals(t)||s.contains(t))return!1;if(s.p1.y>t.y==s.p2.y>t.y)continue;const i=(s.p2.x-s.p1.x)/(s.p2.y-s.p1.y);t.x<i*(t.y-s.p1.y)+s.p1.x&&(e=!e)}return e}at(t){return Mt.interpolateList([...this.points,this.points[0]],t)}project(t){let e,s=1/0;for(const i of this.edges){const n=i.project(t),o=Mt.distance(t,n);o<s&&(e=n,s=o)}return e||this.points[0]}transform(t){return new this.constructor(...this.points.map((e=>e.transform(t))))}rotate(t,e=kt){if(q(t,0))return this;const s=this.points.map((s=>s.rotate(t,e)));return new this.constructor(...s)}reflect(t){const e=this.points.map((e=>e.reflect(t)));return new this.constructor(...e)}scale(t,e=t){const s=this.points.map((s=>s.scale(t,e)));return new this.constructor(...s)}shift(t,e=t){const s=this.points.map((s=>s.shift(t,e)));return new this.constructor(...s)}translate(t){return this.shift(t.x,t.y)}equals(t){return!1}}class Kt extends Wt{constructor(){super(...arguments),this.type="polyline"}get length(){let t=0;for(let e=1;e<this.points.length;++e)t+=Mt.distance(this.points[e-1],this.points[e]);return t}get edges(){const t=[];for(let e=0;e<this.points.length-1;++e)t.push(new St(this.points[e],this.points[e+1]));return t}}class Gt extends Wt{constructor(){super(...arguments),this.type="triangle"}get circumcircle(){const[t,e,s]=this.points,i=2*(t.x*(e.y-s.y)+e.x*(s.y-t.y)+s.x*(t.y-e.y)),n=(t.x**2+t.y**2)*(e.y-s.y)+(e.x**2+e.y**2)*(s.y-t.y)+(s.x**2+s.y**2)*(t.y-e.y),o=(t.x**2+t.y**2)*(s.x-e.x)+(e.x**2+e.y**2)*(t.x-s.x)+(s.x**2+s.y**2)*(e.x-t.x),r=new Mt(n/i,o/i),h=Mt.distance(r,this.points[0]);return new _t(r,h)}get incircle(){const t=this.edges,e=t.map((t=>t.length)),s=e[0]+e[1]+e[2],[i,n,o]=this.points,r=e[1]*i.x+e[2]*n.x+e[0]*o.x,h=e[1]*i.y+e[2]*n.y+e[0]*o.y,a=new Mt(r/s,h/s),l=a.distanceFromLine(t[0]);return new _t(a,l)}get orthocenter(){const[t,e,s]=this.points;return Ut(new Pt(t,e).perpendicular(s),new Pt(t,s).perpendicular(e))[0]}}class Xt{constructor(t,e=1,s=e){this.p=t,this.w=e,this.h=s,this.type="rectangle"}static aroundPoints(t){let e=1/0,s=-1/0,i=1/0,n=-1/0;for(const o of t)e=e<o.x?e:o.x,s=s>o.x?s:o.x,i=i<o.y?i:o.y,n=n>o.y?n:o.y;return new Xt(new Mt(e,i),s-e,n-i)}get center(){return new Mt(this.p.x+this.w/2,this.p.y+this.h/2)}get centroid(){return this.center}get circumference(){return 2*Math.abs(this.w)+2*Math.abs(this.h)}get area(){return Math.abs(this.w*this.h)}get edges(){return this.polygon.edges}get points(){return this.polygon.points}get polygon(){const t=new Mt(this.p.x+this.w,this.p.y),e=new Mt(this.p.x+this.w,this.p.y+this.h),s=new Mt(this.p.x,this.p.y+this.h);return new Wt(this.p,t,e,s)}collision(t){return this.p.x<t.p.x+t.w&&this.p.x+this.w>t.p.x&&this.p.y<t.p.y+t.h&&this.p.y+this.h>t.p.y}contains(t,e){return V(t.x,this.p.x,this.p.x+this.w,e)&&V(t.y,this.p.y,this.p.y+this.h,e)}project(t){let e;for(const s of this.edges){const i=s.project(t);(!e||Mt.distance(t,i)<Mt.distance(t,e))&&(e=i)}return e}at(t){return this.p}transform(t){return this.polygon.transform(t)}rotate(t,e=kt){return q(t,0)?this:this.polygon.rotate(t,e)}reflect(t){return this.polygon.reflect(t)}scale(t,e=t){return new Xt(this.p.scale(t,e),this.w*t,this.h*e)}shift(t,e=t){return new Xt(this.p.shift(t,e),this.w,this.h)}translate(t){return this.shift(t.x,t.y)}equals(t){return!1}}class Yt{constructor(t,e,s,i){this.xMin=t,this.xMax=e,this.yMin=s,this.yMax=i}contains(t){return this.containsX(t)&&this.containsY(t)}containsX(t){return V(t.x,this.xMin,this.xMax)}containsY(t){return V(t.y,this.yMin,this.yMax)}resize(t,e){return new Yt(this.xMin,this.xMax+t,this.yMin,this.yMax+e)}get dx(){return this.xMax-this.xMin}get dy(){return this.yMax-this.yMin}get xRange(){return[this.xMin,this.xMax]}get yRange(){return[this.yMin,this.yMax]}get rect(){return new Xt(new Mt(this.xMin,this.yMin),this.dx,this.dy)}get center(){return new Mt(this.xMin+this.dx/2,this.yMin+this.dy/2)}get flip(){return new Yt(this.yMin,this.yMax,this.xMin,this.xMax)}}function Qt(t,e,s){const i=e.x*(s.y-t.y)+t.x*(e.y-s.y)+s.x*(t.y-e.y)>0?1:0,n=Mt.distance(e,t);return[t.x,t.y+"A"+n,n,0,i,1,s.x,s.y].join(",")}function Jt(t,e={}){return t.isRight&&!e.round?20:24+20*(1-Q(t.rad,0,Math.PI)/Math.PI)}function te(...t){return"M"+t.map((t=>t.x+","+t.y)).join("L")}function ee(t,e){const s=t.perpendicularVector.scale(6),i=t.unitVector.scale(3),n=t.midpoint;switch(e){case"bar":return te(n.add(s),n.add(s.inverse));case"bar2":return te(n.add(i).add(s),n.add(i).add(s.inverse))+te(n.add(i.inverse).add(s),n.add(i.inverse).add(s.inverse));case"arrow":return te(n.add(i.inverse).add(s),n.add(i),n.add(i.inverse).add(s.inverse));case"arrow2":return te(n.add(i.scale(-2)).add(s),n,n.add(i.scale(-2)).add(s.inverse))+te(n.add(s),n.add(i.scale(2)),n.add(s.inverse));default:return""}}function se(t,e){if(!t||!e)return"";const s=e.perpendicular,i=t.add(e.scale(9)).add(s.scale(9)),n=t.add(e.scale(9)).add(s.scale(-9));return te(i,t,n)}function ie(t,e={}){if(Nt(t))return function(t,e={}){let s=t.a;const i=t.b;let n=t.c;const o=e.size||Jt(t,e),r=Mt.difference(s,i).unitVector,h=Mt.difference(n,i).unitVector;s=Mt.sum(i,r.scale(o)),n=Mt.sum(i,h.scale(o));let a=e.fill?`M${i.x},${i.y}L`:"M";if(t.isRight&&!e.round){const t=Mt.sum(s,h.scale(o));a+=`${s.x},${s.y}L${t.x},${t.y}L${n.x},${n.y}`}else a+=Qt(s,i,n);return e.fill&&(a+="Z"),a}(t,e);if(Bt(t)){if(t.p1.equals(t.p2))return"";let s=te(t.p1,t.p2);return e.mark&&(s+=ee(t,e.mark)),e.arrows&&(s+=function(t,e){let s="";return i(e,"start","both")&&(s+=se(t.p1,t.unitVector)),i(e,"end","both")&&(s+=se(t.p2,t.unitVector.inverse)),s}(t,e.arrows)),s}if("ray"===t.type){if(!e.box)return"";const s=Ut(t,e.box)[0];return s?te(t.p1,s):""}if(Vt(t)){if(!e.box)return"";const s=Ut(t,e.box);if(s.length<2)return"";let i=te(s[0],s[1]);return e.mark&&(i+=ee(t,e.mark)),i}if(Rt(t))return`M ${t.c.x-t.r} ${t.c.y} a ${t.r},${t.r} 0 1 0 ${2*t.r} 0 a ${t.r} ${t.r} 0 1 0 ${-2*t.r} 0`;if(Dt(t)){let s="M"+Qt(t.start,t.c,t.end);return e.arrows&&(s+=function(t,e){let s="";if(i(e,"start","both")){const e=new Pt(t.c,t.start).perpendicularVector.inverse;s+=se(t.start,e)}if(i(e,"end","both")){const e=new Pt(t.c,t.end).perpendicularVector;s+=se(t.end,e)}return s}(t,e.arrows)),s}return jt(t)?`M ${t.c.x} ${t.c.y} L ${Qt(t.start,t.c,t.end)} Z`:It(t)?te(...t.points):Et(t)?te(...t.points)+"Z":Ot(t)?te(...t.polygon.points)+"Z":""}
function ne(t,e,s,i){return new(s||(s=Promise))((function(n,o){function r(t){try{a(i.next(t))}catch(t){o(t)}}function h(t){try{a(i.throw(t))}catch(t){o(t)}}function a(t){var e;t.done?n(t.value):(e=t.value,e instanceof s?e:new s((function(t){t(e)}))).then(r,h)}a((i=i.apply(t,e||[])).next())}))}function oe(t){const e=[];for(let s of Object.keys(t)){let i=t[s];s=encodeURIComponent(s),null!=i?(i=Array.isArray(i)?i.join(","):""+i,i=i.replace(/(\r)?\n/g,"\r\n"),i=encodeURIComponent(i),i=i.replace(/%20/g,"+"),e.push(s+"="+i)):e.push(s)}return e.join("&")}function re(t,e){return ne(this,void 0,void 0,(function*(){const s=e instanceof FormData,i={method:"POST",body:s?e:e?oe(e):void 0,headers:{"X-CSRF-Token":window.csrfToken||""}};s||(i.headers["Content-Type"]="application/x-www-form-urlencoded");const n=t.includes("?")?"&xhr=1":"?xhr=1",o=yield fetch(t+n,i);if(!o.ok)throw new Error(`Fetch error ${o.status}: ${t}`);return o.text()}))}function he(t,e=!1){return new Promise((s=>{const i=new Image;e||(i.crossOrigin="Anonymous"),i.onload=()=>s(i),i.src=t}))}const ae=new Map;function le(t,e){ae.has(t)?r(ae.get(t),e,((t,e)=>y(t.concat(e)))):ae.set(t,e)}function ce(){if(window.navigator.onLine)for(const[t,e]of ae)ae.delete(t),re(t,{data:JSON.stringify(e)}).catch((s=>{console.error("Failed to send POST request:",s),le(t,e)}))}const de=d(ce,5e3);var pe;window.addEventListener("online",de),window.onbeforeunload=ce,function(t){t[t.Array=0]="Array",t[t.BinaryOp=1]="BinaryOp",t[t.Call=2]="Call",t[t.Conditional=3]="Conditional",t[t.Identifier=4]="Identifier",t[t.Literal=5]="Literal",t[t.Member=6]="Member",t[t.UnaryOp=7]="UnaryOp"}(pe||(pe={}));const ue={"===":(t,e)=>t===e,"!==":(t,e)=>t!==e,"||":(t,e)=>t||e,"&&":(t,e)=>t&&e,"==":(t,e)=>t==e,"!=":(t,e)=>t!=e,"<=":(t,e)=>t<=e,">=":(t,e)=>t>=e,"**":(t,e)=>Math.pow(t,e),"<":(t,e)=>t<e,">":(t,e)=>t>e,"+":(t,e)=>t+e,"-":(t,e)=>t-e,"*":(t,e)=>t*e,"/":(t,e)=>t/e,"%":(t,e)=>t%e},fe={"-":t=>-t,"+":t=>+t,"!":t=>!t},ge={"||":1,"&&":2,"==":3,"!=":3,"===":3,"!==":3,"<":4,">":4,"<=":4,">=":4,"+":5,"-":5,"*":6,"/":6,"%":6,"**":7},me={true:!0,false:!1,undefined:void 0},ve=/\s/,$e=/[0-9]/,we=/[a-zA-Zα-ωΑ-Ω$_]/,xe=/[0-9a-zA-Zα-ωΑ-Ω$_]/;function ye(t){const e=t.length;let s=0;function i(e){throw new Error(`${e} at character ${s} of "${t}"`)}function n(){for(;ve.test(t[s]);)s+=1}function o(){let n=t[s];for(we.test(t[s])||i("Unexpected "+n),s+=1;s<e&&xe.test(t[s]);)n+=t[s++];return n in me?{type:pe.Literal,value:me[n]}:{type:pe.Identifier,name:n}}function r(n){const o=[];let r,h=!1;for(;s<e;){if(t[s]===n){r&&o.push(r),h=!0,s+=1;break}","===t[s]?(o.push(r||{type:pe.Literal,value:void 0}),s+=1):r=l()}return h||i("Expected "+n),o}function h(){n();for(const e of[3,2,1]){const i=t.substr(s,e);if(i in ue)return s+=e,i}}function a(){n();const h=t[s];return $e.test(h)||"."===h?function(){let e="";for(;$e.test(t[s]);)e+=t[s++];if("."===t[s])for(e+=t[s++];$e.test(t[s]);)e+=t[s++];const n=t[s];n&&we.test(n)?i(`Variable names cannot start with a number (${e+t[s]})`):"."===n&&i("Unexpected period");return{type:pe.Literal,value:parseFloat(e)}}():"'"===h||'"'===h?function(){const n=t[s];s+=1;let o=!1,r="";for(;s<e;){const e=t[s++];if(e===n){o=!0;break}r+=e}return o||i(`Unclosed quote after "${r}"`),{type:pe.Literal,value:r}}():"["===h?(s+=1,{type:pe.Array,elements:r("]")}):h in fe?(s+=1,{type:pe.UnaryOp,operator:h,argument:a()}):we.test(h)||"("===h?function(){let e;if("("===t[s]){if(s+=1,e=l(),n(),")"===t[s])return s+=1,e;i("Unclosed (")}else e=o();for(n();".[(".includes(t[s]);)"."===t[s]?(s++,n(),e={type:pe.Member,object:e,computed:!1,property:o()}):"["===t[s]?(s++,e={type:pe.Member,object:e,computed:!0,property:l()},n(),"]"!==t[s]&&i("Unclosed ["),s++):"("===t[s]&&(s++,e={type:pe.Call,args:r(")"),callee:e}),n();return e}():void i("Expression parsing error")}function l(){const e=function(){let t=a(),e=h();if(!e)return t;let s,n=a();n||i("Expected expression after "+e);const o=[t,e,n];for(;e=h();){const r=ge[e],h=e;for(;o.length>2&&r<=ge[o[o.length-2]];)n=o.pop(),e=o.pop(),t=o.pop(),s={type:pe.BinaryOp,operator:e,left:t,right:n},o.push(s);s=a(),s||i("Expected expression after "+h),o.push(h,s)}let r=o.length-1;for(s=o[r];r>1;)s={type:pe.BinaryOp,operator:o[r-1],left:o[r-2],right:s},r-=2;return s}();if(n(),!e||"?"!==t[s])return e;{s+=1;const o=l();if(o||i("Expected expression"),n(),":"===t[s]){s++;const t=l();return t||i("Expected expression"),{type:pe.Conditional,test:e,consequent:o,alternate:t}}i("Expected :")}}const c=l();return s<t.length&&i(`Unexpected "${t[s]}"`),c}const be=[void 0,void 0];function Me(t,e){switch(t.type){case pe.Array:const s=t.elements.map((t=>Me(t,e)[0]));return s.some((t=>void 0===t))?be:[s,void 0];case pe.BinaryOp:const i=Me(t.left,e)[0],n=Me(t.right,e)[0];return!"+-**/%".includes(t.operator)||void 0!==i&&void 0!==n?[ue[t.operator](i,n),void 0]:be;case pe.Call:const[o,r]=Me(t.callee,e),h=t.args.map((t=>Me(t,e)[0]));return h.some((t=>void 0===t))||"function"!=typeof o?be:[o.apply(r,h),void 0];case pe.Conditional:const a=Me(t.consequent,e),l=Me(t.alternate,e);return Me(t.test,e)[0]?a:l;case pe.Identifier:return[e[t.name],void 0];case pe.Literal:return[t.value,void 0];case pe.Member:const c=Me(t.object,e)[0],d=t.computed?Me(t.property,e)[0]:t.property.name;return c?[c[d],c]:[void 0,void 0];case pe.UnaryOp:const p=Me(t.argument,e)[0];return void 0===p&&"!"!==t.operator?be:[fe[t.operator](p),void 0]}}function ke(t){const e=ye(t);return e?(t={})=>Me(e,t)[0]:(t={})=>{}}const Ae=/\${([^}]+)}/g;function Ce(t){const e=t.split(Ae),s=e.map(((t,e)=>e%2?ke(t.replace(/×/g,"*")):void 0));return t=>e.map(((e,i)=>{if(!(i%2))return e;const n=s[i](t);return"number"==typeof n&&n<0?"–"+-n:n})).join("")}const Pe="ontouchstart"in window,Te="onpointerdown"in window;function Se(t){if(t.touches){const e=t.targetTouches.length?t.targetTouches:t.changedTouches;return new Mt(e[0].clientX,e[0].clientY)}return new Mt(t.clientX||0,t.clientY||0)}function Le(t,e){return Se(t).transform(e.inverseTransformMatrix)}function _e(t,e){const s=Se(t),i=e.bounds,n=(s.x-i.left)*e.canvasWidth/i.width,o=(s.y-i.top)*e.canvasHeight/i.height;return new Mt(n,o)}function ze(t,e){const s=e.$box||t;let i=Se;"svg"===s.type?i=t=>Le(t,s.$ownerSVG):"canvas"===s.type&&(i=t=>_e(t,s));const n=e.justInside?t:ls;let o,r,h=!1,a=0;function l(t){if(!o)return;if(a&&t.pointerId!==a)return;t.preventDefault();const s=i(t);Mt.distance(s,r)<.5||(!h&&e.start&&e.start(o),e.move&&e.move(s,o,r),r=s,h=!0)}function c(t,s=!1){o&&(a&&t.pointerId!==a||(t.preventDefault(),n.off("pointermove",l),n.off("pointerstop",c),e.up&&e.up(r,o),h&&e.end&&e.end(r,o),h||!e.click||s||e.click(o),o=void 0))}"auto"===t.css("touch-action")&&t.css("touch-action","none"),t.addClass("noselect"),$s.onKey("escape",(()=>{if(!o)return;h&&e.move&&e.move(o,o,r),r=o;const t=document.createEvent("MouseEvent");t.pointerId=a,c(t,!0)})),t.on("pointerdown",(function(t){t.handled||function(t){return t.touches||[]}(t).length>1||(t.preventDefault(),h=!1,a=t.pointerId||0,n.on("pointermove",l),n.on("pointerstop",c),o=r=i(t),e.down&&e.down(o))})),e.justInside&&t.on("mouseleave",c),e.accessible&&(t.setAttr("tabindex","0"),document.addEventListener("keydown",(s=>{if(![37,38,39,40].includes(s.keyCode))return;if(t!==$s.getActiveInput())return;const n=t.boxCenter,o=i({clientX:n.x,clientY:n.y}),r=37===s.keyCode?-25:39===s.keyCode?25:0,h=38===s.keyCode?-25:40===s.keyCode?25:0,a=o.shift(r,h);e.down&&e.down(o),e.start&&e.start(o),e.move&&e.move(a,o,o),e.end&&e.end(a,o)})))}function Ee(t,e){const s=e.$clickTarget||t;let i=0,n=!1,o=!1,r=!1;function a(){n||(e.enter&&e.enter(),n=!0)}function l(){n&&(clearTimeout(i),e.exit&&e.exit(),n=!1)}t.on("mouseover",(()=>{e.preventMouseover&&e.preventMouseover()||(clearTimeout(i),i=h((()=>{a(),o=!0}),e.delay))})),t.on("mouseout",(()=>{o&&(clearTimeout(i),i=h(l,e.exitDelay||e.delay))})),s.on("focus",(()=>{n||e.preventMouseover&&e.preventMouseover()||(clearTimeout(i),a(),r=!0)}));const c=()=>{r&&(e.canFocusWithin?setTimeout((()=>{const e=$s.getActiveInput();e&&e.hasParent(t)?e.one("blur",c):l()})):l())};s.on("blur",c),s.on("click",(()=>{n&&!o?l():n||(a(),o=!1)})),t.on("clickOutside",l)}let Ie;function Oe(t){for(const e of t){const t=e.isIntersecting?"enterViewport":"exitViewport";setTimeout((()=>rs(e.target).trigger(t)))}}function qe(t){if(!t._data.intersectionEvents)if(t._data.intersectionEvents=!0,window.IntersectionObserver)Ie||(Ie=new IntersectionObserver(Oe)),Ie.observe(t._el);else{let e=!1;ls.on("scroll",(()=>{const s=t.isInViewport;e&&!s?(t.trigger("exitViewport"),e=!1):s&&!e&&(t.trigger("enterViewport"),e=!0)}))}}function Ve(t){if(t._data.pointerPositionEvents)return;t._data.pointerPositionEvents=!0;const e=t.parent;let s;e.on("pointerend",(()=>s=void 0)),e.on("pointermove",(e=>{const i=s,n=function(t){if(t instanceof PointerEvent&&"mouse"===t.pointerType)return rs(t.target);const e=Se(t);return rs(document.elementFromPoint(e.x,e.y)||void 0)}(e);s=n.equals(t)||n.hasParent(t),null!=i&&s&&!i&&t.trigger("pointerenter",e),!s&&i&&t.trigger("pointerleave",e)}))}function Be(t,e){e._data["_"+t]||(e._data["_"+t]=!0,Te?e.on(t.replace("mouse","pointer"),(s=>{"mouse"===s.pointerType&&e.trigger(t,s)})):Pe||e._el.addEventListener(t,(s=>e.trigger(t,s))))}const Re={scrollwheel:"DOMMouseScroll mousewheel",pointerdown:Te?"pointerdown":Pe?"touchstart":"mousedown",pointermove:Te?"pointermove":Pe?"touchmove":"mousemove",pointerup:Te?"pointerup":Pe?"touchend":"mouseup",pointercancel:Te?"pointercancel":"touchcancel",pointerstop:Te?"pointerup pointercancel":Pe?"touchend touchcancel":"mouseup"},De={scroll:function(t){if(t._data.scrollEvents)return;t._data.scrollEvents=!0;let e,s=!1;function i(){const n=t.scrollTop;n!==e?(e=n,t.trigger("scroll",{top:e}),window.requestAnimationFrame(i)):s=!1}function n(){s||window.requestAnimationFrame(i),s=!0}function o(){window.removeEventListener("touchmove",n),window.removeEventListener("touchend",o)}("window"===t.type?window:t._el).addEventListener("scroll",n),t._el.addEventListener("touchstart",(function(t){t.handled||(window.addEventListener("touchmove",n),window.addEventListener("touchend",o))}))},tap:function(t){if(t._data.tapEvent)return;let e;t._data.tapEvent=!0,t.on("pointerdown",(t=>e=Se(t))),t.on("pointerup",(s=>{if(!e)return;const i=Se(s);Mt.distance(e,i)<6&&t.trigger("tap",s),e=void 0})),t.on("pointercancel",(()=>e=void 0))},clickOutside:function(t){t._data.clickOutsideEvent||(t._data.clickOutsideEvent=!0,ls.on("pointerdown",(e=>{const s=rs(e.target);s&&(s.equals(t)||s.hasParent(t))||t.trigger("clickOutside",e)})))},key:function(t){t.on("keydown",(e=>{if(e.metaKey||e.ctrlKey)return;if($s.isAndroid&&229===e.keyCode)return;const s=(e.key||String.fromCharCode(e.which)).toLowerCase();t.trigger("key",{code:e.keyCode,key:s})})),$s.isAndroid&&"input"===t.type&&t.on("input",(e=>{const s=e.data[e.data.length-1].toLowerCase();t.trigger("key",{code:void 0,key:s}),t.value=""}))},mousedown:Be.bind(void 0,"mousedown"),mousemove:Be.bind(void 0,"mousemove"),mouseup:Be.bind(void 0,"mouseup"),pointerenter:Ve,pointerleave:Ve,enterViewport:qe,exitViewport:qe,resize:function(t,e=!1){if(e&&(t._data.resizeObserver&&t._data.resizeObserver.disconnect(),t._data.resizeObserver=void 0),!t._data.resizeObserver)if(window.ResizeObserver){const e=new window.ResizeObserver((()=>t.trigger("resize")));e.observe(t._el),t._data.resizeObserver=e}else if(window.MutationObserver){const e=new MutationObserver((()=>t.trigger("resize")));e.observe(t._el,{attributes:!0,childList:!0,characterData:!0,subtree:!0}),t._data.resizeObserver=e}}};function je(t,e,s,i){if(e in De)De[e](t,!1);else if(e in Re){const n=A(Re[e]);for(const e of n)t._el.addEventListener(e,s,i)}else t._el.addEventListener(e,s,i)}function Ne(t,e,s){if(e in De)t._events[e]&&t._events[e].length||De[e](t,!0);else if(s&&e in Re){const i=A(Re[e]);for(const e of i)t._el.removeEventListener(e,s)}else s&&t._el.removeEventListener(e,s)}function He(t,e){const s=new Map,i=new Map;let n,o=0;function r(t){n=t;const e=t(f);return n=void 0,e}function h(t){for(const e of s.values())e.has(t)&&e.delete(t)}function a(e,s){i.has(e)&&h(i.get(e));const o=()=>{t[e]=s(f),n===o&&(n=void 0),l(e)};i.set(e,o),r(o)}function l(e){const i=s.get(e);if(i)for(const e of i)e(t)}function c(){for(const e of s.values())for(const s of e)s(t)}function d(e){Object.assign(t,e),c()}function p(){for(o+=1;"_x"+o in t;)o+=1;return"_x"+o}function u(){t={},s.clear(),i.clear(),o=0}const f=new Proxy(t,{get:(i,o)=>"watch"===o?r:"unwatch"===o?h:"setComputed"===o?a:"forceUpdate"===o?c:"assign"===o?d:"getKey"===o?p:"clear"===o?u:"_internal"===o?[t,s]:(n&&(s.has(o)||s.set(o,new Set),s.get(o).add(n)),o in t||function(t){e&&e.watch((()=>f[t]=e[t]))}(o),t[o]),set:(e,s,n)=>(t[s]===n||(t[s]=n,i.has(s)&&(h(i.get(s)),i.delete(s)),l(s)),!0),deleteProperty:(e,n)=>(delete t[n],s.delete(n),i.delete(n),!0)});return f}const Ze={A:7,C:6,H:1,L:2,M:2,Q:4,S:4,T:2,V:1,Z:0},Fe=/[astvzqmhlc]([^astvzqmhlc]*)/gi,Ue=/-?[0-9]*\.?[0-9]+(?:e[-+]?\d+)?/gi;function We(t){const e=[];let s;for(const i of t.match(Fe)||[]){const t=i[0].toUpperCase();if("Z"===t){e.push({type:"Z",points:[]});continue}const n=(i.slice(1).match(Ue)||[]).map((t=>+t)),o=t===i[0];for(const[i,r]of M(n,Ze[t]).entries()){let n,h=[],a="M"===t&&i>0?"L":t;"H"===t?(a="L",h=[new Mt(r[0],o&&(null==s?void 0:s.y)||0)]):"V"===t?(a="L",h=[new Mt(o&&(null==s?void 0:s.x)||0,r[0])]):"A"===t?(a="A",h=[new Mt(r[5],r[6])],n=r.slice(0,5)):"MLCSQT".includes(t)&&(h=M(r,2).map((t=>new Mt(t[0],t[1])))),!o&&s&&(h=h.map((t=>t.translate(s)))),s=v(h),e.push({type:a,points:h,options:n})}}return e}function Ke(t){if(!t)return[];return We(t).map((t=>v(t.points))).filter((t=>!!t))}class Ge{constructor(t){this._el=t,this._data={},this._events={},this.type="default",t._view=this}get id(){return this._el.id}get data(){return this._el.dataset}get tagName(){return this._el.tagName.toUpperCase()}equals(t){return this._el===t._el}addClass(t){for(const e of A(t))this._el.classList.add(e)}removeClass(t){for(const e of A(t))this._el.classList.remove(e)}hasClass(t){return this._el.classList.contains(t)}toggleClass(t){return this._el.classList.toggle(t)}setClass(t,e){e?this.addClass(t):this.removeClass(t)}attr(t){return this._el.getAttribute(t)||""}hasAttr(t){return this._el.hasAttribute(t)}setAttr(t,e){void 0===e?this.removeAttr(t):this._el.setAttribute(t,e.toString())}removeAttr(t){this._el.removeAttribute(t)}get attributes(){return Array.from(this._el.attributes||[])}get html(){return this._el.innerHTML||""}set html(t){this._el.innerHTML=t}get text(){return this._el.textContent||""}set text(t){this._el.textContent=t}set textStr(t){this._el.textContent=""+t}blur(){this._el.blur()}focus(){this._el.focus()}getParentModel(){const t=this.parent;return t?t.model||t.getParentModel():void 0}bindModel(t,e=!0){var s;if(!this.model){if(this.model=t,this.hasAttr(":for"))return this.makeDynamicList(t);for(const{name:e,value:s}of this.attributes)this.makeDynamicAttribute(e,s,t);for(const i of this.childNodes)if(i instanceof Text){if(null===(s=i.textContent)||void 0===s?void 0:s.includes("${")){const e=Ce(i.textContent);t.watch((()=>i.textContent=e(t)||""))}}else e&&i.bindModel(t)}}bindVariable(t,e){}makeDynamicAttribute(t,e,s){if(t.startsWith("@")){const i=t.slice(1),n=ke(e);this.on(i,(()=>n(s)))}else if(":show"===t){const t=ke(e);s.watch((()=>this.toggle(!!t(s))))}else if(":if"===t){const t=ke(e),i=rs(document.createComment(""));this.insertBefore(i);let n=!0;s.watch((()=>{const e=!!t(s);e!==n&&(e&&i.insertBefore(this),e||this.detach(),n=e)}))}else if(":html"===t){const t=ke(e);s.watch((()=>this.html=t(s)||""))}else if(":draw"===t){const t=ke(e);s.watch((()=>this.draw(t(s))))}else if(":class"===t){const t=ke(e),i=this.attr("class")+" ";s.watch((()=>this.setAttr("class",i+t(s))))}else if(":bind"===t)this.bindVariable(s,e);else if(t.startsWith(":")){const i=ke(e),n=t.slice(1);s.watch((()=>this.setAttr(n,i(s))))}else if(e.includes("${")){const i=Ce(e);s.watch((()=>this.setAttr(t,i(s)||"")))}(t.startsWith("@")||t.startsWith(":"))&&this.removeAttr(t)}makeDynamicList(t){const[e,s]=this.attr(":for").split(" in ");this.removeAttr(":for");const i=ke(s),n=rs(document.createComment(""));this.insertBefore(n),this.detach();const o=[];let r=0;t.watch((()=>{let s=i(t);Array.isArray(s)||(s=[]);for(let t=s.length;t<r;++t)o[t].detach();for(let t=r;t<o.length;++t)n.insertBefore(o[t]);for(let i=o.length;i<s.length;++i){const s=this.copy(!0);s.bindModel(He({[e]:void 0},t)),n.insertBefore(s),o.push(s)}r=s.length;for(let t=0;t<r;++t)o[t].model[e]=s[t]}))}get bounds(){return this._el.getBoundingClientRect()}get isInViewport(){if(0===this.height)return!1;const t=this.bounds;return V(t.top,-t.height,$s.height)}get topLeftPosition(){const t=this.bounds;return new Mt(t.left,t.top)}get boxCenter(){const t=this.bounds;return new Mt(t.left+t.width/2,t.top+t.height/2)}get scrollWidth(){return this._el.scrollWidth}get scrollHeight(){return this._el.scrollHeight}get scrollTop(){return this._el.scrollTop}set scrollTop(t){this._el.scrollTop=t,this.trigger("scroll",{top:t,left:this.scrollLeft})}get scrollLeft(){return this._el.scrollLeft}set scrollLeft(t){this._el.scrollLeft=t,this.trigger("scroll",{top:this.scrollTop,left:t})}scrollTo(t,e=1e3,s="cubic"){t<0&&(t=0);const i=this.scrollTop,n=t-i;this._data.scrollAnimation&&this._data.scrollAnimation.cancel(),this._data.scrollAnimation=ks((t=>{const e=i+n*Cs(s,t);this.scrollTop=e,this.trigger("scroll",{top:e})}),e)}scrollBy(t,e=1e3,s="cubic"){t&&this.scrollTo(this.scrollTop+t,e,s)}css(t,e){if(void 0===e){if("string"==typeof t)return window.getComputedStyle(this._el).getPropertyValue(t);{const e=Object.keys(t);for(const s of e)this._el.style.setProperty(s,""+t[s])}}else"string"==typeof t&&this._el.style.setProperty(t,""+e)}get transform(){return this.css("transform").replace("none","")}get transformMatrix(){const t=this.transform;if(!t)return[[1,0,0],[0,1,0]];const e=t.match(/matrix\(([0-9,.\s-]*)\)/);if(!e||!e[1])return[[1,0,0],[0,1,0]];const s=e[1].split(",");return[[+s[0],+s[2],+s[4]],[+s[1],+s[3],+s[5]]]}get scale(){const t=this.transformMatrix;return[t[0][0],t[1][1]]}setTransform(t,e=0,s=1){let i="";t&&(i+=`translate(${Y(t.x,.1)}px,${Y(t.y,.1)}px)`),e&&(i+=` rotate(${e}rad)`),s&&(i+=` scale(${s})`),this._el.style.transform=i}translate(t,e){this.setTransform(new Mt(t,e))}show(){this.hasAttr("hidden")&&this.removeAttr("hidden"),"visibility"===this.data.display?this._el.style.visibility="visible":this._el.style.display=this.data.display||"block"}hide(){"visibility"===this.data.display?this._el.style.visibility="hidden":this._el.style.display="none"}toggle(t){t?this.show():this.hide()}is(t){return this._el.matches?this._el.matches(t):Array.from(document.querySelectorAll(t)).includes(this._el)}index(){let t=0,e=this._el;for(;void 0!==(e=e.previousSibling||void 0);)++t;return t}prepend(t){const e=this._el.childNodes;e.length?this._el.insertBefore(t._el,e[0]):this._el.appendChild(t._el)}append(t){this._el.appendChild(t instanceof Text?t:t._el)}insertBefore(t){this.parent._el.insertBefore(t._el,this._el)}insertAfter(t){const e=this._el.nextSibling;e?this.parent._el.insertBefore(t._el,e):this.parent._el.appendChild(t._el)}get next(){return rs(this._el.nextSibling)}get prev(){return rs(this._el.previousSibling)}$(t){return rs(t,this)}$$(t){return hs(t,this)}get parent(){return rs(this._el.parentElement||void 0)}parents(t){const e=[];let s=this.parent;for(;s;)t&&!s.is(t)||e.push(s),s=s.parent;return e}hasParent(...t){const e=t.map((t=>t._el));let s=this._el.parentNode;for(;s;){if(i(s,...e))return!0;s=s.parentNode}return!1}get children(){return Array.from(this._el.children||[],(t=>rs(t)))}get childNodes(){return Array.from(this._el.childNodes,(t=>{if(!(t instanceof Comment))return t instanceof Text?t:rs(t)})).filter((t=>t))}detach(){this._el&&this._el.parentNode&&this._el.parentNode.removeChild(this._el)}remove(){this.detach()}removeChildren(){for(;this._el.firstChild;)this._el.removeChild(this._el.firstChild)}on(t,e,s){for(const i of A(t))i in this._events?this._events[i].includes(e)||this._events[i].push(e):this._events[i]=[e],je(this,i,e,s)}one(t,e,s){const i=s=>{this.off(t,i),e(s)};this.on(t,i,s)}off(t,e){for(const s of A(t))s in this._events&&(this._events[s]=e?this._events[s].filter((t=>t!==e)):[]),Ne(this,s,e)}trigger(t,e={}){for(const s of A(t)){if(!this._events[s])return;for(const t of this._events[s])t.call(this,e)}}onKeyDown(t,e){const s=A(t).map((t=>ds[t]||t));this._el.addEventListener("keydown",(t=>{s.indexOf(t.keyCode)>=0&&e(t)}))}onAttr(t,e){new MutationObserver((s=>{for(const i of s)"attributes"===i.type&&i.attributeName===t&&e(this.attr(t))})).observe(this._el,{attributes:!0}),e(this.attr(t),!0)}onPromise(t,e=!1){return e?Promise.resolve():new Promise((t=>this.one("solve",(()=>t()))))}animate(t,e=400,s=0,i="ease-in-out"){return Ps(this,t,e,s,i)}enter(t="fade",e=500,s=0){return Ss(this,t,e,s)}exit(t="fade",e=500,s=0,i=!1){return Ls(this,t,e,s,i)}effect(t){this.one("animationend",(()=>this.removeClass("effects-"+t))),this.addClass("effects-"+t)}copy(t=!0,e=!0,s){const i=rs(this._el.cloneNode(t));return e&&i.copyInlineStyles(this,t,s),i}copyInlineStyles(t,e=!0,s){const i=window.getComputedStyle(t._el);for(const t of s||Array.from(i))this.css(t,i.getPropertyValue(t));if(e){const e=this.children,i=t.children;for(let t=0;t<e.length;++t)e[t].copyInlineStyles(i[t],!0,s)}}}class Xe extends Ge{get offsetTop(){return this._el.offsetTop}get offsetLeft(){return this._el.offsetLeft}get offsetParent(){return rs(this._el.offsetParent||void 0)}get width(){return this._el.offsetWidth}get height(){return this._el.offsetHeight}get innerWidth(){const t=parseFloat(this.css("padding-left")),e=parseFloat(this.css("padding-right"));return this._el.clientWidth-t-e}get innerHeight(){const t=parseFloat(this.css("padding-bottom")),e=parseFloat(this.css("padding-top"));return this._el.clientHeight-t-e}get outerWidth(){const t=parseFloat(this.css("margin-left")),e=parseFloat(this.css("margin-right"));return this.width+t+e||0}get outerHeight(){const t=parseFloat(this.css("margin-bottom")),e=parseFloat(this.css("margin-top"));return this.height+t+e||0}get positionTop(){let t=this._el,e=0;for(;t;)e+=t.offsetTop,t=t.offsetParent;return e}get positionLeft(){let t=this._el,e=0;for(;t;)e+=t.offsetLeft,t=t.offsetParent;return e}offset(t){if(t._el===this._el.offsetParent){const e=this.offsetTop+t._el.clientTop,s=this.offsetLeft+t._el.clientLeft;return{top:e,left:s,bottom:e+this.height,right:s+this.width}}{const e=t._el.getBoundingClientRect(),s=this._el.getBoundingClientRect();return{top:s.top-e.top,left:s.left-e.left,bottom:s.bottom-e.top,right:s.right-e.left}}}}const Ye=["font-family","font-size","font-style","font-weight","letter-spacing","text-decoration","color","display","visibility","alignment-baseline","baseline-shift","text-anchor","clip","clip-path","clip-rule","mask","opacity","filter","fill","fill-rule","marker","marker-start","marker-mid","marker-end","stroke","stroke-dasharray","stroke-dashoffset","stroke-linecap","stroke-linejoin","stroke-width","text-rendering","transform"];class Qe extends Ge{constructor(){super(...arguments),this.type="svg"}get $ownerSVG(){return rs(this._el.ownerSVGElement||void 0)}get width(){return this.bounds.width}get height(){return this.bounds.height}get positionLeft(){const t=this._el.getBBox().x+this._el.getCTM().e;return this.$ownerSVG.positionLeft+t}get positionTop(){const t=this._el.getBBox().y+this._el.getCTM().f;return this.$ownerSVG.positionTop+t}get inverseTransformMatrix(){const t=this._el.getScreenCTM().inverse(),e=[[t.a,t.c,t.e],[t.b,t.d,t.f]];if($s.isFirefox){const t=this.transformMatrix;e[0][2]-=t[0][2],e[1][2]-=t[1][2]}return e}setTransform(t,e=0,s=1){const i=t?`translate(${Y(t.x,.1)} ${Y(t.y,.1)})`:"",n=q(e,0)?"":`rotate(${180*e/Math.PI})`,o=q(s,1)?"":`scale(${s})`;this.setAttr("transform",[i,n,o].join(" "))}get strokeLength(){if(this._el instanceof SVGGeometryElement)return this._el.getTotalLength();{const t=this.bounds;return 2*t.height+2*t.width}}getPointAtLength(t){if(this._el instanceof SVGGeometryElement){const e=this._el.getPointAtLength(t);return new Mt(e.x,e.y)}return new Mt(0,0)}getPointAt(t){return this.getPointAtLength(t*this.strokeLength)}get points(){return Ke(this.attr("d"))}set points(t){const e=t.length?"M"+t.map((t=>t.x+","+t.y)).join("L"):"";this.setAttr("d",e)}addPoint(t){const e=this.attr("d")+" L "+t.x+","+t.y;this.setAttr("d",e)}get center(){const t=+this.attr("TEXT"===this.tagName?"x":"cx"),e=+this.attr("TEXT"===this.tagName?"y":"cy");return new Mt(t,e)}setCenter(t){this.setAttr("TEXT"===this.tagName?"x":"cx",t.x),this.setAttr("TEXT"===this.tagName?"y":"cy",t.y)}setLine(t,e){this.setAttr("x1",t.x),this.setAttr("y1",t.y),this.setAttr("x2",e.x),this.setAttr("y2",e.y)}setRect(t){this.setAttr("x",t.p.x),this.setAttr("y",t.p.y),this.setAttr("width",t.w),this.setAttr("height",t.h)}draw(t,e={}){if(!t)return this.setAttr("d","");const s={mark:this.attr("mark"),arrows:this.attr("arrows"),size:+this.attr("size")||void 0,fill:this.hasClass("fill"),round:this.hasAttr("round")};this.setAttr("d",ie(t,n(e,s)))}}class Je extends Qe{get viewBox(){return this._el.viewBox.baseVal||{width:0,height:0}}get $ownerSVG(){return this}get positionLeft(){return parseInt(this.css("margin-left"))+this.parent.positionLeft}get positionTop(){return parseInt(this.css("margin-top"))+this.parent.positionTop}get svgWidth(){return this.viewBox.width||this.width}get svgHeight(){return this.viewBox.height||this.height}pngImage(t,e,s){return ne(this,void 0,void 0,(function*(){const i=this.copy(!0,!0,Ye);e||(e=t||this.svgHeight),t||(t=this.svgWidth),i.setAttr("width",t),i.setAttr("height",e),i.setAttr("viewBox",s||this.attr("viewBox")||`0 0 ${this.svgWidth} ${this.svgHeight}`),i.setAttr("xmlns","http://www.w3.org/2000/svg");const n=i.$$('image[href^="http"]');yield Promise.all(n.map((t=>ne(this,void 0,void 0,(function*(){const e=yield he(t.attr("href")),s=as("canvas",{width:e.width,height:e.height});s.ctx.drawImage(e,0,0,e.width,e.height);const i=yield s.pngImage;t.setAttr("href",i)})))));const o=(new XMLSerializer).serializeToString(i._el),r="data:image/svg+xml;utf8,"+encodeURIComponent(o),h=as("canvas",{width:t,height:e});h.ctx.fillStyle=cs.css("background-color")||"white",h.ctx.fillRect(0,0,t,e);const a=yield he(r);return h.ctx.drawImage(a,0,0,t,e),h.pngImage}))}downloadImage(t,e,s,i){const n=$s.isIOS?window.open("","_blank"):void 0;this.pngImage(e,s,i).then((e=>{if(n)return n.location.href=e;as("a",{download:t,href:e,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))}))}}class ts extends Xe{constructor(){super(...arguments),this.type="window"}get width(){return window.innerWidth}get height(){return window.innerHeight}get innerWidth(){return window.innerWidth}get innerHeight(){return window.innerHeight}get outerWidth(){return window.outerWidth}get outerHeight(){return window.outerHeight}get scrollWidth(){return document.body.scrollWidth}get scrollHeight(){return document.body.scrollHeight}get scrollTop(){return window.pageYOffset}set scrollTop(t){document.body.scrollTop=document.documentElement.scrollTop=t,this.trigger("scroll",{top:t,left:this.scrollLeft})}get scrollLeft(){return window.pageXOffset}set scrollLeft(t){document.body.scrollLeft=document.documentElement.scrollLeft=t,this.trigger("scroll",{top:this.scrollTop,left:t})}}class es extends Xe{constructor(){super(...arguments),this.type="form"}get action(){return this._el.action}get formData(){const t={};for(const e of Array.from(this._el.elements)){const s=e.name||e.id;s&&(t[s]=e.value)}return t}get isValid(){return this._el.checkValidity()}}class ss extends Xe{constructor(){super(...arguments),this.type="input"}get checked(){return this._el.checked||!1}set checked(t){this._el.checked=t}get value(){return this._el.value}set value(t){this._el.value=t}bindVariable(t,e){const s="number"===this._el.type,i="checkbox"===this._el.type;if(e in t?i?this.checked=t[e]:this.value=t[e]:this.value&&(t[e]=i?this.checked:this.value),s){const s=this.hasAttr("min")?+this.attr("min"):-1/0,i=this.hasAttr("max")?+this.attr("max"):1/0;this.change((n=>t[e]=Q(+n,s,i))),this.on("blur",(()=>this.value=t[e]))}else i?this.on("change",(()=>t[e]=this.checked)):this.change((s=>t[e]=s));t.watch((()=>{i?this.checked=t[e]:this.value=t[e]}))}setInputPattern(t){if(isNaN(+t))return;const e=t.match(/^[0-9]+$/);this.setAttr("inputmode",e?"numeric":"decimal"),e&&this.setAttr("pattern","[0-9]*")}change(t){let e=this.value||"";this.on("change keyup input paste",(()=>{this.value!==e&&(e=this.value.trim(),t(e))}))}validate(t){this.change((e=>this.setValidity(t(e))))}setValidity(t){this._el.setCustomValidity(t)}get isValid(){return this._el.checkValidity()}}class is extends Xe{constructor(){super(...arguments),this.type="canvas"}getContext(t="2d",e={}){return this._el.getContext(t,e)}get pngImage(){return this._el.toDataURL("image/png")}get canvasWidth(){return this._el.width}get canvasHeight(){return this._el.height}get ctx(){return this._ctx||(this._ctx=this.getContext()),this._ctx}draw(t,e={}){this.ctx.save(),function(t,e,s={}){if(s.fill&&(t.fillStyle=s.fill),s.opacity&&(t.globalAlpha=s.opacity),s.stroke&&(t.strokeStyle=s.stroke,t.lineWidth=s.strokeWidth||1,s.lineCap&&(t.lineCap=s.lineCap),s.lineJoin&&(t.lineJoin=s.lineJoin)),t.beginPath(),Bt(e))t.moveTo(e.p1.x,e.p1.y),t.lineTo(e.p2.x,e.p2.y);else if(Rt(e))t.arc(e.c.x,e.c.y,e.r,0,yt);else if(Et(e)){t.moveTo(e.points[0].x,e.points[0].y);for(const s of e.points.slice(1))t.lineTo(s.x,s.y);t.closePath()}else if(It(e)){t.moveTo(e.points[0].x,e.points[0].y);for(const s of e.points.slice(1))t.lineTo(s.x,s.y)}s.fill&&t.fill(),s.stroke&&t.stroke()}(this.ctx,t,e),this.ctx.restore()}clear(){this.ctx.clearRect(0,0,this.canvasWidth,this.canvasHeight)}fill(t){this.ctx.save(),this.ctx.fillStyle=t,this.ctx.fillRect(0,0,this.canvasWidth,this.canvasHeight),this.ctx.restore()}clearCircle(t,e){this.ctx.save(),this.ctx.globalCompositeOperation="destination-out",this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,0,2*Math.PI,!1),this.ctx.fill(),this.ctx.restore()}downloadImage(t){as("a",{download:t,href:this.pngImage,target:"_blank"})._el.dispatchEvent(new MouseEvent("click",{view:window,bubbles:!1,cancelable:!0}))}}class ns extends Xe{play(){return this._el.play()||Promise.resolve()}pause(){return this._el.pause()}}const os=["path","rect","circle","ellipse","polygon","polyline","g","defs","marker","line","text","tspan","pattern","mask","svg","foreignObject","image"];function rs(t,e){if(!t)return;const s=e?e._el:document.documentElement,i="string"==typeof t?s.querySelector(t):t;if(!i)return;if(i._view)return i._view;const n=(i.tagName||"").toLowerCase();return"svg"===n?new Je(i):"canvas"===n?new is(i):"form"===n?new es(i):"input"===n||"select"===n||"textarea"===n?new ss(i):"video"===n||"audio"===n?new ns(i):os.includes(n)?new Qe(i):new Xe(i)}function hs(t,e){const s=e?e._el:document.documentElement,i=t?s.querySelectorAll(t):[];return Array.from(i,(t=>rs(t)))}function as(t,e={},s){const i=os.includes(t)?document.createElementNS("http://www.w3.org/2000/svg",t):document.createElement(t);for(const[t,s]of Object.entries(e))void 0!==s&&("id"===t?i.id=s:"html"===t?i.innerHTML=s:"text"===t?i.textContent=s:"path"===t?i.setAttribute("d",ie(s)):i.setAttribute(t,s));const n=rs(i);return s&&s.append(n),n}const ls=new ts(document.body),cs=new ts(document.documentElement),ds={backspace:8,tab:9,enter:13,shift:16,ctrl:17,alt:18,pause:19,capslock:20,escape:27,space:32,pageup:33,pagedown:34,end:35,home:36,left:37,up:38,right:39,down:40,insert:45,delete:46},ps="_M",us=window.navigator.userAgent.toLowerCase(),fs={};for(const[t,e]of Object.entries(ds))fs[e]=t;const gs=/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i,ms=/iphone|ipad|ipod/i,vs=/^((?!chrome|android).)*safari/i;const $s=window.BoostBrowser||new class{constructor(){var t,e;this.isMobile=gs.test(us),this.isRetina=(window.devicePixelRatio||1)>1,this.isTouch=!!window.Touch||"ontouchstart"in window,this.isChrome=!!window.chrome,this.isFirefox=us.indexOf("firefox")>=0,this.isAndroid=us.indexOf("android")>=0,this.isIOS=ms.test(us),this.isSafari=ms.test(us)||vs.test(us),this.loadQueue=[],this.loaded=!1,this.width=window.innerWidth,this.height=window.innerHeight,this.resizeCallbacks=[],this.theme={name:"light",isDark:!1},this.themeChangedCallbacks=[],this.themeOverride="",this.darkQuery=null===(t=window.matchMedia)||void 0===t?void 0:t.call(window,"(prefers-color-scheme: dark)"),window.onload=()=>this.afterLoad(),document.addEventListener("DOMContentLoaded",(()=>this.afterLoad()));const s=d((()=>this.applyResize()));window.addEventListener("resize",s),null===(e=this.darkQuery)||void 0===e||e.addEventListener("change",(()=>this.applyThemeChange()));const i=this.getCookie("theme");i&&this.setTheme(i);try{this.localStorage=window.localStorage}catch(t){console.warn("Unable to access Local Storage in this context.")}}afterLoad(){if(!this.loaded){this.loaded=!0;for(const t of this.loadQueue)t();setTimeout((()=>this.resize()))}}ready(t){this.loaded?t():this.loadQueue.push(t)}redraw(){document.body.offsetHeight}applyResize(){const t=window.innerWidth,e=window.innerHeight;if(this.width!==t||this.height!==e){this.width=t,this.height=e;for(const t of this.resizeCallbacks)t({width:this.width,height:this.height});ls.trigger("scroll",{top:ls.scrollTop})}}onResize(t){t({width:this.width,height:this.height}),this.resizeCallbacks.push(t)}offResize(t){const e=this.resizeCallbacks.indexOf(t);e>=0&&this.resizeCallbacks.splice(e,1)}resize(){this.applyResize()}applyThemeChange(){const t=this.theme.name,e="dark"===t||"auto"===t&&this.darkQuery.matches;if(e!==this.theme.isDark){this.theme.isDark=e,cs.setAttr("theme",this.themeOverride||(e?"dark":"light"));for(const t of this.themeChangedCallbacks)t(this.theme)}}setTheme(t){t!==this.theme.name&&(this.theme.name=t,this.setCookie("theme",t),this.applyThemeChange())}onThemeChange(t){this.themeChangedCallbacks.push(t)}getHash(){return window.location.hash.slice(1)}setHash(t){const e=document.body.scrollTop;window.location.hash=t,document.body.scrollTop=e}setURL(t,e=""){window.history.replaceState({},e,t),e&&(window.document.title=e)}getCookies(){const t=document.cookie.split(";"),e={};for(let s=0,i=t.length;s<i;++s){const i=t[s].split("=");i[0]=i[0].replace(/^\s+|\s+$/,""),e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}getCookie(t){const e=document.cookie.match(new RegExp(`(^|;) ?${t}=([^;]*)(;|$)`));return e?e[2]:void 0}setCookie(t,e,s=31536e3){const i=window.location.hostname.replace(/^[a-z]{2}\./,"");document.cookie=`${t}=${e};path=/;max-age=${s};domain=${i}`}deleteCookie(t){this.setCookie(t,"",-1)}setStorage(t,e){var s,i;const n=(t||"").split("."),o=p((null===(s=this.localStorage)||void 0===s?void 0:s.getItem(ps))||void 0);let r=o;for(let t=0;t<n.length-1;++t)null==r[n[t]]&&(r[n[t]]={}),r=r[n[t]];r[n[n.length-1]]=e,null===(i=this.localStorage)||void 0===i||i.setItem(ps,JSON.stringify(o))}getStorage(t){var e;let s=p((null===(e=this.localStorage)||void 0===e?void 0:e.getItem(ps))||void 0);if(!t)return s;const i=(t||"").split("."),n=i.pop();for(const t of i){if(!(t in s))return;s=s[t]}return s[n]}deleteStorage(t){var e;t?this.setStorage(t,void 0):null===(e=this.localStorage)||void 0===e||e.setItem(ps,"")}getActiveInput(){const t=document.activeElement;return t===document.body?void 0:rs(t)}onKey(t,e,s=!1){const i=A(t),n=s?"keyup":"keydown";document.addEventListener(n,(t=>{const s=fs[t.keyCode]||t.key;if(!i.includes(s))return;const n=this.getActiveInput();n&&n.is("input, textarea, [contenteditable]")||n&&["space","enter","tab"].includes(s)&&n.is("button, a, [tabindex]")||e(t,s)}))}};window.BoostBrowser=$s;const ws=/\bTrident\/[567]\b|\bMSIE (?:9|10)\.0\b/.test(navigator.userAgent)||+(navigator.userAgent.match(/\bEdge\/12\.(\d+)\b/)||[])[1]<10547||+(navigator.userAgent.match(/\bAppleWebKit\/(\d+)\b/)||[])[1]<537,xs={};function ys(){if(!ws)return;Array.from(document.querySelectorAll("svg > use")).forEach((function(t){const e=t.getAttribute("xlink:href"),[s,i]=e.split("#");if(!s.length||!i)return;const n=t.parentNode;n.removeChild(t),s in xs||(xs[s]=fetch(s).then((t=>t.text())));xs[s].then((t=>{const e=document.implementation.createHTMLDocument("");e.documentElement.innerHTML=t;const s=e.getElementById(i).cloneNode(!0),o=document.createDocumentFragment();for(;s.childNodes.length;)o.appendChild(s.firstChild);n.appendChild(o)}))}))}let bs=!1;setTimeout((()=>bs=!0));const Ms={cancel:()=>{},promise:Promise.resolve()};function ks(t,e){if(0===e)return t(1,0,(()=>{})),Ms;const s=Date.now(),i=l();let n=0,o=!0;const r=()=>{o=!1,i.reject()};return function h(){o&&(!e||n<=e)&&window.requestAnimationFrame(h);const a=Date.now()-s;t(e?Math.min(1,a/e):a,a-n,r),e&&a>=e&&i.resolve(),n=a}(),{cancel:r,promise:i.promise}}function As(t,e=0,s=0){switch(t){case"quad":return Math.pow(e,2);case"cubic":return Math.pow(e,3);case"quart":return Math.pow(e,4);case"quint":return Math.pow(e,5);case"circ":return 1-Math.sqrt(1-Math.pow(e,2));case"sine":return 1-Math.cos(e*Math.PI/2);case"exp":return e<=0?0:Math.pow(2,10*(e-1));case"back":return s||(s=1.70158),e*e*((s+1)*e-s);case"elastic":return s||(s=.3),-Math.pow(2,10*(e-1))*Math.sin((2*(e-1)/s-.5)*Math.PI);case"swing":return.5-Math.cos(e*Math.PI)/2;case"spring":return 1-Math.cos(4.5*e*Math.PI)*Math.exp(6*-e);case"bounce":return e<1/11?1/64-7.5625*(.5/11-e)*(.5/11-e):e<3/11?1/16-7.5625*(2/11-e)*(2/11-e):e<7/11?1/4-7.5625*(5/11-e)*(5/11-e):1-7.5625*(1-e)*(1-e);default:return e}}function Cs(t,e=0,s=0){if(0===e)return 0;if(1===e)return 1;const[i,n]=t.split("-");return"in"===n?As(i,e,s):"out"===n?1-As(i,1-e,s):e<=.5?As(i,2*e,s)/2:1-As(i,2*(1-e),s)/2}function Ps(t,e,s=400,i=0,n="ease-in-out"){if(!bs)return Object.keys(e).forEach((s=>{const i=e[s];t.css(s,Array.isArray(i)?i[1]:i)})),Ms;"bounce-in"===n&&(n="cubic-bezier(0.175, 0.885, 0.32, 1.275)"),"bounce-out"===n&&(n="cubic-bezier(0.68, -0.275, 0.825, 0.115)");let o="";$s.isSafari&&(o=t._el.style.transition,t.css("transition","none"),$s.redraw());const r=t._data.animation;r&&r.cancel();const a={},c={},d=l(),p=window.getComputedStyle(t._el);Object.keys(e).forEach((s=>{const n=e[s],o=C(s);c[o]=Array.isArray(n)?n[0]:p.getPropertyValue(s),a[o]=Array.isArray(n)?n[1]:n,i&&t.css(s,c[o])}));const u=a.height;let f;"auto"===a.height&&(a.height=$(t.children.map((t=>t.outerHeight)))+"px");let g=!1;h((()=>{g||(f=t._el.animate([c,a],{duration:s,easing:n,fill:"forwards"}),f.onfinish=()=>{t._el&&Object.keys(e).forEach((e=>t.css(e,"height"===e?u:a[e]))),$s.isSafari&&t.css("transition",o),d.resolve(),f.cancel()})}),i);const m={cancel(){g=!0,t._el&&Object.keys(e).forEach((e=>t.css(e,t.css(e)))),f&&f.cancel()},promise:d.promise};return setTimeout((()=>t._data.animation=m)),m}const Ts=/matrix\([0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,[0-9.\-\s]+,([0-9.\-\s]+),([0-9.\-\s]+)\)/;function Ss(t,e="fade",s=500,i=0){if(t.show(),!bs)return Ms;const n=+t.css("opacity")||1;if("fade"===e)return Ps(t,{opacity:[0,n]},s,i);if("pop"===e){const e=t.transform.replace(/scale\([0-9.]*\)/,"").replace(Ts,"translate($1px,$2px)");return Ps(t,{opacity:[0,n]},s,i),Ps(t,{transform:[e+" scale(0.5)",e+" scale(1)"]},s,i,"bounce-in")}if("descend"===e){return Ps(t,{opacity:[0,1],transform:["translateY(-50%)","none"]},s,i)}if(e.startsWith("draw")){const n=t.strokeLength;t.css("stroke-dasharray",n+"px"),t.css("opacity")||t.css("opacity",1);const o=Ps(t,{"stroke-dashoffset":[n+"px","draw-reverse"===e?2*n+"px":0]},s,i,"linear");return o.promise.then((()=>t.css("stroke-dasharray",""))),o}if(e.startsWith("slide")){const o={opacity:[0,n],transform:["translateY(50px)","none"]};return e.includes("down")&&(o.transform[0]="translateY(-50px)"),e.includes("right")&&(o.transform[0]="translateX(-50px)"),e.includes("left")&&(o.transform[0]="translateX(50px)"),Ps(t,o,s,i)}if(e.startsWith("reveal")){const o={opacity:[0,n],height:[0,"auto"]};return e.includes("left")&&(o.transform=["translateX(-50%)","none"]),e.includes("right")&&(o.transform=["translateX(50%)","none"]),Ps(t,o,s,i)}return Ms}function Ls(t,e="fade",s=400,i=0,n=!1){if(!t._el)return Ms;if(!bs)return t.hide(),Ms;if("none"===t.css("display"))return Ms;let o;if("fade"===e)o=Ps(t,{opacity:[1,0]},s,i);else if("pop"===e){const e=t.transform.replace(/scale\([0-9.]*\)/,"");Ps(t,{opacity:[1,0]},s,i),o=Ps(t,{transform:[e+" scale(1)",e+" scale(0.5)"]},s,i,"bounce-out")}else if("ascend"===e){o=Ps(t,{opacity:[1,0],transform:["none","translateY(-50%)"]},s,i)}else if(e.startsWith("draw")){const n=t.strokeLength;t.css("stroke-dasharray",n);o=Ps(t,{"stroke-dashoffset":["draw-reverse"===e?2*n+"px":0,n+"px"]},s,i,"linear")}else if(e.startsWith("slide")){const n={opacity:0,transform:"translateY(50px)"};e.includes("up")&&(n.transform="translateY(-50px)"),o=Ps(t,n,s,i)}else if(e.startsWith("reveal")){const n={opacity:0,height:0};e.includes("left")&&(n.transform="translateX(-50%)"),e.includes("right")&&(n.transform="translateX(50%)"),o=Ps(t,n,s,i)}return o.promise.then((()=>n?t.remove():t.hide())),o}class _s extends T{constructor(t,e,s={}){let i;super(),this.$el=t,this.position=new Mt(0,0),this.disabled=!1,this.width=0,this.height=0,this.options=n(s,{moveX:!0,moveY:!0}),this.setDimensions(e),ze(t,{start:()=>{this.disabled||(i=this.position,this.trigger("start"),cs.addClass("grabbing"))},move:(t,e)=>{this.disabled||(this.setPosition(i.x+t.x-e.x,i.y+t.y-e.y),this.trigger("drag",this.position))},end:(t,e)=>{this.disabled||(this.trigger(t.equals(e)?"click":"end"),cs.removeClass("grabbing"))},accessible:!0}),$s.onResize((()=>{const t=this.width,s=this.height;this.setDimensions(e),this.setPosition(this.position.x*this.width/t||0,this.position.y*this.height/s||0)}))}setDimensions(t){"svg"===t.type?(this.width=this.options.width||t.svgWidth,this.height=this.options.height||t.svgHeight):(this.width=this.options.width||t.width,this.height=this.options.height||t.height)}setPosition(t,e){const s=this.options.margin||0;let i=new Mt(this.options.moveX?t:0,this.options.moveY?e:0).clamp(new Yt(0,this.width,0,this.height),s).round(this.options.snap||1);this.options.round&&(i=this.options.round(i)),i.equals(this.position)||(this.position=i,this.options.useTransform?this.$el.translate(i.x,i.y):(this.options.moveX&&this.$el.css("left",i.x+"px"),this.options.moveY&&this.$el.css("top",i.y+"px")),this.trigger("move",i))}}function zs(t,e){const s=e.regex.exec(t);if(s){s.shift();const t={};for(const[i,n]of e.params.entries())t[n]=s[i];return t}}let Es="complete"===document.readyState;window.addEventListener("load",(()=>setTimeout((()=>Es=!0)))),"scrollRestoration"in window.history&&(window.history.scrollRestoration="manual");const Is=new class extends T{constructor(){super(...arguments),this.$viewport=ls,this.views=[],this.active={path:"",hash:""},this.preloaded=!1,this.transition=!1,this.noLoad=!1,this.initialise=()=>{}}setup(t={}){t.$viewport&&(this.$viewport=t.$viewport),t.initialise&&(this.initialise=t.initialise),t.preloaded&&(this.preloaded=t.preloaded),t.transition&&(this.transition=t.transition),t.noLoad&&(this.noLoad=t.noLoad),t.click&&ls.on("click",(t=>this.onLinkClick(t))),t.history&&window.addEventListener("popstate",(t=>ne(this,void 0,void 0,(function*(){var e;if(!Es||!(null===(e=t.state)||void 0===e?void 0:e.path))return;(yield this.load(t.state.path,t.state.hash))||window.history.pushState(this.active,"",this.active.path+this.active.hash)}))))}view(t,{enter:e,exit:s,template:i}={}){const n=(t.match(/:\w+/g)||[]).map((t=>t.substr(1))),o=t.replace(/:\w+/g,"([\\w-]+)").replace("/","\\/")+"\\/?",r=t.includes("?")?"":"(\\?.*)?",h={regex:new RegExp("^"+o+r+"$","i"),params:n,enter:e,exit:s,template:i};this.views.push(h);const a=window.location.pathname+window.location.search,l=zs(a,h);l&&(this.active={path:a,hash:window.location.hash},window.history.replaceState(this.active,"",this.active.path+this.active.hash),$s.ready((()=>{setTimeout((()=>{this.preloaded?(this.initialise(this.$viewport,l),h.enter&&h.enter(this.$viewport,l)):this.loadView(h,l)}))})))}paths(...t){for(const e of t)this.view(e)}getView(t){for(const e of this.views){const s=zs(t,e);if(s)return{view:e,params:s}}}load(t,e){return ne(this,void 0,void 0,(function*(){if(t===this.active.path&&e!==this.active.hash)return this.trigger("hashChange",e.slice(1)),this.trigger("change",t+e),this.active={path:t,hash:e},!0;const s=this.getView(t);return!!s&&(!(this.beforeChange&&!(yield this.beforeChange()))&&(this.active={path:t,hash:e},this.trigger("change",t+e),window.ga&&window.ga("send","pageview",t+e),this.noLoad?s.view.enter&&s.view.enter(this.$viewport,s.params):this.loadView(s.view,s.params),!0))}))}loadView(t,e={}){return ne(this,void 0,void 0,(function*(){this.showLoadingBar();const s=this.active.path,i=yield function(t,e,s){return ne(this,void 0,void 0,(function*(){return t.template?"string"==typeof t.template?t.template:t.template(e):(yield fetch(s+(s.indexOf("?")>=0?"&xhr=1":"?xhr=1"))).text()}))}(t,e,s);if(this.active.path!==s)return;yield this.$viewport.animate({opacity:0},200).promise,this.$viewport.removeChildren(),ls.scrollTop=0,this.$viewport.html=i,$s.resize(),ys(),this.$viewport.animate({opacity:1},200),this.hideLoadingBar();const n=this.$viewport.$("title");n&&(document.title=n.text),this.initialise(this.$viewport,e),t.enter&&t.enter(this.$viewport,e),this.trigger("afterChange",{$viewport:this.$viewport})}))}onLinkClick(t){if(t.metaKey||t.ctrlKey||t.shiftKey)return;if(t.defaultPrevented)return;let e=t.target;for(;e&&"A"!==e.nodeName;)e=e.parentNode;if(!e||"A"!==e.nodeName)return;const s=e;if(s.target)return;if(s.origin!==window.location.origin)return;if(s.hasAttribute("download")||"external"===s.getAttribute("rel"))return;const i=s.getAttribute("href");i&&i.indexOf("mailto:")>-1||this.getView(s.pathname+s.search)&&(t.preventDefault(),this.goTo(s.pathname+s.search,s.hash))}goTo(t,e=""){return ne(this,void 0,void 0,(function*(){const s=this.active.path+this.active.hash;(yield this.load(t,e))&&s!==this.active.path+this.active.hash&&window.history.pushState(this.active,"",t+e)}))}replace(t,e=""){this.active={path:t,hash:e},window.history.replaceState(this.active,"",t+e)}back(){window.history.back()}forward(){window.history.forward()}showLoadingBar(){this.$loadingBar||(this.$loadingBar=as("div",{style:"position: fixed; top: 0; left: 0; width: 100%; height: 4px; background: #0f82f2; pointer-events: none; z-index: 9999; will-change: transform;"},ls)),this.$loadingBar.css({transform:"translateX(-100%)",opacity:1}),this.$loadingBar.show(),this.animation=ks((t=>{this.$loadingBar.css("transform",`translateX(-${10+90*Math.exp(-4*t)}%)`)}),3e3)}hideLoadingBar(){var t,e,s;return ne(this,void 0,void 0,(function*(){null===(t=this.animation)||void 0===t||t.cancel(),yield null===(e=this.$loadingBar)||void 0===e?void 0:e.animate({transform:"none",opacity:0}).promise,null===(s=this.$loadingBar)||void 0===s||s.hide()}))}};function Os(t){const e=[];for(const s of Array.from(t.children))s.tagName.startsWith("X-")?e.push(s):e.push(...Os(s));return e}const qs=new Map;class Vs extends HTMLElement{constructor(){super(...arguments),this.wasConnected=!1,this.isReady=!1}connectedCallback(){return ne(this,void 0,void 0,(function*(){if(this.wasConnected)return void this._view.trigger("connected");this.wasConnected=!0,this.isReady=!1,this._view.created();const t=qs.get(this._view.tagName)||{};t.template&&function(t,e){const s=Array.from(t.childNodes);t.innerHTML=e;const i={};for(const e of Array.from(t.querySelectorAll("slot")))i[e.getAttribute("name")||""]=e;for(const t of s){const e=i[t.getAttribute&&t.getAttribute("slot")||""]||i[""];e&&e.parentNode.insertBefore(t,e)}for(const t of Object.values(i))t.parentNode.removeChild(t)}(this,t.template);const e=Os(this).filter((t=>!t.isReady)).map((t=>new Promise((e=>t.addEventListener("ready",e)))));yield Promise.all(e),this._view.ready(),this.dispatchEvent(new CustomEvent("ready")),this.isReady=!0}))}disconnectedCallback(){this._view.trigger("disconnected")}}class Bs extends Xe{created(){}ready(){}}function Rs(t,e={}){return function(s){qs.set(t.toUpperCase(),e),window.customElements.define(t,class extends Vs{constructor(){super(),this._view=new s(this)}})}}class Ds{constructor(t){this.clipEndTime=0,this.player=new Audio(t),this.player.preload="true",this.player.addEventListener("timeupdate",(()=>{this.player.currentTime>=this.clipEndTime&&this.triggerCallback(!0)})),window.addEventListener("beforeunload",(()=>this.player.pause()))}playClip(t,e,s){this.triggerCallback(!1),this.player.currentTime=t,this.clipEndTime=e,this.clipCallback=s,this.player.play()}triggerCallback(t){if(!this.clipCallback)return;const e=this.clipCallback;this.clipCallback=void 0,this.player.pause(),e({ended:t})}pause(){this.triggerCallback(!1)}get isPlaying(){return!!this.clipCallback}}let js,Ns=!1;class Hs{constructor(t,e){this.audio=t,this.paragraphs=[],this.paragraphs=e.$$(".voice").map((e=>new Zs(e,t)));for(const[t,s]of this.paragraphs.entries())s.on("end",(()=>{var s;if(this.paragraphs[t+1])this.paragraphs[t+1].play();else{const t=e.nextStep;t&&t.isShown&&(null===(s=t.narration)||void 0===s||s.play())}}))}play(){var t;!this.audio.isPlaying&&Ns&&(null===(t=this.paragraphs[0])||void 0===t||t.play())}}class Zs extends T{constructor(t,e){super(),this.$p=t,this.audio=e,this.playing=void 0,this.sentences=t.$$(".sentence[data-timings]").map((t=>new Fs(t,e))),this.$button=as("button",{class:"playback-btn"}),this.$button.on("click",(()=>{this.playing?this.audio.pause():this.play(),Ns=!Ns,js=void 0})),t.prepend(this.$button),t.addClass("sentence-wrap");for(const[t,e]of this.sentences.entries())e.on("end",(e=>{this.playing=void 0,e&&this.sentences[t+1]?setTimeout((()=>this.play(this.sentences[t+1])),200):(this.$button.removeClass("active"),e&&setTimeout((()=>this.trigger("end")),400))}))}play(t){const e=t||this.sentences[0],s=e.$reveal;if(s&&"hidden"===s.css("visibility"))return this.$button.removeClass("active"),js=s,void s.one("reveal",(()=>{js!==s||this.audio.isPlaying||this.play(e)}));this.playing=e,this.playing.play(),this.$button.addClass("active");const i=this.$p.parents("x-tabbox .tab")[0];if(i){const t=i.parents("x-tabbox")[0];t.makeActive(i.index());const e=t.active;t.one("change",(t=>{this.playing&&t!==e&&this.audio.pause()}))}const n=this.$p.bounds,o=n.top+n.height-$s.height+20;o>0&&ls.scrollBy(o+100),setTimeout((()=>this.$button.focus()),800)}}class Fs extends T{constructor(t,e){super(),this.$el=t,this.audio=e;const s=t.attr("data-timings").split("-");this.start=+s[0]/1e3,this.end=(+s[1]-200)/1e3}play(){this.$el.addClass("playing"),this.audio.playClip(this.start,this.end,(({ended:t})=>{this.$el.removeClass("playing"),this.trigger("end",t)}))}get $reveal(){return this.$el.parents(".reveal")[0]}}class Us extends Error{constructor(t,e){super(e),this.name=t}static undefinedVariable(t){return new Us("EvalError",`Undefined variable “${t}”.`)}static undefinedFunction(t){return new Us("EvalError",`Undefined function “${t}”.`)}static invalidCharacter(t){return new Us("SyntaxError",`Unknown symbol “${t}”.`)}static conflictingBrackets(t){return new Us("SyntaxError",`Conflicting brackets “${t}”.`)}static unclosedBracket(t){return new Us("SyntaxError",`Unclosed bracket “${t}”.`)}static startOperator(t){return new Us("SyntaxError",`A term cannot start with a “${t}”.`)}static endOperator(t){return new Us("SyntaxError",`A term cannot end with a “${t}”.`)}static consecutiveOperators(t,e){return new Us("SyntaxError",`A “${t}” cannot be followed by a “${e}”.`)}static invalidExpression(){return new Us("SyntaxError","This expression is invalid.")}}const Ws={pi:Math.PI,"π":Math.PI,e:Math.E},Ks={"(":")","[":"]","{":"}"},Gs={"*":"·","**":"∗","//":"//","+-":"±","–":"−","-":"−",xx:"×",sum:"∑",prod:"∏",int:"∫",del:"∂",grad:"∇",aleph:"ℵ",not:"¬",AA:"∀",EE:"∃","'":"’","!=":"≠","<=":"≤",">=":"≥",in:"∈","!in":"∉","==":"≡","~=":"≅","~~":"≈",sub:"⊂",sube:"⊆",prop:"∝",oo:"∞",cap:"∩",cup:"∪","<-":"←","->":"→","=>":"⇒","<=>":"⇔","|->":"↦",uarr:"↑",darr:"↓",lArr:"⇐"},Xs={Gamma:"Γ",Delta:"Δ",Theta:"Θ",Lambda:"Λ",Xi:"Ξ",Pi:"Π",Sigma:"Σ",Phi:"Φ",Psi:"Ψ",Omega:"Ω",alpha:"α",beta:"β",gamma:"γ",delta:"δ",epsilon:"ɛ",zeta:"ζ",eta:"η",theta:"θ",iota:"ι",kappa:"κ",lambda:"λ",mu:"μ",nu:"ν",xi:"ξ",pi:"π",rho:"ρ",sigma:"σ",tau:"τ",upsilon:"υ",phi:"φ",chi:"χ",psi:"ψ",omega:"ω",CC:"ℂ",NN:"ℕ",QQ:"ℚ",RR:"ℝ",ZZ:"ℤ"},Ys="abcdefghijklmnopqrstuvwxyz",Qs=[...Ys.split(""),...Ys.toUpperCase().split(""),...Object.values(Xs),"$"],Js=[..."|()[]{}÷,!<>=*/+-–−~^_…°•∥⊥'∠:%∼△",...Object.values(Gs)],ti={_:"sub","^":"sup","//":"/","÷":"/"},ei={"<":"&lt;",">":"&gt;"};function si(t){return t in ei?ei[t]:t}const ii=new Set(["sin","cos","tan","sec","csc","cot","arcsin","arccos","arctan","sinh","cosh","tanh","sech","csch","coth","exp","log","ln","det","dim","mod","gcd","lcm","min","max"]);function ni(t){return ii.has(t)}const oi={"+":"plus","−":"minus","·":"times","×":"times","/":"over","//":"divided by","%":"percent","!":"factorial","±":"plus-minus","=":"equals","≠":"does not equal","<":"is less than",">":"is greater than","≤":"is less than or equal to","≥":"is greater than or equal to","π":"pi","≅":"is congruent to","∥":"is parallel to","⊥":"is perpendicular to"};for(const t of Object.keys(Xs))oi[Xs[t]]=t;class ri{evaluate(t={}){return NaN}substitute(t={}){return this}get simplified(){return this}get variables(){return[]}get functions(){return[]}collapse(){return this}toString(){return""}toVoice(t={}){return""}toMathML(t={}){return""}}class hi extends ri{constructor(t){super(),this.n=t}evaluate(){return this.n}toString(){return""+this.n}toVoice(){return""+this.n}toMathML(){return`<mn>${this.n}</mn>`}}class ai extends ri{constructor(t){super(),this.i=t}evaluate(t={}){if(this.i in t)return t[this.i];if(this.i in Ws)return Ws[this.i];throw Us.undefinedVariable(this.i)}toMathML(){return`<mi${ni(this.i)?' mathvariant="normal"':""}>${this.i}</mi>`}substitute(t={}){return t[this.i]||this}get variables(){return[this.i]}toString(){return this.i}toVoice(){return this.i in oi?oi[this.i]:1===this.i.length?`_${this.i}_`:this.i}}class li extends ri{constructor(t){super(),this.s=t}evaluate(t={}){if(this.s in t)return t[this.s];throw Us.undefinedVariable(this.s)}toString(){return'"'+this.s+'"'}toVoice(){return this.s}toMathML(){return`<mtext>${this.s}</mtext>`}}class ci extends ri{toString(){return" "}toMathML(){return"<mspace></mspace>"}}class di extends ri{constructor(t){super(),this.o=t}toString(){return this.o.replace("//","/")}toVoice(){return oi[this.o]||this.o}get functions(){return[this.o]}toMathML(){const t=si(this.toString());return`<mo value="${t}">${t}</mo>`}}const pi=A("+ − * × · / ÷ // sup sub subsup"),ui=A("sub sup subsup"),fi='<mo value="," lspace="0">,</mo>';function gi(t,e){return!!pi.includes(e)&&(t instanceof wi||t instanceof $i&&(!!pi.includes(t.fn)&&(!(!ui.includes(t.fn)||!ui.includes(e))||pi.indexOf(e)>pi.indexOf(t.fn))))}function mi(t,e){return t instanceof wi||t instanceof $i?`<mrow>${e}</mrow>`:e}function vi(t){return"2"===t?"squared":"3"===t?"cubed":`to the power of ${t}`}class $i extends ri{constructor(t,e=[]){super(),this.fn=t,this.args=e}evaluate(t={}){const e=this.args.map((e=>e.evaluate(t)));if(this.fn in t)return t[this.fn](...e);switch(this.fn){case"+":return e.reduce(((t,e)=>t+e),0);case"−":return e.length>1?e[0]-e[1]:-e[0];case"*":case"·":case"×":return e.reduce(((t,e)=>t*e),1);case"/":return e[0]/e[1];case"sin":case"cos":case"tan":return Math.sin(e[0]);case"log":return Math.log(e[0])/Math.log(e[1]||Math.E);case"sup":return Math.pow(e[0],e[1]);case"sqrt":return Math.sqrt(e[0]);case"root":return Math.pow(e[0],1/e[1]);case"(":return e[0]}throw Us.undefinedFunction(this.fn)}substitute(t={}){return new $i(this.fn,this.args.map((e=>e.substitute(t))))}collapse(){return"("===this.fn?this.args[0].collapse():new $i(this.fn,this.args.map((t=>t.collapse())))}get simplified(){return this}get variables(){return y(b(this.args.map((t=>t.variables))))}get functions(){return y([this.fn,...b(this.args.map((t=>t.functions)))])}toString(){const t=this.args.map((t=>gi(t,this.fn)?"("+t.toString()+")":t.toString()));return"−"===this.fn?t.length>1?t.join(" − "):"−"+t[0]:"sup"===this.fn?t.join("^"):"sub"===this.fn?t.join("_"):"subsup"===this.fn?`${t[0]}_${t[1]}^${t[2]}`:A("+ * × · / = < > ≤ ≥ ≈").includes(this.fn)?t.join(" "+this.fn+" "):i(this.fn,"(","[","{")?this.fn+this.args.join(", ")+Ks[this.fn]:"abs"===this.fn?`|${this.args.join(", ")}|`:i(this.fn,"!","%")?t[0]+this.fn:`${this.fn}(${t.join(", ")})`}toMathML(t={}){const e=this.args.map((e=>e.toMathML(t))),s=this.args.map(((t,s)=>{return i=t,n=this.fn,o=e[s],gi(i,n)?`<mfenced>${o}</mfenced>`:o;var i,n,o}));if(this.fn in t){const s=e.map(((t,e)=>({toString:()=>t,val:this.args[e]})));return t[this.fn](...s)}if("−"===this.fn)return s.length>1?s.join('<mo value="−">−</mo>'):'<mo rspace="0" value="−">−</mo>'+s[0];if(i(this.fn,"+","=","<",">","≤","≥","≈")){const t=si(this.fn);return s.join(`<mo value="${t}">${t}</mo>`)}if(i(this.fn,"*","×","·")){let t=s[0];for(let e=1;e<s.length-1;++e){t+=(this.args[0]instanceof hi&&this.args[1]instanceof hi?'<mo value="×">×</mo>':"")+s[1]}return t}if("//"===this.fn)return s.join('<mo value="/">/</mo>');if("sqrt"===this.fn)return`<msqrt>${s[0]}</msqrt>`;if(i(this.fn,"/","root")){const t="/"===this.fn?"mfrac":"mroot";return`<${t}>${this.args.map(((t,s)=>mi(t,e[s]))).join("")}</${t}>`}if(i(this.fn,"sup","sub")){const t=[mi(this.args[0],s[0]),mi(this.args[1],e[1])];return`<m${this.fn}>${t.join("")}</m${this.fn}>`}if("subsup"===this.fn){return`<msubsup>${[mi(this.args[0],s[0]),mi(this.args[1],e[1]),mi(this.args[2],e[2])].join("")}</msubsup>`}if(i(this.fn,"(","[","{"))return`<mfenced open="${this.fn}" close="${Ks[this.fn]}">${s.join(fi)}</mfenced>`;if(i(this.fn,"!","%"))return s[0]+`<mo value="${this.fn}" lspace="0">${this.fn}</mo>`;if("abs"===this.fn)return`<mfenced open="|" close="|">${s.join(fi)}</mfenced>`;if("bar"===this.fn)return`<mover>${mi(this.args[0],s[0])}<mo value="‾">‾</mo></mover>`;if("vec"===this.fn)return`<mover>${mi(this.args[0],s[0])}<mo value="→">→</mo></mover>`;return`<mi${ni(this.fn)?' mathvariant="normal"':""}>${this.fn}</mi><mfenced>${s.join(fi)}</mfenced>`}toVoice(t={}){const e=this.args.map((e=>e.toVoice(t))),s=e.join(" ");if(this.fn in t){const s=e.map(((t,e)=>({toString:()=>t,val:this.args[e]})));return t[this.fn](...s)}return i(this.fn,"(","[","{")?s:"sqrt"===this.fn?`square root of ${s}`:"%"===this.fn?`${s} percent`:"!"===this.fn?`${s} factorial`:"/"===this.fn?`${e[0]} over ${e[1]}`:"//"===this.fn?`${e[0]} divided by ${e[1]}`:"sub"===this.fn?s:"subsup"===this.fn?`${e[0]} ${e[1]} ${vi(e[2])}`:"sup"===this.fn?`${e[0]} ${vi(e[1])}`:oi[this.fn]?e.join(` ${oi[this.fn]} `):ni(this.fn)?`${this.fn} ${s}`:`${this.fn} of ${s}`}}class wi extends ri{constructor(t){super(),this.items=t}evaluate(t={}){return this.collapse().evaluate(t)}substitute(t={}){return this.collapse().substitute(t)}get simplified(){return this.collapse().simplified}get variables(){return y(k(...this.items.map((t=>t.variables))))}get functions(){return this.collapse().functions}toString(){return this.items.map((t=>t.toString())).join(" ")}toMathML(t={}){return this.items.map((e=>e.toMathML(t))).join("")}toVoice(t={}){return this.items.map((e=>e.toVoice(t))).join(" ")}collapse(){return function(t){if(!(t=t.filter((t=>!(t instanceof ci)))).length)throw Us.invalidExpression();if(Mi(t[0],"%!"))throw Us.startOperator(t[0]);for(let e=0;e<t.length;++e)Mi(t[e],"%!")&&(t.splice(e-1,2,new $i(t[e].o,[t[e-1]])),e-=1);Ai(t,"= < > ≤ ≥"),Ai(t,"// ÷"),Mi((t=Pi(t,"× * ·",!0))[0],"− ±")&&t.splice(0,2,new $i(t[0].o,[t[1]]));Ai(t,"− ±"),Mi(t[0],"+")&&(t=t.slice(1));if((t=Pi(t,"+")).length>1)throw Us.invalidExpression();return t[0]}(this.items).collapse()}}var xi;function yi(t,e){if(e===xi.STR)return new li(t);if(t&&e){if(e===xi.SPACE&&t.length>1)return new ci;if(e===xi.NUM){if(isNaN(+t))throw Us.invalidExpression();return new hi(+t)}return e===xi.VAR?t in Xs?new ai(Xs[t]):t in Gs?new di(Gs[t]):new ai(t):e===xi.OP?new di(t in Gs?Gs[t]:t):void 0}}function bi(t,e){const s=[[]];for(const i of t)e(i)?s.push([]):v(s).push(i);return s}function Mi(t,e){return t instanceof di&&A(e).includes(t.o)}function ki(t){return t instanceof $i&&"("===t.fn?t.args[0]:t}function Ai(t,e){if(Mi(t[0],e))throw Us.startOperator(t[0]);if(Mi(v(t),e))throw Us.endOperator(v(t));for(let s=1;s<t.length-1;++s){if(!Mi(t[s],e))continue;const i=t[s],n=t[s-1],o=t[s+1];if(n instanceof di)throw Us.consecutiveOperators(n.o,i.o);if(o instanceof di)throw Us.consecutiveOperators(i.o,o.o);const r=t[s+2];if("^ _"===e&&Mi(i,"_ ^")&&Mi(r,"_ ^")&&i.o!==r.o){const e=t[s+3];if(e instanceof di)throw Us.consecutiveOperators(r.o,e.o);const h=[ki(n),ki(o),ki(e)];"^"===i.o&&([h[1],h[2]]=[h[2],h[1]]),t.splice(s-1,5,new $i("subsup",h)),s-=4}else{const e=ti[i.o]||i.o,r=[ki(n),ki(o)];t.splice(s-1,3,new $i(e,r)),s-=2}}}function Ci(t){return Ai(t,"^ _"),Ai(t,"/"),(e=t).length>1||e[0]instanceof di?new wi(e):e[0];var e}function Pi(t,e,s=!1){const i=[];let n=[],o=!1;function r(){if(o)throw Us.invalidExpression();n.length&&(i.push(n.length>1?new $i(e[0],n):n[0]),n=[])}for(const h of t)if(Mi(h,e)){if(o||!n.length)throw Us.invalidExpression();o=!0}else if(h instanceof di)r(),i.push(h),o=!1;else{const t=!s||h instanceof hi;if(n.length&&!o&&t)throw Us.invalidExpression();n.push(h),o=!1}return r(),i}!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SPACE=1]="SPACE",t[t.STR=2]="STR",t[t.NUM=3]="NUM",t[t.VAR=4]="VAR",t[t.OP=5]="OP"}(xi||(xi={}));const Ti={numEquals:function(t,e){try{const s=y([...t.variables,...e.variables]),i=t.collapse(),n=e.collapse();let o=0;for(let t=0;t<5;++t){const t={};for(const e of s)t[e]=Ws[e]||5*Math.random();const e=i.evaluate(t),r=n.evaluate(t);if(!isNaN(e)&&!isNaN(r)){if(!q(e,r))return!1;o+=1}}return!!o}catch(t){return!1}},parse:c((function(t,e=!1,s){const i=function(t,e){const s=[[]],i=["π",...(null==e?void 0:e.variables)||[]];for(const e of t){const t=v(s).length?v(s)[0].o:void 0;if(Mi(e,") ] }")){if(!Mi(e,Ks[t]))throw Us.conflictingBrackets(e.o);const n=s.pop(),o=v(s),r=v(o),h=Mi(e,")")&&r instanceof ai&&!i.includes(r.i)?o.pop().i:n[0].o,a=bi(n.slice(1),(t=>Mi(t,",")));o.push(new $i(h,a.map(Ci)))}else Mi(e,"( [ {")?s.push([e]):v(s).push(e)}if(s.length>1)throw Us.unclosedBracket(v(s)[0].o);return Ci(s[0])}(function(t){const e=[];let s="",i=xi.UNKNOWN;for(const n of t){if('"'===n){const t=i===xi.STR?xi.UNKNOWN:xi.STR,n=yi(s,i);n&&e.push(n),s="",i=t;continue}if(i===xi.STR){s+=n;continue}const t=n.match(/[0-9.]/)?xi.NUM:Qs.includes(n)?xi.VAR:Js.includes(n)?xi.OP:n.match(/\s/)?xi.SPACE:xi.UNKNOWN;if(!t)throw Us.invalidCharacter(n);if(!i||i===xi.NUM&&t!==xi.NUM||i===xi.VAR&&t!==xi.VAR&&t!==xi.NUM||i===xi.OP&&!(s+n in Gs)||i===xi.SPACE&&t!==xi.SPACE){const n=yi(s,i);n&&e.push(n),s="",i=t}s+=n}const n=yi(s,i);return n&&e.push(n),e}(t),s);return e?i.collapse():i}))};class Si{constructor(){this.callbacks=[]}add(t){this.callbacks.push(t)}start(t=1e3){return ks((t=>{for(const e of this.callbacks)e(t)}),t).promise}}function Li(t,e,s){if("adding"===s){const s=t.strokeLength,i=e<.5?0:Cs("cubic-in",2*e-1);t.css({"stroke-dasharray":s+"px","stroke-dashoffset":s*(1-i)+"px"})}else if("deleting"===s){const s=t.strokeLength,i=e<.5?Cs("cubic-in",2*e):1;t.css({"stroke-dasharray":s+"px","stroke-dashoffset":s*(2-i)+"px"})}}function _i(t,e){const s=[t];let i=t.expr;for(;e.startsWith(i);){if(e===i)return s;const t=v(s).next;if(!t)return;s.push(t),i+=t.expr}}function zi(t,e){return 1===e.length&&"mrow"===e[0].type?e[0]:new Bi(e,t)}class Ei{constructor(t,e,s,i){this.type=t,this.equation=s,this.$element=i,this.children=[],this.status="",this.value="",this.customColor="",this.roundedMotion=!1,this.width=0,this.height=0,this.baseline=0,this.transform={x:0,y:0,scale:1},this.currentDimensions=[0,0,0],this.currentWorldTransform={x:0,y:0,scale:1},this.addChildren(e),i&&s.$row.append(i)}get expr(){return""}get log(){const t=this.children.map((t=>t.log));return`<${this.type}>${t.join("")}</${this.type}>`}get color(){return this.customColor||(this.parent?this.parent.color:"")}static create(t,e){const s=t.nodeName.toLowerCase();if(i(s,"mn","mi","mo","mtext"))return new Vi(s,t,e);if(!i(s,"mrow","mfrac","mfenced","msqrt","mroot","msub","msup","msubsup"))return new Zi(t,e);if("mfenced"===s&&"["===t.getAttribute("open")){const s=t.children.length,i=b(Array.from(t.children,(t=>Array.from(t.children,(t=>Ei.create(t,e)))))),n=new Hi(i,e,s);return new ji([n],e)}let n=Array.from(t.children,(t=>Ei.create(t,e)));switch(s){case"mrow":return new Bi(n,e);case"mfrac":return n=n.map((t=>zi(e,[t]))),new Ri(n,e);case"mfenced":return n=[zi(e,n)],new ji(n,e);case"msqrt":return n=[zi(e,n)],new Ni(s,n,e);case"mroot":return n=n.map((t=>zi(e,[t]))),new Ni(s,n,e);case"msub":case"msup":case"msubsup":return n=n.map((t=>zi(e,[t]))),new Di(s,n,e)}throw new Error(`Unknown element type tag ${t.nodeName}`)}get marginLeft(){return.1}get marginRight(){return.1}setTransform(t=0,e=0,s=1){this.transform.x=t,this.transform.y=e,this.transform.scale=s}get worldTransform(){let t=this;const e=Object.assign({},this.transform);for(;t=t.parent;)s=e,i=t.transform,s.scale*=i.scale,s.x=s.x*i.scale+i.x,s.y=s.y*i.scale+i.y;var s,i;return e}get next(){if(!this.parent)return;const t=this.parent.children.indexOf(this);return this.parent.children[t+1]}get prev(){if(!this.parent)return;const t=this.parent.children.indexOf(this);return this.parent.children[t-1]}addChildren(t,e=this.children.length){for(const e of t)e.detach(),e.parent=this;this.children.splice(e,0,...t)}insertAfter(t){const e=this.parent.children.indexOf(this);this.parent.addChildren(t,e+1)}insertBefore(t){const e=this.parent.children.indexOf(this);this.parent.addChildren(t,e)}detach(){if(this.parent){const t=this.parent.children.indexOf(this);t>=0&&this.parent.children.splice(t,1)}}deleteFromDom(){this.$element&&this.$element.remove(),this.$element=void 0;for(const t of this.children)t.deleteFromDom()}hasParent(t){let e=this;for(;e=e.parent;)if(e.type===t)return!0;return!1}measure(){for(const t of this.children)t.measure()}clean(){for(const t of this.children)t.clean()}setStatus(t){this.status=t;for(const e of this.children)e.setStatus(t)}render(t){for(const e of this.children)e.render(t);if(!this.$element)return;const e=this.currentWorldTransform,s=this.currentWorldTransform=this.worldTransform,n=this.currentDimensions,o=this.currentDimensions=[this.width,this.height,this.baseline];if(h=s,q((r=e).x,h.x)&&q(r.y,h.y)&&q(r.scale,h.scale)&&function(t,e){return t.every(((t,s)=>q(t,e[s])))}(n,o)&&!this.status)return;var r,h;if(!t)return this.positionElement(s),void this.drawElement(1,o[0],o[1],o[2],s.scale);"adding"===this.status&&this.positionElement(s);const a=s.y+this.baseline<this.equation.root.baseline?-1:1,l=this.roundedMotion?function(t,e,s=1){const i=s*Math.abs(e.x-t.x)/3,n=Mt.average(t,e).shift(0,i);return function(s){return{x:(1-s)**2*t.x+2*s*(1-s)*n.x+s*s*e.x,y:(1-s)**2*t.y+2*s*(1-s)*n.y+s*s*e.y}}}(e,s,a):void 0;this.roundedMotion=!1,t.add((t=>{if(!this.$element)return;const r=Cs("cubic",t),h=i(this.status,"adding","deleting"),a=h?o[0]:J(n[0],o[0],r),c=h?o[1]:J(n[1],o[1],r),d=h?o[2]:J(n[2],o[2],r),p=h?s.scale:J(e.scale,s.scale,r);if(this.drawElement(t,a,c,d,p),!this.status){const t=l?l(r):Mt.interpolate(e,s,r);this.positionElement({x:t.x,y:t.y,scale:p})}}))}positionElement(t){this.$element.setTransform(t,0,t.scale)}drawElement(t,e,s,i,n){}}const Ii=1.1,Oi=["=","≈","<",">","≤","≥"],qi=as("svg",{width:0,height:0,style:"position: absolute; top: -100px; left: -100px"},ls);class Vi extends Ei{constructor(t,e,s){const i=as("text",{text:e.textContent},qi),n=i.width;super(t,[],s,i),this.value=e.textContent||"",this.width=n;const o=this.value.split("").every((t=>"acegmnopqrsuvwxyz".includes(t)));this.height=(Ii-(o?.15:0))*this.equation.fontSize,this.baseline=this.height-.2*this.equation.fontSize,"mtext"!==t&&"normal"!==e.getAttribute("mathvariant")||i.addClass("font-normal")}get expr(){return"mtext"===this.type?`"${this.value}"`:this.value}get log(){return`<${this.type}>${this.value}</${this.type}>`}get marginLeft(){if("mo"===this.type)return Oi.includes(this.value)?this.equation.isDisplay?.6:.35:i(this.value,"∡","△","!","%","’")||i(this.value,"…","°")&&this.prev&&"mn"===this.prev.type?0:.25;if("mi"===this.type){if(this.prev&&"mn"===this.prev.type)return.1;if(this.prev&&"mi"===this.prev.type)return.05;if(this.prev&&"mfrac"===this.prev.type)return.15}return 0}get marginRight(){return"mo"===this.type?this.equation.isDisplay&&Oi.includes(this.value)?.6:i(this.value,"∡","△")?0:"−"!==this.value||this.prev&&!Oi.includes(this.prev.value)?.25:.1:0}positionElement(t){if(!this.$element)return;const e=(this.equation.fontSize-this.baseline)*t.scale;this.$element.setTransform({x:t.x,y:t.y-e},0,t.scale)}drawElement(t,e,s,i,n){"adding"===this.status?this.$element.setAttr("opacity",t<.5?0:Cs("cubic-in",2*t-1)):"deleting"===this.status&&this.$element.setAttr("opacity",t<.5?1-Cs("cubic-in",2*t):0),this.$element.css("stroke-width",1.5*(1-n)+"px"),this.$element.css("color",this.color||"currentColor")}}class Bi extends Ei{constructor(t,e,s,i=0){super("mrow",t,e),this.align=s,this.dx=i}addChildren(t,e=this.children.length){const s=[];for(const e of t)"mrow"===e.type?(s.push(...e.children),e.detach()):s.push(e);Ei.prototype.addChildren.call(this,s,e)}get expr(){return this.children.map((t=>t.expr)).join("")}measure(){if(Ei.prototype.measure.call(this),!this.children.length)return void(this.height=this.width=this.baseline=0);this.baseline=Math.max(...this.children.map((t=>t.baseline))),this.height=this.baseline+Math.max(...this.children.map((t=>t.height-t.baseline)));let t=0;for(const[e,s]of this.children.entries())s.setTransform(t,this.baseline-s.baseline),t+=s.width,e<this.children.length-1&&(t+=Math.max(s.marginRight,this.children[e+1].marginLeft)*this.equation.fontSize);if(this.align){const t=this.children.find((t=>t.expr===this.align));t&&(this.transform.x=this.dx-t.transform.x-t.width/2)}this.width=t}}class Ri extends Ei{constructor(t,e){super("mfrac",t,e,as("line"))}get expr(){return this.children.map((t=>t.expr)).join("/")}measure(){Ei.prototype.measure.call(this);const t=.1*this.equation.fontSize,e=!this.equation.isDisplay||this.hasParent("mfrac")||this.hasParent("matrix")?.66:1,[s,i]=this.children;this.width=(Math.max(s.width,i.width)+2*t)*e,this.height=(s.height+i.height)*e,this.baseline=s.height*e+this.equation.fontSize*(.55-.2),s.setTransform((this.width-s.width*e)/2,0,e),i.setTransform((this.width-i.width*e)/2,s.height*e,e)}drawElement(t,e,s,i){const n=i-this.equation.fontSize*(.55-.2);this.$element.setLine({x:0,y:n},{x:e,y:n}),this.$element.setAttr("stroke",this.color||"currentColor"),Li(this.$element,t,this.status)}}class Di extends Ei{get expr(){let t=this.children[0].expr;return"msup"!==this.type&&(t+="_"+this.children[1].expr),"msup"===this.type&&(t+="^"+this.children[1].expr),"msubsup"===this.type&&(t+="^"+this.children[2].expr),t}measure(){Ei.prototype.measure.call(this);const[t,e,s]=this.children,i="msup"===this.type?void 0:e,n="msubsup"===this.type?s:"msup"===this.type?e:void 0,o=.05*this.equation.fontSize,r=.65,h=n?n.height*r-.4*this.equation.fontSize:0,a=i?i.height*r-.5*this.equation.fontSize:0,l=n?n.width:0,c=i?i.width:0;this.width=t.width+o+Math.max(l,c)*r,this.height=t.height+h+a,this.baseline=t.baseline+h,t.setTransform(0,this.baseline-t.baseline),n&&n.setTransform(t.width+o,0,r),i&&i.setTransform(t.width+o,this.height-i.height*r,r)}clean(){if(Ei.prototype.clean.call(this),this.children=this.children.filter((t=>"mrow"!==t.type||t.children.length)),0===this.children.length)return this.detach();1===this.children.length&&(this.insertAfter(this.children),this.detach())}}class ji extends Ei{constructor(t,e){super("mfenced",t,e,as("path"))}get expr(){return`(${this.children.map((t=>t.expr)).join()})`}get marginLeft(){return.2}get marginRight(){return.2}measure(){Ei.prototype.measure.call(this);const t=this.children[0];this.height=t.height+2,this.baseline=t.baseline+1;const e=1+this.height/this.equation.fontSize,s=.1*this.equation.fontSize;this.width=t.width+2*(e+s),t.setTransform(e+s,1)}drawElement(t,e,s){const i=Math.min(2+s/this.equation.fontSize,5),n=s-4,o=`M${i},2c${-2*i/3},${.15*n},${-i},${.32*n},${-i},${n/2}s${i/3},${.35*n},${i},${n/2}M${e-i},2c${2*i/3},${.15*n},${i},${.32*n},${i},${n/2}s${-i/3},${.35*n},${-i},${n/2}`;this.$element.setAttr("d",o),this.$element.css("stroke",this.color||"currentColor"),Li(this.$element,t,this.status)}clean(){Ei.prototype.clean.call(this),this.children.length||this.detach()}}class Ni extends Ei{constructor(t,e,s){super(t,e,s,as("path"))}get expr(){return`sqrt(${this.children.map((t=>t.expr)).join()})`}get marginLeft(){return.2}get marginRight(){return.2}measure(){Ei.prototype.measure.call(this);const t=this.children[0];this.height=t.height+2,this.baseline=t.baseline+2;const e=Math.min(16,3+5*this.height/this.equation.fontSize),s=.05*this.equation.fontSize;this.width=t.width+e+2*s,t.setTransform(e+s,2)}drawElement(t,e,s){const i=Math.min(16,3+5*s/this.equation.fontSize),n=s-2,o=`M0,${.55*n}L${.18*i},${.51*n}L${.45*i},${n}L${i},2L${e},2`;this.$element.setAttr("d",o),this.$element.css("stroke",this.color||"currentColor"),Li(this.$element,t,this.status)}clean(){Ei.prototype.clean.call(this),this.children.length||this.detach()}}class Hi extends Ei{constructor(t,e,s){super("matrix",t,e,as("g")),this.rows=s,this.cols=Math.floor(t.length/s)}get expr(){return`${this.children.map((t=>t.expr)).join(", ")}`}measure(){Ei.prototype.measure.call(this);const t=.6*this.equation.fontSize,e=g((t=>Math.max(...g((e=>this.children[t*this.cols+e].height),this.cols))),this.rows),s=g((t=>Math.max(...g((e=>this.children[e*this.cols+t].width),this.rows))),this.cols);this.height=$(e)+(this.rows-1)*t/2,this.width=$(s)+this.cols*t,this.baseline=(this.height+Ii*this.equation.fontSize)/2;let i=0;for(let n=0;n<this.rows;++n){let o=t/2;for(let r=0;r<this.cols;++r){const h=this.children[n*this.cols+r],a=o+(s[r]-h.width)/2,l=i+(e[n]-h.height)/2;h.setTransform(a,l),o+=s[r]+t}i+=e[n]+t/2}}}class Zi extends Ei{constructor(t,e){var s;super("foreign",[],e,as("g")),this.$body=as("div",{},e.$overlay),this.$body._el.appendChild(t),this.$measure=as("span",{text:".",style:"font-size: 0"},this.$body),this.checkForResize(),this.$body.on("resize",(()=>{this.checkForResize()&&this.equation.resize()})),null===(s=this.$body.$("x-blank, x-blank-input"))||void 0===s||s.on("solve",(t=>{h((()=>this.replace(t.solution,"#0f82f2")),t.restore?0:200)}))}deleteFromDom(){var t;null===(t=this.$body)||void 0===t||t.remove(),this.$body=void 0,this.$measure=void 0}replace(t,e){var s;const i=isNaN(+t)?"mtext":"mn",n=document.createElement(i);n.textContent=t;const o=new Vi(i,n,this.equation);o.customColor=e,this.insertAfter([o]),null===(s=this.$body)||void 0===s||s.off("resize"),this.detach(),this.deleteFromDom(),this.equation.resize()}checkForResize(){var t,e;const s=this.height,i=this.width,n=this.baseline;return this.height=(null===(t=this.$body)||void 0===t?void 0:t.height)||0,this.width=(null===(e=this.$body)||void 0===e?void 0:e.width)||0,this.baseline=this.$measure.bounds.top-this.$body.bounds.top,!(q(s,this.height)&&q(i,this.width)&&q(n,this.baseline))}positionElement(t){this.$body.css({left:t.x+"px",top:t.y+"px"}),q(t.scale,1)||this.$body.css("transform",`scale(${t.scale})`)}get expr(){return this.$body.text}get log(){return`<foreign>${this.expr}</foreign>`}}class Fi extends T{constructor(t,e,s=0,i="=",n=18,o=!0){super(),this.$row=t,this.$overlay=e,this.fontSize=n,this.isDisplay=o,this.isReady=!0,this.deletedNodes=new Set,this.desc=as("desc",{},t),this.root=new Bi([],this,i,s)}setValue(t){const e=Array.isArray(t)?t.map((t=>Ei.create(t,this))):this.parse(t);for(const t of this.root.children)t.deleteFromDom();this.root.addChildren(e),this.updateDescription(),this.resize()}updateDescription(){this.desc.text=this.root.expr}resize(){this.root.measure(),this.root.render()}parse(t){var e;const s=new DOMParser,i=Ti.parse(t).toMathML(),n=s.parseFromString(`<math>${i}</math>`,"text/xml");if("parsererror"===(null===(e=n.firstChild)||void 0===e?void 0:e.nodeName))throw new Error(n.firstChild.textContent);const o=n.firstChild.childNodes;return Array.from(o,(t=>Ei.create(t,this)))}find(t){let[e,s]=t.split("`");e=e.replace(/[–-]/g,"−");const i=+s||1,n=this.root.children.slice(0);let o=0;for(;n.length;){const t=n.shift(),s=t instanceof Bi?void 0:_i(t,e);if(s&&(o+=1,o===i))return s;n.unshift(...t.children)}throw new Error(`Can't find element ${e}.`)}animate(t=1200){return s(this,void 0,void 0,(function*(){this.isReady=!1,this.root.clean(),this.root.measure();const e=new Si;this.root.render(e),this.trigger("resize",{height:this.root.height});for(const t of this.deletedNodes)t.render(e);yield e.start(t);for(const t of this.deletedNodes)t.deleteFromDom();this.root.setStatus(""),this.deletedNodes.clear(),this.isReady=!0}))}addTermAfter(t,e){const s=v(e?this.find(e):this.root.children),i=this.parse(t);s.insertAfter(i);for(const t of i)t.setStatus("adding");this.updateDescription()}addTermBefore(t,e){const s=e?this.find(e)[0]:this.root.children[0],i=this.parse(t);s.insertBefore(i);for(const t of i)t.setStatus("adding");this.updateDescription()}deleteTerm(t){for(const e of this.find(t))e.setStatus("deleting"),e.detach(),this.deletedNodes.add(e);this.updateDescription()}replaceTerm(t,e){const s=this.find(t),i=this.parse(e);s[0].insertBefore(i);for(const t of i)t.setStatus("adding");for(const t of s)t.setStatus("deleting"),t.detach(),this.deletedNodes.add(t);this.updateDescription()}moveTermAfter(t,e){const s=this.find(t);for(const t of s)t.roundedMotion=!0;v(e?this.find(e):this.root.children).insertAfter(s),this.updateDescription()}moveTermBefore(t,e){const s=this.find(t);for(const t of s)t.roundedMotion=!0;(e?this.find(e)[0]:this.root.children[0]).insertBefore(s),this.updateDescription()}moveTermToStart(t){const e=this.find(t);for(const t of e)t.roundedMotion=!0;this.root.children[0].insertBefore(e),this.updateDescription()}wrapTerms(t,...e){const s=e.map((t=>this.find(t)));for(const t of s)for(const e of t)e.roundedMotion=!0;const i=this.parse(t);for(const t of i)t.setStatus("adding");s[0][0].insertBefore(i);for(const[t,e]of s.entries()){const s=this.find("$"+(t+1))[0];s.insertAfter(e),s.detach(),s.deleteFromDom()}this.updateDescription()}unwrapTerm(t,e=1){const s=this.find(t);let i=s[0],n=1;for(;n<=e;)i=i.parent,i instanceof Bi&&(i=i.parent),n+=1;i.insertAfter(s),i.setStatus("deleting"),i.detach(),this.deletedNodes.add(i),this.updateDescription()}get leftSide(){const t=this.root.children.findIndex((t=>"="===t.expr));return this.root.children.slice(0,t-1)}get rightSide(){const t=this.root.children.findIndex((t=>"="===t.expr));return this.root.children.slice(t+1)}}const Ui=600;let Wi=class extends Bs{constructor(){super(...arguments),this.rows=[],this.isReady=!0,this.topOffset=4,this.currentHeight=0,this.currentStep=0,this.nextEvents={},this.backEvents={}}ready(){this.$svg=this.$("svg"),this.$lastRow=this.$svg.$("g"),this.$overlay=this.$(".overlay"),this.$legend=this.$(".legend-box"),this.$steps=this.$legend.$$("li"),this.$back=this.$(".back"),this.$next=this.$(".next");const t=+this.attr("dx")||0;this.equation=new Fi(this.$lastRow,this.$overlay,t);const e=this.$(".math"),s=e?Array.from(e._el.children):[];this.equation.setValue(this.attr("expr")||s),this.currentHeight=this.topOffset+this.$lastRow.height+16,this.$svg.css("height",this.currentHeight+"px"),this.equation.on("resize",(({height:t})=>{const e=this.topOffset+t+16;Math.abs(e-this.currentHeight)<8||(this.currentHeight=e,this.$svg.animate({height:e+"px"},1200))})),this.$back.on("click",(()=>this.goBack())),this.$next.on("click",(()=>this.goNext())),this.$steps[0].show(),$s.onResize((()=>{const t=this.$svg.width/2;for(const e of[this.$lastRow,this.$overlay])e.css("transform",`translate(${t}px, ${this.topOffset}px)`);for(const e of this.rows)e.$el.css("transform",`translate(${t}px, ${e.top}px)`)}));const i=this.$overlay.$$("x-blank, x-blank-input");i.length&&(this.$next.addClass("hide"),Promise.all(i.map((t=>t.onPromise("solve")))).then((()=>setTimeout((()=>this.goNext()),1200))))}setup(t){this.one("next",(({step:e})=>t.score("algebra-flow-"+(e-1))))}newRow(){return s(this,void 0,void 0,(function*(){const t=this.$lastRow.copy(!0,!1),e=this.equation.root.height;this.rows.push({$el:t,height:e,top:this.topOffset}),this.$lastRow.insertBefore(t),$s.redraw(),this.topOffset+=e+16,this.currentHeight=this.topOffset+e+16;for(const t of[this.$lastRow,this.$overlay])t.animate({transform:`translate(${this.$svg.width/2}px, ${this.topOffset}px)`},Ui);yield this.$svg.animate({height:this.currentHeight+"px"},Ui).promise}))}hideLastRow(){return s(this,void 0,void 0,(function*(){if(!this.rows.length)return;const t=this.rows.pop();this.topOffset=t.top;for(const e of[this.$lastRow,this.$overlay])e.animate({transform:`translate(${this.$svg.width/2}px, ${t.top}px)`},Ui);this.currentHeight=t.top+this.$lastRow.height+16,this.$svg.animate({height:this.currentHeight+"px"},Ui),yield t.$el.exit("fade",300,300).promise,t.$el.remove()}))}onNextStep(t){this.nextEvents=t}onBackStep(t){this.backEvents=t}goNext(){return s(this,void 0,void 0,(function*(){if(!this.isReady||!this.equation.isReady||this.currentStep>=this.$steps.length-1)return;this.isReady=!1;const t=this.currentStep+1;this.$steps[t].hasClass("new-row")&&(yield this.newRow(),yield a(400)),t in this.nextEvents&&(yield this.nextEvents[t](this.equation),yield this.equation.animate(1200),yield a(1200)),yield this.go(t),this.trigger("next",{step:t}),this.isReady=!0}))}goBack(){return s(this,void 0,void 0,(function*(){if(!this.isReady||!this.equation.isReady||this.currentStep<=0)return;const t=this.currentStep-1;this.isReady=!1,this.currentStep in this.backEvents&&(yield this.backEvents[this.currentStep](this.equation),yield this.equation.animate()),this.$steps[this.currentStep].hasClass("new-row")&&this.hideLastRow(),yield this.go(t),this.trigger("back",{step:t}),this.isReady=!0}))}go(t){return s(this,void 0,void 0,(function*(){this.$steps[t].show();const e=this.$steps[t].height+"px";this.$steps[t].hide(),this.$legend.animate({height:e},800).promise.then((()=>this.$legend.css("height","auto")));const s=this.currentStep;this.currentStep=t,this.trigger("step",t),yield this.$steps[s].exit("fade",400).promise,this.$back.setClass("hide",t<=0),this.$next.setClass("hide",t>=this.$steps.length-1),yield this.$steps[t].enter("fade",400).promise}))}};Wi=e([Rs("x-algebra-flow",{template:'<svg class="equation"><g></g></svg><div class="overlay"></div><div class="nav"><div class="btn back hide"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#left"></use></svg></div><div class="btn next"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#right"></use></svg></div></div><div class="legend-box"><slot></slot></div>'})],Wi);let Ki=class extends Bs{constructor(){super(...arguments),this.done=!1}ready(){this.$target=this.$(".target"),this.$popup=this.$(".popup");const t=this.$popup.$$(".choice");this.solution=t[0].html;mt.shuffle(m(t.length)).forEach((e=>{this.$popup.append(t[e]),t[e].on("click",(()=>{this.removeClass("on"),t[e].blur(),e?(this.$target.html=t[e].html,this.addClass("invalid"),this.trigger("invalid")):(this.solve(),this.trigger("valid",this.solution))}))}));const e=this.$target.bounds.left+this.$popup.width>$s.width-15;this.setClass("left",e),Ee(this,{enter:()=>{if(this.done)return;this.addClass("on");const t=this.$target.bounds,e=this.$popup.width,s=this.$popup.height,i=$s.width-10-t.left,n=e<i,o=t.right-e>10,r=t.top+t.height+s>$s.height-10;this.setClass("left",o&&!n),this.setClass("top",r),this.$popup.css("max-width",o||n?"none":`${i}px`)},exit:()=>{this.removeClass("on")},delay:100,exitDelay:400,$clickTarget:this.$target})}setup(t,e,s){var i;(null===(i=null==s?void 0:s.scores)||void 0===i?void 0:i.includes(e))&&this.solve(!0),this.one("valid",(()=>{t.addHint("correct"),t.score(e)})),this.on("invalid",(e=>t.addHint(e.hint||"incorrect",{class:"incorrect"})))}solve(t=!1){this.done=!0,this.$target.html=this.solution,this.removeClass("on invalid"),this.addClass("done"),this.trigger("solve",{solution:this.solution,restore:t}),setTimeout((()=>this.$popup.remove()),250),this.$target.removeAttr("tabindex")}};Ki=e([Rs("x-blank",{template:'<span class="target" slot="target" tabindex="0" aria-label="Fill in this blank">???</span><div class="popup"><slot></slot></div>'})],Ki);function Gi(t){if(t.match("^[0-9]+/[0-9]+$")){const e=t.split("/");return+e[0]/+e[1]}return Z(t)}let Xi=class extends Bs{constructor(){super(...arguments),this.solution="",this.solutionNum=NaN,this.solutionDisplay="",this.range=0,this.input="",this.hint="",this.attempts=0,this.placeholder="???",this.done=!1}ready(){if(this.$input=this.$("input"),this.$target=this.$(".target"),this.solution=this.attr("solution"),this.solution.indexOf("±")>=0){const t=this.solution.split("±");this.solution=t[0].trim(),this.range=+t[1]}this.solutionNum=Gi(this.solution),this.solutionDisplay=this.solution,this.hint=this.attr("hint"),this.removeAttr("solution"),this.removeAttr("hint"),this.$input.setInputPattern(this.solution),this.hasAttr("placeholder")&&(this.placeholder=this.attr("placeholder")),this.$input.setAttr("placeholder",this.placeholder),this.removeAttr("placeholder"),this.$input.change((t=>{this.input=t,this.isCorrect&&(this.solve(),this.trigger("valid",t),this.moveCursor())})),this.$input.onKeyDown("enter",(()=>this.$input.blur())),this.$input.on("focus",(()=>{this.addClass("on"),this.removeClass("invalid"),this.$input.setAttr("placeholder"," ")})),this.$input.on("blur",(()=>{if(this.removeClass("on"),this.setClass("invalid",!!this.input&&!this.done),this.$input.setAttr("placeholder",this.placeholder),this.input&&!this.done){this.attempts+=1;const t=this.attempts>=(this.hint?4:3)?`Hmmm… maybe try ${this.solution}?`:this.attempts>=2?this.hint:void 0;this.trigger("invalid",{hint:t})}}))}setup(t,e,s){var i;this.goal=e,(null===(i=null==s?void 0:s.scores)||void 0===i?void 0:i.includes(e))&&this.solve(!0),this.one("valid",(()=>{t.addHint("correct"),t.score(this.solvedBlank?this.solvedBlank.goal:e)})),this.on("invalid",(e=>t.addHint(e.hint||"incorrect",{class:"incorrect"})))}get isCorrect(){if(this.done)return!0;if(this.linkedBlanks){const t=this.linkedBlanks.map((t=>t.solvedBlank));return this.solvedBlank=this.linkedBlanks.find((e=>!(e.done&&!e.solvedBlank)&&(!t.includes(e)&&(!!e.checkAnswer(this.input)||void 0)))),this.solvedBlank&&(this.solutionDisplay=this.solvedBlank.solution),!!this.solvedBlank}return this.checkAnswer(this.input)}checkAnswer(t){const e=Gi(t);return t.toLowerCase()===this.solution.toLowerCase()||(this.range&&Math.abs(e-this.solutionNum)<=this.range?(this.solutionDisplay=t,!0):q(e,this.solutionNum)||G(e)===this.solution||t===G(this.solutionNum))}moveCursor(){const t=this.getParentModel().$step;if(!t)return;const e=t.$blanks[t.$blanks.indexOf(this)+1];e&&!e.done&&"X-BLANK"!==e.tagName&&"hidden"!==e.css("visibility")&&e.bounds.width&&e.focus()}solve(t=!1){this.done=!0,this.$input.remove(),this.$target.html=this.solutionDisplay,this.addClass("done"),this.trigger("solve",{solution:this.solutionDisplay,restore:t})}focus(){this.$input.focus()}blur(){this.$input.blur()}};Xi=e([Rs("x-blank-input",{template:'<label class="target"><input maxlength="15" autocomplete="off" aria-label="Fill in this blank"></label>'})],Xi);const Yi=ds;function Qi(t){const e=t.prev;e&&i(e.tagName,"MO","MI","MN")?e.insertBefore(t):e?v(e.children).append(t):t.parent.hasClass("math")||(t.parent.prev?t.parent.prev.append(t):t.parent.parent.insertBefore(t))}function Ji(t,e){e.insertBefore(t),e.parent.removeClass("empty"),t.children.length&&t.children[0].append(e)}function tn(t,e){"abcdefghijklmnopqrstuvwxyzπ".includes(e)?Ji(as("mi",{text:e}),t):"0123456789.".includes(e)?Ji(as("mn",{text:e}),t):"+−±×÷<>≤≥=%!".includes(e)?Ji(as("mo",{text:e,value:e}),t):"frac"===e?Ji(as("mfrac",{html:'<mrow class="empty"></mrow><mrow class="empty"></mrow>'}),t):"sqrt"===e?Ji(as("msqrt",{html:'<mrow class="empty"></mrow>'}),t):i(e,"^","sup")?Ji(as("msup",{html:'<mrow class="empty"></mrow>'}),t):"brackets"===e||"([{|".includes(e)?Ji(as("mfenced",{html:'<mrow class="empty"></mrow>',type:"("}),t):")]}".includes(e)&&(t.next||"MFENCED"!==t.parent.parent.tagName||t.parent.parent.insertAfter(t))}function en(t,e){const s=t.$$(`${e}:first-child, *:not(${e}) + ${e}`);for(const t of s)if("MFRAC"!==t.parent.tagName)for(;t.next&&t.next.tagName===e.toUpperCase();)t.text+=t.next.text,t.next.remove()}const sn={"+":"addition","×":"multiplication","/":"fractions or division","−":"subtraction",sqrt:"square roots","^":"powers"};function nn(t,e){if(t instanceof Text)return t.textContent||"";if(t.hasClass("cursor"))return"";const s=t.childNodes;return"MI"===t.tagName?t.text+(e?" ":""):"MFENCED"===t.tagName?"("+nn(s[0],e)+")":"MSUP"===t.tagName?"^("+nn(s[0],e)+")":"MFRAC"===t.tagName?`(${nn(s[0],e)})/(${nn(s[1],e)})`:"MSQRT"===t.tagName?"sqrt("+nn(s[0],e)+")":s.map((t=>nn(t,e))).join("")}function on(t,e,s){const i=t.variables;if(e.length){const t=i.find((t=>!e.includes(t)));if(t){const i=function(t,e){const s=t.length/2,i=w(e.map((e=>({w:e,d:P(t,e)}))).filter((({d:t})=>t<s)),(t=>t.d))[0];return i?i.w:void 0}(t,s||e);return i?`Did you mean “<em>${i}</em>” instead of “<em>${t}</em>”?`:`There shouldn’t be a variable called “<em>${t}</em>”.`}const n=e.find((t=>!i.includes(t)));if(n)return`Your expression should contain “<em>${n}</em>”.`}}let rn=class extends Bs{constructor(){super(...arguments),this.isDone=!1,this.shortVar=!1,this.lastAttempt="",this.errorCount=0,this.hints=[],this.fns=[],this.vars=[],this.validate=void 0}ready(){if(this.$math=this.$(".math"),this.$textarea=this.$("textarea"),this.$cursor=this.$(".cursor"),this.$error=this.$(".error-message"),this.solution=Ti.parse(this.attr("solution")),this.hasAttr("numeric")&&(this.numeric=+this.attr("precision")||.01),this.vars=this.hasAttr("vars")?A(this.attr("vars")):this.solution?this.solution.variables:[],this.hasAttr("fns")&&(this.fns=A(this.attr("fns"))),this.solution&&this.fns.push(...this.solution.functions),this.fns.includes("/")&&!this.fns.includes("×")&&this.fns.push("×"),this.hasAttr("hints")&&(this.hints=A(this.attr("hints"))),this.hasAttr("substitutions")){this.substitutions={},this.autocomplete=this.vars.slice(0);for(const t of this.attr("substitutions").split("|"))if(t.trim()){const[e,s]=t.split(":");this.autocomplete.push(e.trim()),this.substitutions[e.trim()]=Ti.parse(s)}}for(const t of["solution","precision","vars","fns","vars-required","substitutions"])this.removeAttr(t);this.shortVar=this.hasAttr("short-var");const t=A(this.attr("keys")||"+ − × ÷ frac sup sqrt brackets"),e=this.$(".keys");for(const s of e.children)t.includes(s.data.type)?(s.on("pointerdown",(t=>t.preventDefault())),s.on("pointerup",(()=>{tn(this.$cursor,s.data.type),this.check()}))):s.remove();this.on("pointerdown",(t=>this.onPointerdown(t))),this.$textarea.on("focus",(()=>this.onPointerdown())),this.$textarea.on("blur",(()=>this.onBlur())),this.$textarea.on("key",(t=>this.onKey(t)))}setup(t,e,s){var i;this.$step=t,(null===(i=null==s?void 0:s.scores)||void 0===i?void 0:i.includes(e))&&this.solve(),this.on("solve",(()=>{t.addHint("correct"),t.score(e)}))}focus(){this.trigger("pointerdown")}onPointerdown(t){if(this.isDone)return;t&&t.preventDefault&&t.preventDefault(),this.addClass("active"),this.$textarea.focus();const e=t&&t.target?rs(t.target):this;if("X-EQUATION"===e.tagName||e.hasClass("math")){const e=$(this.$math.children.map((t=>t.outerWidth)))/2;!t||Se(t).x<this.$math.bounds.left+e?this.$math.prepend(this.$cursor):this.$math.append(this.$cursor)}else if("M"===e.tagName[0]){const s=Se(t).x<e.boxCenter.x;"MROW"===e.tagName?s?e.prepend(this.$cursor):e.append(this.$cursor):s?e.insertBefore(this.$cursor):e.insertAfter(this.$cursor)}}onKey(t){if(i(t.code,Yi.enter,Yi.escape))this.$textarea.blur();else if(t.code===Yi.left)Qi(this.$cursor);else if(t.code===Yi.right)!function(t){const e=t.next;if(e&&i(e.tagName,"MO","MI","MN"))return e.insertAfter(t);e?e.children[0].prepend(t):t.parent.hasClass("math")||(t.parent.next?t.parent.next.prepend(t):t.parent.parent.insertAfter(t))}(this.$cursor);else if(t.code===Yi.up)!function(t){let e=t.parent;for(;"MFRAC"!==e.parent.tagName||!e.prev;){if(e.hasClass("math"))return;e=e.parent}e.prev.append(t)}(this.$cursor);else if(t.code===Yi.down)!function(t){let e=t.parent;for(;"MFRAC"!==e.parent.tagName||!e.next;){if(e.hasClass("math"))return;e=e.parent}e.next.prepend(t)}(this.$cursor);else if(i(t.code,Yi.backspace,Yi.delete))!function(t){const e=t.prev,s=t.parent;if(e&&i(e.tagName,"MO","MI","MN"))e.remove(),s.children.length<=1&&s.addClass("empty");else if(e||s.prev||s.hasClass("math"))Qi(t);else{const e=s.parent;e.insertBefore(t);for(const t of e.children)for(const s of t.children)e.insertBefore(s);e.remove(),t.parent.children.length<=1&&t.parent.addClass("empty")}}(this.$cursor),this.check();else{const e=t.key.replace("*","×").replace("/","÷").replace("-","−");tn(this.$cursor,e),this.check()}}onBlur(){if(this.isDone)return;if(!this.value)return this.removeClass("active has-error");if(this.removeClass("active"),this.addClass("has-error"),this.value===this.lastAttempt)return;if(this.lastAttempt=this.value,!this.$step)return;const t=this.error||(this.hints||[]).shift()||"incorrect",e=this.$step.addHint(t,{class:"incorrect"});this.$error.html=e.text,this.errorCount+=1,this.trigger("error",{count:this.errorCount,msg:t}),this.errorCount>=5&&this.$step.addHint(`Hmmm… maybe try ${this.solution.toMathML()}?`)}check(){if(this.error=void 0,this.value=nn(this.$math,this.shortVar).trim(),!this.value)return;if(this.$math.$(".empty"))return this.error="Fill in all empty placeholders in the expression.";const t=function(t,e){try{return{expr:Ti.parse(t,!0,{variables:e})}}catch(t){return{error:t instanceof Us?t.message:"This is not a valid mathematical expression."}}}(this.value,this.vars);if(t.error)return this.error=t.error;const e=this.substitutions?t.expr.substitute(this.substitutions):t.expr;if(this.numeric&&function(t,e,s=.001){try{return q(t.evaluate(),e.evaluate(),s)}catch(t){return!1}}(this.solution,e,this.numeric))return this.solve();if(this.validate){const e=this.validate(t.expr)||{};if(e.isCorrect)return this.complete(t.expr);if(e.error)return this.error=e.error}if(this.solution&&Ti.numEquals(this.solution,e))return this.complete(t.expr);const s=on(e,this.vars,this.autocomplete);if(s)return this.error=s;const i=function(t,e){if(e.length){const s=t.functions.find((t=>!e.includes(t)));if(s)return`This expression should not contain ${sn[s]||"“"+s+"”"}.`}}(e,this.fns);return i?this.error=i:void 0}complete(t){this.isDone||(this.isDone=!0,this.removeClass("has-error active"),this.addClass("done"),this.$textarea.blur(),this.shortVar||en(this.$math,"mi"),en(this.$math,"mn"),this.trigger("solve",{expr:t}))}solve(){this.$math.removeClass("empty"),this.$math.html=this.solution.toMathML(),this.complete(this.solution)}};rn=e([Rs("x-equation",{template:'<div class="input"><textarea></textarea></div><div class="math empty"><span class="cursor">&#8203;</span></div><div class="keys">\x3c!-- TODO Make these buttons tabbable--\x3e<div class="btn" data-type="+">+</div><div class="btn" data-type="−">−</div><div class="btn" data-type="×">×</div><div class="btn" data-type="÷">÷</div><div class="btn i" data-type="π">π</div><div class="btn" data-type="frac"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#fraction"></use></svg></div><div class="btn" data-type="sup"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#power"></use></svg></div><div class="btn" data-type="sqrt"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#sqrt"></use></svg></div><div class="btn" data-type="brackets"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#brackets"></use></svg></div></div><div class="error"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#form-warn"></use></svg></div><div class="error-message"></div>'})],rn);const hn={opacity:[0,1],transform:["translateX(-50px)","none"]},an={error:"You’ve already had this expression before. Try simplifying it."};let ln=class extends Bs{constructor(){super(...arguments),this.rowCount=1,this.previousAnswers=[],this.isSolved=!1,this.maxRows=6,this.steps=[],this.hints=[]}created(){this.$table=this.$("table tbody"),this.lastRowContent=this.$table.$("tr:last-child").html}ready(){this.hasAttr("max-rows")&&(this.maxRows=+this.attr("max-rows")),this.hasAttr("steps")&&(this.steps=this.attr("steps").split("|")),this.hasAttr("hints")&&(this.hints=this.attr("hints").split("|")),this.removeAttr("steps"),this.removeAttr("hints"),this.setupEquation(this.$("x-equation"))}setup(t,e,s){var i;(null===(i=null==s?void 0:s.scores)||void 0===i?void 0:i.includes(e))&&this.solve(),this.on("solve",(()=>{t.addHint("correct"),t.score(e)})),this.on("hint",(e=>t.addHint(e)))}setupEquation(t){this.$equation=t,t.one("solve",(t=>this.onSolveRow(t.expr))),t.hints=this.hints,t.validate=t=>{const e=this.previousAnswers.includes(t.toString());return(this.validate?this.validate(t,e):void 0)||(e?an:{})}}onSolveRow(t){if(this.trigger("solve-row",{expr:t,$math:this.$equation.$math}),this.isFinal&&this.isFinal(t))return this.trigger("solve");if(this.isSolved)return;if(this.rowCount+=1,this.previousAnswers.push(t.toString()),this.rowCount>this.maxRows){const t=this.$equation.solution.toMathML();this.trigger("hint","You have to fully simplify this expression. The correct solution is $0.".replace("$0",t)),this.trigger("solve")}const e=as("tr",{html:this.lastRowContent},this.$table);e.animate(hn,400,500),this.setupEquation(e.$("x-equation")),setTimeout((()=>this.$equation.focus()),1200)}solve(){if(this.isSolved=!0,this.steps.length){const t=this.$table.$("tr:last-child"),e=this.lastRowContent.replace(/<x-equation.*<\/x-equation>/,'<span class="math fill"></span>');for(const s of this.steps){const i=as("tr",{html:e},this.$table),n=i.$(".math.fill"),o=Ti.parse(s);n.html=o.toMathML(),t.insertBefore(i),this.trigger("solve-row",{expr:o,$math:n})}}this.$equation.solve()}};ln=e([Rs("x-equation-system")],ln);const cn="free-text";let dn=class extends Bs{setup(t,e,s){var i,n;const o=this.$(".text-area"),r=this.$(".toolbar .submit");let h=(null===(i=null==s?void 0:s.data)||void 0===i?void 0:i[cn])||"";h&&(o.html=h);for(const t of this.$$(".toolbar .command")){const e=t.data.command.split(":");t.on("click",(()=>document.execCommand(e[0],!1,e[1])))}let a=h;const l=d((()=>{a!==h&&t.storeData(cn,h),a=h}),5e3);o.on("change keyup input paste",(()=>{h=o.html.replace(/&nbsp;/g," ").trim().slice(0,500).trim(),r.setClass("invisible",h.length<40),l()})),(null===(n=null==s?void 0:s.scores)||void 0===n?void 0:n.includes(e))?r.remove():(r.setClass("invisible",h.length<40),r.on("click",(()=>{l(),t.score(e),r.exit("pop"),this.trigger("submit")})))}};dn=e([Rs("x-free-text",{template:'<div class="text-area" contenteditable="true"></div><div class="toolbar"><button class="command" data-command="bold"><svg class="icon" viewBox="0 0 20 20" width="20" height="20"><use xlink:href="/icons.fed6ed.svg#bold"></use></svg></button><button class="command" data-command="italic"><svg class="icon" viewBox="0 0 20 20" width="20" height="20"><use xlink:href="/icons.fed6ed.svg#italic"></use></svg></button><button class="command" data-command="underline"><svg class="icon" viewBox="0 0 20 20" width="20" height="20"><use xlink:href="/icons.fed6ed.svg#underlined"></use></svg></button><div class="space"></div><button class="btn btn-green submit"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#check-white"></use></svg> Done</button></div>'})],dn);let pn=class extends Bs{ready(){const t=this.$(".wrapper"),e=this.$(".panel"),s=e.children,i=this.$(".next"),n=this.$(".back"),o=this.$(".dots"),r=s.map((()=>as("div",{class:"dot"},o))),h=s.length,a=+this.attr("slide-width")||void 0;let l=this.width,c=1,d=l,p=0,u=0;const f=t=>{u=t,e.translate(t,0),this.trigger("move",t)},g=t=>{p=t;for(const[e,s]of r.entries())s.setClass("on",e>=t&&e<t+c);i.setClass("disabled",t===h-c),n.setClass("disabled",0===t),this.trigger("change",t)};$s.onResize((()=>{l=this.width,c=a?Math.ceil(l/a):1,d=l/c;for(const t of s)t.css("width",d+"px");e.css("width",h*d+"px"),f(-p*d),g(p)}));let m="quad";let v,$,w,x,y=!1;const b=()=>{v=Date.now()-x,f($+w*Cs(m,v/500)),!y&&v<500?requestAnimationFrame(b):this.trigger("slide-end")};function M(t){y=!1,v=0,$=u,w=-t*d-u,x=Date.now(),g(t),b()}let k,A,C,P;i.on("click",(function(){m="quad",p<h-c&&M(p+1)})),n.on("click",(function(){m="quad",p>0&&M(p-1)})),ze(t,{start:t=>{y=!0,k=u,A=t.x,P=C=A},move:t=>{C=P,P=t.x;const e=k-A+t.x,s=-(h-c)*d;f(e>0?e/4:e<s?s+(e-s)/4:e),this.css("pointer-events","none")},end:()=>{const t=P-C,e=t>12?1:t<-12?-1:0;m="quad-out",M(Q(Math.round(-u/d-e),0,h-c)),setTimeout((()=>this.css("pointer-events","auto")))}})}};pn=e([Rs("x-gallery",{template:'<div class="wrapper"><div class="panel"><slot></slot></div></div><div class="nav"><button class="btn back" aria-label="Previous Step"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#left"></use></svg></button><button class="btn next" aria-label="Next Step"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#right"></use></svg></button><div class="dots"></div></div>'})],pn);let un=class extends Bs{constructor(){super(...arguments),this.history=[],this.completed=!1}ready(){const t=this.$(".slide-template");this.slideTemplate=t.html,t.remove(),this.target=(this.attr("target")||"6/8").split("/").map((t=>+t)),this.$dots=this.$(".dots"),this.$dots.css("margin-left",-8*this.target[1]+"px");for(let t=0;t<this.target[1];++t)as("div",{class:"dot"},this.$dots)}setup(t){this.one("score",(()=>t.score("gameplay")))}setSlideGenerator(t){this.slideGenerator=t,this.makeSlide(!0)}score(t=!1){var e;null===(e=this.$currentSlide)||void 0===e||e.addClass("done"),this.$dots.children[this.history.length].addClass(t?"green":"red"),this.history.push(t),!this.completed&&this.history.filter((t=>t)).length>=this.target[0]?(this.completed=!0,this.$("x-solved").enter(),this.trigger("score")):setTimeout((()=>this.makeSlide()),1e3)}makeSlide(t=!1){if(!this.slideGenerator)return;if(this.history.length>=this.target[1]){this.history.shift(),this.$dots.animate({transform:["none","translateX(-16px)"]},300).promise.then((()=>this.$dots.css("transform","none")));const t=this.$dots.children[0];t.exit("fade",300).promise.then((()=>t.remove()));as("div",{class:"dot"},this.$dots).enter("fade",300)}if(this.$currentSlide){const t=this.$currentSlide;t.animate({transform:["none","translateX(-100%)"]},400).promise.then((()=>t.remove()))}const e=as("div",{class:"slide",html:this.slideTemplate},this);t||e.animate({transform:["translateX(100%)","none"]},400),this.$currentSlide=e,this.slideGenerator(e,(()=>this.score(!0)),(()=>this.score()))}};un=e([Rs("x-gameplay",{template:'<div class="dots"></div><div class="slide-template"><slot></slot></div><x-solved></x-solved>'})],un);var fn='<span class="target" tabindex="0"><slot></slot></span><div class="popup"></div>';const gn=JSON.parse(rs("#glossary").text),mn=JSON.parse(rs("#bios").text);let vn;$s.onResize((()=>{vn&&vn.hide()}));let $n=class extends Bs{ready(){this.xid=this.attr("xid"),this.$target=this.$(".target"),this.$popup=this.$(".popup"),this.$popup.html=this.body()||"",this.setClass("left",$s.width>600&&this.$target.bounds.left+this.$popup.width>$s.width-15),Ee(this,{enter:()=>this.show(),exit:()=>this.hide(),delay:100,exitDelay:200,$clickTarget:this.$target,canFocusWithin:!0,preventMouseover:()=>$s.width<=600})}show(){if(vn=this,this.addClass("on"),$s.width<=600){const t=rs("#glossary-modal");return t.$(".modal-body").html=this.body(),t.open()}const t=this.$target.bounds,e=this.$popup.width,s=this.$popup.height,i=t.top+t.height+s<$s.height-10,n=t.top-s>(window.isWebView?10:54);this.setClass("top",n&&!i),this.setClass("left",t.left+e>$s.width-15)}hide(){vn=void 0,this.removeClass("on")}body(){const t=gn[this.xid];if(!t)return console.warn("missing gloss:",this.xid);let e=t.text;if(t.image&&(e+=`<img class="gloss-img" alt="" src="/resources/shared/glossary/${t.image}"/>`),t.link&&!window.isWebView){location.pathname===t.link.split("#")[0]||(e+=`<p><a href="${t.link}" class="btn btn-white btn-small">Learn more…</a></p>`)}return e}};$n=e([Rs("x-gloss",{template:fn})],$n);let wn=class extends $n{body(){const t=mn[this.xid];if(!t)return console.warn("missing bio:",this.xid);const e=`<img class="bio-img" alt="" src="/resources/shared/portraits/${this.xid}.jpg"/>`,s=t.born?`<p><a href="/timeline/${this.xid}" class="btn btn-white btn-small" target="_blank">Timeline</a></p>`:"";return(!1===t.image?"":e)+t.bio+s}};wn=e([Rs("x-bio",{template:fn})],wn);const xn=document.createElement("a").relList.supports("ar");let yn,bn=!1,Mn={x:0,y:0,s:1};const kn=as("div",{class:"lightbox-overlay"},ls),An=as("div",{class:"lightbox-img"},kn);function Cn(){bn&&(bn=!1,kn.removeClass("on"),An.setTransform(Mn,0,Mn.s),setTimeout((()=>{yn.css("visibility","visible"),kn.css("display","none"),An.css("transform","none"),An.removeClass("transitions")}),400))}kn.on("click touchmove",Cn),$s.onKey("escape",Cn),kn.on("scrollwheel touchmove",(t=>{t.preventDefault(),t.stopPropagation()})),$s.onKey("space up down left right pagedown pageup",(t=>{bn&&(t.preventDefault(),t.stopPropagation())}));let Pn=class extends Bs{ready(){const t=this.attr("src"),e=this.$(".wrap"),s=this.attr("width"),i=this.attr("height");this.css("width",s+"px"),e.css("padding-bottom",+i/+s*100+"%");const n=e.$("img");n.setAttr("src",t),n.setAttr("alt",this.attr("alt")||""),t.endsWith(".gif")&&n.on("click",(()=>n.setAttr("src",t)));const o=e.$(".credit"),r=this.attr("credit");r?o.text=r:o.remove();const h=e.$(".zoom");if(this.hasAttr("lightbox")){this.addClass("interactive");const e=t.replace(/\.(?=[^.]*$)/,"-large.");this.on("click",(()=>function(t,e,s){bn=!0,yn=t,kn.show(),An.show();const i=t.bounds,n=An.bounds,o=i.left+i.width/2-n.left-n.width/2,r=i.top+i.height/2-n.top-n.height/2,h=Math.max(i.width/n.width,i.height/n.height);Mn={x:o,y:r,s:h},An.css("background-image",`url(${s}), url(${e})`),An.css("transform",`translate(${o}px, ${r}px) scale(${h})`),$s.redraw(),An.addClass("transitions"),$s.redraw(),t.css("visibility","hidden"),kn.addClass("on"),An.css("transform","scale(1) translate(0,0)")}(this,t,e)))}else h.remove();if(xn&&this.hasAttr("ar")){const t=as("a",{href:this.attr("ar"),rel:"ar"});e.prepend(t),t.append(n)}}};Pn=e([Rs("x-img",{template:'<div class="wrap"><img alt=""><div class="credit"></div><button class="zoom"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#fullscreen"></use></svg></button><slot></slot></div>'})],Pn);let Tn=class extends Bs{constructor(){super(...arguments),this.correctCount=0,this.solvedCount=0,this.isSolved=!1}setup(t,e,s){var i;const n=this.children,o=n.map((()=>!1));for(const[e,s]of n.entries()){const i=s.data.error,n=i?"incorrect":"correct";i||(this.correctCount+=1),s.one("click",(()=>{o[e]||this.isSolved||(t.addHint(i||"correct",{class:n}),s.addClass(n),i||(this.solvedCount+=1,t.score("picker-"+e),this.checkSolved()))}))}const r=(null===(i=null==s?void 0:s.scores)||void 0===i?void 0:i.filter((t=>t.startsWith("picker-"))))||[];for(const t of r){const e=+t.slice(7);o[e]=!0,n[e].addClass("correct")}this.solvedCount=r.length,this.checkSolved()}checkSolved(){this.solvedCount<this.correctCount||(this.addClass("solved"),this.isSolved=!0)}};Tn=e([Rs("x-picker")],Tn);let Sn=class extends Bs{constructor(){super(...arguments),this.visible=!0}ready(){this.on("click",(()=>{this.play(),setTimeout((()=>this.trigger("play")),400)}))}play(){this.visible&&(this.visible=!1,this.exit("pop",400))}reset(){this.visible||(this.visible=!0,setTimeout((()=>this.enter("pop")),400))}};Sn=e([Rs("x-play-btn",{template:'<button class="play-btn-box" aria-label="Play"><svg class="icon" viewBox="0 0 44 44" width="44" height="44"><use xlink:href="/icons.fed6ed.svg#play"></use></svg></button>'})],Sn);let Ln=class extends Bs{constructor(){super(...arguments),this.playing=!1}ready(){this.$icon=this.$("x-icon-btn"),this.$("button").on("click",(()=>this.toggle()))}toggle(){this.playing?this.pause():this.play()}play(){this.playing||(this.playing=!0,this.$icon.setAttr("icon","pause"),this.trigger("play"))}pause(){this.playing&&(this.playing=!1,this.$icon.setAttr("icon","play"),this.trigger("pause"))}};Ln=e([Rs("x-play-toggle",{template:'<x-icon-btn icon="play"></x-icon-btn>'})],Ln);let _n=class extends Bs{ready(){const t=this.children[0],e=+this.attr("width")||760;t.css("width",e+"px");const s=t.height;$s.onResize((()=>{const i=this.width/e;this.css("height",s*i+"px"),t.css("transform",`scale(${i})`)}))}};_n=e([Rs("x-scale-box",{template:"<div><slot></slot></div>"})],_n);let zn=class extends Bs{constructor(){super(...arguments),this.current=0}ready(){this.onAttr("steps",(t=>this.steps=+t)),this.speed=+this.attr("speed")||1;const t=this.$(".bar"),e=this.$(".knob"),s=this.hasAttr("continuous"),i=this.hasAttr("snap")?t.width/this.steps:.001;this.drag=new _s(e,t,{moveY:!1,snap:i}),this.drag.on("start",(()=>{this.animation&&this.animation.cancel(),this.animation=void 0})),this.drag.on("move",(t=>{let e=t.x/this.drag.width*this.steps;s||(e=Math.round(e)),q(e,this.current)||(this.current=e,this.trigger("move",e))})),this.drag.on("end",(()=>this.trigger("slide-end")));const n=this.$(".play");this.hasAttr("no-play")?n.remove():n.on("click",(()=>this.play()))}setup(t,e){this.bindModel(t.model),this.one("slide-end",(()=>t.score(e)))}set(t){q(t,this.current)||this.drag.setPosition(t*this.drag.width/this.steps,0)}play(){return s(this,void 0,void 0,(function*(){this.current>=this.steps&&this.set(0);const t=3e3*(1-this.current/this.steps)/this.speed;this.moveTo(this.steps,t)}))}moveTo(t,e=600){return s(this,void 0,void 0,(function*(){if(this.animation||t===this.current)return;const s=this.current;this.animation=ks((e=>{this.set(s+(t-s)*Cs("quad",e))}),e),yield this.animation.promise,this.animation=void 0,this.trigger("slide-end")}))}bindVariable(t,e){t[e]=0,this.on("move",(s=>t[e]=s)),t.watch((()=>this.set(t[e])))}};zn=e([Rs("x-slider",{template:'<button class="play" aria-label="Play Slider"><svg class="icon" viewBox="0 0 32 32" width="32" height="32"><use xlink:href="/icons.fed6ed.svg#play"></use></svg></button><div class="bar"><div class="knob"></div></div>'})],zn);let En=class extends Bs{constructor(){super(...arguments),this.length=0,this.current=0,this.locked=!1}ready(){this.$legend=this.$(".legend-box"),this.$steps=this.$legend.children,this.$back=this.$(".back"),this.$next=this.$(".next");const t=this.$(".dots");this.$dots=this.$steps.map((()=>as("div",{class:"dot"},t))),this.length=this.$steps.length,this.current=0,this.$back.on("click",(()=>this.goBack())),this.$next.on("click",(()=>this.goNext())),this.blanks=this.$steps.map((t=>function(t){const e=t.$$("x-blank, x-blank-input");if(!e.length)return Promise.resolve();let s=0;return new Promise((t=>{for(const i of e)i.on("solve",(()=>{s+=1,s>=e.length&&t()}))}))}(t))),this.reveals=this.$$("[slide]").map((t=>{const e=t.attr("slide").split("-"),s=e.length>1?[+e[0]||0,+e[1]||this.length]:[+e[0],+e[0]],i=[t.data.animation||"fade",+t.data.duration||400];return t.data.display="visibility",s[0]>=0&&!t.hasClass("reveal")&&t.hide(),[t,s,i]})),this.autoAdvance="auto"===this.attr("step"),this.$steps[0].show(),this.$dots[0].addClass("on"),this.setupSlide(0)}setup(t,e,s){var i;const n=null===(i=null==s?void 0:s.scores)||void 0===i?void 0:i.filter((t=>t.startsWith("slide-"))).length;if(n&&n<this.$steps.length-1){this.go(n);for(let t=1;t<=n;++t)this.trigger("next",t)}this.on("next",(e=>t.score("slide-"+(e-1))))}go(t){if(this.locked||t<0||t>this.length-1||t===this.current)return;this.locked=!0,setTimeout((()=>this.locked=!1),600),this.$back.setClass("disabled",0===t),this.$next.setClass("disabled",t===this.length-1),this.$dots[this.current].removeClass("on"),this.$dots[t].addClass("on"),this.$steps[t].show();const e=this.$steps[t].height+"px";this.$steps[t].hide(),this.$steps[this.current].exit("fade",300).promise.then((()=>this.$steps[t].enter("fade",300))),this.$legend.animate({height:e},600).promise.then((()=>this.$legend.css("height","auto"))),this.setupSlide(t),this.current=t,this.trigger("step",t)}setupSlide(t){this.$next.setAttr("disabled","true"),this.blanks[t].then((()=>this.$next.removeAttr("disabled")));for(const[e,s,i]of this.reveals){if(e.hasClass("reveal"))continue;const n="hidden"!==e.css("visibility"),o=t>=s[0]&&t<=s[1];o&&!n&&e.enter(...i,300),!o&&n&&e.exit(...i)}}goNext(){this.locked||(this.go(this.current+1),this.trigger("next",this.current))}goBack(){this.locked||(this.go(this.current-1),this.trigger("back",this.current))}};En=e([Rs("x-slideshow",{template:'<slot name="stage"></slot><div class="nav"><button class="btn back disabled" aria-label="Previous Step"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#left"></use></svg></button><button class="btn next" aria-label="Next Step"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#right"></use></svg></button><div class="dots"></div></div><div class="legend-box"><slot></slot></div>'})],En);const In=x(["red","orange","lime","green","teal","blue","purple"]),On=x(["badge","homework","laurels","lightbulb","owl","scroll","trophy"]);let qn=class extends Bs{constructor(){super(...arguments),this.visible=!1}ready(){this.$svg=this.$(".sketch use"),this.$text=this.$(".message"),this.$(".close").on("click",(()=>this.exit()))}enter(){if(this.visible)return Ms;this.visible=!0;const t=this.parents("x-step")[0],e=t?t.addHint("correct").text:"Well done!";return this.setAttr("class","gradient-"+In()),this.$text.text=e.replace(/<.*?>/g,""),this.$svg.setAttr("xlink:href","/sketch.svg#"+On()),ys(),Ss(this,"pop",300,600)}exit(){return this.visible?(this.visible=!1,Ls(this,"pop",300)):Ms}};function Vn(t,e){const s=function(t){let e=0;return t.map((t=>e+=t))}(t.map((t=>t.h+10)));for(const[i,n]of t.entries())n!==e&&n.drag.setPosition(0,s[i-1]||0)}qn=e([Rs("x-solved",{template:'<button class="close"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#close"></use></svg></button><svg class="sketch sketch-" viewBox="0 0 160 160" width="160" height="160"><use xlink:href="/sketch.5903d1.svg#"></use></svg><div class="message">Well done!</div>'})],qn);let Bn=class extends Bs{ready(){this.items=this.children.map((t=>({drag:new _s(t,this,{moveX:!1,useTransform:!0}),index:+t.data.index,h:0})));for(const t of this.children)t.removeAttr("data-index");for(const t of this.items)t.drag.on("drag",(()=>{this.items=w(this.items,(e=>e.drag.position.y-(e===t?10:0))),Vn(this.items,t)})),t.drag.on("end",(()=>{var t;Vn(this.items),((t=this.items).every(((t,e)=>t.index===e))||t.every(((e,s)=>e.index===t.length-s-1)))&&this.solve()}));$s.onResize((()=>{for(const t of this.items)t.h=t.drag.$el.height;const t=$(this.items.map((t=>t.h)));this.css("height",t+10*this.items.length-10+"px"),Vn(this.items)}))}setup(t,e,s){var i;(null===(i=null==s?void 0:s.scores)||void 0===i?void 0:i.includes(e))&&this.solve(),this.one("solve",(()=>{t.addHint("correct"),t.score(e)}))}solve(){this.trigger("solve"),this.addClass("solved");for(const t of this.items)t.drag.disabled=!0}};Bn=e([Rs("x-sortable")],Bn);const Rn=x(["#cd0e66","#0f82f2","#22ab24","#fd8c00"]);class Dn{constructor(t){this.index=t,this.color=Rn(),this.tilt=Math.floor(10*Math.random())-10,this.tiltAngleIncrement=.07*Math.random()+.05,this.tiltAngle=0,this.x=Math.random()*$s.width,this.y=(Math.random()-1)*$s.height,this.r=mt.uniform(10,30)}draw(t){t.beginPath(),t.lineWidth=this.r/2,t.strokeStyle=this.color,t.moveTo(this.x+this.tilt+this.r/4,this.y),t.lineTo(this.x+this.tilt,this.y+this.tilt+this.r/4),t.stroke()}update(t,e){this.tiltAngle+=this.tiltAngleIncrement,this.y+=(Math.cos(t)+3+this.r/2)/2,this.x+=Math.sin(t),this.tilt=15*Math.sin(this.tiltAngle-this.index/3),this.x<-20?(this.x=-20,this.y=Math.random()*$s.height,this.tilt=Math.floor(10*Math.random())-20):this.x>$s.width+20?(this.x=$s.width+20,this.y=Math.random()*$s.height,this.tilt=Math.floor(10*Math.random())-20):e&&this.y>$s.height&&(this.x=Math.random()*$s.width,this.y=-10,this.tilt=Math.floor(10*Math.random())-20)}}let jn;function Nn(t=2e3,e=150){jn||(jn=as("canvas",{style:"position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999"},ls)),jn.setAttr("width",$s.width),jn.setAttr("height",$s.height),jn.show();const s=jn.ctx,i=g((t=>new Dn(t)),e),n=ks((e=>{s.clearRect(0,0,$s.width,$s.height);const o=e<t;let r=0;for(const t of i)t.draw(s),t.update(e,o),t.y<$s.height&&(r+=1);r||(n.cancel(),jn.hide())}))}function Hn(t,e=!1){return s(this,void 0,void 0,(function*(){if("visible"===t.css("visibility"))return;t.data.display="visibility";const s=+t.data.duration||400,i=(e?0:600)+(+t.data.delay||0);yield t.enter(t.data.animation||"fade",s,i).promise,t.css({opacity:"",transform:""}),t.trigger("reveal"),t.removeClass("reveal")}))}let Zn=class extends Bs{constructor(){super(...arguments),this.model=He({}),this.isShown=!1,this.isCompleted=!1,this.scores=new Set,this.tools={confetti:Nn}}ready(){var t,e,s;this.$course=this.parents("x-course")[0],this.$blanks=this.$$("x-blank, x-blank-input"),this.$components=this.$$("[goal]"),this.userData=null===(s=null===(e=null===(t=null==this?void 0:this.$course)||void 0===t?void 0:t.userData)||void 0===e?void 0:e.steps)||void 0===s?void 0:s[this.id],this.goals=A(this.attr("goals")),this.$reveals=this.$$(".reveal");const i=this.$$(".check[data-when]");for(const t of[...this.$reveals,...i])this.onScore(t.data.when,(()=>Hn(t)));this.$nextBtn=this.$$(".next-step");for(const[t,e]of this.$nextBtn.entries())this.onScore("next-"+t,(()=>e.exit("pop"))),e.one("click",(()=>this.score("next-"+t)));for(const t of this.$$(".step-target"))"X-TARGET"!==t.tagName&&Ee(t,{enter:()=>{const e=this.$$('[target~="'+t.data.to+'"]');for(const t of e)t.addClass("focus");this.addClass("focus"),this.trigger("target-focus",{$targets:e})},exit:()=>{for(const t of this.$$(".focus"))t.removeClass("focus");this.removeClass("focus")}});for(const t of this.$$(".var, .var-action"))t.bindModel(this.model);this.$course&&this.$course.audio&&(this.narration=new Hs(this.$course.audio,this))}show(){var t;if(this.isShown)return;this.isShown=!0;const e=C(this.id);window.StepFunctions&&window.StepFunctions[e]&&window.StepFunctions[e](this);for(const t of this.$components)t.setup(this,t.attr("goal"),this.userData);const s=(null===(t=this.userData)||void 0===t?void 0:t.scores)||[];for(const t of s)this.score(t,!1);const i=this.$$("x-gesture[target]");setTimeout((()=>{if(!this.isReady)for(const t of i)t.start()}),2e3),this.$course&&this.$course.log("Step","show",this.id),this.trigger("show"),this.addClass("on"),this.narration&&setTimeout((()=>this.narration.play()),400)}complete(){if(!this.isCompleted){this.isShown||this.show(),this.isCompleted=!0;for(let t=0;t<this.$nextBtn.length;++t)this.score("next-"+t);for(const t of this.$reveals)t.parents("svg").length||Hn(t,!0);this.trigger("complete")}}get isReady(){return this.goals.every((t=>this.scores.has(t)))}get isPageLoaded(){return!this.$course||this.$course.isReady}score(t,e=!0){this.scores.has(t)||(this.scores.add(t),this.trigger("score-"+t),this.trigger("score"),this.$course&&(this.$course.trigger("score"),this.$course.saveProgress({steps:{[this.id]:{scores:[t]}}}),this.$course.log("Step","score",this.id+"/"+t)),e&&this.isReady&&this.$course&&this.$course.isReady&&setTimeout((()=>{this.$course.$activeStep===this&&this.$course.nextStep()}),1200))}storeData(t,e){this.$course&&this.$course.saveProgress({steps:{[this.id]:{data:{[t]:e}}}})}onScore(t,e){const s=A(t);if(s.every((t=>this.scores.has(t))))return e&&e(),Promise.resolve();const i=l(),n=()=>{s.every((t=>this.scores.has(t)))&&(e&&e(),i.resolve(),this.off("score",n))};return this.on("score",n),i.promise}addHint(t,e={}){return this.trigger("hint",t),this.$course&&this.$course.isReady?this.isInViewport?this.$course.$tutor.showHint(t,e):(this.one("enterViewport",(()=>this.$course.$tutor.showHint(t,e))),{text:this.$course.$tutor.hints[t]||t}):{text:t}}delayedHint(t,e=1e4){let s=setTimeout(t,e);this.on("score",(()=>{clearTimeout(s),this.isCompleted||(s=setTimeout(t,2e4))})),this.on("complete",(()=>clearTimeout(s)))}getHelp(){}getText(t){var e;return(null===(e=null==this?void 0:this.$course)||void 0===e?void 0:e.$tutor.hints[t])||t}get nextStep(){if(!this.$course)return;const t=this.$course.$steps.indexOf(this);return this.$course.$steps[t+1]}groupBlanks(...t){const e=t.map((t=>this.$blanks[t]));for(const t of e)t.linkedBlanks=e}};Zn=e([Rs("x-step")],Zn);const Fn=hs("header, x-tutor, .sidebar"),Un=as("svg",{class:"target-body",html:'<defs><mask id="masking"><rect width="100%" height="100%" fill="white"></rect></mask></defs><marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5" markerWidth="4" markerHeight="4" orient="auto"><path d="M 0 0 L 10 5 L 0 10 z"></path></marker><rect x="0" y="0" width="100%" height="100%" mask="url(#masking)" opacity="0.8"></rect><path class="target-arrow" stroke-width="5" marker-end="url(#arrow)" opacity="0.4" stroke-linecap="round"></path>'},ls),Wn=Un.$("mask"),Kn=Un.$(".target-arrow");let Gn=!1,Xn=[],Yn=class extends Bs{ready(){this.setAttr("tabindex",0);const t=this.attr("to").replace(/_/g," "),e=this.hasClass("no-margins");let s,n,o,r;const a=()=>{Gn=!0;const i=hs(t);if(!i.length)return;const n=i[0].hasParent(...Fn);void 0===s&&(s=this.hasParent(...Fn));const r=this.bounds,h=i.map((t=>t.bounds)).filter((t=>t.width||t.height));if(o=0,!n){const t=Math.min(...h.map((t=>t.top))),e=Math.max(...h.map((t=>t.top+t.height))),s=$s.height-12-e,i=(window.isWebView?12:56)-t;o=s<0?s:i>0?i:0}for(const t of Xn)t.remove();Xn=[r,...h].map(((t,i)=>{const n=!i||e?4:10;return as("rect",{x:t.left-n,y:t.top-n+(i||!s?o:0),width:t.width+2*n,height:t.height+2*n,rx:i?4:18,ry:i?4:18},Wn)})),Kn.points=function(t,e,s,i){const n=new Mt(t.left-15,t.top+s-15),o=new Xt(n,t.width+30,t.height+30),r=new Mt(e.left-15,e.top+i-15),h=new Xt(r,e.width+30,e.height+30),a=new St(o.center,h.center);return[Ut(a,o)[0],Ut(a,h)[0]]}(r,h[0],s?0:o,n?0:o)},l=()=>{o&&ls.scrollBy(-o,300),Un.css("display","block"),$s.redraw(),h((function(){Un.css("opacity",1)}),o?300:0)},c=t=>{if(Gn){if(t){if(i(t.type,"mousemove","pointermove")&&(e=n,s=[t.clientX,t.clientY],Math.abs(e[0]-s[0])+Math.abs(e[1]-s[1])<40))return}var e,s;clearTimeout(r),Gn=!1,Un.css("opacity",0),setTimeout((()=>{Gn||Un.css("display","none")}),300),ls.off("mousewheel mousemove touchend touchmove",c),this.off("mouseleave blur",c)}},d=()=>{o&&!s?ls.on("mousemove",c):this.on("mouseleave",c),ls.on("mousewheel touchend touchmove",c),this.on("blur",c)};this.on("mouseenter touchstart focus",(t=>{n=[t.clientX,t.clientY],a(),r=window.setTimeout(l,o?50:30),d()})),this.on("click",(e=>{Gn?(e.handled=!0,c(),setTimeout((()=>rs(t).trigger("click mousedown")))):(Gn=!0,o=0,l(),d())}))}};Yn=e([Rs("x-target")],Yn);const Qn=/[0-9+\-*/()^\s]+/g;function Jn(t,e,s={}){const n=as("div",{class:"msg-wrap","data-display":"flex"}),o=as("div",{class:"msg "+e},n);return s.class&&o.addClass(s.class),s.visible||n.hide(),i(e,"hint","question")?o.html=t:"img"===e?o.css("background-image",`url(${t})`):"video"===e&&as("iframe",{src:t,allowfullscreen:!0},o),n}let to=class extends Bs{constructor(){super(...arguments),this.recentMessages=[],this.isOpen=!1,this.queuePromise=Promise.resolve()}ready(){this.$course=this.parents("x-course")[0],this.hints=this.$course?JSON.parse(this.$course.$("#hints").text):{},this.correct=x(mt.shuffle(this.hints.correct||[])),this.incorrect=x(mt.shuffle(this.hints.incorrect||[])),this.$toasts=this.$(".toasts"),this.$chat=this.$(".chat"),this.$chatBody=this.$(".chat-body"),this.$toasts.on("click",(t=>{t.handled||this.open()})),this.$(".close").on("click",(()=>this.close()));const t=this.$(".chat-footer");this.$query=t.$(".input"),this.$query.onKeyDown("enter",(t=>{t.preventDefault(),this.askQuestion(this.$query.text.trim()),this.$query.text=""})),this.$query.on("focus",(()=>t.addClass("focus"))),this.$query.on("blur",(()=>t.removeClass("focus"))),this.$(".hint").on("click",(()=>{this.queue(this.hints.tutorial1),this.queue(this.$course.user?this.hints.tutorial2:this.hints.account)}))}open(){this.isOpen||(this.isOpen=!0,this.$chat.enter("slide-up",200),this.$chatBody.scrollTop=this.$chatBody.scrollHeight,this.trigger("open"))}close(){this.isOpen&&(this.isOpen=!1,this.$query.blur(),this.trigger("close"),this.$chat.exit("slide-down",200))}queue(t,e="hint",s={}){this.queuePromise=this.queuePromise.then((()=>(this.display(t,e,s),a(500))))}display(t,e="hint",s={}){let i=s.timeout||8e3;$s.width<640&&(i*=.7);if((null==s.toast||s.toast)&&!this.isOpen){const n=Jn(t,e,s);n.setAttr("role","alert"),this.$toasts.append(n),n.enter("reveal-right"),setTimeout((()=>n.exit("reveal-right",400,0,!0)),i),this.on("open",(()=>n.exit("reveal",200,0,!0)))}const n=Jn(t,e,{class:s.class,visible:!this.isOpen});this.$chatBody.append(n),this.isOpen&&(n.enter("reveal",300),ks((()=>this.$chatBody.scrollTop=this.$chatBody.scrollHeight),200))}showHint(t,e={}){if(i(t,"correct","incorrect")){const s="correct"===t?this.correct():this.incorrect(),i="correct"===t?3e3:5e3;return this.queue(s,"hint",{class:e.class||t,timeout:i}),{text:s}}let s=this.hints[t]||t;if(e.variables)for(const[t,i]of Object.entries(e.variables))s=s.replace(new RegExp("\\$"+t,"g"),i);return!e.force&&this.recentMessages.includes(t)||(this.recentMessages.push(t),setTimeout((()=>this.recentMessages.shift()),1e4),!1!==e.store&&this.$course&&this.$course.saveProgress({hints:[{content:s,kind:"hint"}]}),this.queue(s,"hint",{class:e.class})),{text:s}}askQuestion(t){if(!t)return;this.queue(t,"question"),this.$course&&this.$course.log("Tutor","ask",t);const e=(t.match(Qn)||[]).filter((t=>t.length>=3&&!t.match(/^[\s0-9]+$/)));if(e.length)try{const t=Ti.parse(e[0],!0),s=Ti.parse("="+t.evaluate());return this.queue(`<span class="math">${t.toMathML()}${s.toMathML()}</span>`)}catch(t){console.log("Parse Error:",e[0])}}meanEasterEgg(){}};to=e([Rs("x-tutor",{template:'<div class="toasts"><div class="msg-wrap"><button class="msg archie" aria-label="Virtual Tutor"><slot name="icon"></slot></button></div></div><div class="chat" data-display="flex"><div class="chat-header"><slot name="header"></slot><button class="close"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#close"></use></svg></button></div><div class="chat-body"></div><div class="chat-footer"><div class="input" contenteditable></div><button class="hint"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#lightbulb"></use></svg></button></div></div>'})],to);const eo=as("div",{class:"var-overlay"},ls);let so=class extends Bs{constructor(){super(...arguments),this.valueChange=!1}ready(){const t=this.attr("bind");if(!t)return;const[e,s,i]=t.split("|");[this.min,this.max,this.step]=i.split(",").map((t=>+t)),this.name=e,this.model=this.getParentModel(),this.$(".content").bindModel(this.model),this.$progress=this.$(".progress"),this.setValue(+s);const n=20*($s.isMobile?1.5:1)/Q((this.max-this.min)/this.step/12,1,3);let o=0,r=0;for(const t of this.$$(".left, .right")){const e=t.hasClass("left")?-this.step:this.step;t.on("click",(()=>{this.setValue(this.value+e),this.trigger("slide-end")}))}ze(this,{start:t=>{o=t.x,r=this.value,this.addClass("on"),this.valueChange=!1,eo.show(),cs.addClass("grabbing")},move:t=>{const e=(t.x-o)/n;this.setValue(r+X(e)*this.step)},end:()=>{this.removeClass("on"),this.valueChange&&this.trigger("slide-end"),eo.hide(),cs.removeClass("grabbing")}})}setup(t,e){this.one("slide-end",(()=>t.score(e)))}setValue(t){const e=X(Q(t,this.min,this.max),2);if(e===this.value)return;this.value=e,this.valueChange=!0,this.model&&(this.model[this.name]=e);const s=this.max-this.min;this.$progress.css("width",116*(e-this.min)/s+"px")}};so=e([Rs("x-var",{template:'<div class="left" tabindex="0"><svg class="icon" viewBox="0 0 14 14" width="14" height="14"><use xlink:href="/icons.fed6ed.svg#left"></use></svg></div><div class="content"><slot></slot></div><div class="right" tabindex="0"><svg class="icon" viewBox="0 0 14 14" width="14" height="14"><use xlink:href="/icons.fed6ed.svg#right"></use></svg></div><div class="bubble"><div class="bubble-box"><div class="progress"></div></div><div class="bubble-arrow"></div></div>'})],so);function io(t){const e=Math.floor(t/60),s=Math.floor(t%60);return e+":"+(s<10?"0":"")+s}let no=class extends Bs{ready(){const t=this.attr("src"),e=this.$(".video-wrap"),s=this.$("video"),i=this.attr("width"),n=this.attr("height");this.css("width",i+"px"),e.css("padding-bottom",+n/+i*100+"%"),s.setAttr("poster",this.attr("poster")||t.replace(/mp4$/,"jpg")),this.hasAttr("loop")&&(s._el.loop=!0),this.hasAttr("audio")||(s._el.muted=!0),as("source",{src:t,type:"video/mp4"},s),this.hasAttr("credit")&&(this.$(".credit").text=this.attr("credit"));const o=this.$(".bar"),r=this.$(".progress"),h=this.$(".buffer"),a=this.$(".timecode"),l=new _s(this.$(".handle"),o,{moveY:!1}),c=this.video=s._el;let d=this.width-110;$s.onResize((()=>d=this.width-110)),s.on("canplay",(()=>{a.text=io(+c.duration)})),s.on("timeupdate",(()=>{const t=c.currentTime/c.duration;r.css("width",100*t+"%"),a.text=io(+c.currentTime),l.setPosition(t*d,0),this.trigger("timeupdate",c.currentTime)})),s.on("progress",(()=>{if(c.buffered.length<=0||c.duration<=0)return;const t=c.buffered.end(c.buffered.length-1)/c.duration*100;h.css("width",t+"%")})),s.on("ended",(()=>{c.pause(),this.removeClass("playing"),this.trigger("end")}));const p=()=>c.paused?this.play():this.pause(),u=t=>this.setTime(t/d*c.duration);this.hasAttr("hover")?(s.on("mouseover touchstart",(()=>this.play())),s.on("mouseout touchend touchcancel",(()=>this.pause()))):s.on("click",p),this.hasAttr("controls")&&(this.$(".controls").show(),this.$(".play-pause-btn").on("click",p),l.on("start",(()=>this.pause())),l.on("drag",(t=>u(t.x))),o.on("click",(t=>u(t.offsetX))))}setTime(t){this.video.currentTime=t}play(){this.video.play(),this.addClass("playing"),this.trigger("play")}pause(){this.video.pause(),this.removeClass("playing")}};no=e([Rs("x-video",{template:'<div class="video-wrap"><video preload playsinline></video></div><div class="credit"></div><x-play-btn></x-play-btn><div class="controls"><div class="shadow"></div><div class="play-pause-btn"><div class="play-icon" tabindex="0" aria-label="Play Video"><svg class="icon" viewBox="0 0 32 32" width="32" height="32"><use xlink:href="/icons.fed6ed.svg#play"></use></svg></div><div class="pause-icon"><svg class="icon" viewBox="0 0 32 32" width="32" height="32"><use xlink:href="/icons.fed6ed.svg#pause"></use></svg></div></div><div class="timeline"><div class="bar"><div class="background"></div><div class="buffer"></div><div class="progress"></div></div><div class="handle"></div></div><div class="timecode"></div></div>'})],no);function oo(t,e){const s=e.positionLeft-t.positionLeft+e.width/2,i=e.positionTop-t.positionTop+e.height/2;return new Mt(s,i)}function ro(t){return t?new Mt(...t.split(",").map((t=>+t))):void 0}let ho=class extends Bs{constructor(){super(...arguments),this.doAnimation=!1}created(){this.slide=ro(this.attr("slide")),this.shift=ro(this.attr("offset"))}ready(){this.$target=rs(this.attr("target")),this.$target&&(this.$target.on("click pointerdown focus",(()=>this.stop())),this.hasAttr("start")&&this.start())}setTarget(t,e,s){this.$target="string"==typeof t?rs(t):t,e&&(this.slide=e),s&&(this.slide=s)}start(t){this.doAnimation||!this.from&&!this.$target||(this.doAnimation=!0,t&&(this.slide=t),this.slide||this.$end?this.runSlideAnimation():this.runClickAnimation())}startSlide(t,e){this.$target=t,this.$end=e,this.start()}stop(){this.doAnimation=!1}runSlideAnimation(){return s(this,void 0,void 0,(function*(){this.show();let t=this.from||oo(this,this.$target);this.shift&&(t=t.add(this.shift));const e=this.slide?t.add(this.slide):oo(this,this.$end),s=`translate(${t.x-15}px,${t.y-10}px)`,i=`translate(${e.x-15}px,${e.y-10}px)`;yield this.animate({transform:[s+" scale(2)",s],opacity:[0,1]},300).promise,yield this.animate({transform:[s,i]},1e3).promise,yield this.animate({transform:[i,i+" scale(2)"],opacity:[1,0]},300).promise,this.hide(),setTimeout((()=>{this.doAnimation&&this.runSlideAnimation()}),1e3)}))}runClickAnimation(){return s(this,void 0,void 0,(function*(){this.show();let t=this.from||oo(this,this.$target);this.shift&&(t=t.add(this.shift));const e=`translate(${t.x-15}px,${t.y-10}px)`;yield this.animate({transform:[e+" scale(2)",e],opacity:[0,1]},500).promise,yield this.animate({transform:[e,e+" scale(2)"],opacity:[1,0]},500,200).promise,this.hide(),setTimeout((()=>{this.doAnimation&&this.runClickAnimation()}),1e3)}))}};ho=e([Rs("x-gesture",{template:'<svg width="70" height="80"><path d="M20.5,7.4,27.2,24c-1.9-4.7,6-7.1,8-2.3l1.4,3.6c-1.9-4.8,6.1-7.1,8-2.3l1.3,3.1c-2-4.7,5.7-6.5,7.7-1.8,3.3,7.8,5.8,13.6,9,21.3S60.8,56.2,65,66.7L44.9,75A13.9,13.9,0,0,0,36,66.9c-7.7-2.2-11.4-8.3-18.4-14.3a44.2,44.2,0,0,0-9.5-6.5c-2.6-1.5-4.2-3.4-2.2-5.7,3.5-4.1,9.3-1.3,13.1,1.5,1.6,1.2,4.4,4.1,5.9,3.8s1.7-.8,1-2.6L12.8,10.5c-1.9-4.7,5.8-7.9,7.7-3.1Z"></path></svg>'})],ho);const ao=[5,2,1];function lo(t){return[Math.min(...t.map((t=>Math.min(...t.map((t=>t.y)))))),Math.max(...t.map((t=>Math.max(...t.map((t=>t.y))))))]}function co(t,e,s){return t.hasAttr(e)?"no"!==t.attr(e):s}function po(t,e,s){const i=t?t.split(","):[];if(3===i.length)return i.map((t=>+t));let n=i.length>0?+i[0]:s?s[0]:0,o=i.length>1?+i[1]:s?s[1]:e;if(q(n,o))return[n-1,o+1,1];o+=.01*(o-n);const r=(o-n)/Math.floor(Math.abs(e)/80),h=Math.floor(Math.log10(r)),a=Math.pow(10,h),l=ao.find((t=>a*t<=r))*a;return o=l*Math.ceil(o/l),n=l*Math.floor(n/l),[n,o,l]}const uo={hasGeoModel:!0,pi:Math.PI,point:(t,e)=>void 0!==t&&void 0!==e?new Mt(t,e):void 0,angle:(t,e,s)=>t&&e&&s?new Lt(t,e,s):void 0,line:(t,e)=>t&&e&&!t.equals(e)?new Pt(t,e):void 0,ray:(t,e)=>t&&e&&!t.equals(e)?new Tt(t,e):void 0,segment:(t,e)=>t&&e&&!t.equals(e)?new St(t,e):void 0,circle:(t,e)=>t&&e?new _t(t,e):void 0,arc:(t,e,s)=>t&&e&&s?new At(t,e,s):void 0,sector:(t,e,s)=>t&&e&&s?new Ct(t,e,s):void 0,polygon:(...t)=>t.every((t=>t))?new Wt(...t):void 0,polyline:(...t)=>t.every((t=>t))?new Kt(...t):void 0,triangle:(t,e,s)=>t&&e&&s?new Gt(t,e,s):void 0,rectangle:(t,e,s)=>t?new Xt(t,e,s):void 0,distance:Mt.distance,round:(t,e=0)=>X(t,e),sqrt:Math.sqrt,floor:Math.floor,ceil:Math.ceil,intersections:Ut};function fo(t,e,s){let i,n=s;for(const s of t){const t=e(s);void 0!==t&&t<n&&(n=t,i=s)}return i}function go(t,e){return qt(t)?t.offset(e):Rt(t)?new Pt(t.c,e).angle/2/Math.PI:Dt(t)?new Lt(t.start,t.c,e).rad/t.angle:.5}function mo(t,e,s,i){return`translate(${t.x}px, ${t.y-e}px) scale(${i/100}) rotate(${s}rad)`}class vo extends Bs{constructor(){super(...arguments),this.labelSuffix=["",""],this.gridSize=[1,1],this.showGrid=!1,this.showXAxis=!1,this.showYAxis=!1,this.showLabels=!1}setupCoordinates(t,e={}){this.$svg=t,t.addClass("canvas"),this.proportional=!!e.proportional,this.padding=function(t){const e=A(t).map((t=>+t));return 1===e.length?[e[0],e[0],e[0],e[0]]:2===e.length?[e[0],e[1],e[0],e[1]]:3===e.length?[e[0],e[1],e[2],e[1]]:e}(this.attr("padding")||e.padding||"0"),co(this,"grid",e.showGrid||!1)&&(this.$grid=as("g",{class:"grid"}),t.prepend(this.$grid),this.showGrid=!0);const s=this.attr("axes")||(e.showAxes?"yes":"no");[this.showXAxis,this.showYAxis]=function(t){const e=t.split(",");return["no"!==e[0],"no"!==(e.length>1?e[1]:e[0])]}(s),(this.showXAxis||this.showYAxis)&&(as("defs",{html:'<marker id="axis-arrow" refX="3" refY="3" markerWidth="6"\n    markerHeight="6" orient="auto"><path d="M 0 0 L 6 3 L 0 6 z"/></marker>'},t),this.$axes=as("g",{class:"axes"}),t.prepend(this.$axes),this.axisNames=(this.attr("axis-names")||",").split(",")),this.$axes&&co(this,"labels",!0)&&(this.labelSuffix=(this.attr("label-suffix")||",").split(","),this.showLabels=!0),(this.showLabels||this.axisNames)&&(this.$labels=as("g",{class:"labels"},t)),this.resize()}resize(){this.css("max-width","none");const t=+this.attr("width")||this.width,e=+this.attr("height")||(this.hasAttr("width")?t:this.height);this.css("max-width",t+"px"),this.$svg.setAttr("width",t),this.$svg.setAttr("height",e),this.$svg.setAttr("viewBox",`0 0 ${t} ${e}`);const s=this.padding;this.viewportBounds=new Yt(s[3],t-s[1],s[0],e-s[2]),this.updatePlotBounds(),this.positionElements(t,e)}updatePlotBounds(t){const[e,s,i]=po(this.attr("x-axis"),this.viewportBounds.dx,null==t?void 0:t.xRange),[n,o,r]=po(this.attr("y-axis"),this.viewportBounds.dy,null==t?void 0:t.yRange),h=Math.abs(this.viewportBounds.dx/(s-e)),a=Math.abs(this.viewportBounds.dy/(o-n)),l=Math.min(h,a),c=this.proportional?h/l:1,d=this.proportional?a/l:1;this.plotBounds=new Yt(c*e,c*s,d*o,d*n),this.plotScale=this.proportional?l:(h+a)/2,this.gridSize=[i,r];const[p,u]=[this.plotBounds,this.viewportBounds];this.plotToViewportMatrix=[[u.dx/p.dx,0,u.xMin-p.xMin/p.dx*u.dx],[0,u.dy/p.dy,u.yMin-p.yMin/p.dy*u.dy]];const f=e>0?c*e:s<0?c*s:0,g=n>0?d*n:o<0?d*o:0;this.plotOrigin=new Mt(f,g),this.drawAxes()}drawAxes(){const[t,e]=[this.plotBounds,this.viewportBounds],s=this.toViewportCoords(this.plotOrigin),[i,n]=this.gridSize;if(this.$grid&&this.$grid.removeChildren(),this.$axes&&this.$axes.removeChildren(),this.$labels&&this.$labels.removeChildren(),this.showGrid||this.showXAxis){for(let n=i*Math.trunc(t.xMin/i+.01);n<t.xMax;n+=i){if(this.showYAxis&&n===this.plotOrigin.x)continue;const t=this.toViewportCoords(new Mt(n,0)).x;this.showGrid&&as("line",{x1:t,y1:e.yMin,x2:t,y2:e.yMax},this.$grid),this.showLabels&&this.makeLabel(0,n,t,s)}}if(this.showGrid||this.showYAxis){const[i,o]=t.yMin<t.yMax?[t.yMin,t.yMax]:[t.yMax,t.yMin];for(let t=n*Math.trunc(i/n+.01);t<o;t+=n){if(this.showXAxis&&t===this.plotOrigin.y)continue;const i=this.toViewportCoords(new Mt(0,t)).y;this.showGrid&&as("line",{x1:e.xMin,y1:i,x2:e.xMax,y2:i},this.$grid),this.showLabels&&this.makeLabel(1,t,i,s)}}this.showXAxis&&(this.$xAxis=as("line",{x1:e.xMin,x2:e.xMax,y1:s.y,y2:s.y},this.$axes)),this.showYAxis&&(this.$yAxis=as("line",{x1:s.x,x2:s.x,y1:e.yMax,y2:e.yMin},this.$axes)),this.showLabels&&this.showXAxis&&this.showYAxis&&(0!==t.xMin||0!==t.yMax||this.labelSuffix[0]||this.labelSuffix[1]?t.yMax===this.plotOrigin.y?this.makeLabel(0,this.plotOrigin.x,s.x,s):this.makeLabel(1,this.plotOrigin.y,s.y,s):as("text",{text:0,x:s.x-5,y:s.y+15,"text-anchor":"end"},this.$labels)),this.axisNames&&(this.axisNames[0]&&as("text",{text:this.axisNames[0],x:this.viewportBounds.xMax-2,y:s.y-12,"text-anchor":"end"},this.$labels),this.axisNames[1]&&as("text",{text:this.axisNames[1],x:s.x+10,y:this.viewportBounds.yMin+5},this.$labels))}makeLabel(t,e,s,i){const n=this.labelSuffix[t];as("text",{text:"i"===n?new ot(0,e).toString():D(e,4)+n,x:t?i.x-8:s,y:t?s+4:i.y+18,"text-anchor":t?"end":"middle"},this.$labels),as("line",{class:"tick",x1:t?i.x:s,y1:t?s:i.y,x2:t?i.x-4:s,y2:t?s:i.y+4},this.$axes)}positionElements(t,e){for(const s of this.$$("[data-bounds]")){const i=s.data.bounds.split(","),n=this.toViewportCoords(new Mt(+i[3],+i[0])),o=this.toViewportCoords(new Mt(+i[1],+i[2]));s.css({left:n.x/t*100+"%",top:n.y/e*100+"%",width:(o.x-n.x)/t*100+"%",height:(o.y-n.y)/e*100+"%"})}}toPlotCoords(t){return t.changeCoordinates(this.viewportBounds,this.plotBounds)}toViewportCoords(t){return t.transform(this.plotToViewportMatrix)}}let $o=class extends vo{constructor(){super(...arguments),this.steps=400}ready(){const t=as("svg",{},this),e=as("g",{class:"plot"},t);this.$path=as("path",{},e),this.setupCoordinates(t,{showGrid:!0,showAxes:!0,padding:"20"}),this.clear();const s=this.viewportBounds,i=this.steps/s.dx;let n;ze(t,{start:()=>n=void 0,move:t=>{const e=Q(Math.round((t.x-s.xMin)*i),0,this.steps-1);this.points[e]=this.toPlotCoords(new Mt(s.xMin+e/i,t.y)),n&&this.interpolate(n,e),n=e,this.redraw()},end:()=>this.snap()})}interpolate(t,e){e<t&&([t,e]=[e,t]);const s=this.points[t],i=this.points[e];for(let n=t+1;n<e;++n)this.points[n]=Mt.interpolate(s,i,(n-t)/(e-t))}redraw(){let t="",e=!0;for(const s of this.points){if(s){const i=this.toViewportCoords(s);t+=(e?"M":"L")+`${i.x},${i.y}`}e=!s}this.$path.setAttr("d",t)}snap(){const t=this.points.filter((t=>t)).map((t=>[t.x,t.y])),e=xt.bestPolynomial(t);if(e){for(let t=0;t<this.steps;++t){if(!this.points[t])continue;const s=this.plotBounds.xMin+t/this.steps*this.plotBounds.dx;this.points[t]=new Mt(s,e.fn(s))}this.redraw(),this.trigger("snap",{regression:e})}}clear(){this.points=u(void 0,this.steps),this.$path.setAttr("d","")}};$o=e([Rs("x-coordinate-sketch")],$o);let wo=class extends vo{constructor(){super(...arguments),this.isAnimated=this.hasAttr("animate"),this.crosshairGrid=10,this.getCrosshairPosn=t=>t}ready(){const t=as("svg",{},this);if(this.$plot=as("g",{class:"plot"},t),this.$overlay=as("g",{class:"overlay"},t),this.setupCoordinates(t,{showGrid:!0,showAxes:!0,padding:"20"}),this.hasAttr("fn")){const t=Ti.parse(this.attr("fn"),!0);this.setFunctions((e=>t.evaluate({x:e})))}co(this,"crosshairs",!0)&&(this.crosshairGrid=+this.attr("crosshair-grid")||10,this.setupCrosshairs(t))}setPoints(t,e=1){const s=t.map(((t,s)=>new Mt(s+e,t)));this.setSeries(s)}setSeries(...t){const e=Math.max(...t.map((t=>v(t).x))),[s,i]=lo(t);this.updatePlotBounds(new Yt(0,e,s,i)),this.$plot.removeChildren();for(const e of t)this.drawLinePlot(e);this.getCrosshairPosn=e=>t[0].reduce(((t,s)=>Math.abs(s.x-e.x)<=Math.abs(t.x-e.x)?s:t))}setFunctions(...t){const[e,s]=[this.plotBounds,this.viewportBounds],i=t.map((t=>{const e=[];for(let i=s.xMin;i<s.xMax;i+=2){const s=this.toPlotCoords(new Mt(i,0)).x;e.push(new Mt(s,t(s)))}return e})),[n,o]=lo(i);this.updatePlotBounds(new Yt(e.xMin,e.xMax,n,o)),this.$plot.removeChildren();for(const t of i)this.drawLinePlot(t);const r=this.gridSize[0]/this.crosshairGrid;this.getCrosshairPosn=s=>{const i=Y(Q(s.x,e.xMin,e.xMax),r);return new Mt(i,t[0](i))}}drawLinePlot(t){const e=as("g",{},this.$plot),s=as("path",{},e),i=this.plotBounds,n=(t=t.filter((t=>t.y>=i.yMax&&t.y<=i.yMin))).map((t=>this.toViewportCoords(t)));this.isAnimated?ks((e=>{const o=t.findIndex((t=>t.x>i.xMin+e*i.dx));s.points=n.slice(0,o)}),5e3):s.points=n}drawPoints(t){const e=as("g",{},this.$plot),s=this.plotBounds;for(const i of t){const t=this.toViewportCoords(i),n=as("circle",{r:4,cx:t.x,cy:t.y},e);if(this.isAnimated){n.hide();const t=5e3*(i.x-s.xMin)/(s.xMax-s.xMin);setTimeout((()=>n.show()),t)}}}setupCrosshairs(t){const e=as("g",{class:"crosshair"},t),s=as("path",{},e),i=as("circle",{r:4},e),n=as("text",{},e);let o=0;const r=t=>{const e=this.getCrosshairPosn(this.toPlotCoords(t));if(q(e.x,o))return;o=e.x;const r=this.toViewportCoords(e),h=this.toViewportCoords(this.plotOrigin);i.setCenter(r),s.points=[new Mt(h.x,r.y),r,new Mt(r.x,h.y)],n.text=`(${D(e.x,5,!1)}, ${D(e.y,5,!1)})`;const a=n.width,l=r.x+8+a<this.viewportBounds.dx;n.setAttr("x",l?r.x+5:r.x-a-5),n.setAttr("y",r.y>20?r.y-7:r.y+18)};!function(t,e){let s=Se;"svg"===t.type?s=e=>Le(e,t.$ownerSVG):"canvas"===t.type&&(s=e=>_e(e,t));let i=!1;t.on("touchstart mouseenter",(t=>{!i&&e.enter&&e.enter(),e.move&&e.move(s(t)),i=!0}),{passive:!0}),t.on("pointermove",(t=>{i&&e.move&&e.move(s(t))})),t.on("touchend mouseleave",(()=>{i&&e.exit&&e.exit(),i=!1}),{passive:!0})}(t,{enter:()=>e.show(),move:t=>r(t),exit:()=>e.hide()})}};wo=e([Rs("x-coordinate-system")],wo);class xo{constructor(t,e){this.$canvas=t,this.defaultCallbacks=e,this.callbacks=new WeakMap,this.isMoving=!1,this.shiftKey=!1,this.altKey=!1,this.cancelled=!1,setTimeout((()=>{document.addEventListener("keydown",(t=>{this.shiftKey=t.shiftKey,this.altKey=t.altKey})),document.addEventListener("keyup",(t=>{this.shiftKey=t.shiftKey,this.altKey=t.altKey})),document.addEventListener("visibilitychange",(()=>{this.shiftKey=this.altKey=!1}))}),2e3),t.css("touch-action","none"),t.on("pointerdown",(t=>this.startEvent(t))),t.on("contextmenu",(t=>t.preventDefault())),e.hover&&t.on("pointermove",(s=>{this.isMoving||e.hover({posn:Le(s,t),event:s})}))}listen(t,e){this.callbacks.set(t._el,e),t.hasParent(this.$canvas)||(t.css("touch-action","none"),t.on("pointerdown",(t=>this.startEvent(t))))}startEvent(t){if(t.handled)return;this.isMoving=!0,this.cancelled=!1,t.preventDefault();const e=$s.getActiveInput();e&&e.blur();const s=t.pointerId,i=this.getCallbacks(t.target);"shiftKey"in t&&(this.shiftKey=t.shiftKey);const n=Le(t,this.$canvas);let o=n,r=!1;const h=t=>{if(t.pointerId&&t.pointerId!==s)return;if(t.preventDefault(),this.cancelled)return a(t);const e=Le(t,this.$canvas);Mt.distance(e,o)<.5||(!r&&i.start&&i.start({posn:n,event:t}),i.move&&i.move({posn:e,startPosn:n,lastPosn:o,event:t}),r||!1===i.cursor||cs.addClass("grabbing"),o=e,r=!0)},a=t=>{t.pointerId&&t.pointerId!==s||(t.preventDefault(),ls.off("pointermove",h),ls.off("pointerstop",a),r&&i.end&&i.end({posn:o,lastPosn:o,startPosn:n,event:t}),r||this.cancelled||!i.click||i.click({posn:n,event:t}),cs.removeClass("grabbing"),this.isMoving=!1)};i.down&&i.down({posn:n,event:t}),ls.on("pointermove",h),ls.on("pointerstop",a)}getCallbacks(t){for(;t;){const e=this.callbacks.get(t);if(e&&(!e.checkIfActive||e.checkIfActive()))return e;t=t.parentNode||void 0}return this.defaultCallbacks}cancel(){this.cancelled=!0}}function yo(t,e,s){const i=e.map((e=>function(t,e){if("string"==typeof t){const s=ke(t);return t=>{var i;return null===(i=s(e))||void 0===i?void 0:i.equals(t)}}return"function"==typeof t?t:e=>t.equals(e)}(e,t.model))),n=u(void 0,e.length),o=l();let r=[];const h=({point:t})=>r.push(t),a=s.maxErrors||4;let c=0;const d=({path:t})=>{s.onBegin&&s.onBegin(t)},p=()=>{n.every((t=>t))&&(s.onComplete&&s.onComplete(!0),t.off("add:path",f),t.off("begin:path",d),t.off("add:point",h),o.resolve(n))},f=({path:o})=>{const h=o.value;if(h){for(const[t,e]of i.entries())if(!n[t]&&e(h))return n[t]=o,s.onCorrect&&s.onCorrect(o,t),c=0,r=[],p();o.delete();for(const t of r)t.delete();if(r=[],!(qt(h)&&h.length<1))if(c+=1,c>=a){const i=n.findIndex((t=>!t)),o=e[i];if("function"!=typeof o){const e=t.drawPath(o,{animated:1e3});n[i]=e,s.onHint&&s.onHint(e,i),c=0,p()}}else s.onIncorrect&&s.onIncorrect(o)}};return t.on("begin:path",d),t.on("add:path",f),t.on("add:point",h),o.promise}function bo(t,e){const s=[];for(const i of e.paths)i!==t&&i.value&&s.push(i.value.transform(e.plotToViewportMatrix));return s}const Mo=new _t(new Mt(0,-9),12);function ko(t,e,s){for(const t of s)if(e.every((e=>!Ut(Mo.translate(t),e).length)))return t;return s[0]}class Ao{constructor(t,e,s,i){this.$parent=t,this.$el=s,this.color="",this.label="",this.isPending=!1,this.isLocked=!1,this.components=[],this.dependencies=[],this.fixedLabel=!1,this.name=i||t.model.getKey(),t.shapes.set(this.name,this),t.model.watch((e=>{const s=e[this.name];this.$el.css("display",s?"block":"none"),this.$label&&this.$label.css("display",s?"block":"none"),s&&this.redraw(s),t.queueLabelPositioning()})),this.color=s.css("color")||"",this.setValue(e),s.hasAttr("label")&&this.setLabel(s.attr("label"))}get value(){return this.$parent.model[this.name]}get type(){var t;return null===(t=this.value)||void 0===t?void 0:t.type}get locked(){return this.isLocked}get isHidden(){return this.isPending||this.$el.hasAttr("hidden")||this.$el.hasClass("transparent")}setValue(t){t instanceof Function?this.$parent.model.setComputed(this.name,t):this.$parent.model[this.name]=t}setLabel(t,e,s){this.$label||(this.$label=function(t,e){return as("text",{target:t.attr("target")||void 0,class:t.attr("label-class")||t.attr("class")||void 0,"data-when":t.data.when,style:e?`color: ${e}`:void 0,"text-anchor":"middle"})}(this.$el,e),this.$parent.$objLabels.append(this.$label));const i=Ce(t);if(this.$parent.model.watch((t=>this.$label.text=i(t)||"")),this.fixedLabel=!!s,s){const t=ke(s);this.$parent.model.watch((e=>{this.$label.setTransform(t(e).shift(0,5))}))}this.updateLabelPosition()}setColor(t){this.color=t,this.$el.css("color",t);for(const e of this.dependencies)e.setColor(t);this.$label&&this.$label.css("color",t)}updateLabelPosition(){if(!this.$label||!this.value||this.fixedLabel)return;const[t,e]=function(t,e){const s=t.value.transform(e.plotToViewportMatrix),i=t.$el;if(qt(s)){let n=s.perpendicularVector,o=s.angle;n.y>=0&&(n=n.scale(-1),o+=Math.PI);const r=[];for(const t of[.5,.35,.65])for(const e of[-15,5])r.push(s.at(t).add(n.scale(e)));if(!e.labelPositioning)return[r[0],o];let h=ko(0,bo(t,e),r);return i.hasAttr("mark")&&(h=h.add(s.unitVector.scale(12))),[h,o]}if(jt(s))return[s.at(.5).subtract(s.c).scale(.6).add(s.c).shift(0,5)];if(Dt(s)){const t=new Pt(s.start,s.end),e=t.perpendicularVector.y>=0,i=t.angle+(e?Math.PI:0);return[s.at(.5).add(t.perpendicularVector.scale(e?14:5)),i]}if(Nt(s)){const t=(+i.attr("size")||Jt(s,{round:i.hasAttr("round")}))+8;return[s.b.add(s.bisector.unitVector.scale(t+5)).shift(0,3)]}if(Ht(s)){const n=i.hasClass("move")?10:8,o=[s.shift(n,-n),s.shift(-n,-n),s.shift(n,10+n),s.shift(-n,10+n)];return e.labelPositioning?[ko(0,bo(t,e),o)]:[o[0]]}return zt(s)?[s.centroid.shift(0,5)]:Rt(s)?[s.c.shift(0,5)]:[]}(this,this.$parent);this.$label.setTransform(t,e)}select(){this.$el.addClass("selected"),this.$el.parent.append(this.$el);for(const t of this.dependencies)t.select()}deselect(){this.$el.removeClass("selected");for(const t of this.dependencies)t.deselect()}hover(t=!1){if(!t){if(this.$parent.hovering===this)return;this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.hovering=this}this.$el.addClass("hover");for(const t of this.dependencies)t.hover(!0)}unhover(t=!1){if(!t){if(this.$parent.hovering!==this)return;this.$parent.hovering=void 0}this.$el.removeClass("hover");for(const t of this.dependencies)t.unhover(!0)}delete(t=300){return s(this,void 0,void 0,(function*(){this.$parent.shapes.delete(this.name);for(const t of this.components)t.deselect();this.$label&&this.$label.exit("fade",t,0,!0),yield this.removeElement(t),this.$parent.model[this.name]=void 0}))}}class Co extends Ao{constructor(t,e,s,i,n=!1){i||(i=as("circle",{})),super(t,e,i,s),this.$parent.hidePoints||t.$points.append(this.$el),t.points.add(this),this.projectionId=t.model.getKey(),this.projectionOffset=void 0,t.model.watch((t=>{this.projection=t[this.projectionId],this.projection&&(void 0===this.projectionOffset&&(this.projectionOffset=go(this.projection,this.$parent.model[this.name])),this.$parent.model[this.name]=this.projection.at(this.projectionOffset))})),this.lock(n)}setValue(t){t instanceof Function?(this.project(void 0),this.$parent.model.setComputed(this.name,t)):(t&&this.projection&&(t=this.projection.project(t),this.projectionOffset=go(this.projection,t)),this.$parent.model[this.name]=t)}redraw(t){const e=t.transform(this.$parent.plotToViewportMatrix);this.$el.setCenter(e),this.$halo&&this.$halo.setCenter(e),this.$pulse&&this.$pulse.setCenter(e)}removeElement(t){return s(this,void 0,void 0,(function*(){this.$parent.points.delete(this),yield this.$el.exit("pop",t,0,!0).promise}))}distance(t){return this.value?Mt.distance(t,this.value):1/0}lock(t=!0){this.isLocked=t,this.$el.setClass("move",!t),t?this.$el.removeAttr("tabindex"):this.$el.setAttr("tabindex",0)}project(t){if(this.projectionOffset=void 0,"string"==typeof t){const e=ke(t);this.$parent.model.setComputed(this.projectionId,e)}else t?this.$parent.model.setComputed(this.projectionId,(()=>t.value)):this.$parent.model[this.projectionId]=void 0}makeIntersection({path1:t,path2:e,index:s}){this.setValue((i=>{if(!i[t.name]||!i[e.name])return;const n=Ut(i[t.name],i[e.name]);return n[Math.min(s,n.length-1)]})),this.lock()}addHalo(){this.$halo=as("circle",{class:"halo",r:18},this.$parent.$pulses),this.$halo.setCenter(this.$el.center),this.$halo.enter("pop")}removeHalo(){return s(this,void 0,void 0,(function*(){this.$halo&&(this.$halo.exit("pop",500,0,!0),this.$halo=void 0)}))}pulsate(){this.$pulse=as("circle",{class:"pulse",r:8},this.$parent.$pulses),this.$pulse.setCenter(this.$el.center),this.$el.one("mouseover pointerdown focus",(()=>{this.$pulse&&this.$pulse.remove(),this.$pulse=void 0}))}}class Po extends Ao{constructor(t,e,s,i){super(t,e,i||as("path"),s),t.$paths.append(this.$el),t.paths.add(this)}get locked(){return this.isLocked||!this.components.length||this.components.every((t=>t.locked))}redraw(t){const e=t.transform(this.$parent.plotToViewportMatrix);this.$el.draw(e,{box:this.$parent.boundsRect})}distance(t){return this.value?Mt.distance(t,this.value.project(t)):1/0}removeElement(t){return s(this,void 0,void 0,(function*(){this.$parent.paths.delete(this),yield this.$el.exit("draw",t,0,!0).promise}))}setComponents(t,e){this.components=this.dependencies=t,this.setValue((()=>{const s=t.map((t=>t.value));if(!s.some((t=>void 0===t)))return e(...s)}))}}class To{constructor(t){this.$parent=t}enable(){}down(t){}start(t){}move(t,e){}end(t){}hover(t){}click(t){}cancel(){}snapToGrid(t){return this.$parent.snapToGrid?t.round(this.$parent.snapToGrid):t}snapToPoint(t,e){return this.snapPoint=this.$parent.getPointAt(e),this.snapPoint?(t.$el.setClass("move",!this.snapPoint.locked),t.setValue(this.snapPoint.value)):(this.snapIntersect=this.$parent.getIntersectionAt(e),this.snapIntersect?(t.$el.removeClass("move"),t.setValue(this.snapIntersect.posn)):!this.$parent.snapToGrid&&(this.snapPath=this.$parent.getPathAt(e),this.snapPath)?t.setValue(this.snapPath.value.project(e)):(t.$el.addClass("move"),void t.setValue(this.snapToGrid(e))))}getOrMakePointAt(t){let e=this.$parent.getPointAt(t);if(!e){e=new Co(this.$parent,this.snapToGrid(t));const s=this.$parent.getIntersectionAt(t);if(s)e.makeIntersection(s);else if(!this.$parent.snapToGrid){const s=this.$parent.getPathAt(t);s&&e.project(s)}this.$parent.trigger("add:point",{point:e})}return e}showPendingPointAt(t){var e,s,i;const n=(null===(e=this.$parent.getIntersectionAt(t))||void 0===e?void 0:e.posn)||(null===(i=null===(s=this.$parent.getPathAt(t))||void 0===s?void 0:s.value)||void 0===i?void 0:i.project(t)),o=!!n;if(this.$parent.$pendingPoint.toggle(o),o){const e=this.$parent.toViewportCoords(n||t);this.$parent.$pendingPoint.setCenter(e)}}}class So extends To{constructor(){super(...arguments),this.isMoving=!1}enable(){}down(t){this.obj=this.$parent.getPointAt(t)||this.$parent.getPathAt(t),this.obj||this.$parent.deselect();const e=this.$parent.selection;e!==this.obj&&(e&&e.components.includes(this.obj)||this.$parent.select(this.obj))}start(){this.obj&&(this.isMoving=!0,this.obj.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("move",{obj:this.obj}))}move(t,e){if(this.obj&&!this.obj.locked&&!this.$parent.locked)if(this.obj instanceof Po){const s=t.subtract(e);for(const t of this.obj.components)t.locked||t.setValue(t.value.add(s))}else this.obj instanceof Co&&this.obj.setValue(this.snapToGrid(t))}end(){this.obj&&(this.isMoving=!1,this.obj.isPending=!1,this.snapPoint||(this.snapIntersect?this.obj.makeIntersection(this.snapIntersect):this.snapPath&&this.obj.project(this.snapPath)),this.$parent.trigger("moveEnd",{path:this.obj}),this.obj=void 0,this.$parent.updateIntersections())}hover(t){if(this.isMoving)return;const e=this.$parent.getPointAt(t)||this.$parent.getPathAt(t),s=e&&!this.$parent.locked&&!e.locked,i=e&&this.$parent.canSelect;this.$parent.setCursor(s?"grab":i?"pointer":"default"),s||i?e.hover():this.$parent.hovering&&this.$parent.hovering.unhover()}}class Lo extends So{down(t){this.$parent.deselect(),this.obj=this.getOrMakePointAt(t),this.$parent.select(this.obj)}hover(t){const e=this.$parent.getPointAt(t);if(e)return this.$parent.setCursor(this.$parent.locked||e.locked?"default":"grab"),this.$parent.$pendingPoint.hide(),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(t)}}class _o extends To{enable(){this.$parent.setCursor("crosshair")}down(t){this.$parent.deselect(),this.startPoint=this.getOrMakePointAt(t)}start(t){this.startPoint&&(this.$parent.$pendingPoint.hide(),this.endPoint=new Co(this.$parent,t),this.endPoint.isPending=!0,this.endPoint.$el.addClass("pending"),this.path=new Po(this.$parent,void 0),this.path.setComponents([this.startPoint,this.endPoint],this.expr),this.path.isPending=!0,this.$parent.updateIntersections(),this.$parent.trigger("begin:path",{path:this.path,start:this.startPoint}))}move(t){if(!this.startPoint||!this.path||!this.endPoint)return;if(Mt.distance(t,this.startPoint.value)<20/this.$parent.plotScale)return this.endPoint.setValue(this.snapToGrid(t));this.snapToPoint(this.endPoint,t)}end(){if(!this.startPoint||!this.path||!this.endPoint)return;this.path.isPending=!1,this.endPoint.isPending=!1,this.startPoint.value.equals(this.endPoint.value)?(this.endPoint.delete(),this.path.delete(),this.path=this.endPoint=void 0):this.snapPoint?(this.path.setComponents([this.startPoint,this.snapPoint],this.expr),this.endPoint.delete(),this.endPoint=void 0):this.snapIntersect?this.endPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.endPoint.project(this.snapPath),this.endPoint&&(this.$parent.trigger("add:point",{point:this.endPoint}),this.endPoint.$el.removeClass("pending"));const t=this.path;this.startPoint=this.endPoint=this.path=void 0,t&&(this.$parent.trigger("add:path",{path:t}),this.$parent.updateIntersections())}hover(t){const e=this.$parent.getPointAt(t);if(e)return this.$parent.$pendingPoint.hide(),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.showPendingPointAt(t)}cancel(){this.endPoint&&this.endPoint.delete(),this.path&&this.path.delete(),this.$parent.$pendingPoint.hide(),this.startPoint=this.endPoint=this.path=void 0}}class zo extends _o{expr(t,e){return new St(t,e)}}class Eo extends _o{expr(t,e){return new _t(t,Mt.distance(t,e))}}class Io extends _o{expr(t,e){return new Xt(t,e.x-t.x,e.y-t.y)}}class Oo extends _o{expr(t,e){return new St(t,e).perpendicularBisector}}const qo=(t,e,s)=>new Lt(t,e,s).bisector;class Vo extends To{enable(){}down(t){if(this.$parent.deselect(),this.firstPoint)if(this.secondPoint){this.path.isPending=this.thirdPoint.isPending=!1,this.thirdPoint.$el.removeClass("pending"),this.firstPoint.removeHalo(),this.secondPoint.removeHalo(),this.snapPoint?(this.path.setComponents([this.firstPoint,this.secondPoint,this.snapPoint],qo),this.thirdPoint.delete(),this.thirdPoint=void 0):this.snapIntersect?this.thirdPoint.makeIntersection(this.snapIntersect):this.snapPath&&this.thirdPoint.project(this.snapPath);const t=this.path,e=this.thirdPoint;this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0,e&&this.$parent.trigger("add:point",{point:e}),this.$parent.trigger("add:path",{path:t}),this.$parent.updateIntersections()}else{if(this.secondPoint=this.getOrMakePointAt(t),!this.secondPoint)return;this.secondPoint.addHalo(),this.thirdPoint=new Co(this.$parent,this.secondPoint.value),this.thirdPoint.$el.addClass("pending"),this.path=new Po(this.$parent,void 0),this.path.setComponents([this.firstPoint,this.secondPoint,this.thirdPoint],qo),this.path.isPending=this.thirdPoint.isPending=!0}else this.firstPoint=this.getOrMakePointAt(t),this.firstPoint&&this.firstPoint.addHalo()}hover(t){if(this.$parent.$pendingPoint.hide(),this.thirdPoint)return this.snapToPoint(this.thirdPoint,t),void this.$parent.setCursor(this.snapPoint?"pointer":"crosshair");const e=this.$parent.getPointAt(t);if(e)return this.$parent.setCursor("pointer"),e.hover();this.$parent.hovering&&this.$parent.hovering.unhover(),this.$parent.setCursor("crosshair"),this.showPendingPointAt(t)}cancel(){this.firstPoint&&this.firstPoint.removeHalo(),this.secondPoint&&this.secondPoint.removeHalo(),this.thirdPoint&&this.thirdPoint.delete(),this.path&&this.path.delete(),this.firstPoint=this.secondPoint=this.thirdPoint=this.path=void 0}}let Bo=class extends vo{constructor(){super(...arguments),this.shapes=new Map,this.points=new Set,this.paths=new Set,this.intersections=new Set,this.snapToGrid=0,this.locked=!1,this.hidePoints=!1,this.canSelect=!1,this.canIntersect=!1,this.canProject=!0,this.labelPositioning=!1,this.cursor="default"}ready(){const t=this.children.filter((t=>"SVG"===t.tagName))[0];if(this.hasAttr("complex")&&(this.setAttr("label-suffix",",i"),this.setAttr("axis-names","Real, Imaginary"),this.setAttr("axes","true"),this.setAttr("grid","true")),!this.hasAttr("x-axis")&&!this.hasAttr("y-axis")){const t=+this.attr("grid"),e=+this.attr("width")||this.width,s=+this.attr("height")||e;this.setAttr("x-axis",t?`-0.5,${e/t-.5},1`:`0,${e},1`),this.setAttr("y-axis",t?s/t-.5+",-0.5,1":`${s},0,1`),t&&this.setAttr("snap",1)}this.setupCoordinates(t,{proportional:!0}),this.boundsRect=this.viewportBounds.rect,this.model=this.getParentModel()||He({}),this.model.hasGeoModel||this.model.assign(uo),this.$paths=as("g",{class:"paths"},t),this.$pulses=as("g",{class:"pulses"},t),this.$points=as("g",{class:"points"},t),this.$objLabels=as("g",{class:"labels"},t),this.snapToGrid=this.hasAttr("snap")?+this.attr("snap")||1:0,this.hidePoints=this.hasAttr("no-points"),this.canIntersect=co(this,"intersections",!1),this.canProject=co(this,"projections",!0),this.canSelect=co(this,"selectable",!1),this.labelPositioning=co(this,"label-positioning",!0),this.hasClass("sticky")&&this.css("top",`calc(50vh - ${this.height/2}px)`),this.queueLabelPositioning=d((()=>{for(const t of this.shapes.values())t.updateLabelPosition()}),0,!0);const e=t.$$("path[x], path[\\:d], circle");for(const t of e){const e=t.hasAttr("x")?ke(t.attr("x")):void 0,s=t.attr("name");if(t.hasAttr(":d"))this.$paths.append(t),t.bindModel(this.model);else if("PATH"===t.tagName)this.$paths.append(t),new Po(this,e,s,t);else{this.$points.append(t);const i=!t.hasClass("move"),n=e||t.center,o=new Co(this,n,s,t,i);t.hasAttr("project")&&o.project(t.attr("project")),t.hasClass("pulsate")&&o.pulsate()}}this.$pendingPoint=as("circle",{class:"pending"},this.$points),this.$pendingPoint.hide(),this.updateIntersections();const s={move:new So(this),point:new Lo(this),line:new zo(this),circle:new Eo(this),perpBisector:new Oo(this),angleBisector:new Vo(this),rectangle:new Io(this)};this.$tools=this.$(".tools");let i=s[this.$tools.$active.data.tool];i.enable();const n=()=>this.toolOverride||i;this.$tools.on("change",(t=>{n().cancel(),this.toolOverride=void 0,i=s[t.data.tool],this.hovering&&this.hovering.unhover(),this.$pendingPoint.hide(),this.hovering=void 0,this.deselect(),i.enable()}));const o=(t,e=!1)=>this.toPlotCoords(e?t.clamp(this.viewportBounds,8):t);new xo(t,{down:t=>n().down(o(t.posn)),start:t=>n().start(o(t.posn)),move:t=>n().move(o(t.posn,!0),o(t.lastPosn,!0)),end:t=>n().end(o(t.posn,!0)),click:t=>n().click(o(t.posn)),hover:t=>n().hover(o(t.posn))}),$s.onKey("escape",(()=>n().cancel())),$s.onKey("backspace delete",(()=>this.delete())),document.addEventListener("keydown",(t=>{if([37,38,39,40].indexOf(t.keyCode)<0)return;const e=$s.getActiveInput();if(e&&e.hasParent(this)){t.preventDefault();for(const s of this.points){if(s.$el!==e||!s.value)continue;const i=15/this.plotScale,n=this.plotBounds.yMin>this.plotBounds.yMax?-1:1,o=37===t.keyCode?-i:39===t.keyCode?i:0,r=38===t.keyCode?-n*i:40===t.keyCode?n*i:0;return void s.setValue(s.value.shift(o,r))}}}))}switchTool(t){this.$tools.makeActive(this.$(`.tool[data-tool="${t}"]`))}setCursor(t="default"){t!==this.cursor&&(this.cursor=t,this.$svg.css("cursor",t))}select(t){this.canSelect&&(this.deselect(),t&&(this.selection=t,t.select()),this.trigger("select",{shape:t}))}deselect(){this.selection&&(this.selection.deselect(),this.selection=void 0,this.trigger("select",{shape:void 0}))}delete(){this.hovering&&this.hovering.unhover(),this.selection&&this.selection.delete(),this.trigger("select",{shape:void 0})}redraw(){this.resize(),this.boundsRect=this.viewportBounds.rect,this.model.forceUpdate()}getPointAt(t,e=20){if(this.hidePoints)return;return fo(this.points,(e=>e.isHidden?void 0:e.distance(t)),e/this.plotScale)}getPathAt(t,e=10){if(this.hidePoints||!this.canProject)return;return fo(this.paths,(e=>e.isHidden?void 0:e.distance(t)),e/this.plotScale)}getIntersectionAt(t,e=20){if(!this.canIntersect)return;return fo(this.intersections,(e=>Mt.distance(t,e.posn)),e/this.plotScale)}updateIntersections(){this.canIntersect&&!this.hidePoints&&function(t,e){e.clear();for(const s of t)if(!s.isHidden&&s.value)for(const i of t){if(s.isHidden||!i.value||s===i)continue;const t=Ut(s.value,i.value);for(const[n,o]of t.entries())e.add({path1:s,path2:i,posn:o,index:n})}}(this.paths,this.intersections)}drawPath(t,e={}){"string"==typeof t&&(t=ke(t));const s=new Po(this,t,e.name);e.classes&&s.$el.addClass(e.classes),e.target&&s.$el.setAttr("target",e.target);const i=s.$el.hasClass("fill")?"fade":"draw";return e.animated&&s.$el.enter(i,e.animated),s}drawPoint(t,e={}){"string"==typeof t&&(t=ke(t));const s=new Co(this,t,e.name,void 0,!1===e.interactive);return e.classes&&s.$el.addClass(e.classes),e.target&&s.$el.setAttr("target",e.target),0!==e.animated&&s.$el.enter("pop",e.animated||500),s}animatePoint(t,e,s=400){const i=this.shapes.get(t),n=new St(this.model[t],e);return ks((t=>i.setValue(n.at(Cs("quad",t)))),s)}animateConstruction(t,e=2e3){return s(this,void 0,void 0,(function*(){const s=this.shapes.get(t);let i=s.value;if(Rt(i)&&(i=i.arc),qt(i)){this.$ruler||(this.$ruler=as("path",{d:"M0,0V8H100V0ZM7,6A2,2,0,1,1,9,4,2,2,0,0,1,7,6Z",class:"sketch"},this.$svg));const t=mo(i.at(-.1),12,i.angle-.3,1.2*i.length),n=mo(i.at(-.1),12,i.angle,1.2*i.length);this.$ruler.show(),s.$el.hide(),yield this.$ruler.animate({opacity:[0,1],transform:[t,n]},500).promise,yield s.$el.enter("draw",e).promise,yield this.$ruler.animate({opacity:[1,0],transform:[n,t]},500).promise}else if(Dt(i)){this.$compass||(this.$compass=as("path",{d:"M100,50h0l-5.2-4.9L52.6,10.2v-9C52.6.6,51.4,0,50,0s-2.6.6-2.6,1.2v9L5.2,45.1,0,50H0l6.6-3L35,25.9H65L93.4,47ZM38.4,23.5,50,14.8l11.6,8.7Z",class:"sketch"},this.$svg));const t=mo(i.c,50,i.startAngle,1.5*i.radius),n=mo(i.c,50,i.startAngle,i.radius),o=mo(i.c,50,i.startAngle+i.angle,i.radius),r=mo(i.c,50,i.startAngle+i.angle,1.5*i.radius);this.$compass.show(),s.$el.hide(),yield this.$compass.animate({opacity:[0,1],transform:[t,n]},500).promise,s.$el.enter("draw",e),yield this.$compass.animate({transform:[n,o]},e,0,"linear").promise,yield this.$compass.animate({opacity:[1,0],transform:[o,r]},500).promise}}))}showGesture(t,e){this.$gesture||(this.$gesture=as("x-gesture",{},this)),this.$gesture.stop();const s=this.toViewportCoords(ke(t)(this.model));if(this.$gesture.from=s,e){const t=this.toViewportCoords(ke(e)(this.model));this.$gesture.start(t.subtract(s))}else this.$gesture.start();this.one("click mouseover pointerdown",(()=>this.$gesture.stop()))}waitForPoint(){return s(this,void 0,void 0,(function*(){return new Promise((t=>{this.one("add:point",(({point:e})=>t(e)))}))}))}waitForPath(t,e={}){return s(this,void 0,void 0,(function*(){return(yield yo(this,[t],e))[0]}))}waitForPaths(t,e={}){return yo(this,t,e)}};Bo=e([Rs("x-geopad",{template:'<x-select class="tools"><div class="tool" data-tool="move"><svg class="icon" viewBox="0 0 28 28" width="28" height="28"><use xlink:href="/icons.fed6ed.svg#hand"></use></svg></div><div class="tool" data-tool="point"><svg class="icon" viewBox="0 0 28 28" width="28" height="28"><use xlink:href="/icons.fed6ed.svg#geo-point"></use></svg></div><div class="tool" data-tool="line"><svg class="icon" viewBox="0 0 28 28" width="28" height="28"><use xlink:href="/icons.fed6ed.svg#geo-line"></use></svg></div><div class="tool" data-tool="rectangle"><svg class="icon" viewBox="0 0 28 28" width="28" height="28"><use xlink:href="/icons.fed6ed.svg#geo-rectangle"></use></svg></div><div class="tool" data-tool="circle"><svg class="icon" viewBox="0 0 28 28" width="28" height="28"><use xlink:href="/icons.fed6ed.svg#geo-circle"></use></svg></div><div class="tool" data-tool="perpBisector"><svg class="icon" viewBox="0 0 28 28" width="28" height="28"><use xlink:href="/icons.fed6ed.svg#geo-perp-bisector"></use></svg></div><div class="tool" data-tool="angleBisector"><svg class="icon" viewBox="0 0 28 28" width="28" height="28"><use xlink:href="/icons.fed6ed.svg#geo-angle-bisector"></use></svg></div></x-select><slot></slot>'})],Bo);let Ro=class extends Bs{ready(){const t=this.$("use"),e=t.attr("xlink:href").replace("xxx",""),s=this.$("button");this.onAttr("icon",(s=>t.setAttr("xlink:href",e+s))),this.onAttr("title",(t=>null==s?void 0:s.setAttr("title",t)))}};Ro=e([Rs("x-icon-btn",{template:'<button class="btn"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#xxx"></use></svg></button>'})],Ro);let Do=class extends Bs{ready(){const t=this.$(".image"),e=this.positionTop<50;let s,i;t.css({"background-image":`url("${this.attr("background")}")`,height:e?"100%":"150%"});$s.onResize((({height:t})=>{const e=this.positionTop;s=Math.max(0,e-t),i=e+this.height})),ls.on("scroll",(function(n){if(n.top<s||n.top>i)return;const o=(n.top-s)/(i-s)*(e?50:33);t.css("transform",`translateY(${o}%)`)}))}};Do=e([Rs("x-parallax",{template:'<div class="image"></div><div class="content"><slot></slot></div>'})],Do);let jo=class extends Bs{constructor(){super(...arguments),this.isOpen=!1}ready(){this.animation=this.attr("animation")||"pop",this.$bubble=this.$(".popup-body"),this.$bubble.hide();this.$(".popup-target").on("click",(()=>this.toggle())),this.on("clickOutside",(()=>this.close()));for(const t of this.$bubble.$$("a"))t.on("click",(()=>this.close()));$s.onKey("escape",(()=>this.close()))}toggle(){this.isOpen?this.close():this.open()}open(){this.isOpen||(this.isOpen=!0,this.addClass("active"),this.$bubble.enter(this.animation,150),this.$bubble.setAttr("role","dialog"),this.$bubble.focus())}close(){this.isOpen&&(this.isOpen=!1,this.removeClass("active"),this.$bubble.exit(this.animation,150),this.$bubble.removeAttr("role"))}};jo=e([Rs("x-popup")],jo);let No=class extends Bs{constructor(){super(...arguments),this.$titles=[],this.active=0}ready(){const t=this.$(".titles");this.$body=this.$(".body"),this.$tabs=this.$$(".tab");for(let e=0;e<this.$tabs.length;++e){const s=this.$tabs[e].$("h3")||as("h3");s.setAttr("tabindex","0"),t.append(s),this.$titles.push(s),s.on("click",(()=>this.makeActive(e)))}this.$titles[0].addClass("active"),this.$tabs[0].show()}makeActive(t){if(this.active===t)return;this.$titles[this.active].removeClass("active"),this.$titles[t].addClass("active"),this.$tabs[t].show();const e=this.$tabs[t].outerHeight+"px";this.$tabs[t].hide(),this.$tabs[this.active].exit("fade",300).promise.then((()=>this.$tabs[t].enter("fade",300))),this.$body.animate({height:e},600).promise.then((()=>this.$body.css("height","auto"))),this.active=t,this.trigger("change",t)}};No=e([Rs("x-tabbox",{template:'<div class="titles"></div><div class="body"><slot></slot></div>'})],No);let Ho=class extends Bs{constructor(){super(...arguments),this.completed=!1}ready(){var t;this.r=+this.attr("r")||10,this.r1=this.r+12,this.$svg=as("svg",{width:2*this.r1,height:2*this.r1},this),this.$progress=as("path",{class:"pie",d:(t=this.r,`M${t},${t/2}a${t/2},${t/2},0,0,1,0,${t}A${t/2},${t/2},0,0,1,${t},${t/2}`),"stroke-width":this.r},this.$svg),this.onAttr("p",(t=>this.setProgress(+t,!1)))}setProgress(t,e=!0){if(t>.99)return this.complete(e);const s=Math.PI*this.r;this.$progress.css("stroke",t?"currentColor":"none"),this.$progress.css("stroke-dasharray",`${t*s} ${s}`)}complete(t=!0){if(this.completed)return;var e;if(this.completed=!0,this.$progress.css("stroke","none"),this.$progress.css("fill","currentColor"),this.$progress.setAttr("d",`M ${e=this.r},0 C ${e/2},0,0,${e/2},0,${e}  s ${e/2},${e},${e},${e} s ${e}-${e/2},${e}-${e}     S ${1.5*e},0,${e},0 z M ${44.6*e/50},${76.1*e/50} L ${19.2*e/50},${48.8*e/50} l ${4*e/50}-${4.2*e/50}     l ${19.8*e/50},${11.9*e/50} l ${34.2*e/50}-${32.6*e/50} l ${3.5*e/50},${3.5*e/50} L ${44.6*e/50},${76.1*e/50} z`),!t)return;const s=as("g",{transform:`translate(${this.r1} ${this.r1})`},this.$svg),i=g((()=>as("line",{},s)),18);ks((t=>{const e=this.r+12*Cs("quint-out",t),s=this.r+12*t;for(let t=0;t<18;++t){const n=Math.cos(2*Math.PI*t/18),o=Math.sin(2*Math.PI*t/18);i[t].setLine({x:n*e,y:o*e},{x:n*s,y:o*s})}}),800).promise.then((()=>s.remove()))}};function Zo(t,e,s,i){let n,o;t:for(const[r,h]of s)for(const s of e){const e=(i?i(r,s):r).subtract(s),a=e.length;if(a<t&&(t=a,n=e,o=h,a<1))break t}return n?{shift:n,target:o}:void 0}function Fo(t){if(Ht(t))return[t];if(zt(t))return t.points;if(Bt(t))return[t.p1,t.p2];if(Rt(t))return[t.c.shift(t.r,0),t.c.shift(-t.r,0),t.c.shift(0,t.r),t.c.shift(0,-t.r)];if(jt(t)||Dt(t)){const e=[t.start,t.end];jt(t)&&e.push(t.c);const s=t.radius;for(const[i,n]of[[s,0],[0,s],[-s,0],[0,-s]]){const s=t.c.shift(i,n);t.contains(s)&&e.push(s)}return e}return[]}function Uo(...t){return Xt.aroundPoints(function*(){for(const e of t)for(const t of Fo(e))yield t}())}function Wo(t,e,s=0){if(!t.size&&!e.size)return new Yt(0,100,0,100);const i=Xt.aroundPoints(function*(){for(const e of t)if(e.transformed)for(const t of Fo(e.transformed))yield t;for(const t of e){yield t.segments[0].p1;for(const e of t.segments)yield e.p2}}());return new Yt(i.p.x-s,i.p.x+i.w+s,i.p.y-s,i.p.y+i.h+s)}function Ko(t,e,s){if(Ht(e))return t.contains(e);if(Et(e))return Wt.collision(t.polygon,e);if(Ot(e))return e.collision(t);if(qt(e))return Ut(e,t).length>0||t.contains(e.p1);if(Rt(e))return"geo"===s?Ut(e,t).length>0||t.contains(e.at(0)):e.collision(t);if(jt(e)){const s=new Wt(e.c,e.start,e.at(.25),e.at(.5),e.at(.75),e.end);return Wt.collision(t.polygon,s)}return!1}Ho=e([Rs("x-progress")],Ho);const Go=new Map;function Xo(t){if(!t||!$s.theme.isDark)return t;if(Go.has(t))return Go.get(t);const e=O.fromHex(t).hsl;V(e[2],20,80)||(e[2]=100-e[2]);const s=O.fromHsl(...e).hex;return Go.set(t,s),s}const Yo=180/Math.PI,Qo=Math.PI/180,Jo="#cccccc",tr="#242436",er="#cd0e66",sr="#eb4726",ir="#fd8c00",nr="#bfc212",or="#22ab24",rr="#009ea6",hr="#0f82f2",ar="#6d3bbf",lr=new Map;class cr{constructor(t,e){this.$parent=t,this.type="tile",this.options="",this.colour="",this.posn=kt,this.rot=0,this.flipped=!1,this.locked=!1,this.isActive=!1,this.snapAngles=[0,90],this.rotateAroundOrigin=!1,this.showSelectionOutline=!1,this.hideSelectionOutline=!1,this.canDragToSelect=!0,this.keepOnTop=!1,this.canRotate=!0,this.canMove=!0,this.$el=e||as("g",{class:"tile"},t.$tiles),t.tiles.add(this),lr.set(this.$el._el,this)}makeHandle(t,e,s){const i=as("c"===t?"circle":"path",{class:"handle"},this.$el);"h"===t&&i.setAttr("d","M12.5,0H0V25H12.5a12.5,12.5,0,0,0,0-25Z"),"v"===t&&i.setAttr("d","M0,0V12.5a12.5,12.5,0,0,0,25,0V0Z"),"c"===t&&i.setAttr("r",10);let n,o="";return this.$parent.events.listen(i,{start:()=>{this.$parent.selection.add(this,!0),o=this.options,n=this.size},move:({posn:t})=>e(this.relativePosn(t),t),click:()=>null==s?void 0:s(),end:()=>{this.options===o&&this.size===n||this.$parent.change()}}),i}setColour(t){this.colour=t}setSize(t){this.size=t}flip(t){this.flipped=!this.flipped}click(t){}select(){this.isActive=!0,this.$parent.$activeTiles.append(this.$el)}deselect(){this.isActive=!1,this.$parent.$tiles.append(this.$el)}moveStart(){this.startPosn=this.posn}move(t,e){t&&(this.posn=this.startPosn.add(t),this.transform(!0))}moveEnd(){}transform(t=!1){const e=this.rot*Qo;this.$el.setTransform(this.posn,e),this.customTransform(this.posn,e),!t&&this.path&&(this.transformed=this.path.rotate(e).translate(this.posn),this.snapPoints=this.getSnapPoints().map((t=>t.rotate(e).translate(this.posn))),this.snapLines=this.getSnapLines().map((t=>t.rotate(e).translate(this.posn))))}customTransform(t,e){}setTransform(t,e=this.rot){this.posn=t,this.rot=et(e,360),this.transform()}static makeThumbnail(t,e,s,i){}getSnapPoints(){return this.path?Ht(this.path)?[this.path]:zt(this.path)?this.path.points:qt(this.path)?[this.path.p1,this.path.p2]:Rt(this.path)?[this.path.c,this.path.c.shift(0,this.path.r),this.path.c.shift(0,-this.path.r),this.path.c.shift(this.path.r,0),this.path.c.shift(-this.path.r,0)]:jt(this.path)?[this.path.c,this.path.start,this.path.end]:Dt(this.path)?[this.path.start,this.path.end]:[]:[]}getSnapLines(){return[]}delete(){this.$parent.selection.remove(this),this.$parent.tiles.delete(this),lr.delete(this.$el._el),this.$el.remove()}copy(t={},e=25){const s=new this.constructor(this.options,this.$parent);return this.colour&&s.setColour(this.colour),this.flipped&&s.flip(),s.setTransform(this.posn.shift(e,e),this.rot),this.size&&s.setSize(this.size),s}relativePosn(t){return t.subtract(this.posn).rotate(-this.rot*Qo)}get center(){return this.path?Uo(this.path).center:kt}get ariaDescription(){return`${this.type}: ${this.options}`}static action(t,e,s,i){}toJSON(){return{name:this.type,options:this.options,x:this.posn.x,y:this.posn.y,rot:this.rot,size:this.size,flipped:this.flipped,locked:this.locked,colour:this.colour}}static unSerialize(t,e){if(!t.name)return;const s=e.newTile(t.name,t.options||"");return t.flipped&&s.flip(),s.setTransform(new Mt(t.x,t.y),t.rot),t.colour&&s.setColour(t.colour),t.size&&s.setSize(t.size),s}}const dr=He({});dr.assign(uo);const pr=new Map,ur=new Map,fr=/^_x[0-9]+\.at\([0-9-.e]+\)$/,gr=/^intersections\(|\.midpoint$|\.centroid$/;class mr extends cr{constructor(t,e){super(e,as("path",{class:"geo-path"},e.$geoPaths)),this.$parent=e,this.type="geo",this.hideSelectionOutline=!0,this.isProjection=!1,this.parentIDs=[],this.deleted=!1,this.onDraw=()=>this.draw(),this.$shadow=as("path",{class:"geo-shadow"},e.$geoShadows),this.options=t;let[s,i]=t.split("=");i||(i=s,s=dr.getKey()),this.id=s,pr.set(s,this),this.snapPoints=this.snapLines=this.snapAngles=[],this.setExpr(i),dr.watch(this.onDraw),this.setColour(e.penColour)}setExpr(t,e=!1){const s=ke(t);dr.setComputed(this.id,s),e||(this.options=`${this.id}=${t}`,this.expr=t,this.setParentIDs(t.match(/_x[0-9]+/g)||[]),this.isProjection=fr.test(t),this.locked=gr.test(t),this.$el.setClass("locked",this.locked))}draw(){let t=dr[this.id];if(t===this.path)return;this.path=t,this.$el.toggle(!!t),this.isActive&&!t&&this.$shadow.hide();const e=null==t?void 0:t.type;if(e!==this.geoType){this.$el.setClass("geo-point","point"===e),this.$el.setClass("geo-path","point"!==e);("point"===e?this.$parent.$geoPoints:this.$parent.$geoPaths).append(this.$el),this.geoType=e}t&&("point"===e&&(t=new _t(t,this.locked?3.5:6)),this.$el.draw(t,{box:this.$parent.canvasBounds.rect}),this.$shadow.setAttr("d",this.$el.attr("d")),this.transform())}setParentIDs(t){var e;for(const t of this.parentIDs)null===(e=ur.get(t))||void 0===e||e.delete(this.id);this.parentIDs=t;for(const e of t)ur.has(e)||ur.set(e,new Set),ur.get(e).add(this.id)}get parents(){return this.parentIDs.map((t=>pr.get(t))).filter((t=>t))}get children(){const t=ur.get(this.id);return t?Array.from(t).map((t=>pr.get(t))).filter((t=>t)):[]}get ariaDescription(){var t;return`${null===(t=this.path)||void 0===t?void 0:t.type} ${this.id}: ${this.expr}`}select(){var t;this.isActive=!0,this.path&&this.$shadow.show(),null===(t=this.$el.parent)||void 0===t||t.append(this.$el)}deselect(){this.isActive=!1,this.$shadow.hide()}hover(t=!0){!this.isActive&&this.path&&(t?this.$shadow.show():this.$shadow.hide())}transform(){this.transformed=this.path,this.pending||(this.snapPoints=this.path&&Ht(this.path)?[this.path]:[],this.snapLines=!this.path||Ht(this.path)?[]:[this.path])}setTransform(){this.transform()}setColour(t){var e,s;this.colour=t,null===(e=this.$el)||void 0===e||e.css("color",Xo(t)),null===(s=this.$shadow)||void 0===s||s.css("color",Xo(t))}copy(t={}){if(!this.path)return;if(t[this.id])return t[this.id];let e=this.expr;if(Ht(this.path))e=`point(${this.path.x+25},${this.path.y+25})`;else for(const s of this.parents){const i=t[s.id]||s.copy(t);e=e.replace(s.id,i.id)}return t[this.id]=new mr(e,this.$parent)}delete(){this.deleted=!0,super.delete(),dr.unwatch(this.onDraw),dr[this.id]=void 0,pr.delete(this.id),this.$shadow.remove();for(const t of this.parents)"point"!==t.geoType||t.deleted||t.parentIDs.length||t.children.length||t.delete();for(const t of this.children)t.delete()}setPending(t=!0){this.pending=t,t||this.transform();for(const e of this.children)e.setPending(t)}moveStart(){if(!this.locked&&this.path){if(this.isProjection){if(this.$parent.selection.size>1)return;this.setParentIDs([])}this.setPending(!0);for(const t of this.parents)t.moveStart();this.moveStartValue=this.transformed}}move(t,e){if(t&&this.path&&this.moveStartValue)if(Ht(this.path))this.snapTarget=e,this.$el.setClass("locked",this.locked||!!(null==e?void 0:e.intersection)),dr[this.id]=this.moveStartValue.translate(t);else for(const e of this.parents)e.move(t)}moveEnd(){var t,e,s,i;if(this.moveStartValue){for(const t of this.parents)t.moveEnd();if(this.setPending(!1),null===(t=this.snapTarget)||void 0===t?void 0:t.intersection)this.setExpr(this.snapTarget.intersection.expr);else if("geo"===(null===(s=null===(e=this.snapTarget)||void 0===e?void 0:e.tile)||void 0===s?void 0:s.type)){const t=null===(i=this.snapTarget)||void 0===i?void 0:i.tile;if(t.path&&Ht(t.path)){for(const e of this.children)e.setExpr(e.expr.replace(this.id,t.id));return this.$parent.selection.add(t),this.delete()}if(t.path){const e=go(t.path,dr[this.id]);this.setExpr(`${t.id}.at(${e})`)}}}}static computeIntersections(t){t.intersections.clear();const e=Array.from(pr.values()).filter((t=>t.path&&!Ht(t.path))),s=e.length;for(let i=0;i<s;++i)for(let n=i+1;n<s;++n){const s=Ut(e[i].path,e[n].path);for(const[o,r]of s.entries())t.intersections.add({value:r,expr:`intersections(${e[i].id},${e[n].id})[${o}]`})}}static getInferredShape(t){const e=t.filter((t=>"geo"===t.type&&t.path));if(!e.length)return;if(1===e.length)return{type:e[0].path.type,expr:e[0].id};const s=e.filter((t=>Ht(t.path))),i=e.filter((t=>qt(t.path)||Rt(t.path)));if(1===i.length&&s.length===e.length-1){const t=i[0].path;if(s.every((e=>t.contains(e.path))))return{type:t.type,expr:i[0].id}}const n=i.filter((t=>qt(t.path)));if(s.length+n.length!==e.length)return;for(const t of n)if(Bt(t.path)){const e=t.parentIDs.map((t=>pr.get(t)));for(const t of e)s.includes(t)||s.push(t)}else if(s.filter((e=>t.path.contains(e.path))).length<2)return;const o=s.map((t=>t.id)).join(",");return 2===s.length?{type:"segment",expr:`segment(${o})`}:3===s.length?{type:"triangle",expr:`triangle(${o})`}:{type:"polygon",expr:`polygon(${o})`}}static construct(t,e,s){if((t=t.replace(/\$0/g,e||"")).includes("$1"))s.tools.geoPending.enable(t);else{const e=new mr(t,s);s.selection.add(e,!0);const i=Ht(e.path)?"pop":"draw";e.$el.enter(i,400),e.$shadow.enter(i,400),mr.computeIntersections(s)}}static redrawLines(t){for(const e of pr.values())e.path&&Vt(e.path)&&(e.$el.draw(e.path,{box:t}),e.$shadow.setAttr("d",e.$el.attr("d")))}static clearModel(){dr.clear(),dr.assign(uo)}}function vr(t,e,s,i=!1){const n=e||t,o=s||t,r=Math.atan2(o.y-n.y,o.x-n.x)+(i?Math.PI:0),h=.15*Mt.distance(n,o);return t.shift(Math.cos(r)*h,Math.sin(r)*h)}class $r{constructor(t,e,s,i){this.$parent=t,this.brush=i,this.path="",this.$el=as("path",{class:`stroke ${i}`},t.$strokes),this.setColor(s),t.strokes.add(this),1===e.length&&e.push(e[0].shift(.01)),this.draw(e)}setColor(t){this.color=t,this.$el.setAttr("stroke",Xo(t))}addPoint(t){this.segments.push(new St(v(this.segments).p2,t)),this.path+=`L${t.x},${t.y}`,this.$el.setAttr("d",this.path)}setLine(t){this.segments=[t],this.path=ie(t),this.$el.setAttr("d",this.path)}makeSnapPoints(){this.snapPoints=k(...this.segments.map((t=>[t.p1,t.p2]))),this.snapLines=this.segments}simplify(){const t=this.segments.map((t=>t.p1));t.push(v(this.segments).p2);const e=[t[0]];let s=0;for(let i=2;i<t.length;++i){const n=new St(v(e),t[i]);t.slice(s+1,i).every((t=>n.contains(t,3)))||(e.push(t[i-1]),s=i-1)}e.push(v(t)),this.draw(e)}draw(t){this.path=function(t){return t.length<=2?ie(new Kt(...t)):t.map(((e,s)=>{if(0===s)return`M${e.x} ${e.y}`;if(Mt.distance(t[s-1],e)<4)return`L${e.x},${e.y}`;const i=vr(t[s-1],t[s-2],e),n=vr(e,t[s-1],t[s+1],!0);return`C${i.x},${i.y} ${n.x},${n.y} ${e.x},${e.y}`})).join("")}(t),this.segments=new Kt(...t).edges,this.$el.setAttr("d",this.path)}hitTest(t,e){const s=e**2;return this.segments.some((e=>e.distanceSquared(t)<s))}delete(){this.$parent.strokes.delete(this),this.$el.remove()}serialize(){return{points:this.path.slice(0,16e3),colour:this.color,brush:this.brush}}static unSerialize(t,e){const s=Ke(t.points),i=new $r(e,s,t.colour||"#000",t.brush||"");return 2===s.length&&i.makeSnapPoints(),i}}function wr(t){const e=Math.cos(2*Math.PI/t);return 1/Math.sqrt(2-2*e)}const xr=t=>et(Math.round(t.angle*Yo),180),yr=t=>t.map((t=>`${X(t.x,3)} ${X(t.y,3)}`)).join(",");function br(t,e){const s=new Mt(-t/2,-e/2);return yr(new Xt(s,t,e).points)}const Mr=50,kr=Math.sqrt(3)/4*Mr,Ar=new Pt(kt,new Mt(0,1)),Cr={"equ-triangle":new Wt(new Mt(-25,kr),new Mt(25,kr),new Mt(0,-kr)),square:Wt.regular(4,Mr*wr(4)),"reg-pentagon":Wt.regular(5,Mr*wr(5)),"reg-hexagon":Wt.regular(6,Mr*wr(6)),"reg-heptagon":Wt.regular(7,Mr*wr(7)),"reg-octagon":Wt.regular(8,Mr*wr(8)),"reg-decagon":Wt.regular(10,Mr*wr(10)),"reg-dodecagon":Wt.regular(12,Mr*wr(12)),rectangle:new Xt(new Mt(-50,-25),100,Mr).polygon,trapezium:new Wt(new Mt(-50,kr),new Mt(Mr,kr),new Mt(25,-kr),new Mt(-25,-kr)),rhombus:new Wt(new Mt(-37.5,kr),new Mt(12.5,kr),new Mt(37.5,-kr),new Mt(-12.5,-kr)),"right-triangle":new Wt(new Mt(-25,-25),new Mt(25,-25),new Mt(-25,25)),"rhombus-2":new Wt(new Mt(25-kr,12.5),new Mt(-kr-25,12.5),new Mt(kr-25,-12.5),new Mt(kr+25,-12.5)),chevron:new Wt(new Mt(-37.5,2*kr),new Mt(12.5,2*kr),new Mt(37.5,0),new Mt(12.5,-2*kr),new Mt(-37.5,-2*kr),new Mt(-12.5,0)),"right-triangle-2":new Wt(new Mt(-2*kr,-25),new Mt(-2*kr,25),new Mt(2*kr,-25)),kite:new Wt(new Mt(0,-50),new Mt(2*kr,-25),new Mt(0,Mr),new Mt(-2*kr,-25)),dart:new Wt(new Mt(2*kr,37.5),new Mt(0,-37.5),new Mt(-2*kr,37.5),new Mt(0,12.5))},Pr=["","","",ir,hr,or,er,rr,ar,"",nr,"",sr],Tr={trapezium:er,"right-triangle":or,"rhombus-2":sr,chevron:sr,kite:ar,dart:rr},Sr={"equ-triangle":or,square:ir,"reg-pentagon":hr,"reg-hexagon":"#ffd615","reg-decagon":er,rectangle:ir,trapezium:"#cc1030",rhombus:hr,"rhombus-2":"#e6e2c6",chevron:"#cc1030","right-triangle-2":"#ffd615",kite:"#134791",dart:ar};function Lr(t){if(t in Cr)return Cr[t];if(t.match(/^[0-9.,\-\s]+$/)){const e=t.split(",").map((t=>new Mt(...t.split(" ").map((t=>+t)))));return new Wt(...e)}throw new Error("Unknown polygon type.")}const _r=["trapezium","rhombus","rhombus-2","rectangle","right-triangle","right-triangle-2"],zr=["equ-triangle","square","reg-pentagon","reg-hexagon","reg-heptagon","reg-octagon","reg-decagon","reg-dodecagon","rectangle","trapezium","kite","dart"];class Er extends cr{constructor(t,e){super(e),this.type="polygon",this.options=t,this.path=Lr(t),this.snapAngles=y(this.path.edges.map(xr)),this.symmetric=zr.includes(t);const s=e.options.altColors?Sr:Tr;this.colour=s[t]||Pr[this.path.points.length];const i=Xt.aroundPoints(this.path.points),n=new Mt(i.center.x,i.p.y);this.showSelectionOutline=Mt.distance(n,this.path.project(n))>5;const o={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=as("path",o,this.$el),this.$outline=as("path",{class:"outline",path:this.path},this.$el)}static makeThumbnail(t,e,s,i){const n=_r.includes(t)?30:40;let o=Lr(t);const r=Math.max(...o.points.map((t=>t.length)));o=o.scale(36/r).shift(40,n);const h=as("svg",{width:80,height:2*n},e),a=as("path",{class:"polygon-tile",path:o},h);s.options.watch((e=>{const s=e.altColors?Sr:Tr,n=i||s[t]||Pr[o.points.length];a.setAttr("fill",n)}))}setColour(t){super.setColour(t),this.$path.setAttr("fill",Xo(this.colour))}flip(t){t&&(this.posn=new Mt(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.flipped=!this.flipped,this.symmetric||(this.path=this.path.reflect(Ar),this.$path.draw(this.path),this.$outline.draw(this.path)),this.transform()}static action(t,e,s){if("flip"===t){for(const t of e)t.flip(s);e.values().next().value.$parent.selection.update()}}}const Ir=[[0,-.2],[1.2,-1],[.6,1],[-.6,1],[-1.2,-.2]].map((t=>new Mt(50*t[0],50*t[1])));class Or extends Er{constructor(t,e){super(t||yr(Ir),e),this.type="custom-polygon",this.$handles=[],this.showSelectionOutline=!0;for(const[t,e]of this.path.points.entries())this.makeVertex(e,t);let s;this.updatePath(),this.$parent.events.listen(this.$outline,{down:({posn:t})=>{t=this.relativePosn(t);const e=this.path.edges.findIndex((e=>t.distanceFromLine(e)<5));s=this.makeVertex(t,(e+1)%this.$handles.length),this.updatePath()},move:({posn:t})=>{s&&this.moveVertex(s,t)},end:()=>{s&&this.$parent.change()}}),this.$outline.css("cursor","crosshair")}makeVertex(t,e){if(this.$handles.length>=24)return;const s=this.makeHandle("c",((t,e)=>this.moveVertex(s,e)),(()=>this.deleteVertex(s)));return s.setCenter(t),s.setAttr("r",8),s.css("cursor","move"),this.$handles.splice(e,0,s),s}deleteVertex(t){t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.updatePath()}moveVertex(t,e){var s;const i=null===(s=this.$parent.snap([e]))||void 0===s?void 0:s.shift;t.setCenter(this.relativePosn(i?e.add(i):e)),this.updatePath()}updatePath(){const t=this.$handles.map((t=>t.center));this.path=new Wt(...t),this.$path.draw(this.path),this.$outline.draw(this.path),this.transform(),this.snapAngles=y(this.path.edges.map(xr)),this.options=yr(t),this.$parent.selection.update()}flip(t){t&&(this.posn=new Mt(2*t.x-this.posn.x,this.posn.y)),this.rot=-this.rot,this.transform();for(const t of this.$handles)t.setCenter(t.center.reflect(Ar));this.updatePath()}lock(){const t=new Er(this.options,this.$parent);t.setColour(this.colour),t.setTransform(this.posn,this.rot),this.$parent.selection.add(t),this.delete()}static makeThumbnail(t,e){const s=new Wt(...Ir).scale(.5).shift(40),i=as("svg",{width:80,height:80},e);as("path",{class:"polygon-tile",path:s,fill:or},i);for(const t of s.points)as("circle",{cx:t.x,cy:t.y,r:3,fill:"white"},i)}static action(t,e){if("lock"===t)for(const t of Array.from(e))t.lock()}}const qr=12.5,Vr=[[[0,2],[0,-4],[-2,-4],[-2,4],[2,4],[2,2],[0,2]],[[0,0],[0,-4],[-2,-4],[-2,2],[0,2],[0,4],[2,4],[2,0],[0,0]],[[-5,-1],[5,-1],[5,1],[-5,1]],[[-3,-2],[-3,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2]],[[3,-2],[3,0],[1,0],[1,-2],[-1,-2],[-1,2],[5,2],[5,-2],[3,-2]],[[-1,-3],[-1,-1],[-3,-1],[-3,3],[-1,3],[-1,1],[1,1],[1,-1],[3,-1],[3,-3],[-1,-3]],[[1,1],[1,-3],[-1,-3],[-1,1],[-3,1],[-3,3],[3,3],[3,1],[1,1]],[[1,-1],[1,-3],[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,1],[3,1],[3,-1],[1,-1]],[[-1,-3],[-1,-1],[-3,-1],[-3,1],[-1,1],[-1,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-4,-2],[-4,0],[-2,0],[-2,2],[0,2],[0,0],[4,0],[4,-2],[-4,-2]],[[-1,-3],[-1,1],[-3,1],[-3,3],[1,3],[1,-1],[3,-1],[3,-3],[-1,-3]],[[-1,-3],[-1,1],[-5,1],[-5,3],[1,3],[1,-3],[-1,-3]],[[-1,2],[1,2],[1,0],[3,0],[3,-2],[-3,-2],[-3,0],[-1,0]],[[-3,2],[-3,0],[-1,0],[-1,-2],[3,-2],[3,0],[1,0],[1,2]],[[-3,2],[-3,-2],[3,-2],[3,0],[-1,0],[-1,2]],[[-2,2],[2,2],[2,-2],[-2,-2]],[[-4,1],[4,1],[4,-1],[-4,-1]]].map((t=>t.map((t=>new Mt(t[0]*qr,t[1]*qr))))),Br=[[2,4],[4,4],[5,9],[7,2],[7,6],[11,3],[13,7],[15,3],[17,7],[20,2],[21,5],[23,7],[3,2],[7,2],[5,6],[10,4],[8,7]],Rr=[...O.rainbow(12).map((t=>t.hex)),er,hr,or,ir,ar];class Dr extends Er{constructor(t,e){super(yr(Vr[+t]),e),this.type="pentomino",this.options=t,this.setColour(Rr[+t])}static makeThumbnail(t,e){const s=Br[+t],i=new Wt(...Vr[+t]).scale(.8);e.draw(i.shift(10*s[0],10*s[1]).shift(1,1)),e.setAttr("fill",Rr[+t])}}const jr=[[[-4,-2],[0,2],[4,-2]],[[-4,-2],[0,2],[4,-2]],[[-2,0],[0,-2],[2,0],[0,2]],[[-3,1],[1,1],[3,-1],[-1,-1]],[[0,-1],[2,1],[-2,1]],[[0,-1],[2,1],[-2,1]],[[-2,-2],[2,-2],[2,2]]],Nr=[er,hr,or,ir,sr,rr,ar],Hr=[[2,4],[4,2],[6,4],[3,7],[7,2],[4,5],[6,6]],Zr=[-90,0,0,0,-90,0,90];class Fr extends Er{constructor(t,e){super(yr(jr[+t].map((t=>new Mt(...t).scale(25)))),e),this.type="tangram",this.snapAngles=[0,45,90,135],this.options=t,this.setColour(Nr[+t]),this.rot=Zr[+t],this.transform()}static makeThumbnail(t,e,s,i){const n=Hr[+t],o=jr[+t].map((e=>new Mt(...e).rotate(Zr[+t]*Qo).shift(...n).scale(18).shift(2,2))),r=new Wt(...o);e.draw(r),e.setAttr("fill",i||Nr[+t])}getSnapLines(){return this.path.edges}}const Ur=(1+Math.sqrt(5))/2*25,Wr=25*Math.sqrt((5+Math.sqrt(5))/2),Kr=Ur*(Math.sqrt(5)-1)/2,Gr=[`0 ${-Ur},${Wr} ${-Kr},0 ${Ur},${-Wr} ${-Kr}`,`0 ${2*Kr-Ur},${Wr} ${Kr},0 ${-Ur},${-Wr} ${Kr}`],Xr=[["M29.4-30.9C25.3-18.2,13.4-9.5,0-9.5c-13.4,0-25.3-8.6-29.4-21.4","M29.4,0C20.8-6.2,10.6-9.5,0-9.5c-10.6,0-20.8,3.3-29.4,9.5"],["M18.2,15.5C20.1,9.6,19,3.3,15.5-1.7C11.9-6.6,6.1-9.5,0-9.5c-6.1,0-11.9,2.9-15.5,7.9c-3.6,4.9-4.6,11.3-2.7,17.1","M18.2-15.5C12.9-11.6,6.5-9.5,0-9.5c-6.5,0-12.9-2.1-18.2-5.9"]],Yr=[er,hr];class Qr extends Er{constructor(t,e){super(Gr[+t],e),this.type="penrose",this.setColour(Yr[+t]),this.options=t;const s=as("g",{class:"penrose-circles"});this.$path.insertAfter(s);for(const e of Xr[+t])as("path",{d:e},s)}static makeThumbnail(t,e,s,i){const n=+t,o=as("svg",{width:80,height:80,viewBox:"-50 -50 100 100"},e);as("polygon",{points:Gr[n],class:"polygon-tile",fill:i||Yr[n]},o);const r=as("g",{class:"penrose-circles"},o);for(const t of Xr[n])as("path",{d:t},r)}}const Jr=["M13.9-13.9,2.8-25H-2.8L-25-2.8V2.8L-2.8,25H2.8L13.9,13.9C21.6,6.6,21.6-6.6,13.9-13.9Zm-2.8,25L0,22.2-22.2,0,0-22.2,11.1-11.1A15.8,15.8,0,0,1,11.1,11.1Z","M25-2.8,13.9-13.9c-7.3-7.7-20.5-7.7-27.8,0L-25-2.8V2.8l11.1,11.1c7.3,7.7,20.5,7.7,27.8,0L25,2.8ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1a15.8,15.8,0,0,1,22.2,0L22.2,0Z","M-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0s7.6-20.5,0-27.8L2.8-25H-2.8ZM15.7,0a15.9,15.9,0,0,1-4.6,11.1,15.8,15.8,0,0,1-22.2,0L-22.2,0,0-22.2,11.1-11.1A15.9,15.9,0,0,1,15.7,0Z","M-25-2.8V2.8L-2.8,25H2.8L25,2.8V-2.8L2.8-25H-2.8Zm25,25L-22.2,0,0-22.2,22.2,0Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8c-7.6,7.3-7.6,20.5,0,27.8s20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1c-5.8,6.1-16.3,6.1-22.2,0a15.8,15.8,0,0,1,0-22.2,15.8,15.8,0,0,1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z","M0-19.7a19.5,19.5,0,0,0-13.9,5.8L-25-2.8V2.8l11.1,11.1c7.3,7.6,20.5,7.6,27.8,0C26.3,1.6,17.5-19.7,0-19.7ZM11.1,11.1a15.8,15.8,0,0,1-22.2,0L-22.2,0l11.1-11.1c5.9-6.1,16.4-6.1,22.2,0A15.8,15.8,0,0,1,11.1,11.1Z"];class th extends Er{constructor(t,e){super("square",e),this.type="kolam",this.setColour(sr),this.options=t,as("path",{d:Jr[+t],fill:"white"},this.$el),as("circle",{r:3,fill:"white"},this.$el),this.$el.append(this.$outline),this.$path.css("stroke-width",".5px")}static makeThumbnail(t,e){const s=as("svg",{width:60,height:60},e);as("rect",{class:"polygon-tile",fill:sr,x:5,y:5,width:50,height:50},s),as("path",{d:Jr[+t],fill:"white",transform:"translate(30 30)"},s),as("circle",{r:3,cx:30,cy:30,fill:"white"},s)}}const eh=["M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-32.3,6.5,0,84.3H0L32.3,6.5A80.4,80.4,0,0,0,0,0,86.6,86.6,0,0,0-32.3,6.5Z","M-42.1,0A288.5,288.5,0,0,0-20.2,110.2a287.6,287.6,0,0,0,62.3,93.3V0Z","M-42.1,0V203.5a289.5,289.5,0,0,0,62.4-93.3A286.5,286.5,0,0,0,42.1,0Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-101.7 101.7L101.7 101.7Z","M0 0L-59.6 59.6L59.6 59.6Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z","M42.1.1H-42.2l-59.5,59.6A143.4,143.4,0,0,0,0,101.8,143,143,0,0,0,101.7,59.7Z"],sh=[[66,-17.5,-22.5],[82,-17.5,22.5],[23,-36.5,45],[125,-36.5,-45],[56,47.3,135],[92,47.3,-135],[74,101,180],[41,98,45],[107,98,-45]],ih={0:1,1:1,2:3,3:2,7:8,8:7},nh=[nr,rr,hr,er,ir,or,Jo,sr,ar];class oh extends Er{constructor(t,e){super(yr(Ke(eh[+t])),e),this.type="egg",this.snapAngles=[0,45,90,135],this.options=t,this.$path.setAttr("d",eh[+t]),this.$outline.setAttr("d",eh[+t]),this.setColour(nh[+t]),this.rot=sh[+t][2],this.transform(),+t<=1&&this.snapAngles.push(22.5,67.5,112.5,157.5)}flip(t){super.flip(t);const e=this.flipped&&ih[this.options]||this.options;this.$path.setAttr("d",eh[+e]),this.$outline.setAttr("d",eh[+e])}static makeThumbnail(t,e){e.setAttr("d",eh[+t]);const s=sh[+t];e.css("transform",`translate(${s[0]}px, ${s[1]}px) rotate(${s[2]}deg) scale(0.5)`),e.setAttr("fill",nh[+t]),e.css("stroke-width","2px")}}const rh=1/Math.sqrt(3),hh=50/rh,ah=[hr,ar,er,sr,ir],lh=Wt.regular(6,hh).rotate(Math.PI/6).points;lh.splice(3,1),lh.splice(2,0,new Mt(2*lh[1].x,lh[0].y));class ch extends Er{constructor(t,e){super(yr(lh.map((e=>e.scale(rh**+t)))),e),this.type="fractal",this.setColour(ah[+t]),this.options=t}static makeThumbnail(t,e){let s=new Wt(...lh).scale(.6*rh**+t);const i=Xt.aroundPoints(s.points),n=as("svg",{width:20+i.w,height:20+i.h},e);s=s.shift(10-i.center.x+i.w/2,10-i.center.y+i.h/2),as("path",{class:"polygon-tile",path:s,fill:ah[+t]},n)}}const dh=50;class ph extends cr{constructor(t,e){super(e),this.canRotate=!1,this.canDragToSelect=!1,this.$el.addClass("utensil"),this.width=+t,this.absoluteEnd=new Mt(this.width,0),this.setup(),this.$handles=[0,1].map((t=>this.makeHandle("c",((e,s)=>{var i;const n=t?this.posn:this.absoluteEnd,o=null===(i=this.$parent.snap([s]))||void 0===i?void 0:i.shift;s=o?s.add(o):s.snap(n,10),Mt.distance(s,n)<75&&(s=new _t(n,75).project(s)),t?this.absoluteEnd=s:this.posn=s,this.rot=this.absoluteEnd.angle(this.posn)*Yo,this.width=this.absoluteEnd.subtract(this.posn).length,this.update(),this.transform()})))),this.update()}moveEnd(){this.absoluteEnd=new Mt(this.width,0).rotate(this.rot).add(this.posn)}update(){this.options=""+this.width,this.$handles[1].setCenter({x:this.width,y:0})}}const uh=["ruler","protractor"];function fh(t){return uh.includes(t.type)}class gh extends ph{constructor(){super(...arguments),this.type="ruler"}setup(){this.$glass=as("rect",{x:-20,height:60,class:"glass",rx:5},this.$el),this.$ticks=as("path",{class:"ticks"},this.$el),this.$labels=g((t=>as("text",{text:t,x:dh*t,y:31},this.$el)),21)}update(){this.path=new St(kt,new Mt(this.width,0));const t=this.path.length+.1;this.$glass.setAttr("width",t+40);let e="";for(let s=0;s<=t;s+=5){e+=`M${s} 0L${s} ${[10,15,20][s%dh?s%25?0:1:2]}`}this.$ticks.setAttr("d",e);for(const[e,s]of this.$labels.entries())s.toggle(e<=t/dh);super.update()}getSnapPoints(){const t=this.path.length;return g((e=>this.path.at(e*dh/t)),t/dh)}getSnapLines(){return[this.path]}}class mh extends ph{constructor(){super(...arguments),this.type="protractor"}setup(){this.$glass=as("path",{d:"",class:"glass"},this.$el),this.$ticks=as("path",{class:"ticks"},this.$el),this.$labels=g((t=>as("text",{text:10*t,transform:`rotate(${90-10*t})`},this.$el)),19)}update(){const t=this.width;this.path=new At(kt,new Mt(-this.width,0),Math.PI),this.$glass.setAttr("d",function(t){return`M0-${t}A${t},${t},0,0,0-${t},0V3a5,5,0,0,0,5,5H${t-5}a5,5,0,0,0,5-5V0A${t},${t},0,0,0,0-${t}Z`}(t));let e="";const s=this.width<100?5:1;for(let i=0;i<=180;i+=s){const s=!(i%10),n=Mt.fromPolar(-i*Qo),o=t-(s?30:20);e+=`M${n.x*t} ${n.y*t}L${n.x*o} ${n.y*o}`,s&&(e+=`M${8*n.x} ${8*n.y}L${n.x*(t-50)} ${n.y*(t-50)}`)}this.$ticks.setAttr("d",e);for(const[e,s]of this.$labels.entries()){const i=t>160||!(e%3);s.toggle(i),i&&s.setAttr("y",44-t)}super.update()}getSnapPoints(){return[kt,this.path.start,this.path.at(.5),this.path.end]}getSnapLines(){return[]}}class vh extends ph{constructor(){super(...arguments),this.type="compass"}setup(){}update(){}getSnapPoints(){return[]}getSnapLines(){return[]}}const $h=["M-25,34.4a81.3,81.3,0,0,1,50,0h0A81.1,81.1,0,0,0,40.4-13.1h.1A81.5,81.5,0,0,1,0-42.5H0A81.5,81.5,0,0,1-40.5-13.2h.1A81.1,81.1,0,0,0-25,34.4Z","M-15.4-21.3A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3a80.6,80.6,0,0,1,50,0A80.3,80.3,0,0,1,25,8.1,80.4,80.4,0,0,1,40.4,55.7,80.2,80.2,0,0,1,0,26.3,80.2,80.2,0,0,1-40.4,55.7,80.4,80.4,0,0,1-25,8.1,80.3,80.3,0,0,1-65.4-21.3,80.6,80.6,0,0,1-15.4-21.3Z","M65.4-21.3A80.5,80.5,0,0,1,0,12.1,80.5,80.5,0,0,1-65.4-21.3a80.6,80.6,0,0,1,50,0A80.5,80.5,0,0,1,0-68.8,80.5,80.5,0,0,1,15.4-21.3,80.6,80.6,0,0,1,65.4-21.3Z","M80.9-47.5h0A81.5,81.5,0,0,1,40.4-76.9,80.4,80.4,0,0,0,0-47.5,80.2,80.2,0,0,0-40.5-76.9h0A80.8,80.8,0,0,1-80.9-47.6h0A80.3,80.3,0,0,1-65.5,0,80.3,80.3,0,0,1-80.9,47.5h0A80.8,80.8,0,0,1-40.5,76.9h0A80.2,80.2,0,0,0,0,47.5,80.4,80.4,0,0,0,40.4,76.9,81.5,81.5,0,0,1,80.9,47.6h0A80.3,80.3,0,0,1,65.5,0,80.3,80.3,0,0,1,80.9-47.5Z","M0-47.5A80.3,80.3,0,0,1,15.5,0,80.3,80.3,0,0,1,0,47.5,80.3,80.3,0,0,1-15.5,0,80.3,80.3,0,0,1,0-47.5Z","M130.9,153.8a80.5,80.5,0,0,1,15.4-47.5,80.2,80.2,0,0,1-40.4-29.4A80.1,80.1,0,0,1,90.5,29.4a80.6,80.6,0,0,1-50,0A80.6,80.6,0,0,1,0,0,80.3,80.3,0,0,1-40.4,29.4a80.9,80.9,0,0,1-50.1,0,80.8,80.8,0,0,1-15.4,47.5,80.9,80.9,0,0,1-40.5,29.4,79.9,79.9,0,0,1,15.5,47.5,81.3,81.3,0,0,1,50,0A80.9,80.9,0,0,1,0,72.9a80.9,80.9,0,0,1,80.9,80.9A81.3,81.3,0,0,1,130.9,153.8Z","M40.4-13.2A80.4,80.4,0,0,0,0-42.5,80.7,80.7,0,0,0-40.4-13.1,80.9,80.9,0,0,0-25,34.4a80.6,80.6,0,0,0,50,0A81.2,81.2,0,0,0,40.4-13.2Z","M40.4-13.1A82,82,0,0,1,0-42.5,81.1,81.1,0,0,1-40.5-13.2,81.3,81.3,0,0,1-25,34.4a81.3,81.3,0,0,1,50,0A81.6,81.6,0,0,1,40.4-13.1Z"],wh=["M16.2-.3a5.5,5.5,0,0,1-4.4,6.4A5.3,5.3,0,0,1,5.5,1.8,5.4,5.4,0,0,1,9.8-4.6,5.5,5.5,0,0,1,16.2-.3Zm8-8A3.8,3.8,0,0,0,28-4.5a3.7,3.7,0,0,0,3.7-3.8A3.6,3.6,0,0,0,28-12,3.7,3.7,0,0,0,24.2-8.3ZM19,23.4a4.9,4.9,0,0,0,4.8-4.8A4.8,4.8,0,0,0,19,13.9a4.7,4.7,0,0,0-4.7,4.7A4.8,4.8,0,0,0,19,23.4ZM-11.7,6.1A5.3,5.3,0,0,0-5.4,1.8,5.4,5.4,0,0,0-9.7-4.6,5.5,5.5,0,0,0-16.1-.3,5.5,5.5,0,0,0-11.7,6.1ZM-27.9-4.5a3.8,3.8,0,0,0,3.8-3.8A3.7,3.7,0,0,0-27.9-12a3.6,3.6,0,0,0-3.7,3.7A3.7,3.7,0,0,0-27.9-4.5ZM20.9-22A139.9,139.9,0,0,1,3-19.5a1.1,1.1,0,0,1-.1.5L1-15.2V30H-1V-15.2L-2.9-19a1.1,1.1,0,0,1-.1-.5,127,127,0,0,1-17.8-2.6A80.8,80.8,0,0,0,0-41.7,83.3,83.3,0,0,0,20.9-22ZM-3.8-26.7A3.2,3.2,0,0,0-7-30a3.3,3.3,0,0,0-3.3,3.3A3.2,3.2,0,0,0-7-23.5,3.2,3.2,0,0,0-3.8-26.7ZM6.5-30a3.2,3.2,0,0,0-3.2,3.3,3.2,3.2,0,0,0,3.2,3.2,3.2,3.2,0,0,0,3.3-3.2A3.3,3.3,0,0,0,6.5-30ZM-23.7,18.6a4.9,4.9,0,0,0,4.8,4.8,4.8,4.8,0,0,0,4.7-4.8,4.7,4.7,0,0,0-4.7-4.7A4.8,4.8,0,0,0-23.7,18.6Z","M-16.9-4.7l-17.7-6.1a.8.8,0,0,1-.5-.9.8.8,0,0,1,.9-.5L-16.5-6a.7.7,0,0,1,.5.9.7.7,0,0,1-.7.4ZM-24.6-13l9.7,5.4h.3a.9.9,0,0,0,.7-.3.9.9,0,0,0-.3-1l-9.7-5.4a.8.8,0,0,0-1,.2A.8.8,0,0,0-24.6-13ZM-7.8-4.9l5.9,1.2h.5c.2-.1.3-.2.3-.4l.3-1.4a.6.6,0,0,0-.5-.8L-7.2-7.7h-.6l-.3.4-.3,1.4A.8.8,0,0,0-7.8-4.9ZM2.8-2.5a.9.9,0,0,0,.7.6h.2l1.6-.3a1,1,0,0,0,.5-.4.7.7,0,0,0,.1-.5l-1.4-6a.8.8,0,0,0-.9-.6L2-9.4l-.5.3a1.3,1.3,0,0,0-.1.6ZM10.9.4a.7.7,0,0,0-.1-.5L10-1.3a.8.8,0,0,0-1-.2L4,1.9c-.2.1-.3.2-.3.4a.7.7,0,0,0,.1.5L4.6,4a.6.6,0,0,0,.6.3h.4l5-3.4ZM-4.5-1l-1.4-.3a.4.4,0,0,0-.5.1c-.2.1-.3.2-.3.4L-8.2,5.1a.7.7,0,0,0,.5.8l1.4.4h.5a.5.5,0,0,0,.3-.5L-4-.1A.7.7,0,0,0-4.5-1Zm-12.1-.6a.7.7,0,0,0,.7-.6c.1-.4-.2-.7-.6-.8l-11-1.7a.8.8,0,0,0-.8.6c0,.4.2.8.6.8l11,1.7Zm16.1,6H-1c-.2,0-.3.1-.5.3l-.8,1.1a.8.8,0,0,0,.1,1l4.9,3.6.4.2h.1l.4-.3.9-1.1c.2-.4.2-.8-.1-1Zm-9.4,8.8a.7.7,0,0,0-1,.1L-22.2,28.2a.7.7,0,0,0,.1,1l.4.2a.9.9,0,0,0,.6-.3l11.3-15A.6.6,0,0,0-9.9,13.2Zm-11.2,5.6c.2.2.3.3.5.3l.5-.2,8.2-7.6a.7.7,0,0,0,0-1,.8.8,0,0,0-1,0L-21,17.8A.7.7,0,0,0-21.1,18.8Zm14-4.9a.8.8,0,0,0-1,.4L-13,24.2a.6.6,0,0,0,.3.9h.3a.6.6,0,0,0,.6-.4l5-9.9A.8.8,0,0,0-7.1,13.9Zm17.4-.7a.8.8,0,0,0-1-.2.8.8,0,0,0-.2,1L19.9,29.4a.5.5,0,0,0,.5.3h.4a.7.7,0,0,0,.2-1ZM7,14.4A.7.7,0,0,0,6,14a.7.7,0,0,0-.3.9L10.3,25a.8.8,0,0,0,.7.4h.3a.8.8,0,0,0,.3-1Zm4-2.8,7.8,7.8.5.2.5-.2a.7.7,0,0,0,0-1L12,10.6a.7.7,0,0,0-1,1ZM34.4-11.2a.7.7,0,0,0-.8-.5l-18,5.5a.7.7,0,0,0-.4.9.6.6,0,0,0,.6.5c.1,0,.2,0,.2-.1l18-5.4A.7.7,0,0,0,34.4-11.2ZM26.7-4l-11,1.3a.6.6,0,0,0-.6.8.7.7,0,0,0,.7.6h.1l11-1.3c.4,0,.6-.4.6-.8S27.1-4,26.7-4ZM14-7.3h.3l9.8-5.1a.7.7,0,0,0,.3-1,.7.7,0,0,0-.9-.3L13.6-8.6a.8.8,0,0,0-.3,1A.8.8,0,0,0,14-7.3ZM-.5-16.6h0a.7.7,0,0,0,.7-.6L.6-36a.7.7,0,0,0-.7-.7.7.7,0,0,0-.7.7l-.4,18.7A.7.7,0,0,0-.5-16.6Zm3.2,1.2h.2a.7.7,0,0,0,.7-.6L5.7-26.9a.7.7,0,0,0-.5-.8.8.8,0,0,0-.9.6L2.2-16.3A.7.7,0,0,0,2.7-15.4Zm-6.1-.1h.1c.4-.1.7-.5.6-.8l-1.8-11c0-.4-.4-.6-.8-.6a.8.8,0,0,0-.6.8l1.8,11A.9.9,0,0,0-3.4-15.5Z","M60.8-16.2l-3.6-2.5,1.4-3.9-.9-.3-1.3,3.5h0l-9.5,3,2.8-7.8h-1l-3,8.3-9.5,3.1,4.4-11.8H39.5L35-12.5,25.5-9.4l5-14.7H29.4L24.3-9.1l-9.1,3,6-16.3-1.2.3L14-5.7l-1.8.5a50.6,50.6,0,0,0,5.3-16.2l-1.9.6-.4.2L1-9.8v-10L14.4-30.3c0-.4-.1-.8-.1-1.2L1-21.1v-10l11.7-9.1-.3-1.1L1-32.4v-10l8.9-6.9a3,3,0,0,0-.4-1L1-43.7v-10l5.2-4a4.1,4.1,0,0,0-.5-.9l-5.2,4h-1l-5.2-4a4.1,4.1,0,0,0-.5.9l5.2,4v10l-8.5-6.6a3,3,0,0,0-.4,1L-1-42.4v10l-11.4-8.9-.3,1.1L-1-31.1v10L-14.3-31.5c0,.4-.1.8-.1,1.2L-1-19.8v10L-15.2-20.6l-.4-.2-1.9-.6A50.6,50.6,0,0,0-12.2-5.2L-14-5.7l-6-16.4-1.2-.3,6,16.3-9.1-3L-29.4-24h-1.1l5,14.7L-35-12.5l-4.5-12.2h-1.1l4.4,11.8L-45.7-16l-3-8.3h-1l2.8,7.8-9.5-3h0l-1.3-3.5-.9.3,1.4,3.9-3.6,2.5.7.7,3.1-2.2v.2l9.4,3-6.8,4.8.7.7,7.3-5.1,9.6,3.1L-47.3-3.8l.9.6,10.8-7.4,9.5,3.1-13,8.9,1,.5,13.2-9,9.6,3-14.4,10,1.2.4,14.3-9.9h.4l3,1C-9.8-1-8.9.5-7.9,1.9L-18.4,9.4l1.3.3,9.8-7a64.2,64.2,0,0,0,6.6,8H.7a64.2,64.2,0,0,0,6.6-8l9.8,7,1.3-.3L7.9,1.9C8.9.5,9.8-1,10.8-2.6l3-1h.4L28.5,6.3l1.2-.4L15.3-4.1l9.6-3,13.2,9,1-.5-13-8.9,9.5-3.1L46.4-3.2l.9-.6L36.8-11l9.6-3.1L53.7-9l.7-.7-6.8-4.8,9.4-3v-.2l3.1,2.2Zm-76-3.2L-1-8.5V.6l-9.7-7.4A45.9,45.9,0,0,1-15.2-19.4ZM0,8.5A66.6,66.6,0,0,1-9.6-4.7L-1,1.8V6.3a1,1,0,0,0,1,1,1,1,0,0,0,1-1V1.8L9.6-4.7A71,71,0,0,1,0,8.5ZM10.7-6.8,1,.6V-8.5L15.2-19.4A45.9,45.9,0,0,1,10.7-6.8Z","M65-1V1.1A81.6,81.6,0,0,1,40,5c-8.9,0-12.7-.4-20.6-2.9A1,1,0,0,1,18.8.8.9.9,0,0,1,20,.2C27.7,2.7,31.2,3,40,3A79.7,79.7,0,0,0,64.7-.9ZM-64.6,1.1A82.4,82.4,0,0,0-39.4,5c8.8,0,12.6-.4,20.5-2.9A1.2,1.2,0,0,0-18.2.8,1,1,0,0,0-19.5.2C-27.2,2.7-30.7,3-39.4,3A79.9,79.9,0,0,1-64.2-.9H-65V1ZM-45.8,36a6.7,6.7,0,0,1,6.7-6.7A6.7,6.7,0,0,1-32.4,36a6.7,6.7,0,0,1-6.7,6.7A6.7,6.7,0,0,1-45.8,36Zm2,0a4.7,4.7,0,0,0,4.7,4.7A4.7,4.7,0,0,0-34.4,36a4.7,4.7,0,0,0-4.7-4.7A4.7,4.7,0,0,0-43.8,36Zm10.4-71.4a5.7,5.7,0,0,0-5.7-5.7,5.6,5.6,0,0,0-5.7,5.7,5.7,5.7,0,0,0,5.7,5.7A5.8,5.8,0,0,0-33.4-35.4ZM4.9-37.1a2.2,2.2,0,0,0,2.2,2.2,2.2,2.2,0,0,0,2.2-2.2,2.2,2.2,0,0,0-2.2-2.2A2.2,2.2,0,0,0,4.9-37.1ZM38.7,42.7h0A6.8,6.8,0,0,1,32,36a6.7,6.7,0,1,1,6.7,6.7ZM43.4,36a4.7,4.7,0,1,0-4.7,4.7h0A4.7,4.7,0,0,0,43.4,36ZM0,42.9c4.1.7,8.7-9.6,11.4-17.9A78.6,78.6,0,0,0,15.3.3c0-6.7-1.3-13.7-3.2-21.6-.6-1.6-3.4-4.2-5.8-5.1,2.2-2,1.8-2.9,2.3-3.7s.1-3.3,0-3.8c-4.5,1.1-6.3-2.7-4.3-5.5C9-44,19.3-53.3,29-55.2a6.4,6.4,0,0,0,1,1.3,3.1,3.1,0,0,0,1.8.5,2.9,2.9,0,0,0,2.4-1.2h0a3,3,0,0,0-.6-4.2,2.9,2.9,0,0,0-4.2.7,2.6,2.6,0,0,0-.5.9C19-55.4,8.7-46.5,3.6-41.5A33.5,33.5,0,0,1-.2-42.6l-3.7,1.2c-5-4.9-15.3-13.9-25.4-15.8a2.7,2.7,0,0,0-.5-1.1,3,3,0,0,0-4.2-.6,3,3,0,0,0-.6,4.2h0a3,3,0,0,0,2.4,1.2,3.2,3.2,0,0,0,1.8-.6,3.1,3.1,0,0,0,.9-1.1c10.1,2,20.8,11.8,25.2,16.3,1.3,2.5-.4,5.8-4.2,5-.1.6-.5,3,0,4s.6,1.5,2.3,3.5c-2.4.7-6,4-6.3,5.3-1.6,7-3,15.5-3,21.4a78.8,78.8,0,0,0,4,24.7C-8.8,33.3-3.5,43.8,0,42.9Zm-5.2-80a2.2,2.2,0,0,0-2.2-2.2,2.2,2.2,0,0,0-2.2,2.2,2.2,2.2,0,0,0,2.2,2.2A2.2,2.2,0,0,0-5.2-37.1ZM33-35.4a5.8,5.8,0,0,0,5.7,5.7,5.7,5.7,0,0,0,5.7-5.7,5.6,5.6,0,0,0-5.7-5.7A5.7,5.7,0,0,0,33-35.4Z","M.9,33.4v-9l12.7-9.9.3-1.4L.9,23.2v-10l14-10.9V1L.9,12V2L14.5-8.6c0-.3-.1-.7-.1-1.1L.9.8v-10l11.9-9.3a3.6,3.6,0,0,1-.2-1L.9-10.4v-10l9.2-7.1a4.2,4.2,0,0,0-.4-1L.9-21.6v-9.9h0l5.6-4.3L6-36.8.4-32.4H-.4L-6-36.8l-.5.9L-1-31.6a.1.1,0,0,0-.1.1v9.8l-8.6-6.8a4.2,4.2,0,0,0-.4,1l9,7v10l-11.5-9a3.6,3.6,0,0,1-.2,1L-1.1-9.3V.7L-14.4-9.7c0,.4-.1.8-.1,1.1L-1.1,1.9v10L-14.9,1V2.3L-1.1,13.1v10l-12.8-10,.3,1.4,12.5,9.8v9l-9.6-7.5.6,1.8,9,7v4.1a1,1,0,0,0,1,1,.9.9,0,0,0,1-1v-4l9.2-7.1.6-1.7Z","M0,.8A76.2,76.2,0,0,0,7.8,9.9c-1.6,1.9-5.4,7.6-6.6,21.6h-2C-2,17.1-6,11.4-7.6,9.7A72.7,72.7,0,0,0,0,.8ZM124.3,117.2c-6.5,4.7-6.3,16,.5,25.4a30,30,0,0,0,5.8,6,81.7,81.7,0,0,1,8.3-31.1C133.6,114.7,128.1,114.4,124.3,117.2ZM-82.6,86.3A82.8,82.8,0,0,0-104,75l-1.2,1.7A81,81,0,0,1-83.8,87.9a79.9,79.9,0,0,1,17.6,17.7l.3.5,1.3-1.7A81.3,81.3,0,0,0-82.6,86.3Zm47.3-33.1a80,80,0,0,1-3.9-23.7l-1.1.4-.9.2a83.5,83.5,0,0,0,4,23.7A79.9,79.9,0,0,0-25.8,76.6l2-.6-.3-.4A78.4,78.4,0,0,1-35.3,53.2Zm-81,62.7.6-1.9c-11.9-5.1-16.5-10-18.1-12.4a81.4,81.4,0,0,1-11.8,4.9,85.1,85.1,0,0,1,5.8,9.4C-138.6,115.3-132.2,112.1-116.3,115.9ZM-90,30.1a81.7,81.7,0,0,1-.8,11.1c2,.4,8.7,2.3,18.5,13.8l1.7-1.2c-6.9-11.4-7.6-18.1-7.4-20.9A99.4,99.4,0,0,1-90,30.1ZM38,53.8a85.2,85.2,0,0,0,4.1-23.4l-1.8-.5h-.2a81.5,81.5,0,0,1-4,23.4A81.4,81.4,0,0,1,24.6,75.5l-.4.6,2,.7h0A83,83,0,0,0,38,53.8Zm68.4,24.7-.9-1.3-.3-.4a82,82,0,0,1-17.3,17,82,82,0,0,1-22.5,11.3h-.2l1.2,1.7A85.2,85.2,0,0,0,89.1,95.4,81.6,81.6,0,0,0,106.4,78.5ZM70.8,54.6l1.6,1.2c9.9-11.4,16.5-13.4,18.5-13.7a80.8,80.8,0,0,1-.9-12,97.8,97.8,0,0,1-11.9,2.8C78.4,35.1,78.4,42.1,70.8,54.6ZM126.3,152a28,28,0,0,0-3.9-7.7,26.3,26.3,0,0,0-11.9-9.5c-4.6-1.6-8.8-1.3-12,1s-5.5,8.3-4.3,14.4A82.6,82.6,0,0,1,126.3,152Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z","M0,4L5,6.6L4,1.1L8.1,-2.9L2.5,-3.7L0,-8.8L-2.5,-3.7L-8.1,-2.9L-4,1.1L-5,6.6Z"],xh=[er,hr,or,ir,or,rr,sr,ar],yh=["-30 -35 60 60","-35 -42 70 70","-35 -60 70 70","-45 -45 90 90","-15 -30 30 60","-75 28 150 100","-30 -35 60 60","-30 -35 60 60"],bh=[.7,.6,.3,.6,.3,.6,.7,.7];class Mh extends Er{constructor(t,e){super(yr(Ke($h[+t])),e),this.type="garden",this.options=t;const s=+t;this.$path.setAttr("d",$h[s]),this.$outline.setAttr("d",$h[s]);const i=as("path",{d:wh[s],fill:"black",opacity:bh[s]});this.$path.insertAfter(i),this.symmetric=!0,this.setColour(xh[s])}static makeThumbnail(t,e){const s=+t,i=as("svg",{width:4===s?40:5===s?120:80,height:80,viewBox:yh[s]},e),n=as("g",{transform:"scale(0.5)"},i);as("path",{d:$h[s],fill:xh[s],class:"polygon-tile"},n),as("path",{d:wh[s],fill:"black",opacity:bh[s]},n)}}const kh=["M34,0a16,16,0,0,1,6.3-12.7l-9-15.7A34.1,34.1,0,0,0,16,0,34.1,34.1,0,0,0,31.3,28.4l9-15.7A16,16,0,0,1,34,0Z","M-25,9.3a33.7,33.7,0,0,0-15.2,3.6l9,15.7A14.4,14.4,0,0,1-25,27.3a16.1,16.1,0,0,1,15.9,14h18A34,34,0,0,0-25,9.3Z","M-25-9.3a33.7,33.7,0,0,1-15.2-3.6l9-15.7A14.4,14.4,0,0,0-25-27.3a16.1,16.1,0,0,0,15.9-14h18A34,34,0,0,1-25-9.3Z","M-8.9,41.3h18A16.1,16.1,0,0,1,25,27.3a14.4,14.4,0,0,1,6.2,1.3l9-15.7A33.9,33.9,0,0,0-8.9,41.3Z","M-31.3-28.4l-9,15.6A65.9,65.9,0,0,1-9.1,41.3h18A83.7,83.7,0,0,0-31.3-28.4Z","M-8.9,41.3h18A65.9,65.9,0,0,1,40.3-12.8l-9-15.6A83.7,83.7,0,0,0-8.9,41.3Z","M-40.3 12.9L-31.3 28.4L40.3 -12.9L31.3 -28.4Z","M-40.2,12.9l9,15.6A65.7,65.7,0,0,1,0,20.6a65.7,65.7,0,0,1,31.2,7.9l9-15.6A82.6,82.6,0,0,0,0,2.6,82.6,82.6,0,0,0-40.2,12.9Z","M31.3,28.4l9-15.6A65.9,65.9,0,0,1,9.1-41.3h-18A83.7,83.7,0,0,0,31.3,28.4Z"],Ah=[[6,3,2],[6,4,8],[7,2,5],[7,5,2],[2,6,3],[8,6,4],[5,7,2],[2,7,5],[3,2,6],[4,8,6],[2,5,7],[5,2,7],[0,1,2],[0,2,1]],Ch="#242436",Ph=[er,or,ir];function Th(t,e){const s=Ah[t].map(((t,e)=>[t,e])).sort(((t,e)=>e[0]-t[0]));for(const[t,i]of s)as("path",{d:kh[t],"stroke-width":2.8,stroke:Ch,fill:Ph[i]},e)}class Sh extends Er{constructor(t,e){super("reg-hexagon",e),this.type="tantrix",this.options=t,this.$path.setAttr("fill",Ch),Th(+t,this.$el)}static makeThumbnail(t,e){const s=as("svg",{width:60,height:60,viewBox:"-54 -54 108 108"},e);as("path",{class:"polygon-tile",path:Lr("reg-hexagon"),fill:Ch},s),Th(+t,s)}}const Lh=25,_h={100:ir,10:hr};function zh(t,e,s){return as("rect",{class:"number-tile",width:t,height:t,fill:s},e)}function Eh(t,e,s,i,n,o){t.setAttr("x",n+e%s*i),t.setAttr("y",o+Math.floor(e/s)*i)}class Ih extends cr{constructor(t,e){super(e),this.type="number-tile",this.options=t;const[s,i]=t.split(":").map((t=>+t));this.count=i,this.colour=_h[i]||er,this.$tiles=g((()=>zh(Lh,this.$el,this.colour)),i),this.$outline=as("path",{class:"outline"},this.$el),i>1&&(this.$handle=this.makeHandle("h",(t=>this.setWidth(Math.round(t.x/Lh))))),this.setWidth(s,!0)}setWidth(t,e=!1){var s;if((t=Q(t,1,this.count))!==this.width){this.value=this.count,this.width=t,this.options=`${t}:${this.count}`;for(let e=0;e<this.count;++e)Eh(this.$tiles[e],e,t,Lh,-12.5,-12.5);this.path=function(t,e,s,i){const n=i.shift(t*s,0),o=n.shift(0,Math.floor(e/t)*s),r=i.shift(0,Math.ceil(e/t)*s),h=r.shift(e%t*s,0),a=h.shift(0,e%t?-s:0);return new Wt(i,n,o,a,h,r)}(t,this.count,Lh,new Mt(-12.5,-12.5)),this.$outline.draw(this.path),null===(s=this.$handle)||void 0===s||s.setTransform(new Mt((t-.5)*Lh,-12.5)),this.transform(),e||this.$parent.selection.update()}}setColour(t){this.colour=t;for(const e of this.$tiles)e.setAttr("fill",Xo(t))}static makeThumbnail(t,e){let[s,i]=t.split(":").map((t=>+t));s=Math.min(s,i);const n=as("svg",{width:1===i?40:80,height:80},e),o=(1===i?20:40)-s/2*7,r=40-Math.ceil(i/s)/2*7,h=_h[i]||er;for(let t=0;t<i;++t)Eh(zh(7,n,h),t,s,7,o,r)}getSnapPoints(){const t=new Mt(-12.5,-12.5),e=[t];for(let s=1;s<=this.width;++s)e.push(t.shift(s*Lh,0));const s=Math.ceil(this.count/this.width);for(let i=1;i<=s;++i)e.push(t.shift(0,i*Lh));for(let s=0;s<this.count;++s)e.push(t.shift((s%this.width+1)*Lh,Math.floor(s/this.width+1)*Lh));return e}split(){if(1===this.count)return;const t=g((t=>{const e=t%this.width*Lh,s=Math.floor(t/this.width)*Lh,i=this.posn.shift(e,s).rotate(this.rot*Qo,this.posn);return Oh(1,1,this.$parent,i,this.rot,this.colour)}),this.count);this.$parent.selection.select(t),this.delete()}static action(t,e){if("split"===t)for(const t of e)t.split();else if("merge"===t){const t=Array.from(e),s=$(t.map((t=>t.count))),i=v(w(t,(t=>t.count))),n=i.$parent,o=Math.min(...t.map((t=>t.posn.x))),r=Math.min(...t.map((t=>t.posn.y))),h=Oh(s,Math.max(...t.map((t=>Math.ceil((t.posn.x-o)/Lh)+t.width))),n,new Mt(o,r),i.rot,i.colour);for(const t of e)t.delete();n.selection.add(h)}}}function Oh(t,e,s,i,n,o){const r=new Ih(`${e}:${t}`,s);return r.setColour(o),r.setTransform(i,n),r}const qh=[ir,"#f15e19","#e1343b",er,"#8d2ca1","#4e53d0",hr,rr,or,nr],Vh=["#e6e2c6","#cc1030",or,er,"#ffd615",rr,"#181824","#9a2e13",hr,ir];class Bh extends Er{constructor(t,e){super(br(25*+t,25),e),this.type="number-bar",this.options=t,this.value=+t,this.$text=as("text",{text:t,class:"polygon-label",y:6},this.$el),this.setColour((e.options.altColors?Vh:qh)[+t-1])}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}static makeThumbnail(t,e,s){const i=+t,n=new Xt(new Mt(1,1),20*i,20),o=as("svg",{width:20*i+2,height:22},e),r=as("path",{class:"polygon-tile",path:n},o);as("text",{html:t,class:"polygon-label",x:10*i+1,y:16},o),s.options.watch((t=>r.setAttr("fill",(t.altColors?Vh:qh)[i-1])))}}class Rh extends cr{constructor(t,e){super(e),this.type="number-line",this.$el.addClass("number-line"),this.$fill=as("path",{fill:"transparent"},this.$el),this.$lines=as("path",{class:"number-line-ticks"},this.$el),this.$labels=as("g",{},this.$el),this.setColour(tr);const[s,i,n,o,r]=t.split(":").map((t=>+t)),h={start:s,step:i,width:n,size:o,minor:r},a=e.bindSettingsPanel(this,'<h3>Number Line</h3><label class="row"><div class="label">Start:</div><input class="input-field" type="number" :bind="start"></label><label class="row"><div class="label">Step Size:</div><input class="input-field" type="number" :bind="step" min="0"></label><label class="row"><div class="label">Width:</div><input class="input-field" type="number" :bind="size" min="1" max="25"></label><label class="row"><div class="label">Divisions:</div><input class="input-field" type="number" :bind="minor" min="1" max="25"></label>',h);this.$start=this.makeHandle("h",(t=>{const e=Math.round(t.x/25/a.size);e&&(this.setTransform(this.posn.shift(25*e*a.size,0),this.rot),a.width-=e,a.start=X(a.start+e*a.step,5))})),this.$start.setTransform({x:-25,y:-2.5},Math.PI),this.$end=this.makeHandle("h",(t=>{const e=t.x/25/a.size;a.width=Q(Math.round(e),1,100)})),a.watch((()=>{a.start=X(a.start,4),a.step=X(a.step,4),a.size=Math.round(a.size),a.minor=Math.round(a.minor),this.setDimensions(a)}))}setDimensions({start:t,step:e,width:s,size:i,minor:n}){const o=`${t}:${e}:${s}:${i}:${n}`;if(o===this.options)return;this.options=o,this.$labels.removeChildren();let r=`M0 10L${s*(i*=25)} 10`;for(let o=0;o<=s*n;o+=1){const s=o*i/n,h=!(o%n),a=D(t+o*e/n,4);r+=`M${s} ${h?0:5}L${s} ${h?20:15}`,h&&as("text",{text:a,x:s,y:40},this.$labels)}this.$lines.setAttr("d",r),this.$end.setTransform({x:s*i,y:-2.5}),this.linePoints=g((t=>new Mt(t*i,10)),s+1),this.line=new St(new Mt(0,10),new Mt(s*i,10)),this.path=new Xt(kt,s*i,44),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update(),this.$parent.change()}getSnapPoints(){return this.linePoints}getSnapLines(){return[this.line]}customTransform(){for(const t of this.$labels.children)t.css("transform",`rotate(${-this.rot}deg)`)}setColour(t){super.setColour(t),this.$lines.setAttr("stroke",Xo(t)),this.$labels.setAttr("fill",Xo(t))}static makeThumbnail(t,e){const s=as("svg",{width:240,height:40,class:"number-line"},e);let i="M20 10L220 10";for(let t=0;t<=10;t+=1){const e=20+20*t;i+=`M${e} 5L${e} 15`,as("text",{text:t,x:e,y:30},s)}as("path",{d:i,class:"number-line-ticks"},s)}}const Dh=2*Math.PI,jh={1:Jo,2:ir,3:or,5:hr,7:ar};function Nh(t,e,s=1){const i=t.y*e.x-t.x*e.y>0?s:1-s;return[t.x,t.y+"A"+t.length,t.length,0,i,s,e.x,e.y].join(",")}function Hh(t,e,s=50){if(1===e)return"M0-xAx,x,0,0,0-x,0,x,x,0,0,0,0,x,x,x,0,0,0,x,0,x,x,0,0,0,0-xZM0,yAz,z,0,0,1-y,0,z,z,0,0,1,0-y,z,z,0,0,1,y,0,z,z,0,0,1,0,yZ".replace(/x/g,""+s).replace(/y/g,""+.4*s).replace(/z/g,""+(.4*s+.1));const i=Dh/e,n=-Math.PI/2-i/2,o=Mt.fromPolar(n+i*t,s),r=Mt.fromPolar(n+i*(t+1),s);return`M${Nh(o,r)}L${Nh(r.scale(.4),o.scale(.4),0)}Z`}function Zh(t){return 1===t?[1]:ht(t).reverse()}class Fh extends cr{constructor(t,e){super(e),this.type="prime-disk",this.$segments=[],this.factors=[],this.path=new _t(kt,50),as("circle",{class:"prime-background",r:50},this.$el),this.$segmentWrap=as("g",{},this.$el),this.$label=as("text",{class:"prime-label",y:5},this.$el),this.$outline=as("path",{class:"outline",path:this.path},this.$el),this.setValue(+t)}setValue(t){t=this.value=Q(Math.round(t),1,9999999),this.options=this.$label.text=""+t,this.factors=Zh(t);const e=this.factors.length;for(let t=0;t<e;++t){const s=this.getSegment(t);s.setAttr("fill",jh[this.factors[t]]||er),s.setAttr("d",Hh(t,e)),s.show()}for(let t=e;t<this.$segments.length;++t)this.$segments[t].hide()}multiply(t){this.setValue(+this.options*t)}getSegment(t){if(this.$segments[t])return this.$segments[t];const e=as("path",{class:"polygon-tile"},this.$segmentWrap);return this.$parent.events.listen(e,{down:()=>{this.locked||this.$parent.selection.add(this,!this.$parent.events.shiftKey)},start:()=>{this.isActive&&(this.$parent.selection.add(this,!0),e.addClass("prime-move"),this.$parent.$activeTiles.append(e))},move:t=>{this.isActive&&(e.setTransform(this.posn.add(t.posn).subtract(t.startPosn)),this.setCollision(this.findNearbyTile(t.posn)))},end:s=>{if(!this.isActive)return;e.removeClass("prime-move"),e.setTransform(),this.$segmentWrap.append(e);const i=s.lastPosn.subtract(s.startPosn);if(i.length>50){if(this.collision)this.collision.multiply(this.factors[t]),this.$parent.selection.add(this.collision,!0),this.setCollision();else{const e=this.$parent.newTile("prime-disk",""+this.factors[t]);e.setTransform(this.posn.add(i)),this.$parent.selection.add(e,!0)}this.setValue(+this.options/this.factors[t]),this.$parent.change()}},checkIfActive:()=>this.factors.length>1}),this.$segments[t]=e,e}setColour(t){if(this.colour=t,t)for(const t of this.$segments)t.setAttr("fill",Xo(this.colour))}findNearbyTile(t){for(const e of this.$parent.tiles)if(e!==this&&"prime-disk"===e.type&&Mt.distance(e.posn,t)<50)return e}setCollision(t){this.collision&&t!==this.collision&&this.collision.$outline.removeClass("active"),this.collision=t,t&&t.$outline.addClass("active")}move(t){super.move(t),this.$parent.selection.tiles.size>1||this.setCollision(this.findNearbyTile(this.posn))}moveEnd(){this.collision&&(this.collision.multiply(+this.options),this.$parent.selection.add(this.collision,!0),this.setCollision(),this.delete())}static makeThumbnail(t,e){const s=as("svg",{width:54,height:54},e),i=as("g",{transform:"translate(27 27)"},s);e.onAttr("data-options",(t=>(t=>{i.removeChildren();const e=Zh(t);for(let s=0;s<e.length;++s)as("path",{fill:jh[e[s]]||er,d:Hh(s,e.length,25),class:"polygon-tile"},i),as("text",{text:t,y:4,fill:"white",style:"font-size: 11px; text-anchor: middle"},i)})(Math.round(+t))))}}const Uh=25;class Wh extends cr{constructor(t,e){super(e),this.type="decimal-grid",this.$handles=[],this.$tiles=as("g",{},this.$el),this.$outline=as("path",{class:"outline"},this.$el),this.$handles[0]=this.makeHandle("h",(t=>this.setDimensions(t.x/Uh,this.height,this.size))),this.$handles[1]=this.makeHandle("v",(t=>this.setDimensions(this.width,t.y/Uh,this.size))),this.$handles[2]=this.makeHandle("c",(t=>this.setDimensions(this.width,this.height,(t.x+t.y)/2/Uh))),this.$handles[1].css("cursor","ns-resize"),this.$handles[2].css("cursor","nwse-resize");const[s,i,n]=t.split(":");this.setDimensions(+s,+i,+n)}setDimensions(t,e,s){const i=[t=this.width=Q(Math.round(t),1,100),e=this.height=Q(Math.round(e),1,100),s=this.size=Q(Math.round(s),2,Math.max(t,e))].join(":");if(i===this.options)return;this.options=i,this.$tiles.removeChildren();const n=Math.floor(t/s)*s,o=Math.floor(e/s)*s,r=s*Uh;for(let t=0;t<n;t+=s)for(let e=0;e<o;e+=s)this.drawRect(t*Uh,e*Uh,r,r,ir);for(let e=n;e<t;++e)for(let t=0;t<o;t+=s)this.drawRect(e*Uh,t*Uh,Uh,r,hr);for(let t=0;t<n;t+=s)for(let s=o;s<e;++s)this.drawRect(t*Uh,s*Uh,r,Uh,hr);for(let s=n;s<t;++s)for(let t=o;t<e;++t)this.drawRect(s*Uh,t*Uh,Uh,Uh,er);this.$handles[0].setTransform({x:t*Uh,y:0}),this.$handles[1].setTransform({x:0,y:e*Uh}),this.$handles[2].setTransform({x:r,y:r}),this.path=new Xt(kt,t*Uh,e*Uh),this.$outline.draw(this.path),this.$parent.selection.update(),this.transform()}drawRect(t,e,s,i,n){as("rect",{x:t,y:e,width:s,height:i,fill:this.colour||n,class:"polygon-tile"},this.$tiles)}setColour(t){this.colour=t;for(const e of this.$tiles.children)e.setAttr("fill",Xo(t))}static makeThumbnail(t,e){const s=as("svg",{width:140,height:80},e),i=(t,e,i,n,o)=>as("rect",{x:5+t,y:5+e,width:i,height:n,fill:o,class:"polygon-tile"},s);for(let t=0;t<2;++t)i(50*t,0,50,50,ir);for(let t=0;t<3;++t)i(100+10*t,0,10,50,hr);for(let t=0;t<2;++t)for(let e=0;e<2;++e)i(50*t,50+10*e,50,10,hr);for(let t=0;t<3;++t)for(let e=0;e<2;++e)i(100+10*t,50+10*e,10,10,er)}}class Kh extends cr{constructor(t,e){super(e),this.type="dot-machine",this.canRotate=!1,this.canDragToSelect=!1,this.cells=[],this.isAnimating=!1;const[s,i]=t.split(":").map((t=>+t)),n={base:s,boxes:i};this.model=e.bindSettingsPanel(this,'<h3>Dot Machine</h3><label class="row"><div class="label">Base:</div><input class="input-field" type="number" :bind="base" min="2" max="25"></label><label class="row"><div class="label">Boxes:</div><input class="input-field" type="number" :bind="boxes" min="1" max="10"></label>',n),this.$outline=as("rect",{class:"outline",rx:12},this.$el),this.model.watch((()=>this.draw(this.model))),this.setColour(ar),this.onMove=()=>{const t=Array.from(e.selection.tiles).filter((t=>"dot"===t.type));for(const e of this.cells)e.hover(t.some((t=>e.contains(t.posn))))},this.onMoveEnd=()=>{for(const t of this.cells)t.hover(!1)},e.on("move-selection",this.onMove),e.on("move-end",this.onMoveEnd),this.onChange=()=>this.rearrangeDots(),setTimeout((()=>{this.rearrangeDots(),e.on("change",this.onChange)}))}delete(){this.$parent.off("move-selection",this.onMove),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}select(){this.isActive=!0,this.$outline.show();for(const t of this.cells)t.hover()}deselect(){this.isActive=!1,this.$outline.hide();for(const t of this.cells)t.hover(!1);this.$parent.$tiles.prepend(this.$el)}draw(t){const e=Math.round(t.base),s=Math.round(t.boxes);if(this.options=`${e}:${s}`,this.cells.length>s)for(let t=s;t<this.cells.length;++t)this.cells[t].delete(),this.cells=this.cells.slice(0,s);else if(this.cells.length<s)for(let t=this.cells.length;t<s;++t){const e=new Gh(this,t);this.cells.push(e),e.setColour(this.colour)}for(const t of this.cells)t.setBase(e);const i=150*(s-1)+10;this.path=new Xt(new Mt(-i,-10),i+160,170),this.$outline.setRect(this.path),this.transform(),this.$parent.selection.update()}getSnapPoints(){return[]}setColour(t){super.setColour(t);for(const e of this.cells)e.setColour(t)}moveEnd(){super.moveEnd();for(const t of this.cells)for(const e of[...t.dots,...t.antiDots])e.cell=void 0}rearrangeDots(){if(!this.isAnimating){for(const t of this.cells)t.clear();for(const t of this.$parent.tiles)if("dot"===t.type&&!t.deleted)for(const e of this.cells)(t.cell===e||!t.cell&&e.contains(t.posn))&&e.addDot(t);for(const t of this.cells)t.rearrange()}}static makeThumbnail(t,e){const s=as("svg",{width:160,height:60},e);for(const t of[105,55,5])as("rect",{x:t,y:5,width:50,height:50,class:"dot-cell",stroke:"#eee",style:"stroke-width: 6px"},s),as("circle",{cx:t+25,cy:5,r:2},s),as("circle",{cx:t+25,cy:55,r:2},s)}static action(t,e){return s(this,void 0,void 0,(function*(){if("explode"===t)for(const t of e)t.isAnimating||t.cells[0].explode();else if("annihilate"===t)for(const t of e)t.isAnimating||t.cells[0].annihilate()}))}}class Gh{constructor(t,e=0){this.machine=t,this.index=e,this.dots=[],this.antiDots=[];const s=-150*e;this.$el=as("rect",{class:"dot-cell",width:150,height:150,x:s}),this.$label=as("text",{class:"dot-label",x:75+s,y:154,"font-size":"12px"},t.$el),this.$value=as("text",{class:"dot-label",x:75+s,y:6,text:0,"font-size":"18px"},t.$el),this.bounds=new Xt(new Mt(s,0),150,150),t.$el.prepend(this.$el)}setBase(t){this.$label.text=D(Math.pow(t,this.index))}delete(){this.$el.remove(),this.$label.remove(),this.$value.remove()}setColour(t){this.$el.setAttr("stroke",t),this.machine.isActive&&this.$el.css("fill",t)}hover(t=!0){this.machine.isActive&&!t||this.$el.css("fill",t?this.machine.colour:"none")}contains(t){return this.bounds.translate(this.machine.posn).contains(t)}clear(){this.dots=[],this.antiDots=[]}addDot(t){("1"===t.options?this.dots:this.antiDots).push(t),t.cell=this}rearrange(){this.$value.text=D(this.dots.length-this.antiDots.length);const t=[...this.dots,...this.antiDots];if(!t.length)return;const e=Math.ceil(Math.sqrt(t.length)),s=Math.ceil(t.length/e),i=t.length<=16?30:t.length<=25?25:20,n=this.bounds.center.add(this.machine.posn).shift(-i*(e-1)/2,-i*(s-1)/2),o=g((t=>n.shift(t%e*i,Math.floor(t/e)*i)),t.length);return this.animatePoints(t,o)}animatePoints(t,e){const s=t.map((t=>t.posn));for(const[s,i]of t.entries())i.setTransform(e[s]);return ks((i=>{var n;for(const[o,r]of t.entries()){const t=Mt.interpolate(s[o],e[o],Cs("quad",i));r.$el.setTransform(t),r.transformed=null===(n=r.path)||void 0===n?void 0:n.translate(t)}this.machine.$parent.selection.update()}),240).promise}getDotsToExplode(){const t=this.machine.model.base;return this.dots.length>=t?this.dots.splice(0,t):this.antiDots.length>=t?this.antiDots.splice(0,t):void 0}explode(){return s(this,void 0,void 0,(function*(){const t=this.machine.cells[this.index+1];if(!t)return this.machine.isAnimating=!1,void this.machine.$parent.change();this.machine.isAnimating=!0;const e=this.getDotsToExplode();if(!e)return t.explode();t.addDot(e[0]);for(const t of e.slice(1))t.popOut();return t.rearrange(),yield a(400),this.rearrange(),yield a(400),this.explode()}))}annihilate(){return s(this,void 0,void 0,(function*(){this.machine.isAnimating=!0;const t=Math.min(this.dots.length,this.antiDots.length);if(t){const e=this.dots.splice(0,t),s=this.antiDots.splice(0,t);for(const t of[...e,...s])t.popOut();this.rearrange(),yield a(600)}const e=this.machine.cells[this.index+1];if(e)return e.annihilate();this.machine.isAnimating=!1,this.machine.$parent.change()}))}}const Xh=12.5;class Yh extends cr{constructor(t,e){super(e),this.type="dot",this.deleted=!1,this.options=t,this.$path=as("circle",{r:Xh,class:"polygon-tile"},this.$el),this.$outline=as("circle",{r:Xh,class:"outline"},this.$el),this.path=new _t(kt,Xh),this.setColour(hr)}setColour(t){this.colour=t,this.$path.setAttr("fill","-1"===this.options?er:this.colour)}getSnapPoints(){return[]}getCell(){for(const t of this.$parent.tiles)if("dot-machine"===t.type&&!t.isActive)for(const e of t.cells)if(e.contains(this.posn))return e}moveEnd(){const t=this.cell,e=this.cell=this.getCell();if(!t||!e||t===e)return;if(t.machine!==e.machine)return;const s=Math.abs(t.index-e.index),i=t.machine.model.base**s;if(t.index<e.index){const e="1"===this.options?t.dots:t.antiDots;if(e.length<i)return this.cell=t;for(const t of e.filter((t=>!t.isActive)).slice(0,i-1))t.popOut()}else for(let t=0;t<i-1;++t){const t=new Yh(this.options,this.$parent);t.posn=this.posn,t.cell=e}}static makeThumbnail(t,e){const s="1"===t?hr:er,i=as("svg",{width:40,height:40},e);as("circle",{class:"polygon-tile",cx:20,cy:20,r:Xh,fill:s},i)}negate(){this.options="-1"===this.options?"1":"-1",this.setColour(hr)}popOut(){return s(this,void 0,void 0,(function*(){this.deleted=!0,yield this.$path.exit("pop").promise,this.delete()}))}static action(t,e){if("negate"===t)for(const t of e)t.negate()}}function Qh(t){return 0===t?Jo:t>0?t%2?sr:hr:t%2?er:rr}function Jh(t){return+t.replace("–","-")}function ta(t,e,s=40,i=50){e=Q(Math.round(e),-9999,9999);const n=(t.text=D(e)).length;return t.css("font-size",(n>=6?.625:n>=4?.75:1)*s+"px"),t.setAttr("y",(n>=6?.9:n>=4?.94:1)*i),e}class ea extends cr{constructor(t,e){super(e),this.type="number-card",this.path=new Xt(kt,75),this.$path=as("rect",{class:"polygon-tile",rx:10,width:75,height:75},this.$el),this.$label=as("text",{x:37.5,fill:"white",style:"text-anchor: middle"},this.$el),this.$outline=as("rect",{class:"outline",rx:10,width:75,height:75},this.$el),this.setValue(Jh(t))}setValue(t){this.value=ta(this.$label,t),this.options=""+this.value,this.setColour()}setColour(t){super.setColour(t||Qh(this.value)),this.$path.setAttr("fill",Xo(this.colour))}findNearbyTile(t){for(const e of this.$parent.tiles)if(e!==this&&"number-card"===e.type&&Mt.distance(e.posn,t)<40&&V(e.value+this.value,-9999,9999))return e}setCollision(t){this.collision&&t!==this.collision&&this.collision.$outline.removeClass("active"),this.collision=t,t&&t.$outline.addClass("active")}move(t){super.move(t),this.$parent.selection.tiles.size>1||this.setCollision(this.findNearbyTile(this.posn))}moveEnd(){this.collision&&(this.collision.setValue(this.collision.value+this.value),this.$parent.selection.add(this.collision,!0),this.setCollision(),this.delete())}static makeThumbnail(t,e){const s=as("svg",{width:60,height:60},e),i=as("rect",{x:5,y:5,width:50,height:50,class:"polygon-tile",rx:5},s),n=as("text",{fill:"white",x:30,style:"text-anchor: middle"},s);e.onAttr("data-options",(t=>{const e=ta(n,Jh(t),30,39);i.setAttr("fill",Qh(e))}))}}const sa=50,ia=[ir,"#f15e19","#e1343b",er,"#8d2ca1","#4e53d0",hr,"#0595bf","#0ba27b",or,"#8bba18","#dbc607"];function na(t,e,s,i,n=0){const o=as("g",{class:"fraction"},i);as("text",{text:1,x:e,y:.42*s+n},o),as("text",{text:t,x:e,y:2.5+.77*s+n},o);const r=t>=10?.2:.14;return as("line",{x1:e-r*s,y1:s/2+n,x2:e+r*s,y2:s/2+n},o),o}function oa(t,e,s,i,n,o,r=-e/2,h=-e/2){const a=as("g",{transform:`translate(${t*i+r} ${h})`},n);return[a,as("rect",{width:t,height:e,fill:o,class:"polygon-tile"},a),na(s,t/2,e,a)]}class ra extends cr{constructor(t,e){super(e),this.type="fraction-bar",this.count=0,this.$parts=[],this.options=t;const[s,i]=t.split(":").map((t=>+t));this.denominator=s,this.tileWidth=500/s,this.colour=ia[s-1],this.$fraction=as("g",{},this.$el),this.$outline=as("path",{class:"outline"},this.$el),this.$handle=this.makeHandle("h",(t=>this.setCount(Math.round(t.x/this.tileWidth)))),this.setCount(i)}setCount(t){if((t=Q(t,1,20))!==this.count){if(this.value=t/this.denominator,t<this.count){for(let e=t;e<this.count;e+=1)this.$parts[e][0].remove();this.$parts=this.$parts.slice(0,t)}else for(let e=this.count;e<t;e+=1)this.$parts.push(oa(this.tileWidth,sa,this.denominator,e,this.$fraction,this.colour));this.count=t,this.options=`${this.denominator}:${t}`,this.path=new Xt(new Mt(-25,-25),t*this.tileWidth,sa),this.$outline.draw(this.path),this.$handle.setTransform(new Mt(t*this.tileWidth-25,-25)),this.transform(),this.$parent.selection.update()}}setColour(t){this.colour=t;for(const e of this.$parts)e[1].setAttr("fill",Xo(t))}customTransform(){for(const t of this.$parts)t[2].css("transform",`rotate(${-this.rot}deg)`)}static makeThumbnail(t,e){const[s,i]=t.split(":").map((t=>+t)),n=as("svg",{width:222,height:22},e),o=ia[s-1],r=220/s;for(let t=0;t<i;++t)oa(r,20,s,t,n,o,1,1)}getSnapPoints(){const t=[];for(let e=0;e<=this.count;e+=1)t.push(new Mt(e*this.tileWidth-25,-25)),t.push(new Mt(e*this.tileWidth-25,25));return t}split(){if(1===this.count)return;const t=g((t=>{const e=this.posn.shift(t*this.tileWidth,0).rotate(this.rot*Qo,this.posn),s=new ra(`${this.denominator}:1`,this.$parent);return s.setTransform(e,this.rot),s.setColour(this.colour),s}),this.count);this.$parent.selection.select(t),this.delete()}static action(t,e){if("split"===t)for(const t of e)t.split();else if("merge"===t){const t=Array.from(e),s=Math.min(...t.map((t=>t.posn.x))),i=Math.min(...t.map((t=>t.posn.y))),n=t.map((t=>t.count)),o=$(n),r=new ra(`${t[0].denominator}:${o}`,t[0].$parent);r.setColour(O.mixMany(t.map((t=>O.from(t.colour))),n).hex),r.setTransform(new Mt(s,i),t[0].rot);for(const t of e)t.delete();t[0].$parent.selection.add(r)}}}class ha extends cr{constructor(t,e){super(e),this.type="fraction-circle",this.rotateAroundOrigin=!0,this.options=t;const s={class:"polygon-tile",path:this.path,fill:this.colour};this.$path=as("path",s,this.$el),this.$outline=as("path",{class:"outline",path:this.path},this.$el);const i=+t;if(this.value=1/i,i>1){const t=new Mt(0,-100).rotate(-Math.PI/i),e=this.path=new Ct(kt,t,2*Math.PI/i);this.snapAngles=[0,bt(t)*Yo,bt(e.end)*Yo]}else this.path=new _t(kt,100);if(this.$path.draw(this.path),this.$outline.draw(this.path),i>1){const t=-75-2.5*(i-2);this.$label=na(i,0,50,this.$el,t)}this.colour=ia[i-1],this.$path.setAttr("fill",this.colour)}customTransform(){var t;null===(t=this.$label)||void 0===t||t.css("transform",`rotate(${-this.rot}deg)`)}setColour(t){this.colour=t,this.$path.setAttr("fill",Xo(t))}static makeThumbnail(t,e){const s=+t,i=as("svg",{width:80,height:44},e),n=as("path",{class:"polygon-tile"},i),o=new Mt(40,2).rotate(-Math.PI/s,new Mt(40,42)),r=s>1?new Ct(new Mt(40,42),o,2*Math.PI/s):new _t(new Mt(40,22),20);if(n.draw(r),n.setAttr("fill",ia[s-1]),s>1){const t=as("g",{class:"fraction"},i);t.translate(40,12-s),na(s,0,25,t)}}}const aa={1:ir,x:or,x2:hr},la={1:1,x:5,x2:25,"-1":-1,"-x":-5,"-x2":-25};function ca(t){return t.replace("-","–").replace("2","²")}function da(t){return"-"===t[0]?er:aa[t]}function pa(t){return"algebra-tile"===t.type}class ua extends Er{constructor(t,e){super(function(t){return br(i(t,"x2","-x2")?135:25,i(t,"1","-1")?25:135)}(t.toLowerCase()),e),this.type="algebra-tile",this.options=t.toLowerCase(),this.value=la[this.options],this.$text=as("text",{text:ca(this.options),class:"polygon-label",y:6},this.$el),this.setColour(da(this.options))}setColour(t=this.colour){super.setColour(t),this.$path.setAttr("fill",Xo(this.collision?"#ddd":this.colour)),this.$text.text=this.collision?"0":ca(this.options)}customTransform(){this.$text.css("transform",`rotate(${-this.rot}deg)`)}setCollision(t){this.collision=t,this.setColour()}move(t){if(super.move(t),this.collision){if(Mt.distance(this.posn,this.collision.posn)<23.75)return;this.collision.setCollision(),this.setCollision()}const e="-"===this.options[0]?this.options.slice(1):"-"+this.options;for(const t of this.$parent.tiles)if(pa(t)&&!t.collision&&t!==this&&t.options===e&&!(Mt.distance(this.posn,t.posn)>=23.75))return this.setCollision(t),void t.setCollision(this)}static makeThumbnail(t,e){const s=i(t,"x2","-x2")?78:20,n=i(t,"1","-1")?20:78,o=i(t,"x2","-x2")?80:54,r=new Xt(new Mt((o-s)/2,40-n/2),s,n),h=as("svg",{width:o,height:80},e);as("path",{class:"polygon-tile",path:r,fill:da(t)},h),as("text",{text:ca(t),class:"polygon-label",x:o/2,y:45},h)}negate(){this.options.startsWith("-")?this.options=this.options.slice(1):this.options="-"+this.options,this.value=la[this.options],this.setColour(da(this.options)),this.$text.text=ca(this.options)}static action(t,e){if("negate"===t)for(const t of e)t.negate()}}const fa=25;function ga(t,e,s,i,n){return new Wt(new Mt(-n,-n),new Mt(-n,t),new Mt(n,t),new Mt(n,-n),new Mt(e,-n),new Mt(e,n),new Mt(n,n),new Mt(n,s),new Mt(-n,s),new Mt(-n,n),new Mt(i,n),new Mt(i,-n))}class ma extends cr{constructor(t,e){super(e),this.type="grid",this.showSelectionOutline=!0,this.canDragToSelect=!1,this.options=t,this.dimensions=new Mt,this.$axes=g((()=>as("line",{class:"grid-axis",stroke:"#777"},this.$el)),2),this.$fill=as("path",{fill:"transparent"},this.$el),this.$handles=[0,1].map((t=>this.makeHandle("c",(e=>{const s=t?this.dimensions.x:Math.round(e.x/fa-1),i=t?Math.round(e.y/fa-1):this.dimensions.y;this.setDimensions(s,i)})))),this.$handles[1].css("cursor","ns-resize");const s=t.split(":");this.setDimensions(+s[0],+s[1])}setDimensions(t,e){t=Q(t,1,100),e=Q(e,1,100),t===this.dimensions.x&&e===this.dimensions.y||(this.dimensions=new Mt(t,e),this.options=`${t}:${e}`,this.path=ga(-1.5,t+1,e+1,-1.5,.5).scale(fa),this.$axes[0].setLine({x:-37.5,y:0},{x:(t+1)*fa,y:0}),this.$axes[1].setLine({x:0,y:-37.5},{x:0,y:(e+1)*fa}),this.$handles[0].setCenter({x:(t+1)*fa,y:0}),this.$handles[1].setCenter({x:0,y:(e+1)*fa}),this.$fill.draw(this.path),this.transform(),this.$parent.selection.update())}setColour(t){this.colour=t;for(const e of this.$axes)e.setAttr("stroke",Xo(t))}static makeThumbnail(t,e){const s=as("svg",{width:80,height:80},e);as("line",{x1:20,y1:0,x2:20,y2:80,stroke:"white","stroke-width":2},s),as("line",{x1:0,y1:20,x2:80,y2:20,stroke:"white","stroke-width":2},s)}}const va=new Map;let $a;const wa=as("div",{class:"snackbar"},ls);let xa=class extends Bs{ready(){var t;wa.append(this),va.set(this.attr("key"),this),null===(t=this.$("button"))||void 0===t||t.on("click",(()=>this.close()))}open(t=2e3){return s(this,void 0,void 0,(function*(){$a!==this&&($a&&(yield $a.close()),$a=this,yield this.enter("pop",300).promise,this.setAttr("role","alert"),t&&setTimeout((()=>this.close()),t))}))}close(){return s(this,void 0,void 0,(function*(){$a===this&&($a=void 0,this.removeAttr("role"),yield this.exit("pop",300).promise)}))}};function ya(t,e=4e3){var s;return null===(s=va.get(t))||void 0===s?void 0:s.open(e)}xa=e([Rs("x-alert")],xa);const ba=new Map,Ma=t=>t.type+t.options+t.colour,ka=t=>{var e,s;return null!==(s=null!==(e=t.value)&&void 0!==e?e:ba.get(Ma(t)))&&void 0!==s?s:1};function Aa(t,e){const s={};let i=0;const n=(t,e=1)=>{i+=e*ka(t),void 0===t.value&&(s[Ma(t)]=(s[Ma(t)]||0)+e)};for(const e of t)n(e,1);for(const t of e)n(t,-1);if(q(i,0))return;const o=Object.keys(s).filter((t=>s[t])),r=o.filter((t=>!ba.has(t)))[0]||v(o);if(!r)return!0;const h=ba.get(r)||1;ba.set(r,h-i/s[r])}const Ca="M120,0C120,16,66.3,20,0,20S-120,16-120,0Z",Pa="M0,26A18.1,18.1,0,0,0-18,44V72H18V44A18.1,18.1,0,0,0,0,26Z",Ta=["text","grid","number-line","spinner","decimal-grid","custom-spinner","ruler","protractor","compass","geo","dot-machine","axes"],Sa=new Xt(new Mt(0,-180),240,180),La=15;function _a(t,e){var s;const i=t.posn.shift(0,e);t.$el.setTransform(i,t.rot*Qo),t.transformed=null===(s=t.path)||void 0===s?void 0:s.rotate(t.rot).translate(i)}class za extends cr{constructor(t,e){super(e),this.type="balance",this.canRotate=!1,this.canDragToSelect=!1,this.level=0,this.left=[],this.right=[],this.isAnimating=!1,this.level=+t||0,this.options=t||"0",this.$beam=as("path",{class:"balance-beam"},this.$el),this.$left=as("path",{d:Ca,class:"balance"},this.$el),this.$right=as("path",{d:Ca,class:"balance"},this.$el),this.$base=as("path",{d:Pa,class:"balance"},this.$el),this.setColour("#bbb"),this.customTransform(),this.draw();const s=as("path",{path:Sa,class:"balance-target"},this.$el),i=as("path",{path:Sa,class:"balance-target"},this.$el);this.onMoveStart=()=>{if(!function(t,e){for(const s of t)if(!e(s))return!1;return!0}(e.selection.tiles,(t=>Ta.includes(t.type)))){s.setTransform({x:-280,y:this.level*La}),i.setTransform({x:40,y:-this.level*La});for(const t of[s,i])t.show()}},this.onMoveEnd=()=>{for(const t of[s,i])t.hide()},this.onChange=()=>{this.checkTileOverlaps(),this.rebalance()},e.on("move-start",this.onMoveStart),e.on("move-end",this.onMoveEnd),setTimeout((()=>{this.checkTileOverlaps(),e.on("change",this.onChange)}))}delete(){this.$parent.off("move-start",this.onMoveStart),this.$parent.off("move-end",this.onMoveEnd),this.$parent.off("change",this.onChange),super.delete()}checkTileOverlaps(){const t=Sa.translate(this.posn).shift(-280,this.level*La),e=Sa.translate(this.posn).shift(40,-this.level*La);this.left=[],this.right=[];for(const s of this.$parent.tiles)s.transformed&&"balance"!==s.type&&!Ta.includes(s.type)&&(Ko(t,s.transformed)?this.left.push(s):Ko(e,s.transformed)&&this.right.push(s))}draw(t=this.level){const e=new Mt(-160,15*t),s=new Mt(160,15*-t);this.$beam.draw(new Kt(e.shift(0,10),e.shift(0,44),s.shift(0,44),s.shift(0,10))),this.$left.setTransform(e),this.$right.setTransform(s)}rebalance(t=400){return s(this,void 0,void 0,(function*(){const e=$(this.left.map((t=>ka(t)))),s=$(this.right.map((t=>ka(t)))),i=q(e,s)?0:e<s?-1:1;if(i===this.level||this.isAnimating)return;const n=this.level,o=(i-n)*La;this.level=i,this.options=i.toString();for(const t of this.left)t.setTransform(t.posn.shift(0,o));for(const t of this.right)t.setTransform(t.posn.shift(0,-o));this.isAnimating=!0,yield ks((t=>{this.draw(J(n,i,t));for(const e of this.left)_a(e,(t-1)*o);for(const e of this.right)_a(e,(1-t)*o);this.$parent.selection.update()}),t).promise,this.isAnimating=!1,this.transform(),this.$parent.selection.update()}))}customTransform(){const t=this.level*La;this.path=new Wt(new Mt(-280,t),new Mt(-40,t),new Mt(-40,25),new Mt(40,25),new Mt(40,-t),new Mt(280,-t),new Mt(280,48-t),new Mt(40,48-t),new Mt(40,72),new Mt(-40,72),new Mt(-40,t+48),new Mt(-280,t+48))}getSnapPoints(){return[]}getSnapLines(){const t=this.level*La;return[new St(new Mt(-280,t),new Mt(-40,t)),new St(new Mt(40,-t),new Mt(280,-t))]}setColour(t){this.colour=t,this.$beam.css("stroke",t);for(const e of[this.$base,this.$left,this.$right])e.css("fill",Xo(t))}static makeThumbnail(t,e){const s=as("svg",{width:250,height:50,viewBox:"-290 -10 580 82",class:"scale"},e);as("path",{d:"M-160 10v34h320v-34",fill:"transparent",stroke:"#bbb","stroke-width":10},s),as("path",{d:Ca,transform:"translate(-160 0)",fill:"#bbb"},s),as("path",{d:Ca,transform:"translate(160 0)",fill:"#bbb"},s),as("path",{d:Pa,fill:"#bbb"},s)}static action(t,e){return s(this,void 0,void 0,(function*(){if("balance"===t)for(const t of e){Aa(t.left,t.right)&&ya("balance-error"),t.rebalance()}}))}}const Ea={circle:"M -25 0a25,25 0 1 0 50 0a25 25 0 1 0 -50 0",square:"M0 -25L25 0L0 25L-25 0Z",cross:"M25 -9L9 -9L9 -25L-9 -25L-9 -9L-25 -9L-25 9L-9 9L-9 25L9 25L9 9L25 9L25 -9Z",weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1ZM0-11a4,4,0,0,1-4-4,4,4,0,0,1,4-4,4,4,0,0,1,4,4A4,4,0,0,1,0-11Z",star:"M0 15.7L15.5 23.8L12.5 6.6L25 -5.6L7.7 -8.1L0 -23.8L-7.7 -8.1L-25 -5.6L-12.5 6.6L-15.5 23.8L0 15.7Z",heart:"M3.4,20.8a4.9,4.9,0,0,1-6.7-.1l-.3-.2C-16.7,8.6-25.3.8-25-8.9a13.7,13.7,0,0,1,5.9-10.7A14.4,14.4,0,0,1,0-16.8a14.4,14.4,0,0,1,19.1-2.8A13.7,13.7,0,0,1,25-8.9C25.3.8,16.7,8.6,3.6,20.5Z"},Ia={weight:"M24.3,22.1,17.7-6.1A4,4,0,0,0,14-9H8a10.3,10.3,0,0,0,2-6A10,10,0,0,0,0-25,10,10,0,0,0-10-15,10.3,10.3,0,0,0-8-9h-6a4,4,0,0,0-3.7,2.9l-6.6,28.2A2.2,2.2,0,0,0-22,25H22A2.2,2.2,0,0,0,24.3,22.1Z"},Oa={circle:sr,square:ar,cross:or,weight:hr,star:ir,heart:er};class qa extends Er{constructor(t,e){super("square",e),this.type="token",this.options=t,this.$path.setAttr("d",Ea[t]),this.$outline.setAttr("d",Ia[t]||Ea[t]),this.setColour(Oa[t])}static makeThumbnail(t,e){const s=as("svg",{width:36,height:36},e),i=as("path",{d:Ea[t],class:"polygon-tile"},s);i.setTransform({x:18,y:18},0,.6),i.setAttr("fill",Oa[t])}}const Va=50;class Ba extends cr{constructor(t,e){super(e),this.type="axes",this.canRotate=!1,this.canDragToSelect=!1,this.functions=[],this.$fill=as("path",{fill:"transparent"},this.$el),this.$grid=as("path",{class:"axis-gridlines"},this.$el),this.$axes=as("path",{class:"grid-axis"},this.$el),this.$functions=as("g",{},this.$el),this.$labels=as("g",{class:"axis-labels"},this.$el),this.setColour(tr),e.options.watch((t=>this.$grid.toggle("none"===t.grid)));const[s,i,n,o,r,h]=t.split(":").map((t=>+t)),a={xMin:s,xMax:n,xStep:i,yMin:o,yMax:h,yStep:r},l=this.model=e.bindSettingsPanel(this,'<h3>Coordinate System</h3><label class="row"><div class="label">X Step:</div><input class="input-field" type="number" :bind="xStep" min="0"></label><label class="row"><div class="label">Y Step:</div><input class="input-field" type="number" :bind="yStep" min="0"></label>',a);this.$handles=[this.makeHandle("c",(t=>l.xMin=Q(Math.round(t.x/Va),-20,0))),this.makeHandle("c",(t=>l.xMax=Q(Math.round(t.x/Va),0,20))),this.makeHandle("c",(t=>l.yMin=Q(Math.round(-t.y/Va),-20,0))),this.makeHandle("c",(t=>l.yMax=Q(Math.round(-t.y/Va),0,20)))];for(const t of[2,3])this.$handles[t].css("cursor","ns-resize");l.watch((()=>this.setSizes(l)))}setSizes({xMin:t,xMax:e,yMin:s,yMax:i,xStep:n,yStep:o}){const r=`${t}:${n}:${e}:${s}:${o}:${i}`;if(r===this.options)return;this.options=r;const h=Va;this.$handles[0].setCenter({x:t*h,y:0}),this.$handles[1].setCenter({x:e*h,y:0}),this.$handles[2].setCenter({x:0,y:-s*h}),this.$handles[3].setCenter({x:0,y:-i*h}),this.$labels.removeChildren();let a="",l=`M${t*h} 0L${e*h} 0M0 ${-s*h}L0 ${-i*h}`;l+=`M0 ${-i*h-3}l5 8h-10ZM${e*h+3} 0l-8 5v-10Z`;for(let o=t+1;o<e;++o)o&&(l+=`M${o*h} 0L${o*h} 5`,a+=`M${o*h} ${-s*h}L${o*h} ${-i*h}`,as("text",{text:D(o*n,4),x:o*h,y:21,"text-anchor":"middle"},this.$labels));for(let n=s+1;n<i;++n)n&&(l+=`M0 ${-n*h}L-5 ${-n*h}`,a+=`M${t*h} ${-n*h}L${e*h} ${-n*h}`,as("text",{text:D(n*o,4),x:-10,y:-n*h+5,"text-anchor":"end"},this.$labels));this.$axes.setAttr("d",l),this.$grid.setAttr("d",a),this.path=ga(-i*Va,e*Va,-s*Va,t*Va,15),this.$fill.draw(this.path);for(const t of this.functions)this.drawFunctions(t);this.transform(),this.$parent.selection.update(),this.$parent.change()}addFunction(t){this.functions.push(Ti.parse(t))}drawFunctions(t){const{xMin:e,xMax:s,yMin:i,yMax:n,xStep:o,yStep:r}=this.model,h=t.variables[0]||"x";let a="",l=!1;for(let c=e;c<s;c+=.05){const e=c*Va,s=t.evaluate({[h]:c*o})/r*Va,d=V(s,i*Va-.01,n*Va+.01);d&&(a+=(l?"L":"M")+`${e},${-s}`),l=d}as("path",{d:a,class:"geo-path",style:"color:red"},this.$labels)}getSnapPoints(){const{xMin:t,xMax:e,yMin:s,yMax:i}=this.model,n=[];for(let o=t;o<=e;++o)for(let t=s;t<=i;++t)n.push(new Mt(o*Va,-t*Va));return n}getSnapLines(){const{xMin:t,xMax:e,yMin:s,yMax:i}=this.model;return[new St(new Mt(t*Va,0),new Mt(e*Va,0)),new St(new Mt(0,-s*Va),new Mt(0,-i*Va))]}setColour(t){super.setColour(t);for(const e of[this.$axes,this.$labels])e.setAttr("fill",Xo(t));for(const e of[this.$axes,this.$grid])e.setAttr("stroke",Xo(t))}static makeThumbnail(t,e){const s=as("svg",{width:180,height:180},e);as("path",{d:"M30 10v160M60 10v160M120 10v160M150 10v160M10 30h160M10 60h160M10 120h160M10 150h160",class:"axis-gridlines",stroke:"white"},s);as("path",{d:"M10 90h160M90 10v160M90 8l4 6h-8ZM172 90l-6 4v-8Z",class:"grid-axis",fill:"white"},s)}}const Ra=2*Math.PI;class Da{constructor(){this.translation=new ja(0,0,0),this.rotation=new ja(0,0,0),this.scale=new ja(1,1,1)}}class ja{constructor(t,e,s){this.x=t,this.y=e,this.z=s}rotate(t){this.rotateProperty(t.z,"x","y"),this.rotateProperty(t.y,"x","z"),this.rotateProperty(t.x,"y","z")}rotateProperty(t,e,s){if(!t||q(t%Ra,0))return;const i=Math.cos(t),n=Math.sin(t),o=this[e],r=this[s];this[e]=o*i-r*n,this[s]=r*i+o*n}equals(t){return q(this.x,t.x)&&q(this.y,t.y)&&q(this.z,t.z)}add(t){return this.x+=t.x||0,this.y+=t.y||0,this.z+=t.z||0,this}multiply(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this}transform(t){return this.multiply(t.scale),this.rotate(t.rotation),this.add(t.translation),this}lerp(t,e){return new ja(J(this.x,t.x||0,e),J(this.y,t.y||0,e),J(this.z,t.z||0,e))}}const Na=new O(0,0,0);class Ha{constructor(){this.transform=new Da,this.visible=!0}}class Za extends Ha{constructor(t,e={},s){super(),this.children=[],this.sorting=!1,this.$el=as("g",e,s);for(const e of t)this.addChild(e)}addChild(t){t.parent&&t.parent.removeChild(t),this.children.push(t),this.$el&&t.$el&&this.$el.append(t.$el),t.parent=this}removeChild(t){const e=this.children.indexOf(t);e>=0&&this.children.splice(e,1),t.$el&&t.$el.remove(),t.parent=void 0}render(){if(this.visible){if(this.sorting)for(const t of w(this.children,(t=>t.zIndex)))this.$el.append(t.$el);for(const t of this.children)t.render()}}get zIndex(){return(t=this.children.map((t=>t.zIndex))).length?$(t)/t.length:0;var t}}class Fa extends Ha{constructor(t,e={}){super(),this.path=t,this.backface=!0,this.perspective=120,this.commands=We(t),this.$el=as("path",e)}getTransformed(t,e=0,s=!1){const i=new ja(t.x,t.y,e);let n=this;do{s?i.rotate(n.transform.rotation):i.transform(n.transform)}while(n=n.parent);return i}project(t){const e=Math.exp(t.z/this.perspective);return t.x*e+","+t.y*e}render(){if(!this.visible)return;if(!this.backface){const t=this.getTransformed(kt,1).z>this.zIndex;if(this.$el.toggle(t),!t)return}if(this.color){const t=this.getTransformed(kt,1,!0).z,e=O.mix(this.color,Na,(t+1)/2);this.$el.setAttr("fill",e),this.$el.setAttr("stroke",e)}const t=this.commands.map((t=>t.type+t.points.map((t=>this.project(this.getTransformed(t)))).join(","))).join("");this.$el.setAttr("d",t)}get zIndex(){return this.getTransformed(kt).z}}class Ua extends Fa{constructor(t,e={}){super(Rt(t)?function(t){const e=t.r,s=t.c.x,i=t.c.y,n=.5523*e;return`M${s} ${i-e}C${s+n} ${i-e} ${s+e} ${i-n} ${s+e} ${i}C${s+e} ${i+n} ${s+n} ${i+e} ${s} ${i+e}C${s-n} ${i+e} ${s-e} ${i+n} ${s-e} ${i}C${s-e} ${i-n} ${s-n} ${i-e} ${s} ${i-e}`}(t):ie(t),e)}}const Wa=19,Ka=[[],[[0,0]],[[-.9,-.9],[.9,.9]],[[-1,-1],[0,0],[1,1]],[[-.9,-.9],[.9,-.9],[.9,.9],[-.9,.9]],[[-1,-1],[1,-1],[1,1],[-1,1],[0,0]],[[-.9,-1.1],[-.9,0],[-.9,1.1],[.9,-1.1],[.9,0],[.9,1.1]],[[0,-1.2],[0,0],[0,1.2],[1,-.6],[1,.6],[-1,-.6],[-1,.6]],[[0,-1.1],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]],[[0,-1.1],[0,0],[0,1.1],[-1.1,-1.1],[-1.1,0],[-1.1,1.1],[1.1,-1.1],[1.1,0],[1.1,1.1]]],Ga=new Xt(new Mt(-19,-19),38,38),Xa=[[0,0],[Math.PI/2,0],[Math.PI,0],[-Math.PI/2,0],[0,Math.PI/2],[0,-Math.PI/2]],Ya=["#656073",rr,hr,ar,er,sr,ir,nr,or,rr];class Qa extends cr{constructor(t,e){super(e),this.type="dice",this.isAnimating=!1,this.options=t;const[s,i]=t.split(":");this.faces=i||"1,2,3,4,5,6";const n=this.faces.split(",").map((t=>{const e=new Ua(Ga,{class:"dice-face",fill:Ya[+t],stroke:Ya[+t]}),s=Ka[+t].map((t=>new Ua(new _t(new Mt(t[0]*Wa/2,t[1]*Wa/2),4),{class:"dice-dot"})));for(const t of s)t.transform.translation.z=2;return new Za([e,...s])}));n[0].transform.translation.z=Wa,n[1].transform.translation.x=-19,n[1].transform.rotation.y=Math.PI/2,n[2].transform.translation.y=Wa,n[2].transform.rotation.x=-Math.PI/2,n[3].transform.translation.y=-19,n[3].transform.rotation.x=Math.PI/2,n[4].transform.translation.x=Wa,n[4].transform.rotation.y=-Math.PI/2,n[5].transform.translation.z=-19,n[5].transform.rotation.y=Math.PI,this.die=new Za(n,{},this.$el),this.die.sorting=!0,this.setValue(+s||mt.integer(1,6)),this.path=new Xt(new Mt(-25,-25),50,50),this.$outline=as("path",{class:"outline",path:this.path},this.$el)}setColour(t){this.colour="#000"===t||"#000000"===t?"":t;for(const t of this.die.children)t.children[0].color=Xo(this.colour);this.die.render()}setValue(t){this.value!==t&&(this.value=t,this.options=`${t}:${this.faces}`,this.die.transform.rotation.x=Xa[t-1][0],this.die.transform.rotation.y=Xa[t-1][1],this.die.render())}roll(t=2e3){return s(this,void 0,void 0,(function*(){if(this.isAnimating)return;this.isAnimating=!0;const e=mt.integer(1,6),s=Xa[this.value-1],i=4*Math.PI+Xa[e-1][0]-s[0],n=4*Math.PI+Xa[e-1][1]-s[1];yield ks((t=>{const e=Cs("sine",t);this.die.transform.translation.z=4*e*(1-e)*Wa,this.die.transform.rotation.x=s[0]+e*i,this.die.transform.rotation.y=s[1]+e*n,this.die.render()}),t).promise,this.setValue(e),this.isAnimating=!1}))}static makeThumbnail(t,e){if("net"===e.data.thumb){const s=as("svg",{width:58,height:76},e),i=t.split(":")[1].split(",").map((t=>+t)),n=e.data.colour,o=[new Mt(20,2),new Mt(20,20),new Mt(20,38),new Mt(20,56),new Mt(2,20),new Mt(38,20)];for(const[t,e]of o.entries()){const o=n||Ya[+i[t]];as("path",{path:new Xt(e,18,18),class:"polygon-tile",fill:o},s);for(const n of Ka[i[t]])as("circle",{cx:e.x+9+4.5*n[0],cy:e.y+9+4.5*n[1],r:1.8,class:"dice-dot"},s)}}else{const t=as("svg",{width:60,height:60},e);as("rect",{x:6,y:6,width:48,height:48,rx:4,class:"polygon-tile",fill:sr},t);for(const e of Ka[5])as("circle",{cx:30+12*e[0],cy:30+12*e[1],r:4,class:"dice-dot"},t)}}static action(t,e,i,n){return s(this,void 0,void 0,(function*(){if("roll"===t){const t=Array.from(e);n.selection.clear(),yield Promise.all(t.map((t=>t.roll()))),n.selection.select(t)}n.change()}))}}const Ja="M12.9,9.7C13.9,3,4,5.3,4,1.2H4C9.4-3.7,7.6-14,.1-14.3S-9.3-3.9-4,1.3c-.1,3.8-9.8,1.9-8.9,8.4h0C-5.5,13.2,5.2,13.2,12.9,9.7Z",tl=[er,hr],el=["M0 7.4L8.6 12L7 2.4L13.9 -4.4L4.3 -5.8L0 -14.5L-4.3 -5.8L-13.9 -4.4L-7 2.4L-8.6 12L0 7.4",Ja];class sl extends cr{constructor(t,e){super(e),this.type="coin",this.isAnimating=!1;const s=new _t(kt,23),i=tl.map(((t,e)=>{const i=new Ua(s,{class:"dice-face",fill:t,stroke:t}),n=new Fa(el[e],{class:"dice-dot"});return n.transform.translation.z=1,new Za([i,n])}));i[0].transform.translation.z=.5,i[1].transform.rotation.x=Math.PI,i[1].transform.translation.z=-.5,this.coin=new Za(i,{},this.$el),this.coin.sorting=!0,this.setValue(t?+t:mt.integer(0,1)),this.path=new _t(kt,25),this.$outline=as("path",{class:"outline",path:this.path},this.$el)}setValue(t){this.value!==t&&(this.value=t,this.options=""+t,this.coin.transform.rotation.x=t?Math.PI:0,this.coin.render())}setColour(t){this.colour=t}roll(t=2e3){return s(this,void 0,void 0,(function*(){if(this.isAnimating)return;this.isAnimating=!0;const e=mt.integer(0,1),s=this.value?Math.PI:0,i=6*Math.PI+(e?Math.PI:0)-s;yield ks((t=>{const e=Cs("sine",t);this.coin.transform.translation.z=4*e*(1-e)*23,this.coin.transform.rotation.x=s+e*i,this.coin.transform.rotation.y=.4*Math.sin(8*e*Math.PI),this.coin.render()}),t).promise,this.setValue(e),this.isAnimating=!1}))}static makeThumbnail(t,e){const s=as("svg",{width:60,height:60},e);as("circle",{cx:30,cy:30,r:28,class:"polygon-tile",fill:hr},s);as("path",{d:Ja,class:"dice-dot"},s).setTransform({x:30,y:30},0,1.2)}}const il=2*Math.PI,nl=Math.PI/2,ol="M9.8-39.1,0-63-9.8-39.1-3-43V60a2.9,2.9,0,0,0,3,3,2.9,2.9,0,0,0,3-3V-43Z";function rl(t,e,s,i=75,n=kt){const o=s?O.shades(s,e.length):O.rainbow(e.length);t.removeChildren();for(const[s,r]of e.entries()){const h=e[s+1]?e[s+1]-r:il-r+e[0];as("path",{path:new Ct(n,Mt.fromPolar(r-nl,i).add(n),h),class:"polygon-tile",fill:o[s]},t)}}class hl extends cr{constructor(t,e){super(e),this.type="spinner",this.angle=0,this.isAnimating=!1,this.path=new _t(kt,75),this.$sectors=as("g",{},this.$el),this.$arrow=as("path",{d:ol,class:"spinner"},this.$el),this.$outline=as("path",{class:"outline",path:this.path},this.$el),this.setupHandles(),as("circle",{r:4,class:"spinner"},this.$el),e.events.listen(this.$arrow,{move:({posn:t})=>{const e=this.relativePosn(t).angle()+nl;this.$arrow.setTransform(void 0,e)},end:({lastPosn:t})=>{const e=this.relativePosn(t).angle()+nl;this.setValue(e*Yo)},click:()=>this.roll()}),this.$arrow.css("cursor","pointer");const[s,i]=t.split(":");this.drawSectors(+i),this.setValue(+s||0)}setupHandles(){this.$handle=this.makeHandle("c",(t=>{const e=(t.angle()+nl)%il;this.drawSectors(il/e)})),this.$handle.css("cursor","move")}drawSectors(t){const e=Q(Math.round(t),2,16);if(e===this.sectors)return;this.sectors=e,this.options=`${this.angle}:${e}`;const s=il/e;rl(this.$sectors,g((t=>s*t),e),this.colour),this.$handle.setCenter(Mt.fromPolar(s-nl,75))}setColour(t){this.colour=t;const e=this.$sectors.children,s=O.shades(t,e.length);for(const[t,i]of e.entries())i.setAttr("fill",s[t])}setValue(t){t=et(Math.round(t),360),this.angle!==t&&(this.angle=t,this.options=`${t}:${this.sectors}`,this.$arrow.setTransform(void 0,this.angle*Qo))}roll(t=2e3){return s(this,void 0,void 0,(function*(){if(this.isAnimating)return;this.isAnimating=!0;const e=this.angle,s=360*(4+Math.random());yield ks((t=>{const i=J(e,s,Cs("sine",t));this.$arrow.setTransform(void 0,i*Qo)}),t).promise,this.setValue(s),this.isAnimating=!1}))}static makeThumbnail(t,e){const s=as("svg",{width:80,height:80},e),i=new Mt(40,40);rl(s,g((t=>il/5*t),5),"",36,i);as("path",{d:ol,class:"spinner"},s).setTransform(i,-.8,.5)}}const al=2*Math.PI,ll=Math.PI/2;class cl extends hl{constructor(t,e){super(`${t.split(":")[0]}:1`,e),this.type="custom-spinner",this.$handles=[];for(const e of t.split(":")[1].split(","))this.makeVertex(Mt.fromPolar(+e*Qo-ll,75))}setupHandles(){let t;this.$parent.events.listen(this.$outline,{down:({posn:e})=>t=this.makeVertex(this.relativePosn(e)),move:({posn:e})=>this.moveVertex(this.relativePosn(e),t),end:()=>this.$parent.change()}),this.$outline.css("cursor","crosshair")}drawSectors(){if(!this.$handles||this.$handles.length<2)return;const t=this.$handles.map((t=>(t.center.angle()+ll)%al)).sort();this.sectors=t.map((t=>Math.round(t*Yo))).join(",");const e=`${this.angle}:${this.sectors}`;e!==this.options&&(this.options=e,rl(this.$sectors,t,this.colour))}makeVertex(t){if(this.$handles.length>=24)return;let e=this.makeHandle("c",(t=>{e&&(t.length>150?(this.deleteVertex(e),e=void 0):this.moveVertex(t,e))}),(()=>{e&&this.deleteVertex(e)}));return e.setAttr("r",8),e.css("cursor","move"),this.$handles.push(e),this.moveVertex(t,e),e}deleteVertex(t){this.$handles.length<=2||(t.remove(),this.$handles.splice(this.$handles.indexOf(t),1),this.drawSectors())}moveVertex(t,e){if(!e)return;const s=Y(t.angle()*Yo,10)*Qo;e.setCenter(Mt.fromPolar(s,75)),this.drawSectors()}static makeThumbnail(t,e){const s=as("svg",{width:80,height:80},e),i=new Mt(40,40),n=t.split(":")[1].split(",").map((t=>+t*Qo));rl(s,n,"",36,i);as("path",{d:ol,class:"spinner"},s).setTransform(i,.4,.5);for(const t of n){const e=Mt.fromPolar(t-ll,36).add(i);as("circle",{cx:e.x,cy:e.y,r:3,fill:"white"},s)}}}const dl="M7.7-5.7l-.2-.4-.3-.2c-.1-.1-.3,0-.4,0A36.6,36.6,0,0,0-3,2.1,36.1,36.1,0,0,0-7.8-.8h-.5l-1,.9a.4.4,0,0,0-.1.3c0,.2,0,.3.1.4a72.1,72.1,0,0,1,6.6,7h.4l.4-.2C1.9,1,3.8-1.8,7.5-5.2,7.7-5.3,7.7-5.5,7.7-5.7Z",pl={fill:"none",style:"touch-action: none",stroke:or};class ul{constructor(t){this.$el=as("g",{}),this.$ring=as("circle",Object.assign({opacity:.6},pl),this.$el),this.$burst=as("path",pl,this.$el),this.$mark=as("g",{class:"problem-marker"},this.$el),this.$circle=as("circle",{r:13},this.$mark),this.$cross=as("path",{d:"M7,4,2.3-.3,6.6-5a1.2,1.2,0,0,0,0-1.5l-.4-.3a1,1,0,0,0-1.4,0L0-2.5-4.8-6.8a1,1,0,0,0-1.4,0l-.4.3A1.2,1.2,0,0,0-6.6-5L-2.3-.3-7,4a1.1,1.1,0,0,0-.1,1.4l1.5,1.4a.9.9,0,0,0,1.3,0L0,2.1,4.3,6.8a.9.9,0,0,0,1.3,0L7.1,5.4A1.1,1.1,0,0,0,7,4Z",fill:"white"},this.$mark),this.$check=as("path",{d:dl,fill:"white"},this.$mark),this.isAnimating=!1,t.append(this.$el)}show(t=!1,e=!0){this.$cross.toggle(!t),this.$check.toggle(t),this.$circle.setAttr("fill",t?or:er),this.$mark.addClass("show"),e&&t&&this.burst()}hide(){this.$mark.removeClass("show")}burst(t=1e3,e=60,i=20){return s(this,void 0,void 0,(function*(){this.isAnimating||(this.isAnimating=!0,yield ks((t=>{const s=Cs("sine-out",t);this.$ring.setAttr("r",.6*s*e),this.$ring.setAttr("stroke-width",.25*(1-s)*e);const n=Cs("exp-out",t),o=(.4+.6*n)*e,r=(.1+.9*n)*e;let h="";for(let t=0;t<i;++t){const e=Math.cos(2*Math.PI*t/i),s=Math.sin(2*Math.PI*t/i);h+=`M${e*r} ${s*r}L${e*o} ${s*o}`}this.$burst.setAttr("d",h)}),t).promise,this.isAnimating=!1)}))}}class fl extends cr{constructor(t,e){super(e),this.type="question-blank",this.size=100,this.canRotate=!1,this.keepOnTop=!0,this.solution="",this.submitted="",this.attempts=0,this.correct=!1,this.focussed=!1,this.colour=e.penColour,this.options=t||"Pw::0";const[s,i,n]=this.options.split(":");this.solution=atob(s),this.submitted=i,this.attempts=+n||0,this.$box=as("rect",{class:"problem-box",rx:6},this.$el),this.$text=as("text",{class:"problem-text",text:this.text,y:36},this.$el),this.mark=new ul(this.$el),this.$input=as("input",{class:"problem-text"},e.$html),this.$input.onKeyDown("enter",(()=>this.$input.blur())),this.$input.on("blur",(()=>this.blur())),this.$parent.canEditQuestions?(this.$handle=this.makeHandle("c",(t=>this.setSize(t.x))),this.$handle.css("cursor","ew-resize")):(this.$input.setInputPattern(this.solution),this.checkAnswer(!1),this.canMove=!1),this.setSize(100)}setSize(t){var e;super.setSize(Y(Q(t,50,400),25)),this.path=new Xt(kt,this.size,50),this.$input.css({width:this.size+"px",height:"50px"}),this.$box.setRect(this.path),this.$text.setAttr("x",this.size/2),this.mark.$el.setTransform({x:this.size,y:0}),null===(e=this.$handle)||void 0===e||e.setCenter({x:this.size,y:50}),this.transform()}delete(){super.delete(),this.$input.remove()}get text(){return(this.$parent.canEditQuestions?this.solution:this.submitted)||"?"}click(){this.focussed||this.$parent.events.shiftKey||this.correct&&!this.$parent.canEditQuestions||(this.focussed=!0,this.$parent.selection.add(this,!0),setTimeout((()=>{this.$el.removeClass("correct incorrect"),this.mark.hide()})),this.$input.css({top:this.posn.y+"px",left:this.posn.x+"px"}),this.$input.value=this.text,this.$text.hide(),this.$input.show(),this.$input.focus(),document.execCommand("selectAll",!1))}blur(){if(!this.focussed)return;this.focussed=!1,this.$input.hide(),this.$text.show();const t=this.text,e=this.$input.value.trim();this.$parent.canEditQuestions?(this.solution=e,this.options=`${btoa(e)}::0`):(e&&e!==this.submitted&&(this.attempts+=1),this.submitted="?"===e?"":e,this.options=`${btoa(this.solution)}:${e}:${this.attempts}`,setTimeout((()=>{this.checkAnswer(),fl.gradeWorksheet(this.$parent)}))),this.$text.text=this.text,this.text!==t&&this.$parent.change()}isCorrect(){if(!this.submitted||!this.solution)return!1;if(this.submitted.toLowerCase()===this.solution.toLowerCase())return!0;const t=Z(this.solution),e=Z(this.submitted);return q(e,t)||G(t)===this.submitted||this.solution===G(e)}checkAnswer(t=!0){this.correct=this.isCorrect(),this.submitted&&this.mark.show(this.correct,t),this.$el.setClass("correct",this.correct),this.$el.setClass("incorrect",!!this.submitted&&!this.correct)}static gradeWorksheet(t){const e=[0,0,0,0];for(const s of t.tiles)"question-blank"===s.type&&(e[0]+=1,s.submitted&&(e[s.correct?s.attempts<=1?1:2:3]+=1));e[0]===e[1]+e[2]&&Nn()}static makeThumbnail(t,e){const s=as("svg",{width:130,height:70},e);as("rect",{x:15,y:15,width:100,height:50,class:"problem-box",rx:6},s),as("text",{x:65,y:50,text:"?",class:"problem-text"},s),as("circle",{cx:115,cy:15,r:13,fill:hr},s),as("path",{d:dl,fill:"white",transform:"translate(115 15)"},s)}}const gl=c(he);class ml extends cr{constructor(t,e){super(e),this.type="image",this.path=new Xt(kt,0,0),this.aspectRatio=1,this.options=t,this.$image=as("image",{href:t,crossorigin:"anonymous"},this.$el),this.$outline=as("path",{class:"outline"},this.$el),gl(t).then((t=>{this.aspectRatio=t.height/t.width,this.setSize(this.size||t.width)})),this.$handle=this.makeHandle("c",(t=>this.setSize(t.x))),this.$handle.css("cursor","nwse-resize")}setHref(t){this.options=t,this.$image.setAttr("href",t),gl(t)}setSize(t){const e=Math.max(50,50*this.aspectRatio),s=Math.min(1e3,1e3/this.aspectRatio);this.size=Q(t,e,s),this.$image.setAttr("width",this.size),this.$image.setAttr("height",this.aspectRatio*this.size),this.path=new Xt(kt,this.size,this.aspectRatio*this.size),this.$outline.draw(this.path),this.$handle.setCenter({x:this.size,y:this.aspectRatio*this.size}),this.transform(),this.$parent.selection.update()}}class vl extends cr{constructor(t,e){super(e),this.type="text",this.size=0,this.keepOnTop=!0,this.focussed=!1,this.timeout=0,this.$box=as("rect",{fill:"transparent"},this.$el),this.$text=as("text",{class:"text-tile"},this.$el),this.$outline=as("path",{class:"outline"},this.$el),this.setColour(e.penColour),this.updateText(t||"Text"),this.$parent.$textEdit.on("blur",(()=>this.blur()))}setSize(t){super.setSize(Q(t,-5,10)),this.$text.css("font-size",this.fontSize),this.updateOutline(),this.transform()}get fontSize(){return 20*1.2**this.size}static action(t,e,i,n){return s(this,void 0,void 0,(function*(){if("larger"===t)for(const t of e)t.setSize(t.size+1);else if("smaller"===t)for(const t of e)t.setSize(t.size-1);n.selection.update(),n.change()}))}getSnapPoints(){return[]}click(){const t=Date.now();t-this.timeout<500&&this.focus(),this.timeout=t}updateOutline(){const t=this.$text.children,e=t.map((t=>t._el.getComputedTextLength())),s=Math.ceil(Math.max(...e)),i=1.4*this.fontSize,n=i*t.length;for(const[e,s]of t.entries())s.setAttr("dy",i-(e?0:(this.fontSize-5)/3));this.path=new Xt(kt,s+16,n+4),this.$box.setRect(this.path),this.$outline.draw(this.path)}updateText(t){this.options=t,this.$text.removeChildren();for(const e of t.split("\n"))as("tspan",{x:8,text:e},this.$text);this.updateOutline(),this.transform()}setColour(t){this.colour=t,this.$text.setAttr("fill",Xo(this.colour))}focus(){if(this.focussed)return;this.focussed=!0,this.$parent.selection.clear();const t=this.posn.subtract(this.$parent.origin).scale(this.$parent.zoom);this.$parent.$textEdit.setTransform(t,this.rot*Qo,this.$parent.zoom),this.$parent.$textEdit.text=this.options||"",this.$parent.$textEdit.css("color",this.colour),this.$parent.$textEdit.css("font-size",this.fontSize+"px"),this.$text.hide(),this.$parent.$textEdit.show(),this.$parent.$textEdit.focus(),document.execCommand("selectAll",!1)}blur(){if(!this.focussed)return;this.focussed=!1,this.$parent.$textEdit.hide();const t=this.$parent.$textEdit.text.trim(),e=this.options!==t;t?(this.$text.show(),this.updateText(t),this.$parent.selection.add(this)):this.delete(),e&&this.$parent.change()}}class $l extends cr{constructor(t,e){super(e),this.type="equation",this.focussed=!1}}function wl(t){switch(t){case"number-bar":return Bh;case"number-tile":return Ih;case"polygon":return Er;case"pentomino":return Dr;case"tangram":return Fr;case"fraction-bar":return ra;case"fraction-circle":return ha;case"text":return vl;case"algebra-tile":return ua;case"grid":return ma;case"custom-polygon":return Or;case"image":return ml;case"dice":return Qa;case"coin":return sl;case"number-line":return Rh;case"penrose":return Qr;case"kolam":return th;case"prime-disk":return Fh;case"balance":return za;case"decimal-grid":return Wh;case"spinner":return hl;case"custom-spinner":return cl;case"token":return qa;case"egg":return oh;case"geo":return mr;case"fractal":return ch;case"ruler":return gh;case"protractor":return mh;case"compass":return vh;case"dot-machine":return Kh;case"dot":return Yh;case"garden":return Mh;case"tantrix":return Sh;case"axes":return Ba;case"question-blank":return fl;case"equation":return $l;case"number-card":return ea}throw Error(`Unknown tile type: ${t}`)}const xl=Math.PI/180;let yl,bl;const Ml=new Set,kl=new Set;function Al(t,e,s){const i=et(t-e,s);return i>s/2?i-s:i}function Cl(t,e){for(const s of t)if(e(s))return!0;return!1}class Pl{constructor(t){this.$parent=t,this.angle=0,this.startAngle=0,this.hasChanged=!1,this.isMoving=!1,this.tiles=new Set,this.$tools=t.$(".transform-tools"),this.$rect=this.$tools.$(".group-outline"),this.$rotateBar=this.$tools.$(".rotate-bar"),this.$rotateCircle=this.$tools.$(".rotate-circle"),t.events.listen(this.$rotateCircle,{start:()=>{this.startAngle=this.angle,this.rotateStart()},move:({startPosn:t,posn:e})=>{this.rotate(this.startAngle-new Lt(e,this.center,t).deg)},end:()=>this.rotateEnd()}),$s.onKey("up down left right r R",((t,e)=>{if(!this.tiles.size)return;if("r"===e||"R"===e){if(Array.from(this.tiles).some((t=>!t.canRotate)))return;return this.rotateStart(),this.rotate(this.angle+("R"===e?-15:15)),void this.rotateEnd()}const s=kt,i=this.$parent.events.shiftKey?5:25,n="left"===e?-i:"right"===e?i:0,o="up"===e?-i:"down"===e?i:0,r=s.shift(n,o);this.moveStart(),this.move({posn:r,startPosn:s}),this.moveEnd()})),$s.onKey("escape",(()=>this.clear()))}get size(){return this.tiles.size}add(t,e=!1,s=!1){e&&this.clear(),t.isActive||this.select([t],s)}select(t,e=!1){for(const e of t)e.isActive||(this.tiles.add(e),e.select(),this.hasChanged=!0);e||this.update(!0)}remove(t,e=!1){t.isActive&&(t.deselect(),this.hasChanged=!0,this.tiles.delete(t),e||this.update(!0))}copy(t=!1,e=25){if(!this.$parent.options.canCopy||!this.tiles.size)return;const s={},i=Array.from(this.tiles).map((t=>t.copy(s,e)));this.clear();for(const t of i)this.add(t);t||this.$parent.change()}delete(){if(this.$parent.options.canDelete&&this.tiles.size){for(const t of this.tiles)t.delete();mr.computeIntersections(this.$parent),this.$parent.change(),this.$parent.newTileShift=0}}clear(){for(const t of this.tiles)t.deselect();this.tiles.size&&(this.hasChanged=!0),this.tiles.clear(),this.update(!0)}getTileProperty(t){if(!this.size)return;const e=Array.from(this.tiles),s=t(e[0]);return e.slice(1).some((e=>t(e)!==s))?void 0:s}update(t=!1){if(t&&!this.hasChanged)return;if(this.hasChanged=!1,!this.size)return this.$tools.hide(),void this.$parent.trigger("change-selection",{tiles:[],color:void 0});const e=Array.from(this.tiles);this.angle=this.getTileProperty((t=>t.rot))||0;const s=Uo(...e.map((t=>t.transformed.rotate(-this.angle*xl)))),i=s.p.shift(s.w/2,s.h/2).rotate(this.angle*xl).shift(-s.w/2,-s.h/2);this.rect=new Xt(i,s.w,s.h),this.center=this.rect.center;let n=!!this.$parent.options.canRotate&&e.every((t=>t.canRotate));if(1===e.length&&Rt(e[0].transformed)&&(n=!1),n&&this.getTileProperty((t=>t.rotateAroundOrigin))){const t=e[0].posn;e.slice(1).every((e=>e.posn.equals(t)))&&(this.center=t,this.angle&&1===e.length&&(this.rect=Uo(e[0].transformed.rotate(-this.angle*xl,t))))}this.$rotateBar.toggle(n),this.$rotateCircle.toggle(n);const o=this.getTileProperty((t=>t.hideSelectionOutline));o||this.positionTools(),this.$rect.toggle(this.size>1||e[0].showSelectionOutline),this.$tools.toggle(!o);const r=this.getTileProperty((t=>t.colour));this.$parent.trigger("change-selection",{tiles:e,color:r})}positionTools(){this.$rect.draw(this.rect.rotate(this.angle*xl,this.center));const t=new Mt(this.center.x,this.rect.p.y),e=new St(t,t.shift(0,-28)).rotate(this.angle*xl,this.center);this.$rotateBar.setLine(e.p1,e.p2),this.$rotateCircle.setCenter(e.p2)}moveStart(){for(const t of this.tiles)if(!t.canMove)return;this.isMoving=!0;for(const t of this.tiles)t.moveStart();this.startSnapPoints=[];for(const t of this.tiles)for(const e of t.snapPoints)this.startSnapPoints.some((t=>e.equals(t)))||this.startSnapPoints.push(e);bl=this.rect,yl=this.center,this.$parent.newTileShift=0,this.$parent.trigger("move-start")}move({posn:t,startPosn:e}){if(!this.isMoving)return;let s=t.subtract(e);const i=this.startSnapPoints.map((t=>t.add(s))),n=this.$parent.snap(i);n&&(s=s.add(n.shift));const o=1===this.tiles.size?null==n?void 0:n.target:void 0;for(const t of this.tiles)t.move(s,o);this.rect=bl.translate(s),this.center=yl.add(s),this.positionTools(),this.$parent.trigger("move-selection")}moveEnd(){if(this.isMoving){for(const t of this.tiles)t.transform(),t.moveEnd();mr.computeIntersections(this.$parent),this.$parent.trigger("move-end"),this.$parent.change(),this.isMoving=!1}}rotateStart(){kl.clear();for(const t of this.tiles)for(const e of t.snapAngles)kl.add(et(e+t.rot,180));Ml.clear(),Ml.add(0);for(const t of this.$parent.tiles)if(!t.isActive&&Cl(this.tiles,(e=>Mt.distance(e.posn,t.posn)<140)))for(const e of t.snapAngles)Ml.add(et(e+t.rot,180));this.$parent.newTileShift=0}rotate(t){if((t=Y(t,3))===this.angle)return;let e=1/0;for(const s of kl)for(const i of Ml){const n=Al(i,s+t-this.startAngle,180);Math.abs(n)<Math.abs(e)&&(e=n)}if(Math.abs(e)<8&&(t+=e),t===this.angle)return;const s=t-this.angle;this.angle=t;for(const t of this.tiles)t.posn=t.posn.rotate(s*Math.PI/180,this.center),t.rot=et(t.rot+s,360),t.transform(!0);this.positionTools(),this.$parent.trigger("rotate-selection")}rotateEnd(){for(const t of this.tiles)t.transform();this.$parent.change()}action(t,e){if("copy"===e)return this.copy();if("delete"===e)return this.delete();wl(t.split(" ")[0]).action(e,this.tiles,this.center,this.$parent),this.$parent.change()}}class Tl{constructor(t){this.$parent=t}getTileAt(t,e=!0){var s,i;const n=this.$parent.snap([t.posn],e,!0,"geo");if("geo"===(null===(i=null===(s=null==n?void 0:n.target)||void 0===s?void 0:s.tile)||void 0===i?void 0:i.type))return n.target.tile;let o=t.event.target;for(;o;){const t=lr.get(o);if(t&&!t.locked&&"geo"!==t.type)return t;if(o=o.parentNode||void 0,o===this.$parent._el)return}}hoverGeoTile(t){var e;this.hoveringTile!==t&&(null===(e=this.hoveringTile)||void 0===e||e.hover(!1)),null==t||t.hover(),this.hoveringTile=t}down(t){}start(t){}move(t){}end(t){}click(t){}hover(t){}cancel(){}}class Sl extends Tl{down(t){const e=this.activeTile=this.getTileAt(t,!1);this.previousSelection=void 0,e?(e.isActive&&this.$parent.events.shiftKey?this.$parent.selection.remove(e):!this.$parent.events.shiftKey&&e.isActive||this.$parent.selection.add(e,!this.$parent.events.shiftKey),cs.addClass("grabbing")):this.$parent.events.shiftKey?this.previousSelection=new Set(this.$parent.selection.tiles):this.$parent.selection.clear()}start(){this.activeTile?(this.$parent.events.altKey&&this.$parent.selection.copy(!0,0),this.$parent.selection.moveStart()):this.$parent.$selection.show()}move(t){var e;if(this.activeTile)return void this.$parent.selection.move(t);const s=Xt.aroundPoints([t.startPosn,t.posn]);this.$parent.$selection.setRect(s);for(const t of this.$parent.tiles){if(t.locked||!t.canDragToSelect||!t.transformed)continue;const i=Ko(s,t.transformed,t.type);(this.$parent.events.shiftKey&&(null===(e=this.previousSelection)||void 0===e?void 0:e.has(t))?!i:i)?this.$parent.selection.add(t,!1,!0):this.$parent.selection.remove(t,!0)}this.$parent.selection.update(!0)}end(){this.activeTile?this.$parent.selection.moveEnd():this.$parent.$selection.hide(),cs.removeClass("grabbing")}click(t){this.activeTile?this.activeTile.click(t):this.$parent.selection.clear()}hover(t){const e=this.getTileAt(t,!1);this.hoverGeoTile("geo"===(null==e?void 0:e.type)?e:void 0),this.$parent.$svg.css("cursor",(null==e?void 0:e.locked)?"pointer":e?"grab":"")}}class Ll extends Tl{constructor(){super(...arguments),this.erased=0}down({posn:t}){this.erase(t)}move({posn:t,lastPosn:e}){const s=Mt.distance(t,e)/4;for(let i=0;i<s;++i)this.erase(Mt.interpolate(t,e,i/s))}shouldErase(t,e,s){return Ht(e)?Mt.distance(e,t)<10:qt(e)?e.distanceSquared(t)<100:Rt(e)&&"geo"===s?Math.abs(Mt.distance(t,e.c)-e.r)<10:e.contains(t)}erase(t){for(const e of this.$parent.tiles)if(e.transformed&&e.canDragToSelect&&this.shouldErase(t,e.transformed,e.type))return e.delete(),void(this.erased+=1);for(const e of this.$parent.strokes)if(e.hitTest(t,10))return e.delete(),void(this.erased+=1)}end(){this.erased&&this.$parent.change(),this.erased=0}}class _l extends Tl{down({posn:t}){const e=this.$parent.newTile("text","");e.setTransform(t.shift(-10,-15)),this.$parent.trigger("add-tile",{tile:e}),e.focus()}}class zl extends Tl{constructor(){super(...arguments),this.brush="pen"}getUtensil(t){for(const e of this.$parent.tiles.values()){if(!e.transformed||!fh(e))continue;const s=e.transformed.project(t);if(Mt.distance(t,s)<30)return e.transformed}}getPoint(t){if("straight"===this.brush){const e=this.$parent.snap([t]);return e?t.add(e.shift):this.startPoint?t.snap(this.startPoint,5):t}return this.utensil?this.utensil.project(t):t}down({posn:t}){this.utensil=this.getUtensil(t),this.startPoint=this.getPoint(t),this.stroke=new $r(this.$parent,[this.startPoint],this.$parent.penColour,this.brush)}move({posn:t}){const e=this.getPoint(t);"straight"===this.brush?this.stroke.setLine(new St(this.startPoint,e)):this.stroke.addPoint(this.getPoint(e))}end(){var t;"straight"===this.brush?null===(t=this.stroke)||void 0===t||t.makeSnapPoints():this.stroke.simplify(),this.stroke=this.startPoint=this.utensil=void 0,this.$parent.change()}}class El extends Tl{constructor(){super(...arguments),this.type="line"}expr(t,e){switch(this.type){case"line":return`segment(${t},${e})`;case"circle":return`circle(${t},distance(${t},${e}))`;case"rect":return`rectangle(${t},${e}.x-${t}.x,${e}.y-${t}.y)`}}snapPoint(t){var e,s,i,n;const o=this.$parent.snap([t]);o&&(t=t.add(o.shift));let r="";const h="geo"===(null===(s=null===(e=null==o?void 0:o.target)||void 0===e?void 0:e.tile)||void 0===s?void 0:s.type)?null===(i=null==o?void 0:o.target)||void 0===i?void 0:i.tile:void 0;return(null==h?void 0:h.path)&&Ht(h.path)&&(r=h.id),(null===(n=null==o?void 0:o.target)||void 0===n?void 0:n.intersection)&&(r=o.target.intersection.expr),{point:t,tile:h,expr:r||`point(${t.x},${t.y})`}}getOrMakePointTile(t){var e,s;if((null===(e=null==t?void 0:t.tile)||void 0===e?void 0:e.path)&&Ht(t.tile.path))return t.tile;if(null===(s=null==t?void 0:t.tile)||void 0===s?void 0:s.path){const e=go(t.tile.path,t.point),s=new mr(`${t.tile.id}.at(${e})`,this.$parent);return this.$parent.trigger("add-tile",{tile:s}),s}const i=new mr(t.expr,this.$parent);return this.$parent.trigger("add-tile",{tile:i}),i}drawPendingPoint(t){var e,s;const i="point"===(null===(s=null===(e=t.tile)||void 0===e?void 0:e.path)||void 0===s?void 0:s.type),n=t.expr.startsWith("intersection");this.$parent.$pendingPoint.toggle(!i),i||(this.$parent.$pendingPoint.setCenter(t.point),this.$parent.$pendingPoint.setClass("locked",n),this.$parent.$pendingPoint.setAttr("r",n?3.5:6))}down({posn:t}){const e=this.snapPoint(t);this.startPoint=this.getOrMakePointTile(e),this.createdNewStart=!e.tile}start(){var t;this.path=new mr("",this.$parent),this.startPoint.pending=this.path.pending=!0,null===(t=this.$parent.$pendingPoint)||void 0===t||t.show(),this.hoverGeoTile(void 0)}move({posn:t}){var e;this.endSnap=this.snapPoint(t),this.path.setExpr(this.expr(this.startPoint.id,this.endSnap.expr),!0),this.drawPendingPoint(this.endSnap),this.hoverGeoTile(null===(e=this.endSnap)||void 0===e?void 0:e.tile)}end(){var t;const e=Mt.distance(this.startPoint.path,this.endSnap.point)<8;if(e)this.path.delete();else{const t=this.getOrMakePointTile(this.endSnap);this.path.setExpr(this.expr(this.startPoint.id,t.id)),this.path.setPending(!1),this.$parent.trigger("add-tile",{tile:this.path})}this.startPoint.setPending(!1),this.startPoint=this.path=this.endSnap=void 0,null===(t=this.$parent.$pendingPoint)||void 0===t||t.hide(),this.hoverGeoTile(void 0),mr.computeIntersections(this.$parent),!this.createdNewStart&&e||this.$parent.change()}click(){this.createdNewStart&&this.$parent.change()}hover(t){var e;const s=this.snapPoint(t.posn);this.drawPendingPoint(s),this.hoverGeoTile("geo"===(null===(e=null==s?void 0:s.tile)||void 0===e?void 0:e.type)?s.tile:void 0)}cancel(){this.$parent.$pendingPoint.hide(),this.path&&this.path.delete(),this.startPoint=this.path=this.endSnap=void 0}}class Il extends El{constructor(){super(...arguments),this.startId="",this.expression=""}enable(t){var e;this.expression=t,this.$parent.selection.clear(),this.$parent.setActiveTool("geoPending"),(null===(e=window.event)||void 0===e?void 0:e.clientX)&&this.hover({posn:Le(window.event,this.$parent.$svg)})}makePath(){return this.path=new mr("",this.$parent),this.path.$el.css("opacity",.5),this.path.pending=!0,this.path}down(t){if(!this.expression)return;super.down(t);const e=this.path||this.makePath();e.$el.css("opacity",1),e.setExpr(this.expression.replace(/\$1/g,this.startPoint.id)),e.pending=!1,this.path=void 0,this.$parent.setActiveTool("move"),this.$parent.selection.add(e,!0),this.$parent.change(),mr.computeIntersections(this.$parent),this.$parent.trigger("add-tile",{tile:e})}hover({posn:t}){var e;if(!this.expression)return;const s=this.snapPoint(t);this.drawPendingPoint(s),this.hoverGeoTile("geo"===(null===(e=null==s?void 0:s.tile)||void 0===e?void 0:e.type)?s.tile:void 0),this.path||this.makePath(),this.path.setExpr(this.expression.replace(/\$1/g,s.expr))}cancel(){super.cancel(),this.expression=""}}class Ol extends zl{constructor(){super(...arguments),this.brush="straight"}enable(t){this.tiles=t;for(const t of this.tiles)t.$outline.addClass("active");this.$parent.selection.clear(),this.$parent.setActiveTool("cutPolygon")}down(){}start({posn:t}){this.tiles&&(this.utensil=this.getUtensil(t),this.startPoint=this.getPoint(t),this.$stroke=as("line",{class:"stroke cut"},this.$parent.$strokes))}move({posn:t}){var e;this.lastPoint=this.getPoint(t),null===(e=this.$stroke)||void 0===e||e.setLine(this.startPoint,this.lastPoint)}end(){var t;const e=new Pt(this.startPoint,this.lastPoint);let s=!1;for(const t of this.tiles||[]){const i=t.transformed.cut(e);if(i.length>=1){for(const e of i){const s=new Er(yr(e.points),this.$parent);s.setColour(t.colour),s.transform()}t.delete(),s=!0}else t.$outline.removeClass("active")}s&&this.$parent.change(),null===(t=this.$stroke)||void 0===t||t.remove(),this.$stroke=this.tiles=this.startPoint=this.lastPoint=void 0,this.$parent.setActiveTool("move")}click(){this.cancel()}cancel(){var t;for(const t of this.tiles||[])t.$outline.removeClass("active");null===(t=this.$stroke)||void 0===t||t.remove(),this.$stroke=this.tiles=this.startPoint=this.lastPoint=void 0,setTimeout((()=>this.$parent.setActiveTool("move")))}}const ql=new Yt(-2e3,4e3,-2e3,4e3),Vl=25,Bl=Vl*Math.sqrt(3)/2,Rl=t=>`${t.xMin} ${t.yMin} ${t.dx} ${t.dy}`;let Dl=class extends Bs{constructor(){super(...arguments),this.tiles=new Set,this.strokes=new Set,this.penColour="#242436",this.initial={},this.intersections=new Set,this.margins=[20,20,20,20],this.origin=kt,this.zoom=1,this.newTileShift=0,this.options=He({grid:"none",canEdit:!0,changeCount:0}),this.canEditQuestions=!1,this.canPinchPan=!1,this.setup=!1,this.undoStack=[],this.redoStack=[]}ready(){var t;this.$svg=this.$("svg.canvas"),this.$tiles=this.$svg.$(".tiles:not(.active)"),this.$activeTiles=this.$svg.$(".tiles.active"),this.$selection=this.$svg.$(".selection"),this.$strokes=this.$svg.$(".strokes"),this.$grid=this.$svg.$(".grid"),this.$html=this.$(".html-overlay"),this.$panels=this.$(".panels"),this.$geoShadows=this.$svg.$(".geo-shadows"),this.$geoPaths=this.$svg.$(".geo-paths"),this.$geoPoints=this.$svg.$(".geo-points"),this.$pendingPoint=as("circle",{class:"geo-point pending",hidden:!0},this.$geoPoints),this.$textEdit=this.$(".text-edit"),this.$textEdit.onKeyDown("escape",(t=>{t.stopPropagation(),this.$textEdit.blur()})),this.tools={move:new Sl(this),pen:new zl(this),geo:new El(this),geoPending:new Il(this),eraser:new Ll(this),text:new _l(this),cutPolygon:new Ol(this)},this.activeTool=this.tools.move,this.setAttr("data-tool","move"),this.events=new xo(this.$svg,{down:t=>this.activeTool.down(t),start:t=>this.activeTool.start(t),move:t=>this.activeTool.move(t),end:t=>this.activeTool.end(t),click:t=>this.activeTool.click(t),hover:t=>this.activeTool.hover(t),cursor:!1}),this.canEditQuestions="teacher"===this.attr("user-type")&&(null===(t=this.initial.canEdit)||void 0===t||t),this.canEditQuestions&&(this.$svg.copy=function(t=!0,e=!0,s){const i=Ge.prototype.copy.call(this,t,e,s);for(const t of i.$$(".problem-text"))t.text="?";return i}),this.selection=new Pl(this),this.options.canRotate=co(this,"rotate",!0),this.options.canDelete=co(this,"delete",!0),this.options.canCopy=co(this,"copy",!0),this.options.grid=this.attr("grid")||"none",this.setViewport(kt,1),this.options.watch((t=>{this.$grid.setAttr("fill","none"!==t.grid?`url(#${t.grid})`:"none"),this.$grid.setRect(this.canvasBounds.rect)})),co(this,"pan",!1)&&this.enablePinchPan(),$s.onKey("backspace",(()=>this.selection.delete())),this.$svg.on("focusin",(()=>{const t=Array.from(this.tiles);this.focusTile(this.events.shiftKey?v(t):t[0])})),this.$svg.on("focusout",(()=>this.focussed=void 0)),ls.on("keydown",(t=>{if(9!==t.keyCode||!this.focussed)return;const e=Array.from(this.tiles);this.focusTile(e[e.indexOf(this.focussed)+(t.shiftKey?-1:1)]),this.focussed&&t.preventDefault()})),$s.onThemeChange((()=>{for(const t of this.tiles)t.setColour(t.colour);for(const t of this.strokes)t.setColor(t.color)}))}focusTile(t){this.focussed=t,this.$svg.setAttr("aria-description",t?t.ariaDescription:"Empty Canvas"),t&&this.selection.add(t,!0)}*snapPoints(t,e){for(const s of this.tiles)if(!(t&&s.isActive||s.pending||e&&s.type!==e))for(const t of s.snapPoints)yield[t,{tile:s}];for(const t of this.strokes)if(t.snapPoints)for(const e of t.snapPoints)yield[e,{stroke:t}];for(const t of this.intersections)yield[t.value,{intersection:t}]}*gridPoints(t){if("none"===this.options.grid)return;const e=this.options.grid.split("-")[0],s=Xt.aroundPoints(t);let i=new Yt(s.p.x-Vl,s.p.x+s.w+50,s.p.y-Vl,s.p.y+s.h+50);if(e.startsWith("square")){const t=("square2"===e?2:1)*Vl,s=Y(i.xMin,t);for(let e=Y(i.yMin,t);e<i.yMax;e+=t)for(let n=s;n<i.xMax;n+=t)yield[new Mt(n,e),{}]}else if(e.startsWith("tri")){const t="tri2"===e;t&&(i=i.flip);const s=Y(i.xMin,Vl);for(let e=Math.floor(i.yMin/Bl);e*Bl<i.yMax;++e)for(let n=s+(e%2?12.5:0);n<i.xMax;n+=Vl){const s=new Mt(n,e*Bl);yield[t?s.flip:s,{}]}}}*snapLines(t,e){for(const s of this.tiles)if(!(t&&s.isActive||s.pending||e&&s.type!==e))for(const t of s.snapLines)yield[t,{tile:s}];for(const t of this.strokes)if(t.snapLines)for(const e of t.snapLines)yield[e,{stroke:t}]}snap(t,e=!0,s=!1,i){return Zo(8,t,this.snapPoints(e,i))||!s&&Zo(18,t,this.gridPoints(t))||Zo(6,t,this.snapLines(e,i),((t,e)=>t.project(e)))}enablePinchPan(){this.canPinchPan=!0,this.on("wheel",(t=>{if(t.preventDefault(),t.ctrlKey){const e=this.zoom*(1-t.deltaY/100);this.setViewport(this.origin,e,Le(t,this.$svg))}else{const e=this.origin.shift(t.deltaX/this.zoom,t.deltaY/this.zoom);this.setViewport(e,this.zoom)}}));let t=0,e=this.origin;this.on("gesturestart",(s=>{s.preventDefault(),e=new Mt(s.pageX,s.pageY).subtract(this.origin),t=this.zoom,this.events.cancel()})),this.on("gesturechange",(s=>{s.preventDefault();const i=t*s.scale,n=new Mt(s.pageX,s.pageY).subtract(e);this.setViewport(n,i,Le(s,this.$svg))})),this.on("gestureend",(t=>t.preventDefault()))}enableImageDrop(t,e){const i=as("div",{class:"image-drop"},this);this.on("dragenter dragover dragleave drop",(t=>t.preventDefault())),this.on("dragenter dragover",(()=>i.show())),this.on("dragleave drop",(()=>i.hide()));const n=(e,i)=>s(this,void 0,void 0,(function*(){const s=Array.from((null==e?void 0:e.files)||[]).slice(0,10).map(((e,s)=>this.newImage(e,i.shift(25*s),t)));yield Promise.all(s),this.change()}));this.on("drop",(t=>n(t.dataTransfer,Le(t,this.$svg)))),null==e||e.on("change",(()=>s(this,void 0,void 0,(function*(){yield n(e._el,this.canvasBounds.center),e.value=""}))))}bindSettingsPanel(t,e,s){const i=as("div",{class:"polypad-settings",html:e},this.$panels);this.on("change-selection",(({tiles:e})=>{i.toggle(1===e.length&&e[0]===t)}));const n=He(s);return i.bindModel(n),n}enableHotkeys(){$s.onKey("z",(t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),t.shiftKey?this.redo():this.undo())})),$s.onKey("y",(t=>{(t.ctrlKey||t.metaKey)&&(t.preventDefault(),this.redo())})),$s.onKey("c",(t=>{$s.getActiveInput()||t.ctrlKey||t.metaKey||this.selection.copy()})),ls.on("cut copy",(t=>{var e;if($s.getActiveInput()||!this.selection.tiles.size)return;const s=Array.from(this.selection.tiles).map((t=>t.toJSON()));null===(e=window.navigator.clipboard)||void 0===e||e.writeText(JSON.stringify(s)),"cut"===t.type&&this.selection.delete()})),ls.on("paste",(()=>s(this,void 0,void 0,(function*(){var t;if($s.getActiveInput())return;const e=yield null===(t=window.navigator.clipboard)||void 0===t?void 0:t.readText();if(e)try{const t=JSON.parse(e);if(!t.length)return;const s=t.map((t=>cr.unSerialize(t,this))).filter((t=>t));this.selection.clear();const i=Uo(...s.map((t=>t.transformed))).center,n=this.canvasBounds.center.subtract(i).shift(25*this.newTileShift);for(const t of s)t.setTransform(t.posn.add(n)),this.selection.add(t);this.change(),this.newTileShift+=1}catch(t){const s=this.newTile("text",e);s.setTransform(this.canvasBounds.center.subtract(s.center)),this.selection.add(s,!0),this.change()}}))))}newImage(t,e,i){return s(this,void 0,void 0,(function*(){const s=new FileReader;s.readAsDataURL(t),yield new Promise((t=>s.onloadend=t));const n=this.newTile("image",(s.result||"").toString());return n.setTransform(e),this.selection.add(n,!0),null==i?void 0:i(t,n)}))}newTile(t,e){return new(wl(t))(e,this)}setViewport(t,e=1,s){if(e=Q(e,1/3,3),s){const i=this.zoom/e;t=s.subtract(s.subtract(this.origin).scale(i))}const i=this.width/e,n=this.height/e;this.zoom=e,this.origin=t.clamp(ql.resize(-i,-n)),this.canvasBounds=new Yt(this.origin.x,this.origin.x+i,this.origin.y,this.origin.y+n),this.$svg.setAttr("viewBox",this.attr("viewBox")||Rl(this.canvasBounds)),this.$html.setTransform(this.origin.inverse.scale(this.zoom),0,this.zoom);const o=this.canvasBounds.rect;"none"!==this.options.grid&&this.$grid.setRect(o),mr.redrawLines(o)}resetViewport(){if(!this.tiles.size&&!this.strokes.size)return this.setViewport(kt,1);const t=Wo(this.tiles,this.strokes,0),[e,s,i,n]=this.margins,o=(this.width-n-s)/t.dx,r=(this.height-e-i)/t.dy,h=Q(Math.min(o,r),1/3,1),a=new Mt(this.width+n-s,this.height+e-i),l=t.center.subtract(a.scale(.5/h));this.setViewport(l,h)}bindSource(t,e,s,i,n){let o;wl(e).makeThumbnail(s,t,this,n);const r=null==i?void 0:i.$(".tiles.active");this.events.listen(t,{down:()=>this.trigger("add-tile-start"),start:({posn:h})=>{o=this.newTile(e,t.data.options||s),n&&o.setColour(n),o.setTransform(h),this.selection.add(o,!0),this.selection.moveStart(),i&&this.canPinchPan&&i.setAttr("viewBox",Rl(this.canvasBounds)),(r||this.$tiles).append(o.$el),this.trigger("add-tile",{tile:o})},move:t=>this.selection.move(t),end:()=>{this.$activeTiles.append(o.$el),this.selection.moveEnd()},click:()=>{const i=this.newTile(e,t.data.options||s);i.setTransform(this.canvasBounds.center.subtract(i.center).shift(25*this.newTileShift)),n&&i.setColour(n),this.selection.add(i,!0),i.moveEnd(),this.trigger("add-tile",{tile:i}),this.change(),this.newTileShift+=1}})}setColour(t="#242436"){this.penColour=t,this.$pendingPoint.css("color",Xo(t));for(const e of this.selection.tiles)e.setColour(t||"");this.selection.tiles.size&&this.change()}setActiveTool(t){this.activeTool.cancel(),this.activeTool=this.tools[t],this.setAttr("data-tool",t),this.selection.clear()}clear(t=!0){this.selection.clear();for(const t of this.tiles)t.delete();for(const t of this.strokes)t.delete();t&&this.setViewport(kt,1),this.change()}thumbnail(t,e){const s=Wo(this.tiles,this.strokes,50);return this.$svg.pngImage(t,e,Rl(s))}downloadImage(t){var e;this.selection.clear();const s=t||(null===(e=this.options.title)||void 0===e?void 0:e.replace(/\s/g,"-").replace(/[^\w-]/g,"").toLowerCase())||"polypad",i=Wo(this.tiles,this.strokes,50);this.$svg.downloadImage(`${s}.png`,i.dx,i.dy,Rl(i))}change(){this.setup||(this.trigger("change"),this.undoStack.push(this.serialize()),this.undoStack.length>20&&this.undoStack.shift(),this.redoStack=[],this.options.canUndo=!0,this.options.changeCount+=1)}undo(){this.undoStack.length&&(this.redoStack.push(this.undoStack.pop()),this.unSerialize(v(this.undoStack)||this.initial),this.trigger("change"),this.options.canUndo=!!this.undoStack.length,this.options.changeCount-=1)}redo(){this.redoStack.length&&(this.undoStack.push(this.redoStack.pop()),this.unSerialize(v(this.undoStack)||this.initial),this.trigger("change"),this.options.canUndo=!0,this.options.changeCount+=1)}serialize(){var t;return{title:null===(t=this.options.title)||void 0===t?void 0:t.slice(0,30),grid:this.options.grid||"none",background:this.options.background,noLabels:this.options.noLabels,tiles:Array.from(this.tiles).slice(0,2e3).map((t=>t.toJSON())),strokes:Array.from(this.strokes).slice(0,1e3).map((t=>t.serialize()))}}unSerialize(t){if(t){this.setup=!0,this.clear(!1),mr.clearModel();for(const e of t.tiles||[])cr.unSerialize(e,this);for(const e of t.strokes||[])$r.unSerialize(e,this);mr.computeIntersections(this);for(const t of this.tiles)t.move();this.setup=!1}}load(t){var e,s;this.initial=t,this.unSerialize(t),this.undoStack=this.redoStack=[],this.options.key=t.key,this.options.grid=t.grid||"none",this.options.thumbnail=t.thumbnail,this.options.title=t.title||"Untitled",this.options.canEdit=null===(e=t.canEdit)||void 0===e||e,this.options.noLabels=null!==(s=t.noLabels)&&void 0!==s?s:this.options.noLabels||!1,this.options.canUndo=!1,this.options.changeCount=0,this.resetViewport()}};Dl=e([Rs("x-polypad",{template:'<svg class="canvas" tabindex="0"><defs><pattern class="grid-pattern" id="square2-grid" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect x="0" y="0" width="50" height="50" opacity="0.1"></rect></pattern><pattern class="grid-pattern" id="square-dots" x="-4" y="-4" width="25" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="4" r="2" opacity="0.15"></circle></pattern><pattern class="grid-pattern" id="square-grid" x="0" y="0" width="125" height="125" patternUnits="userSpaceOnUse"><g opacity="0.1"><line x1="25" y1="0" x2="25" y2="125"></line><line x1="0" y1="25" x2="125" y2="25"></line><line x1="50" y1="0" x2="50" y2="125"></line><line x1="0" y1="50" x2="125" y2="50"></line><line x1="75" y1="0" x2="75" y2="125"></line><line x1="0" y1="75" x2="125" y2="75"></line><line x1="100" y1="0" x2="100" y2="125"></line><line x1="0" y1="100" x2="125" y2="100"></line></g><rect x="0" y="0" width="125" height="125" opacity="0.25"></rect></pattern><pattern class="grid-pattern" id="tri-dots" x="0" y="-4" width="25" height="43.30127018922193" patternUnits="userSpaceOnUse"><circle cx="0" cy="4" r="2" opacity="0.15"></circle><circle cx="25" cy="4" r="2" opacity="0.15"></circle><circle cx="12.5" cy="25.650635094610966" r="2" opacity="0.15"></circle></pattern><pattern class="grid-pattern" id="tri-grid" x="0" y="0" width="25" height="43.30127018922193" patternUnits="userSpaceOnUse"><g opacity="0.1"><line x1="0" y1="0" x2="25" y2="0"></line><line x1="0" y1="21.650635094610966" x2="25" y2="21.650635094610966"></line><line x1="0" y1="43.30127018922193" x2="25" y2="43.30127018922193"></line><line x1="0" y1="0" x2="25" y2="43.30127018922193"></line><line x1="25" y1="0" x2="0" y2="43.30127018922193"></line></g></pattern><pattern class="grid-pattern" id="tri2-dots" x="-4" y="0" width="43.30127018922193" height="25" patternUnits="userSpaceOnUse"><circle cx="4" cy="0" r="2" opacity="0.15"></circle><circle cx="4" cy="25" r="2" opacity="0.15"></circle><circle cx="25.650635094610966" cy="12.5" r="2" opacity="0.15"></circle></pattern><pattern class="grid-pattern" id="tri2-grid" x="0" y="0" width="43.30127018922193" height="25" patternUnits="userSpaceOnUse"><g opacity="0.1"><line x1="0" y1="0" x2="0" y2="25"></line><line x1="21.650635094610966" y1="0" x2="21.650635094610966" y2="25"></line><line x1="43.30127018922193" y1="0" x2="43.30127018922193" y2="25"></line><line x1="0" y1="0" x2="43.30127018922193" y2="25"></line><line x1="0" y1="25" x2="43.30127018922193" y2="0"></line></g></pattern><pattern class="grid-pattern" id="square-checked" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse"><rect class="filled" x="0" y="0" width="25" height="25" opacity="0.1"></rect><rect class="filled" x="25" y="25" width="25" height="25" opacity="0.1"></rect></pattern><marker id="axis-arrow" refX="3" refY="3" markerWidth="6" markerHeight="6" orient="auto"><path d="M 0 0 L 6 3 L 0 6 z"></path></marker><filter id="handdrawn" x="-20%" y="-20%" width="140%" height="140%"><feTurbulence type="fractalNoise" basefrequency="0.004 0.004" numoctaves="26" stitchtiles="stitch" result="turbulence"></feTurbulence><feDisplacementMap in="SourceGraphic" in2="turbulence" scale="20" xchannelselector="R" ychannelselector="G" result="displacementMap"></feDisplacementMap></filter><filter id="pencil" x="-10%" y="-10%" width="110%" height="110%" filterUnits="objectBoundingBox"><feTurbulence type="fractalNoise" baseFrequency="1.2" numOctaves="3" result="noise"></feTurbulence><feDisplacementMap xChannelSelector="R" yChannelSelector="G" scale="2" in="SourceGraphic" result="newSource"></feDisplacementMap></filter></defs><rect class="grid"></rect><g class="tiles"></g><g class="transform-tools" hidden><path class="group-outline"></path><line class="rotate-bar"></line><circle class="rotate-circle" r="10"></circle></g><g class="tiles active"></g><g class="strokes"></g><g class="geo-shadows"></g><g class="geo-paths"></g><g class="geo-points"></g><rect class="selection"></rect></svg><div class="html-overlay"></div><div class="text-edit" hidden contenteditable></div><div class="panels"></div><slot></slot>'})],Dl);const jl=Q(+function(t){t=t.replace(/^[?,&]/,"");const e=decodeURIComponent(t).split("&"),s={};return e.forEach((t=>{const e=t.split("=");s[e[0]]=e[1]})),s}(location.search).size||16,8,24),Nl=Math.ceil(jl/2),Hl=jl+Nl,Zl=[];for(let t=2;t<=1.5*jl;t+=1){const e=rt(t);e&&t>.75*jl||t>jl&&(Fl=t,y(ht(Fl)))[0]>jl/2||(e&&t>jl/2||t>1.25*jl?Zl.push(t):Zl.push(t,t))}var Fl;const Ul=()=>Zl[mt.integer(Zl.length)],Wl=m(1,jl),Kl=10*jl,Gl=g((t=>Kl*2**t),jl);class Xl{constructor(t,e,s){this.$el=as("rect",{width:20,height:20},s),this.setPosition(t,e)}setPosition(t,e){this.x=t,this.y=e,this.$el.setTransform({x:10+20*this.x,y:10+20*this.y})}go(t,e,s){this.setPosition(this.x+s-e,this.y+t)}canSet(t,e,s){return!s.find((s=>s.x===t&&s.y===e))}canGo(t,e,s,i){const n=this.x+s-e,o=this.y+t;return!(o>=Hl||n<0||n>=jl)&&this.canSet(n,o,i)}canGoDown(t){return this.canGo(1,0,0,t)}goDown(t=1){if(0!==t)return this.go(t,0,0)}}let Yl=class extends Bs{constructor(){super(...arguments),this.interval=void 0,this.tiles=[],this.activeTiles=[],this.activeSize=[0,0,0],this.activeFactors=[],this.isDown=!1,this.keyLock=!1,this.requestQueue=Promise.resolve(""),this.highscore=!0}ready(){this.$svg=this.$(".factris-board"),this.$tiles=this.$svg.$(".tiles"),this.$shadow=this.$svg.$(".shadow"),"no"===this.attr("highscore")&&(this.highscore=!1);const t=this.$svg.$(".scores");this.$scores=Gl.map(((e,s)=>{const i=as("g",{},t);return as("text",{text:"+"+e,class:`s${s+1}`},i),i})),this.bindModel(He({time:0,points:0,playing:!1,lost:!1,initial:!0,key:void 0,discardCounter:0,next:[],active:[],highscore:[],showHighscore:!1,min:t=>Math.floor(t/60),numberFormat:D,app:this}));for(const t of this.$$("button, .play"))t.on("contextmenu",(t=>t.preventDefault()));$s.onKey("left up right down",((t,e)=>{this.model.playing&&(t.preventDefault(),this.isDown=!0,this.model.key=e,this.keyPress(e))})),$s.onKey("left up right down",(()=>{this.model.playing&&(this.isDown=this.keyLock=!1,this.model.key=void 0)}),!0),this.setupSVG(),this.updateHighscore()}setupSVG(){this.$svg.setAttr("viewBox",`0 0 ${20*(jl+1)} ${20*(Hl+1)}`);const t=this.$svg.$(".grid"),e=t.$(".faint-grid");for(let s=0;s<=jl;s+=1){const i=10+20*s,n=10+20*(Nl+s),o=s%4&&s!==jl?e:t,r=s%2&&s!==jl?"":"thick";as("line",{x1:10,y1:n,x2:10+20*jl,y2:n,class:r},o),as("line",{x1:i,y1:10+20*Nl,x2:i,y2:20*Hl+10,class:r},o)}}drawShadow(){this.activeTiles.length&&(this.$shadow.setAttr("x",10+20*this.activeSize[0]),this.$shadow.setAttr("y",10+20*this.activeSize[1]),this.$shadow.setAttr("width",20*this.activeSize[2]),this.$shadow.setAttr("height",20*(Hl-this.activeSize[1])))}newRect(){const t=this.getNewTileSize();this.activeFactors=Wl.filter((e=>t%e==0));const e=this.activeFactors.pop(),s=Math.floor((jl-e)/2);this.activeTiles=g((t=>new Xl(s+t%e,Math.floor(t/e),this.$tiles)),t),this.model.active=[t,e,t/e],this.activeSize=[s,t/e,e],this.drawShadow(),this.isDown&&(this.keyLock=!0)}reset(){this.pause(),this.model.time=0,this.model.points=0,this.model.discardCounter=0,this.model.showHighscore=!1,this.model.lost=!1,this.model.next=[Ul(),Ul(),Ul(),Ul()];for(const t of this.tiles)t.$el.remove();for(const t of this.activeTiles)t.$el.remove();this.tiles=[],this.newRect(),this.play(),this.requestQueue=Promise.resolve("")}toggle(){this.model.lost?this.reset():this.model.playing?this.pause():this.play()}pause(){this.model.playing=!1,clearInterval(this.interval)}play(){if(this.model.showHighscore=!1,null===window||void 0===window||window.ga("send","event","Factris","play"),this.model.initial||this.model.lost)return this.model.initial=!1,this.reset();this.model.playing=!0,this.interval=window.setInterval((()=>this.tick()),1e3)}getNewTileSize(){const t=jl*jl-this.tiles.length;if(this.model.next[0]>t)return t>jl?t-jl:jl;this.model.discardCounter>0&&(this.model.discardCounter-=1);const e=this.model.next[0];return this.model.next=[...this.model.next.slice(1),Ul()],e}tick(){this.model.time+=1;if(this.activeTiles.every((t=>t.canGoDown(this.tiles)))){for(const t of this.activeTiles)t.goDown();return this.activeSize[1]+=1,void this.drawShadow()}this.tiles.push(...this.activeTiles);for(const t of this.activeTiles)t.$el.addClass("fixed");if(this.tiles.some((t=>t.y<Nl)))return this.gameOver();this.activeTiles=[];const t=this.getFullRows();if(!t.length)return this.newRect();this.model.points+=$(Gl.slice(0,t.length)),t.length>=6&&Nn(10,150*t.length/jl),this.removeRows(t);const e=this.model.points,s=(e+jl)%13+(e-jl)%87;this.requestQueue=this.requestQueue.then((t=>re("/factris-verify",{token:t,size:jl,score:e,check:s}))),this.trigger("score",{points:e})}getFullRows(){return g((t=>this.tiles.filter((e=>e.y===t+Nl))),jl).filter((t=>t.length===jl))}removeRows(t){const e=b(t);this.tiles=this.tiles.filter((t=>!e.includes(t))),this.$tiles.addClass("animated"),$s.redraw();for(const t of e)t.$el.addClass("removing");const s=t.map((t=>t[0].y));for(const t of this.tiles)t.goDown(s.filter((e=>e>t.y)).length);const i=400/t.length;for(const[t,e]of s.reverse().entries())this.$scores[t].setTransform({x:10+20*Nl,y:27+20*e}),h((()=>this.$scores[t].addClass("visible")),t*i);return setTimeout((()=>{for(const t of this.$scores)t.removeClass("visible")}),600),setTimeout((()=>{for(const t of e)t.$el.remove();this.$tiles.removeClass("animated"),this.newRect()}),1e3),!1}gameOver(){this.model.lost=!0;for(const t of this.activeTiles)t.$el.addClass("error");this.pause(),this.requestQueue.then((t=>{t&&this.trigger("game-over",{token:t,points:this.model.points})}))}discharge(){if(this.model.playing){for(const t of this.activeTiles)t.$el.remove();this.newRect(),this.model.discardCounter=5}}keyPress(t,e=!0){if(this.model.playing&&!this.keyLock){if("up"===t){if(!this.activeFactors.length)return;const t=this.activeFactors.pop(),e=this.activeSize[0]+Math.floor((this.activeSize[2]-t)/2),s=this.activeSize[1];if(this.activeTiles.some(((i,n)=>!i.canSet(e+n%t,s-1-Math.floor(n/t),this.tiles))))return;for(const[i,n]of this.activeTiles.entries())n.setPosition(e+i%t,s-1-Math.floor(i/t));const i=this.model.active[0];this.model.active=[i,t,i/t],this.activeSize=[e,s,t]}else{const s="down"===t?1:0,i="left"===t?1:0,n="right"===t?1:0;if(this.activeTiles.every((t=>t.canGo(s,i,n,this.tiles)))){for(const t of this.activeTiles)t.go(s,i,n);this.activeSize[0]+=n-i,this.activeSize[1]+=s}e&&"down"===t&&setTimeout((()=>this.keyPress("down",!1)),100)}this.drawShadow()}}showHighscore(){this.highscore&&(this.pause(),this.model.showHighscore=!0)}updateHighscore(){return s(this,void 0,void 0,(function*(){if(!this.highscore)return;const t=yield fetch(`/factris-highscore?size=${jl}`);this.model.highscore=yield t.json()}))}};Yl=e([Rs("x-factris",{template:'<div class="factris-panel-left"><div class="keys-play"><button @click="app.reset()" title="Restart Game"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#restart"></use></svg></button><button @click="app.toggle()" :title="playing ? \'Pause\' : \'Play\'"><span :show="playing"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#pause"></use></svg></span><span :show="!playing"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#play"></use></svg></span></button><button class="highscore-btn" @click="app.showHighscore()" title="Highscore"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#trophy"></use></svg></button></div><div class="panel-item"><div class="text-large" :class="points &gt; 999999 ? \'narrow\' : \'\'">${numberFormat(points)}</div><div class="text-small">Points</div></div><div class="panel-item"><div class="text-large margin"><span :show="min(time)" data-display="inline">${min(time)}m</span> ${time % 60}s</div><div class="text-small">Time</div></div><hr :show="highscore.length"><div class="highscore-panel" :show="highscore.length"><div class="highscore-title">Highscore</div><table><tr><td>${highscore[0].name.slice(0, 4)}</td><td>${numberFormat(highscore[0].score)}</td></tr><tr><td>${highscore[1].name.slice(0, 4)}</td><td>${numberFormat(highscore[1].score)}</td></tr><tr><td>${highscore[2].name.slice(0, 4)}</td><td>${numberFormat(highscore[2].score)}</td></tr><tr><td>${highscore[3].name.slice(0, 4)}</td><td>${numberFormat(highscore[3].score)}</td></tr><tr><td colspan="2"><a @click="app.showHighscore()">View more…</a></td></tr></table></div><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V5A12,12,0,0,1,12,17h1V0Z"></path><path d="M0,0V1A12,12,0,0,1,12,13v4h1V0Z"></path></svg></div></div><div class="factris-panel-right"><div class="panel-item"><div class="text-small">Next blocks:</div><div class="text-large">${next[0]}</div><div class="text-large">${next[1]}</div><div class="text-large">${next[2]}</div><div class="text-large">${next[3]}</div><div class="text-large">${next[4]}</div></div><hr><div class="text-small discharge-label">Discharge:</div><button class="discharge" :show="!discardCounter" data-display="inline-block" @click="app.discharge()" title="Discard Tile"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#delete"></use></svg></button><svg class="discharge-count" :show="discardCounter" data-display="inline-block" width="74" height="74" viewBox="0 0 74 74"><circle cx="37" cy="37" r="32" style="strokeDashoffset:${201*discardCounter/5}px"></circle><text class="large" x="37" y="38">${discardCounter}</text><text class="small" x="37" y="51">needed</text></svg><div class="corner"><svg width="13" height="17"><path class="dark" d="M0,0V17H1A12,12,0,0,1,13,5V0Z"></path><path d="M0,0V17H1V13A12,12,0,0,1,13,1V0Z"></path></svg></div></div><div class="factris-body"><svg class="factris-board" :show="(playing || lost) &amp;&amp; !showHighscore &amp;&amp; !initial" data-display="visibility"><defs><linearGradient id="shadow" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color: white; stop-opacity: 0.2"></stop><stop offset="100%" style="stop-color: white; stop-opacity: 0.05"></stop></linearGradient></defs><rect class="shadow" fill="url(#shadow)"></rect><g class="tiles"></g><g class="grid"><g class="faint-grid"></g></g><g class="scores"></g></svg><div class="logo" :class="initial &amp;&amp; !showHighscore ? \'show\' : \'\'"><svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg"><g fill="#ffffff"><path d="m1.5039 59.1143v-57.9034h24.7227v7.8077h-16.4278v17.5659h14.313v7.8071h-14.313v24.7227z"/><path d="m23.7871 59.1143 12.9307-57.9034h6.9122l12.931 57.9034h-8.2954l-2.4394-12.4429h-11.3042l-2.44 12.4429zm20.4937-20.25-4.066-20.9815h-.1626l-4.0664 20.9815z"/><path d="m86.9766 42.6055v3.5781a12.9 12.9 0 0 1 -1.0166 5.083 14.0881 14.0881 0 0 1 -2.8057 4.27 13.5323 13.5323 0 0 1 -4.1885 2.9683 12.2636 12.2636 0 0 1 -5.164 1.0977 18.5964 18.5964 0 0 1 -4.7984-.65 11.3307 11.3307 0 0 1 -4.3911-2.2774 12.5723 12.5723 0 0 1 -3.2123-4.1889 14.814 14.814 0 0 1 -1.2608-6.5463v-31.8795a14.0993 14.0993 0 0 1 .976-5.2861 12.4357 12.4357 0 0 1 2.7648-4.229 12.863 12.863 0 0 1 4.27-2.8054 14.35 14.35 0 0 1 5.4892-1.0169 12.5807 12.5807 0 0 1 9.5151 3.8223 13.6266 13.6266 0 0 1 2.8057 4.4321 14.9842 14.9842 0 0 1 1.0166 5.5708v3.253h-8.2954v-2.7652a6.7153 6.7153 0 0 0 -1.3824-4.2285 4.4819 4.4819 0 0 0 -3.7412-1.789q-3.0915 0-4.1064 1.9111a10.23 10.23 0 0 0 -1.0166 4.8384v29.6025a7.6635 7.6635 0 0 0 1.0976 4.2285q1.098 1.7081 3.9444 1.708a6.0109 6.0109 0 0 0 1.7485-.2846 5.2115 5.2115 0 0 0 1.7485-.9351 4.953 4.953 0 0 0 1.22-1.79 7.2474 7.2474 0 0 0 .4878-2.8462v-2.8457z"/><path d="m99.1748 59.1143v-50.0957h-9.5967v-7.8077h27.4878v7.8077h-9.5959v50.0957z"/><path d="m120.7246 59.1143v-57.9034h13.3369q14.6385 0 14.6385 16.9971a21.4218 21.4218 0 0 1 -1.5859 8.7017 12.2983 12.2983 0 0 1 -5.5708 5.7739l8.9458 26.4307h-8.7832l-7.7256-24.7227h-4.9603v24.7227zm8.2954-50.0957v18.0537h4.7168a8.348 8.348 0 0 0 3.4971-.61 4.7555 4.7555 0 0 0 2.0332-1.7485 7.9534 7.9534 0 0 0 .8945-2.8057 26.9748 26.9748 0 0 0 .2437-3.8628 26.99 26.99 0 0 0 -.2437-3.8628 7.7387 7.7387 0 0 0 -.976-2.8872q-1.5467-2.2753-5.8556-2.2767z"/><path d="m155.6123 59.1143v-57.9034h8.2954v57.9034z"/><path d="m198.7954 17.8828h-8.2949v-1.8706a8.8535 8.8535 0 0 0 -1.3423-4.92 4.962 4.962 0 0 0 -4.5132-2.0737 5.2227 5.2227 0 0 0 -2.7651.65 5.4612 5.4612 0 0 0 -1.708 1.6265 6.8624 6.8624 0 0 0 -.8946 2.3989 15.6706 15.6706 0 0 0 -.2436 2.8057 27.5758 27.5758 0 0 0 .1216 2.8467 5.3954 5.3954 0 0 0 .61 2.0332 4.5014 4.5014 0 0 0 1.4229 1.5449 12.9606 12.9606 0 0 0 2.562 1.3013l6.3433 2.521a15.7628 15.7628 0 0 1 4.4726 2.48 10.7272 10.7272 0 0 1 2.6839 3.2943 15.4228 15.4228 0 0 1 1.22 4.4321 44.0689 44.0689 0 0 1 .3252 5.6524 29.8066 29.8066 0 0 1 -.7319 6.7905 14.3039 14.3039 0 0 1 -2.3584 5.3267 11.699 11.699 0 0 1 -4.4727 3.5781 15.7942 15.7942 0 0 1 -6.75 1.3013 14.7745 14.7745 0 0 1 -5.6113-1.0572 13.31 13.31 0 0 1 -4.4732-2.9277 14.2235 14.2235 0 0 1 -2.9682-4.3506 13.2116 13.2116 0 0 1 -1.0982-5.4082v-3.09h8.2955v2.6025a6.7761 6.7761 0 0 0 1.3418 4.1069q1.3418 1.83 4.5136 1.83a7.2794 7.2794 0 0 0 3.2935-.61 4.3859 4.3859 0 0 0 1.83-1.7486 6.4244 6.4244 0 0 0 .7729-2.7246q.1216-1.5856.1221-3.5376a35.0565 35.0565 0 0 0 -.1631-3.7407 6.4528 6.4528 0 0 0 -.65-2.3584 4.59 4.59 0 0 0 -1.5044-1.4639 19.57 19.57 0 0 0 -2.4805-1.22l-5.9365-2.44q-5.3679-2.1958-7.1972-5.8145a19.9948 19.9948 0 0 1 -1.83-9.0679 21.0112 21.0112 0 0 1 .8945-6.1806 14.0506 14.0506 0 0 1 2.6841-5.042 12.3042 12.3042 0 0 1 4.3506-3.375 14.5257 14.5257 0 0 1 6.3018-1.2609 13.7661 13.7661 0 0 1 5.6519 1.1387 14.5927 14.5927 0 0 1 4.4326 3.0088 12.5712 12.5712 0 0 1 3.7407 8.9458z"/></g></svg></div><div class="play" :class="initial &amp;&amp; !showHighscore ? \'show\' : \'\'" @click="app.play()"><svg class="icon" viewBox="0 0 80 80" width="80" height="80"><use xlink:href="/icons.fed6ed.svg#play"></use></svg></div><div class="overlay lost" :class="lost &amp;&amp; !showHighscore ? \'show\' : \'\'">Game over!</div><div class="overlay paused" :class="playing || lost || initial || showHighscore ? \'\' : \'show\'">Paused</div><div class="highscore" :show="showHighscore"><div class="text-large"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#trophy"></use></svg> Highscore</div><table><tr><td>${highscore[0].name}</td><td>${numberFormat(highscore[0].score)}</td></tr><tr><td>${highscore[1].name}</td><td>${numberFormat(highscore[1].score)}</td></tr><tr><td>${highscore[2].name}</td><td>${numberFormat(highscore[2].score)}</td></tr><tr><td>${highscore[3].name}</td><td>${numberFormat(highscore[3].score)}</td></tr><tr><td>${highscore[4].name}</td><td>${numberFormat(highscore[4].score)}</td></tr><tr><td>${highscore[5].name}</td><td>${numberFormat(highscore[5].score)}</td></tr><tr><td>${highscore[6].name}</td><td>${numberFormat(highscore[6].score)}</td></tr><tr><td>${highscore[7].name}</td><td>${numberFormat(highscore[7].score)}</td></tr><tr><td>${highscore[8].name}</td><td>${numberFormat(highscore[8].score)}</td></tr><tr><td>${highscore[9].name}</td><td>${numberFormat(highscore[9].score)}</td></tr><tr><td>${highscore[10].name}</td><td>${numberFormat(highscore[10].score)}</td></tr></table></div></div><div class="factris-keys"><button class="key-left" :class="key === \'left\' ? \'active\' : \'\'" title="Left" @pointerdown="app.keyPress(\'left\')"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#left"></use></svg></button><div class="keys-center"><button class="key-up" :class="key === \'up\' ? \'active\' : \'\'" title="Resize" @pointerdown="app.keyPress(\'up\')"><svg class="icon" width="54" height="36" viewBox="0 0 54 36" xmlns="http://www.w3.org/2000/svg"><path d="m41.1973 11 1.5975-1.635a.75.75 0 0 1 1.2751.5325v.495a6 6 0 0 1 5.2501 5.8575.75.75 0 0 1 -1.5 0 4.5 4.5 0 0 0 -3.75-4.3426v1.1475a.75.75 0 0 1 -1.2751.5326l-1.5975-1.56a.7676.7676 0 0 1 -.0001-1.0275z"/><path d="m12.8027 11-1.5975-1.635a.75.75 0 0 0 -1.2752.5324v.495a6 6 0 0 0 -5.25 5.8576.75.75 0 0 0 1.5 0 4.5 4.5 0 0 1 3.75-4.3426v1.1475a.75.75 0 0 0 1.2751.5326l1.5975-1.56a.7676.7676 0 0 0 .0001-1.0275z"/><rect height="11" rx="2" width="11" x="15" y="6"/><rect height="11" rx="2" width="11" x="28" y="6"/><rect height="11" rx="2" width="11" x="15" y="19"/><rect height="11" rx="2" width="11" x="28" y="19"/><path d="m50 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/><path d="m11 21v7h-7v-7zm0-2h-7a2 2 0 0 0 -2 2v7a2 2 0 0 0 2 2h7a2 2 0 0 0 2-2v-7a2 2 0 0 0 -2-2z"/></svg>\n</button><button class="key-down" :class="key === \'down\' ? \'active\' : \'\'" title="Down" @pointerdown="app.keyPress(\'down\')"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#down"></use></svg></button></div><button class="key-right" :class="key === \'right\' ? \'active\' : \'\'" title="Right" @pointerdown="app.keyPress(\'right\')"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#right"></use></svg></button></div><div class="factris-panel-top" :class="showHighscore ? \'hide\' : \'\'"><div class="text-small">Block size:</div><div class="text-large">${active[0] || \'?\' } = ${active[2]|| \'?\'} × ${active[1]|| \'?\'}</div><div class="corner left"><svg width="13" height="13"><path d="M12,0A12,12,0,0,1,0,12v1H13V0Z"></path></svg></div><div class="corner right"><svg width="13" height="13"><path d="M1,0A12,12,0,0,0,13,12v1H0V0Z"></path></svg></div></div>'})],Yl);const Ql=as("div",{class:"modal-background"},ls);let Jl,tc,ec;function sc(){tc&&tc.canClose&&tc.close()}Ql.on("click",sc),$s.onKey("escape",sc),Is.on("change",sc),Ql.on("scrollwheel touchmove",(t=>{t.preventDefault(),t.stopPropagation()})),$s.onKey("space up down pagedown pageup",(t=>{tc&&(t.preventDefault(),t.stopPropagation())}));let ic=class extends Bs{constructor(){super(...arguments),this.isOpen=!1,this.canClose=!0}ready(){this.canClose=!this.hasAttr("no-close"),this.$iframe=this.$("iframe[data-src]"),this.$video=this.$("video");const t=hs(`[data-modal=${this.id}]`);for(const e of t)e.on("click",(()=>this.open()));Is.on("afterChange",(({$viewport:t})=>{const e=t.$$(`[data-modal=${this.id}]`);for(const t of e)t.on("click",(()=>this.open()))})),this.hasClass("open")&&!tc&&this.open(!0),this.$("input")&&this.addClass("interactive");const e=this.$(".close");e&&e.on("click",(()=>this.close()));for(const t of this.$$(".btn"))t.on("click",(()=>this.trigger("btn-click",t)))}open(t=!1){if(this.isOpen)return;Ql.setClass("light",this.hasClass("light")),tc?tc.close(!0):t?Ql.show():"block"===Ql.css("display")?null==Jl||Jl.cancel():Ql.enter("fade",250),this.isOpen=!0,tc=this,this.$iframe&&this.$iframe.setAttr("src",this.$iframe.data.src),this.$video&&this.$video.play(),t?this.show():this.enter("pop",250).promise.then((()=>this.css("transform",""))),this.setAttr("role","dialog"),this.trigger("open"),ec=document.activeElement;const e=this.$('input, a, button, textarea, [tabindex="0"]');e&&e.focus()}close(t=!1,e=!1){this.isOpen&&(this.isOpen=!1,this.removeAttr("role"),tc=void 0,this.$iframe&&this.$iframe.setAttr("src",""),this.$video&&this.$video.pause(),t||(Jl=Ql.exit("fade",250)),this.exit("pop",250).promise.then((()=>this.css("transform",""))),e||this.trigger("close"),ec&&ec.focus())}static confirm(t){var e;return s(this,void 0,void 0,(function*(){const s=rs(t);if(!s)return"";s.open();const i=yield new Promise((t=>s.one("close btn-click",t)));return s.close(),(null===(e=null==i?void 0:i.data)||void 0===e?void 0:e.prompt)||""}))}};ic=e([Rs("x-modal")],ic);let nc=class extends Bs{constructor(){super(...arguments),this.$options={}}ready(){const t=this.children;this.$active=this.$(".active")||t[0],this.$active.addClass("active");for(const[e,s]of t.entries())i(s.tagName,"A","BUTTON")||s.hasAttr("tabindex")||s.setAttr("tabindex",0),s.on("click",(()=>this.makeActive(s))),this.$options[s.attr("value")||e]=s;this.trigger("change",this.$active)}makeActive(t){t!==this.$active&&(this.$active.removeClass("active"),this.$active=t,t.addClass("active"),this.trigger("change",t))}bindVariable(t,e){t[e]=this.$active.attr("value"),this.on("change",(s=>t[e]=s.attr("value"))),t.watch((()=>{const s=this.$options[t[e]];s&&this.makeActive(s)}))}};nc=e([Rs("x-select")],nc);let oc=class extends Bs{ready(){this.bindModel(He({title:"",url:"",img:"",body:"",fbAppId:this.attr("facebook"),twitterHandle:this.attr("twitter"),canCopy:!!window.navigator.clipboard,copy:()=>this.copyUrl()}));for(const t of["title","url","img","body"])this.onAttr(t,(e=>this.model[t]=encodeURIComponent(e)));for(const t of this.$$("a.btn"))t.on("click",(e=>{null===window||void 0===window||window.ga("send","event","Share",t.attr("title")),e.preventDefault();const s=`menubar=no,toolbar=no,width=720,height=640,top=${window.screen.height/2-320},left=${window.screen.width/2-360}`;window.open(t.attr("href"),"",s)}))}copyUrl(){return s(this,void 0,void 0,(function*(){const t=this.attr("url");yield window.navigator.clipboard.writeText(t),navigator.canShare&&navigator.share({title:`Polypad – ${this.attr("title")}`,url:t}),ya("clipboard")}))}};oc=e([Rs("x-share",{template:'<a class="btn classroom" title="Classroom" href="https://classroom.google.com/share?url=${url}&amp;title=${title}" target="_blank" rel="noopener"></a><a class="btn twitter" title="Twitter" href="https://twitter.com/intent/tweet?url=${url}&amp;text=${title}&amp;via=${twitterHandle}" target="_blank" rel="noopener"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#twitter"></use></svg></a><a class="btn facebook" title="Facebook" href="https://www.facebook.com/dialog/share?app_id=${fbAppId}&amp;display=page&amp;href=${url}" target="_blank" rel="noopener"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#facebook"></use></svg></a><a class="btn pinterest" title="Pinterest" href="https://pinterest.com/pin/create/bookmarklet/?media=${img}&amp;url=${url}&amp;description=${title}" target="_blank" rel="noopener"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#pinterest"></use></svg></a><a class="btn reddit" title="Reddit" href="https://reddit.com/submit?url=${url}&amp;title=${title}" target="_blank" rel="noopener"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#reddit"></use></svg></a><button class="btn" title="Copy to Clipboard" :show="canCopy" @click="copy()"><svg class="icon" viewBox="0 0 36 36" width="36" height="36"><use xlink:href="/icons.fed6ed.svg#link"></use></svg></button><x-alert class="success" key="clipboard"><svg class="icon" viewBox="0 0 24 24" width="24" height="24"><use xlink:href="/icons.fed6ed.svg#check-white"></use></svg> URL copied to clipboard!</x-alert>'})],oc);let rc=class extends Bs{ready(){const t=Array.from(this._el.children);this.removeChildren();const e=as("svg",{class:"equation"},this),s=as("g",{transform:"translate(2 0)"},e),i=as("div",{class:"overlay"},this),n=parseFloat(this.css("font-size")),o=this.parents(".text-center").length||this.hasClass("display"),r=new Fi(s,i,0,"",n,!!o);r.setValue(this.attr("expr")||t),this.css({width:r.root.width+4+"px",height:r.root.height+"px","vertical-align":`-${r.root.height-r.root.baseline}px`})}};rc=e([Rs("x-math")],rc);const hc={},ac=rs("#search"),lc=null==ac?void 0:ac.$(".form-field input"),cc=null==ac?void 0:ac.$(".search-body");hc[""]=(null==cc?void 0:cc.html)||"";let dc=0,pc=0;function uc(t){return s(this,void 0,void 0,(function*(){const e=dc+=1,i=yield function(t){return s(this,void 0,void 0,(function*(){if((t=encodeURIComponent(function(t){return"pi"===(t=t.trim().replace(/\s+/," ").toLowerCase().slice(0,50))||t.length>=3?t:""}(t)))in hc)return hc[t];const e=yield fetch(`/api/search?s=${t}`);return e.ok?hc[t]=yield e.text():hc[t]=""}))}(t);e<=pc||(pc=e,cc.html=i)}))}null==lc||lc.change((t=>{$s.setCookie("search",t,86400),setTimeout((()=>{lc.value==t&&uc(t)}),300),t&&window.ga&&setTimeout((()=>{lc.value==t&&window.ga("send","event","search",t)}),2e3)})),(null==lc?void 0:lc.value)&&ac.one("open",(()=>uc(lc.value)));const fc="2.4.1",gc="i5iSjo",mc="(not set)",vc=[];class $c{static add(t,e,s){wc(t,e).add(s)}static remove(t,e,s){wc(t,e).remove(s)}constructor(t,e){this.context=t,this.methodName=e,this.isTask=/Task$/.test(e),this.originalMethodReference=this.isTask?t.get(e):t[e],this.methodChain=[],this.boundMethodChain=[],this.wrappedMethod=(...t)=>(0,this.boundMethodChain[this.boundMethodChain.length-1])(...t),this.isTask?t.set(e,this.wrappedMethod):t[e]=this.wrappedMethod}add(t){this.methodChain.push(t),this.rebindMethodChain()}remove(t){const e=this.methodChain.indexOf(t);e>-1&&(this.methodChain.splice(e,1),this.methodChain.length>0?this.rebindMethodChain():this.destroy())}rebindMethodChain(){this.boundMethodChain=[];for(let t,e=0;t=this.methodChain[e];e++){const s=this.boundMethodChain[e-1]||this.originalMethodReference.bind(this.context);this.boundMethodChain.push(t(s))}}destroy(){const t=vc.indexOf(this);t>-1&&(vc.splice(t,1),this.isTask?this.context.set(this.methodName,this.originalMethodReference):this.context[this.methodName]=this.originalMethodReference)}}function wc(t,e){let s=vc.filter((s=>s.context==t&&s.methodName==e))[0];return s||(s=new $c(t,e),vc.push(s)),s}function xc(t,e,s,i,n,o){if("function"==typeof i){const r=s.get("buildHitTask");return{buildHitTask:s=>{s.set(t,null,!0),s.set(e,null,!0),i(s,n,o),r(s)}}}return bc({},t,e)}document.createElement("a");const yc={};const bc=Object.assign||function(t,...e){for(let s=0,i=e.length;s<i;s++){const i=Object(e[s]);for(let e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e])}return t};function Mc(){return+new Date}const kc=function t(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t)};const Ac="autotrack",Cc={};let Pc,Tc=!1;class Sc extends class{constructor(){this.registry_={}}on(t,e){this.getRegistry_(t).push(e)}off(t,e){if(t&&e){const s=this.getRegistry_(t),i=s.indexOf(e);i>-1&&s.splice(i,1)}else this.registry_={}}emit(t,...e){this.getRegistry_(t).forEach((t=>t(...e)))}getEventCount(){let t=0;return Object.keys(this.registry_).forEach((e=>{t+=this.getRegistry_(e).length})),t}getRegistry_(t){return this.registry_[t]=this.registry_[t]||[]}}{static getOrCreate(t,e,s){const i=[Ac,t,e].join(":");return Cc[i]||(Cc[i]=new Sc(i,s),Tc||(window.addEventListener("storage",Lc),Tc=!0)),Cc[i]}static isSupported_(){if(null!=Pc)return Pc;try{window.localStorage.setItem(Ac,Ac),window.localStorage.removeItem(Ac),Pc=!0}catch(t){Pc=!1}return Pc}static get_(t){return window.localStorage.getItem(t)}static set_(t,e){window.localStorage.setItem(t,e)}static clear_(t){window.localStorage.removeItem(t)}constructor(t,e={}){super(),this.key_=t,this.defaults_=e,this.cache_=null}get(){if(this.cache_)return this.cache_;if(Sc.isSupported_())try{this.cache_=_c(Sc.get_(this.key_))}catch(t){}return this.cache_=bc({},this.defaults_,this.cache_)}set(t){if(this.cache_=bc({},this.defaults_,this.cache_,t),Sc.isSupported_())try{Sc.set_(this.key_,JSON.stringify(this.cache_))}catch(t){}}clear(){if(this.cache_={},Sc.isSupported_())try{Sc.clear_(this.key_)}catch(t){}}destroy(){delete Cc[this.key_],Object.keys(Cc).length||(window.removeEventListener("storage",Lc),Tc=!1)}}function Lc(t){const e=Cc[t.key];if(e){const s=bc({},e.defaults_,_c(t.oldValue)),i=bc({},e.defaults_,_c(t.newValue));e.cache_=i,e.emit("externalSet",i,s)}}function _c(t){let e={};if(t)try{e=JSON.parse(t)}catch(t){}return e}const zc={};class Ec{static getOrCreate(t,e,s){const i=t.get("trackingId");return zc[i]?zc[i]:zc[i]=new Ec(t,e,s)}constructor(t,e,s){this.tracker=t,this.timeout=e||Ec.DEFAULT_TIMEOUT,this.timeZone=s,this.sendHitTaskOverride=this.sendHitTaskOverride.bind(this),$c.add(t,"sendHitTask",this.sendHitTaskOverride);try{this.dateTimeFormatter=new Intl.DateTimeFormat("en-US",{timeZone:this.timeZone})}catch(t){}this.store=Sc.getOrCreate(t.get("trackingId"),"session",{hitTime:0,isExpired:!1}),this.store.get().id||this.store.set({id:kc()})}getId(){return this.store.get().id}isExpired(t=this.getId()){if(t!=this.getId())return!0;const e=this.store.get();if(e.isExpired)return!0;const s=e.hitTime;if(s){const t=new Date,e=new Date(s);if(t-e>6e4*this.timeout||this.datesAreDifferentInTimezone(t,e))return!0}return!1}datesAreDifferentInTimezone(t,e){return!!this.dateTimeFormatter&&this.dateTimeFormatter.format(t)!=this.dateTimeFormatter.format(e)}sendHitTaskOverride(t){return e=>{t(e);const s=e.get("sessionControl"),i="start"==s||this.isExpired(),n="end"==s,o=this.store.get();o.hitTime=Mc(),i&&(o.isExpired=!1,o.id=kc()),n&&(o.isExpired=!0),this.store.set(o)}}destroy(){$c.remove(this.tracker,"sendHitTask",this.sendHitTaskOverride),this.store.destroy(),delete zc[this.tracker.get("trackingId")]}}Ec.DEFAULT_TIMEOUT=30;const Ic={CLEAN_URL_TRACKER:1,EVENT_TRACKER:2,IMPRESSION_TRACKER:3,MEDIA_QUERY_TRACKER:4,OUTBOUND_FORM_TRACKER:5,OUTBOUND_LINK_TRACKER:6,PAGE_VISIBILITY_TRACKER:7,SOCIAL_WIDGET_TRACKER:8,URL_CHANGE_TRACKER:9,MAX_SCROLL_TRACKER:10},Oc=Object.keys(Ic).length;function qc(t,e){!function(t){t.set("&_av",fc)}(t),function(t,e){let s=function(t,e){if(t.length<e){let s=e-t.length;for(;s;)t="0"+t,s--}return t}((i=t.get("&_au"),parseInt(i||"0",16).toString(2)),Oc);var i;o=s,r=Oc-e,s=o.substr(0,r)+1+o.substr(r+1),t.set("&_au",(n=s,parseInt(n||"0",2).toString(16)));var n;var o,r}(t,e)}const Vc="hidden",Bc="visible",Rc=kc();!function(t,e){const s=window.GoogleAnalyticsObject||"ga";var i;window[s]=window[s]||function(...t){(window[s].q=window[s].q||[]).push(t)},window.gaDevIds=window.gaDevIds||[],window.gaDevIds.indexOf(gc)<0&&window.gaDevIds.push(gc),window[s]("provide",t,e),window.gaplugins=window.gaplugins||{},window.gaplugins[(i=t,i.charAt(0).toUpperCase()+i.slice(1))]=e}("pageVisibilityTracker",class{constructor(t,e){if(qc(t,Ic.PAGE_VISIBILITY_TRACKER),!document.visibilityState)return;const s={sessionTimeout:Ec.DEFAULT_TIMEOUT,visibleThreshold:5e3,sendInitialPageview:!1,fieldsObj:{}};this.opts=bc(s,e),this.tracker=t,this.lastPageState=document.visibilityState,this.visibleThresholdTimeout_=null,this.isInitialPageviewSent_=!1,this.trackerSetOverride=this.trackerSetOverride.bind(this),this.handleChange=this.handleChange.bind(this),this.handleWindowUnload=this.handleWindowUnload.bind(this),this.handleExternalStoreSet=this.handleExternalStoreSet.bind(this),this.store=Sc.getOrCreate(t.get("trackingId"),"plugins/page-visibility-tracker"),this.store.on("externalSet",this.handleExternalStoreSet),this.session=Ec.getOrCreate(t,this.opts.sessionTimeout,this.opts.timeZone),$c.add(t,"set",this.trackerSetOverride),window.addEventListener("unload",this.handleWindowUnload),document.addEventListener("visibilitychange",this.handleChange),function(t,e){const s=t.get("trackingId"),i=yc[s]=yc[s]||{},n=()=>{clearTimeout(i.timeout),i.send&&$c.remove(t,"send",i.send),delete yc[s],i.queue.forEach((t=>t()))};clearTimeout(i.timeout),i.timeout=setTimeout(n,0),i.queue=i.queue||[],i.queue.push(e),i.send||(i.send=t=>(...e)=>{n(),t(...e)},$c.add(t,"send",i.send))}(this.tracker,(()=>{document.visibilityState==Bc?(this.opts.sendInitialPageview&&(this.sendPageview({isPageLoad:!0}),this.isInitialPageviewSent_=!0),this.store.set({time:Mc(),state:Bc,pageId:Rc,sessionId:this.session.getId()})):this.opts.sendInitialPageview&&this.opts.pageLoadsMetricIndex&&this.sendPageLoad()}))}handleChange(){if(document.visibilityState!=Bc&&document.visibilityState!=Vc)return;const t=this.getAndValidateChangeData(),e={time:Mc(),state:document.visibilityState,pageId:Rc,sessionId:this.session.getId()};document.visibilityState==Bc&&this.opts.sendInitialPageview&&!this.isInitialPageviewSent_&&(this.sendPageview(),this.isInitialPageviewSent_=!0),document.visibilityState==Vc&&this.visibleThresholdTimeout_&&clearTimeout(this.visibleThresholdTimeout_),this.session.isExpired(t.sessionId)?(this.store.clear(),this.lastPageState==Vc&&document.visibilityState==Bc&&(clearTimeout(this.visibleThresholdTimeout_),this.visibleThresholdTimeout_=setTimeout((()=>{this.store.set(e),this.sendPageview({hitTime:e.time})}),this.opts.visibleThreshold))):(t.pageId==Rc&&t.state==Bc&&this.sendPageVisibilityEvent(t),this.store.set(e)),this.lastPageState=document.visibilityState}getAndValidateChangeData(){const t=this.store.get();return this.lastPageState==Bc&&t.state==Vc&&t.pageId!=Rc&&(t.state=Bc,t.pageId=Rc,this.store.set(t)),t}sendPageVisibilityEvent(t,{hitTime:e}={}){const s=this.getTimeSinceLastStoredChange(t,{hitTime:e});if(s&&s>=this.opts.visibleThreshold){const t=Math.round(s/1e3),i={transport:"beacon",nonInteraction:!0,eventCategory:"Page Visibility",eventAction:"track",eventValue:t,eventLabel:mc};e&&(i.queueTime=Mc()-e),this.opts.visibleMetricIndex&&(i["metric"+this.opts.visibleMetricIndex]=t),this.tracker.send("event",xc(i,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}}sendPageLoad(){const t={transport:"beacon",eventCategory:"Page Visibility",eventAction:"page load",eventLabel:mc,["metric"+this.opts.pageLoadsMetricIndex]:1,nonInteraction:!0};this.tracker.send("event",xc(t,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}sendPageview({hitTime:t,isPageLoad:e}={}){const s={transport:"beacon"};t&&(s.queueTime=Mc()-t),e&&this.opts.pageLoadsMetricIndex&&(s["metric"+this.opts.pageLoadsMetricIndex]=1),this.tracker.send("pageview",xc(s,this.opts.fieldsObj,this.tracker,this.opts.hitFilter))}trackerSetOverride(t){return(e,s)=>{const i=function(t){return"object"==typeof t&&null!==t}(e)?e:{[e]:s};i.page&&i.page!==this.tracker.get("page")&&this.lastPageState==Bc&&this.handleChange(),t(e,s)}}getTimeSinceLastStoredChange(t,{hitTime:e}={}){return t.time?(e||Mc())-t.time:0}handleExternalStoreSet(t,e){t.time!=e.time&&(e.pageId!=Rc||e.state!=Bc||this.session.isExpired(e.sessionId)||this.sendPageVisibilityEvent(e,{hitTime:t.time}))}handleWindowUnload(){this.lastPageState!=Vc&&this.handleChange()}remove(){this.store.destroy(),this.session.destroy(),$c.remove(this.tracker,"set",this.trackerSetOverride),window.removeEventListener("unload",this.handleWindowUnload),document.removeEventListener("visibilitychange",this.handleChange)}}),window.$=rs,window.$$=hs,window.Browser=$s,ys(),document.addEventListener("keydown",(t=>{if(t.keyCode===ds.enter||t.keyCode===ds.space){const e=$s.getActiveInput();e&&e.hasAttr("tabindex")&&"TEXTAREA"!==e.tagName&&(t.preventDefault(),e.trigger("pointerdown",t),e.trigger("pointerstop",t),ls.trigger("pointerstop",t),e.trigger("click",t))}})),cs.addClass(($s.isMobile?"is":"not")+"-mobile"),$s.isSafari&&cs.addClass("is-safari"),setTimeout((()=>cs.addClass("ready"))),window.addEventListener("keydown",(t=>{9===t.keyCode&&cs.addClass("is-tabbing")})),window.addEventListener("mousedown",(()=>{cs.removeClass("is-tabbing")})),t.Course=class extends Bs{constructor(){super(...arguments),this.user=window.user,this.isCompleted=!1,this.isReady=!1}created(){this.glossary=JSON.parse(this.$("#glossary").text)||{},this.userData=window.progressData||JSON.parse(this.$("#userdata").text)||{},this.$steps=this.$$("x-step");for(const t of this.$steps)t.on("score",(()=>this.trigger("score")));this.data.audio&&(this.audio=new Ds(this.data.audio))}ready(){this.$footer=this.$("footer"),this.$skipStep=this.$footer.$(".skip-step"),this.$progress=this.$(".sidebar-row.on x-progress"),this.$tutor=this.$("x-tutor"),this.$stepsWrap=this.$(".steps");const t=this.findStep($s.getHash()),e=this.findStep(this.userData.activeStep);this.$activeStep=e||this.$steps[0];for(const t of this.$steps){if(t.show(),t===this.$activeStep)break;t.complete()}if(this.userData.completed||"full"===$s.getHash())this.complete();else for(;this.$activeStep&&this.$activeStep.isReady&&!this.isCompleted;)this.nextStep();(t||e&&!this.userData.completed)&&this.goToStep(t||e,!1),this.$(".section-dev")&&this.complete();const s=this.$(".reveal-banner");setTimeout((()=>{this.isCompleted||(s.removeClass("off"),this.on("score complete",(()=>s.addClass("off"))))}),1500),s.$(".complete").one("click",(()=>this.complete())),$s.onKey("space",(t=>{t.preventDefault(),this.nextStep(),s.addClass("off")})),this.$footer.$(".skip").on("click",(()=>this.nextStep())),this.$footer.$(".show-all").on("click",(()=>this.complete())),this.isReady=!0,setTimeout((()=>this.addClass("ready")))}nextStep(){if(this.isCompleted)return;let t=this.$activeStep;const e=this.$stepsWrap.height;do{if(t.complete(),t=this.$steps[this.$steps.indexOf(t)+1],!t)return this.complete(!0);t.show()}while(t.isReady);this.$stepsWrap.animate({height:[e+"px","auto"]},800),this.$activeStep=t,this.saveProgress({activeStep:t.id})}goToStep(t,e=!0){const s=this.$stepsWrap.height;for(const e of this.$steps){if(e.isShown||(this.$activeStep=e),e.show(),t.isShown&&!e.isReady)break;e.complete()}const i=t.positionTop-Math.max(50,($s.height-t.height)/2);e?(this.$stepsWrap.animate({height:[s+"px","auto"]},800),ls.scrollTo(i)):ls.scrollTop=i;const n=v(this.$steps);if(n.isShown&&n.isReady)return this.complete();this.$activeStep&&this.saveProgress({activeStep:this.$activeStep.id})}complete(t=!1){if(this.isCompleted)return;this.isCompleted=!0,this.$steps.forEach((t=>t.complete())),this.$activeStep=void 0;const e=this.$footer.$(".next-section");t?(this.$skipStep.exit("fade",200),e&&e.enter("pop")):(this.$skipStep.hide(),e&&e.show()),this.trigger("complete"),this.saveProgress({completed:!0}),this.log("Course","complete")}findStep(t){for(const e of this.$steps)if(e.id===t)return e}saveProgress(t){if(!this.isReady)return;$(this.$steps.map((t=>t.scores.size))),this.data.goals}log(t,e,s){}},t.Course=e([Rs("x-course")],t.Course);const Dc=rs(".sidebar");return Dc&&(rs(".sidebar-toggle").on("click",(()=>Dc.addClass("open"))),rs(".sidebar-shadow").on("pointerdown",(()=>Dc.removeClass("open")))),Object.defineProperty(t,"__esModule",{value:!0}),t}({});